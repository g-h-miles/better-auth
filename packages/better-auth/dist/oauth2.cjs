"use strict";var g=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var o=(e,t)=>g(e,"name",{value:t,configurable:!0});var C=(e,t)=>{for(var r in t)g(e,r,{get:t[r],enumerable:!0})},N=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of B(t))!O.call(e,i)&&i!==r&&g(e,i,{get:()=>t[i],enumerable:!(n=S(t,i))||n.enumerable});return e};var V=e=>N(g({},"__esModule",{value:!0}),e);var Q={};C(Q,{createAuthorizationURL:()=>D,generateCodeChallenge:()=>h,generateState:()=>X,getOAuth2Tokens:()=>U,parseState:()=>F,validateAuthorizationCode:()=>I,validateToken:()=>j});module.exports=V(Q);var b=o((e,t="ms")=>new Date(Date.now()+(t==="sec"?e*1e3:e)),"getDate");var k=require("@better-auth/utils/hash"),A=require("@better-auth/utils/base64");async function h(e){let t=await(0,k.createHash)("SHA-256").digest(e);return A.base64Url.encode(new Uint8Array(t),{padding:!1})}o(h,"generateCodeChallenge");function U(e){return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?b(e.expires_in,"sec"):void 0,scopes:e?.scope?typeof e.scope=="string"?e.scope.split(" "):e.scope:[],idToken:e.id_token}}o(U,"getOAuth2Tokens");async function D({id:e,options:t,authorizationEndpoint:r,state:n,codeVerifier:i,scopes:d,claims:s,redirectURI:p,duration:l}){let a=new URL(r);if(a.searchParams.set("response_type","code"),a.searchParams.set("client_id",t.clientId),a.searchParams.set("state",n),a.searchParams.set("scope",d.join(" ")),a.searchParams.set("redirect_uri",t.redirectURI||p),i){let f=await h(i);a.searchParams.set("code_challenge_method","S256"),a.searchParams.set("code_challenge",f)}if(s){let f=s.reduce((m,P)=>(m[P]=null,m),{});a.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...f}}))}return l&&a.searchParams.set("duration",l),a}o(D,"createAuthorizationURL");var x=require("@better-fetch/fetch");var L=require("jose");async function I({code:e,codeVerifier:t,redirectURI:r,options:n,tokenEndpoint:i,authentication:d}){let s=new URLSearchParams,p={"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth"};if(s.set("grant_type","authorization_code"),s.set("code",e),t&&s.set("code_verifier",t),s.set("redirect_uri",r),d==="basic"){let m=btoa(`${n.clientId}:${n.clientSecret}`);p.authorization=`Basic ${m}`}else s.set("client_id",n.clientId),s.set("client_secret",n.clientSecret);let{data:l,error:a}=await(0,x.betterFetch)(i,{method:"POST",body:s,headers:p});if(a)throw a;return U(l)}o(I,"validateAuthorizationCode");async function j(e,t){let{data:r,error:n}=await(0,x.betterFetch)(t,{method:"GET",headers:{accept:"application/json","user-agent":"better-auth"}});if(n)throw n;let i=r.keys,d=JSON.parse(atob(e.split(".")[0])),s=i.find(l=>l.kid===d.kid);if(!s)throw new Error("Key not found");return await(0,L.jwtVerify)(e,s)}o(j,"validateToken");var c=require("zod"),R=require("better-call");var y=Object.create(null),u=o(e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?y:globalThis),"_getEnv"),T=new Proxy(y,{get(e,t){return u()[t]??y[t]},has(e,t){let r=u();return t in r||t in y},set(e,t,r){let n=u(!0);return n[t]=r,!0},deleteProperty(e,t){if(!t)return!1;let r=u(!0);return delete r[t],!0},ownKeys(){let e=u(!0);return Object.keys(e)}});function H(e){return e?e!=="false":!1}o(H,"toBoolean");var $=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var pe=$==="test"||H(T.TEST);function v(e){try{return new URL(e).origin}catch{return null}}o(v,"getOrigin");var K=require("@better-auth/utils/hash"),J=require("@noble/ciphers/chacha"),_=require("@noble/ciphers/utils"),M=require("@noble/ciphers/webcrypto");var q=require("@noble/hashes/scrypt"),z=require("uncrypto"),G=require("@better-auth/utils/hex");var E=require("@better-auth/utils/random"),w=(0,E.createRandomStringGenerator)("a-z","0-9","A-Z","-_");async function X(e,t){let r=e.body?.callbackURL||(e.query?.currentURL?v(e.query?.currentURL):"")||e.context.options.baseURL;if(!r)throw new R.APIError("BAD_REQUEST",{message:"callbackURL is required"});let n=w(128),i=w(32),d=JSON.stringify({callbackURL:r,codeVerifier:n,errorURL:e.body?.errorCallbackURL||e.query?.currentURL,newUserURL:e.body?.newUserCallbackURL,link:t,expiresAt:Date.now()+10*60*1e3}),s=new Date;s.setMinutes(s.getMinutes()+10);let p=await e.context.internalAdapter.createVerificationValue({value:d,identifier:i,expiresAt:s});if(!p)throw e.context.logger.error("Unable to create verification. Make sure the database adapter is properly working and there is a verification table in the database"),new R.APIError("INTERNAL_SERVER_ERROR",{message:"Unable to create verification"});return{state:p.identifier,codeVerifier:n}}o(X,"generateState");async function F(e){let t=e.query.state||e.body.state,r=await e.context.internalAdapter.findVerificationValue(t);if(!r)throw e.context.logger.error("State Mismatch. Verification not found",{state:t}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);let n=c.z.object({callbackURL:c.z.string(),codeVerifier:c.z.string(),errorURL:c.z.string().optional(),newUserURL:c.z.string().optional(),expiresAt:c.z.number(),link:c.z.object({email:c.z.string(),userId:c.z.string()}).optional()}).parse(JSON.parse(r.value));if(n.errorURL||(n.errorURL=`${e.context.baseURL}/error`),n.expiresAt<Date.now())throw await e.context.internalAdapter.deleteVerificationValue(r.id),e.context.logger.error("State expired.",{state:t}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);return await e.context.internalAdapter.deleteVerificationValue(r.id),n}o(F,"parseState");0&&(module.exports={createAuthorizationURL,generateCodeChallenge,generateState,getOAuth2Tokens,parseState,validateAuthorizationCode,validateToken});
