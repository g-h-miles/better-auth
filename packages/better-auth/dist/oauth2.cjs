"use strict";var g=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var O=(e,t)=>{for(var r in t)g(e,r,{get:t[r],enumerable:!0})},C=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of S(t))!B.call(e,s)&&s!==r&&g(e,s,{get:()=>t[s],enumerable:!(n=P(t,s))||n.enumerable});return e};var N=e=>C(g({},"__esModule",{value:!0}),e);var F={};O(F,{createAuthorizationURL:()=>V,generateCodeChallenge:()=>y,generateState:()=>M,getOAuth2Tokens:()=>h,parseState:()=>X,validateAuthorizationCode:()=>D,validateToken:()=>I});module.exports=N(F);var R=(e,t="ms")=>new Date(Date.now()+(t==="sec"?e*1e3:e));var b=require("@better-auth/utils/hash"),k=require("@better-auth/utils/base64");async function y(e){let t=await(0,b.createHash)("SHA-256").digest(e);return k.base64Url.encode(new Uint8Array(t),{padding:!1})}function h(e){return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?R(e.expires_in,"sec"):void 0,scopes:e?.scope?typeof e.scope=="string"?e.scope.split(" "):e.scope:[],idToken:e.id_token}}async function V({id:e,options:t,authorizationEndpoint:r,state:n,codeVerifier:s,scopes:p,claims:o,redirectURI:c,duration:d}){let i=new URL(r);if(i.searchParams.set("response_type","code"),i.searchParams.set("client_id",t.clientId),i.searchParams.set("state",n),i.searchParams.set("scope",p.join(" ")),i.searchParams.set("redirect_uri",t.redirectURI||c),s){let u=await y(s);i.searchParams.set("code_challenge_method","S256"),i.searchParams.set("code_challenge",u)}if(o){let u=o.reduce((f,E)=>(f[E]=null,f),{});i.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...u}}))}return d&&i.searchParams.set("duration",d),i}var U=require("@better-fetch/fetch");var A=require("jose");async function D({code:e,codeVerifier:t,redirectURI:r,options:n,tokenEndpoint:s,authentication:p}){let o=new URLSearchParams,c={"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth"};if(o.set("grant_type","authorization_code"),o.set("code",e),t&&o.set("code_verifier",t),o.set("redirect_uri",r),p==="basic"){let f=btoa(`${n.clientId}:${n.clientSecret}`);c.authorization=`Basic ${f}`}else o.set("client_id",n.clientId),o.set("client_secret",n.clientSecret);let{data:d,error:i}=await(0,U.betterFetch)(s,{method:"POST",body:o,headers:c});if(i)throw i;return h(d)}async function I(e,t){let{data:r,error:n}=await(0,U.betterFetch)(t,{method:"GET",headers:{accept:"application/json","user-agent":"better-auth"}});if(n)throw n;let s=r.keys,p=JSON.parse(atob(e.split(".")[0])),o=s.find(d=>d.kid===p.kid);if(!o)throw new Error("Key not found");return await(0,A.jwtVerify)(e,o)}var a=require("zod"),_=require("better-call");var m=Object.create(null),l=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?m:globalThis),L=new Proxy(m,{get(e,t){return l()[t]??m[t]},has(e,t){let r=l();return t in r||t in m},set(e,t,r){let n=l(!0);return n[t]=r,!0},deleteProperty(e,t){if(!t)return!1;let r=l(!0);return delete r[t],!0},ownKeys(){let e=l(!0);return Object.keys(e)}});function j(e){return e?e!=="false":!1}var H=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var oe=H==="test"||j(L.TEST);function T(e){try{return new URL(e).origin}catch{return null}}var G=require("@better-auth/utils/hash"),K=require("@noble/ciphers/chacha"),w=require("@noble/ciphers/utils"),J=require("@noble/ciphers/webcrypto");var $=require("@noble/hashes/scrypt"),q=require("uncrypto"),z=require("@better-auth/utils/hex");var v=require("@better-auth/utils/random"),x=(0,v.createRandomStringGenerator)("a-z","0-9","A-Z","-_");async function M(e,t){let r=e.body?.callbackURL||(e.query?.currentURL?T(e.query?.currentURL):"")||e.context.options.baseURL;if(!r)throw new _.APIError("BAD_REQUEST",{message:"callbackURL is required"});let n=x(128),s=x(32),p=JSON.stringify({callbackURL:r,codeVerifier:n,errorURL:e.body?.errorCallbackURL||e.query?.currentURL,newUserURL:e.body?.newUserCallbackURL,link:t,expiresAt:Date.now()+10*60*1e3}),o=new Date;o.setMinutes(o.getMinutes()+10);let c=await e.context.internalAdapter.createVerificationValue({value:p,identifier:s,expiresAt:o});if(!c)throw e.context.logger.error("Unable to create verification. Make sure the database adapter is properly working and there is a verification table in the database"),new _.APIError("INTERNAL_SERVER_ERROR",{message:"Unable to create verification"});return{state:c.identifier,codeVerifier:n}}async function X(e){let t=e.query.state||e.body.state,r=await e.context.internalAdapter.findVerificationValue(t);if(!r)throw e.context.logger.error("State Mismatch. Verification not found",{state:t}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);let n=a.z.object({callbackURL:a.z.string(),codeVerifier:a.z.string(),errorURL:a.z.string().optional(),newUserURL:a.z.string().optional(),expiresAt:a.z.number(),link:a.z.object({email:a.z.string(),userId:a.z.string()}).optional()}).parse(JSON.parse(r.value));if(n.errorURL||(n.errorURL=`${e.context.baseURL}/error`),n.expiresAt<Date.now())throw await e.context.internalAdapter.deleteVerificationValue(r.id),e.context.logger.error("State expired.",{state:t}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);return await e.context.internalAdapter.deleteVerificationValue(r.id),n}0&&(module.exports={createAuthorizationURL,generateCodeChallenge,generateState,getOAuth2Tokens,parseState,validateAuthorizationCode,validateToken});
