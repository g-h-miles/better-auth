"use strict";var m=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var r=(t,e)=>m(t,"name",{value:e,configurable:!0});var R=(t,e)=>{for(var o in e)m(t,o,{get:e[o],enumerable:!0})},U=(t,e,o,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of x(e))!M.call(t,s)&&s!==o&&m(t,s,{get:()=>e[s],enumerable:!(n=D(e,s))||n.enumerable});return t};var L=t=>U(m({},"__esModule",{value:!0}),t);var Y={};R(Y,{magicLink:()=>q});module.exports=L(Y);var c=require("zod");var a=require("better-call"),b=(0,a.createMiddleware)(async()=>({})),z=(0,a.createMiddlewareCreator)({use:[b,(0,a.createMiddleware)(async()=>({}))]}),h=(0,a.createEndpointCreator)({use:[b]});var C=require("better-call");var u=class extends Error{static{r(this,"BetterAuthError")}constructor(e,o){super(e),this.name="BetterAuthError",this.message=e,this.cause=o,this.stack=""}};var T=r((t,e="ms")=>new Date(Date.now()+(e==="sec"?t*1e3:t)),"getDate");var p=Object.create(null),d=r(t=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(t?p:globalThis),"_getEnv"),I=new Proxy(p,{get(t,e){return d()[e]??p[e]},has(t,e){let o=d();return e in o||e in p},set(t,e,o){let n=d(!0);return n[e]=o,!0},deleteProperty(t,e){if(!e)return!1;let o=d(!0);return delete o[e],!0},ownKeys(){let t=d(!0);return Object.keys(t)}});function N(t){return t?t!=="false":!1}r(N,"toBoolean");var v=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var te=v==="test"||N(I.TEST);var A=require("@better-auth/utils/base64");var S=require("@better-auth/utils/hmac");async function $(t,e){if(t.context.options.session?.cookieCache?.enabled){let n=A.base64Url.encode(JSON.stringify({session:e,expiresAt:T(t.context.authCookies.sessionData.options.maxAge||60,"sec").getTime(),signature:await(0,S.createHMAC)("SHA-256","base64urlnopad").sign(t.context.secret,JSON.stringify(e))}),{padding:!1});if(n.length>4093)throw new u("Session data is too large to store in the cookie. Please disable session cookie caching or reduce the size of the session data");t.setCookie(t.context.authCookies.sessionData.name,n,t.context.authCookies.sessionData.options)}}r($,"setCookieCache");async function w(t,e,o,n){let s=t.context.authCookies.sessionToken.options,i=o?void 0:t.context.sessionConfig.expiresIn;await t.setSignedCookie(t.context.authCookies.sessionToken.name,e.session.token,t.context.secret,{...s,maxAge:i,...n}),o&&await t.setSignedCookie(t.context.authCookies.dontRememberToken.name,"true",t.context.secret,t.context.authCookies.dontRememberToken.options),await $(t,e),t.context.setNewSession(e),t.context.options.secondaryStorage&&await t.context.secondaryStorage?.set(e.session.token,JSON.stringify({user:e.user,session:e.session}),Math.floor((new Date(e.session.expiresAt).getTime()-Date.now())/1e3))}r(w,"setSessionCookie");var F=require("@better-auth/utils/hash"),V=require("@noble/ciphers/chacha"),k=require("@noble/ciphers/utils"),H=require("@noble/ciphers/webcrypto");var P=require("@noble/hashes/scrypt"),j=require("uncrypto"),B=require("@better-auth/utils/hex");var E=require("@better-auth/utils/random"),O=(0,E.createRandomStringGenerator)("a-z","0-9","A-Z","-_");var _={USER_NOT_FOUND:"User not found",FAILED_TO_CREATE_USER:"Failed to create user",FAILED_TO_CREATE_SESSION:"Failed to create session",FAILED_TO_UPDATE_USER:"Failed to update user",FAILED_TO_GET_SESSION:"Failed to get session",INVALID_PASSWORD:"Invalid password",INVALID_EMAIL:"Invalid email",INVALID_EMAIL_OR_PASSWORD:"Invalid email or password",SOCIAL_ACCOUNT_ALREADY_LINKED:"Social account already linked",PROVIDER_NOT_FOUND:"Provider not found",INVALID_TOKEN:"invalid token",ID_TOKEN_NOT_SUPPORTED:"id_token not supported",FAILED_TO_GET_USER_INFO:"Failed to get user info",USER_EMAIL_NOT_FOUND:"User email not found",EMAIL_NOT_VERIFIED:"Email not verified",PASSWORD_TOO_SHORT:"Password too short",PASSWORD_TOO_LONG:"Password too long",USER_ALREADY_EXISTS:"User already exists",EMAIL_CAN_NOT_BE_UPDATED:"Email can not be updated",CREDENTIAL_ACCOUNT_NOT_FOUND:"Credential account not found",SESSION_EXPIRED:"Session expired. Re-authenticate to perform this action."};var q=r(t=>({id:"magic-link",endpoints:{signInMagicLink:h("/sign-in/magic-link",{method:"POST",requireHeaders:!0,body:c.z.object({email:c.z.string({description:"Email address to send the magic link"}).email(),callbackURL:c.z.string({description:"URL to redirect after magic link verification"}).optional()}),metadata:{openapi:{description:"Sign in with magic link",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{let{email:o}=e.body;if(t.disableSignUp&&!await e.context.internalAdapter.findUserByEmail(o))throw new C.APIError("BAD_REQUEST",{message:_.USER_NOT_FOUND});let n=O(32,"a-z","A-Z");await e.context.internalAdapter.createVerificationValue({identifier:n,value:o,expiresAt:new Date(Date.now()+(t.expiresIn||60*5)*1e3)});let s=`${e.context.baseURL}/magic-link/verify?token=${n}&callbackURL=${e.body.callbackURL||"/"}`;return await t.sendMagicLink({email:o,url:s,token:n},e.request),e.json({status:!0})}),magicLinkVerify:h("/magic-link/verify",{method:"GET",query:c.z.object({token:c.z.string({description:"Verification token"}),callbackURL:c.z.string({description:"URL to redirect after magic link verification, if not provided will return session"}).optional()}),requireHeaders:!0,metadata:{openapi:{description:"Verify magic link",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"},user:{$ref:"#/components/schemas/User"}}}}}}}}}},async e=>{let{token:o,callbackURL:n}=e.query,s=n?.startsWith("http")?n:n?`${e.context.options.baseURL}${n}`:e.context.options.baseURL,i=await e.context.internalAdapter.findVerificationValue(o);if(!i)throw e.redirect(`${s}?error=INVALID_TOKEN`);if(i.expiresAt<new Date)throw await e.context.internalAdapter.deleteVerificationValue(i.id),e.redirect(`${s}?error=EXPIRED_TOKEN`);await e.context.internalAdapter.deleteVerificationValue(i.id);let l=i.value,f=await e.context.internalAdapter.findUserByEmail(l),g=f?.user.id||"";if(!f){if(t.disableSignUp)throw e.redirect(`${s}?error=failed_to_create_user`);if(g=(await e.context.internalAdapter.createUser({email:l,emailVerified:!0,name:l})).id,!g)throw e.redirect(`${s}?error=failed_to_create_user`)}let y=await e.context.internalAdapter.createSession(g,e.headers);if(!y)throw e.redirect(`${s}?error=failed_to_create_session`);if(await w(e,{session:y,user:f?.user}),!n)return e.json({token:y.token});throw e.redirect(n)})},rateLimit:[{pathMatcher(e){return e.startsWith("/sign-in/magic-link")||e.startsWith("/magic-link/verify")},window:t.rateLimit?.window||60,max:t.rateLimit?.max||5}]}),"magicLink");0&&(module.exports={magicLink});
