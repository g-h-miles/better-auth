import{createFetch as Q}from"@better-fetch/fetch";var P=Object.create(null),m=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?P:globalThis),g=new Proxy(P,{get(e,t){return m()[t]??P[t]},has(e,t){let n=m();return t in n||t in P},set(e,t,n){let u=m(!0);return u[t]=n,!0},deleteProperty(e,t){if(!t)return!1;let n=m(!0);return delete n[t],!0},ownKeys(){let e=m(!0);return Object.keys(e)}});function N(e){return e?e!=="false":!1}var D=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var Z=D==="test"||N(g.TEST);var T=class extends Error{constructor(t,n){super(t),this.name="BetterAuthError",this.message=t,this.cause=n,this.stack=""}};function j(e){try{return new URL(e).pathname!=="/"}catch{throw new T(`Invalid base URL: ${e}. Please provide a valid base URL.`)}}function A(e,t="/api/auth"){return j(e)?e:(t=t.startsWith("/")?t:`/${t}`,`${e}${t}`)}function E(e,t){if(e)return A(e,t);let n=g.BETTER_AUTH_URL||g.NEXT_PUBLIC_BETTER_AUTH_URL||g.PUBLIC_BETTER_AUTH_URL||g.NUXT_PUBLIC_BETTER_AUTH_URL||g.NUXT_PUBLIC_AUTH_URL||(g.BASE_URL!=="/"?g.BASE_URL:void 0);if(n)return A(n,t);if(typeof window<"u"&&window.location)return A(window.location.origin,t)}import"nanostores";import"@better-fetch/fetch";var w={id:"redirect",name:"Redirect",hooks:{onSuccess(e){if(e.data?.url&&e.data?.redirect&&typeof window<"u"&&window.location&&window.location)try{window.location.href=e.data.url}catch{}}}},_={id:"add-current-url",name:"Add current URL",hooks:{onRequest(e){if(typeof window<"u"&&window.location&&window.location)try{let t=new URL(e.url);t.searchParams.set("currentURL",window.location.href),e.url=t}catch{}return e}}};import{atom as M}from"nanostores";import"@better-fetch/fetch";import{atom as q,onMount as H}from"nanostores";var U=(e,t,n,u)=>{let o=q({data:null,error:null,isPending:!0,isRefetching:!1}),p=()=>{let l=typeof u=="function"?u({data:o.get().data,error:o.get().error,isPending:o.get().isPending}):u;return n(t,{...l,async onSuccess(f){typeof window<"u"&&o.set({data:f.data,error:null,isPending:!1,isRefetching:!1}),await l?.onSuccess?.(f)},async onError(f){o.set({error:f.error,data:null,isPending:!1,isRefetching:!1}),await l?.onError?.(f)},async onRequest(f){let i=o.get();o.set({isPending:i.data===null,data:i.data,error:null,isRefetching:!0}),await l?.onRequest?.(f)}})};e=Array.isArray(e)?e:[e];let a=!1;for(let l of e)l.subscribe(()=>{a?p():H(o,()=>(p(),a=!0,()=>{o.off(),l.off()}))});return o};function I(e){let t=M(!1);return{session:U(t,"/get-session",e,{method:"GET"}),$sessionSignal:t}}var V={proto:/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,constructor:/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,protoShort:/"__proto__"\s*:/,constructorShort:/"constructor"\s*:/},W=/^\s*["[{]|^\s*-?\d{1,16}(\.\d{1,17})?([Ee][+-]?\d+)?\s*$/,x={true:!0,false:!1,null:null,undefined:void 0,nan:Number.NaN,infinity:Number.POSITIVE_INFINITY,"-infinity":Number.NEGATIVE_INFINITY},G=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d{1,7}))?(?:Z|([+-])(\d{2}):(\d{2}))$/;function J(e){return e instanceof Date&&!isNaN(e.getTime())}function z(e){let t=G.exec(e);if(!t)return null;let[,n,u,o,p,a,l,f,i,s,c]=t,d=new Date(Date.UTC(parseInt(n,10),parseInt(u,10)-1,parseInt(o,10),parseInt(p,10),parseInt(a,10),parseInt(l,10),f?parseInt(f.padEnd(3,"0"),10):0));if(i){let r=(parseInt(s,10)*60+parseInt(c,10))*(i==="+"?-1:1);d.setUTCMinutes(d.getUTCMinutes()+r)}return J(d)?d:null}function X(e,t={}){let{strict:n=!1,warnings:u=!1,reviver:o,parseDates:p=!0}=t;if(typeof e!="string")return e;let a=e.trim();if(a[0]==='"'&&a.endsWith('"')&&!a.slice(1,-1).includes('"'))return a.slice(1,-1);let l=a.toLowerCase();if(l.length<=9&&l in x)return x[l];if(!W.test(a)){if(n)throw new SyntaxError("[better-json] Invalid JSON");return e}if(Object.entries(V).some(([i,s])=>{let c=s.test(a);return c&&u&&console.warn(`[better-json] Detected potential prototype pollution attempt using ${i} pattern`),c})&&n)throw new Error("[better-json] Potential prototype pollution attempt detected");try{return JSON.parse(a,(s,c)=>{if(s==="__proto__"||s==="constructor"&&c&&typeof c=="object"&&"prototype"in c){u&&console.warn(`[better-json] Dropping "${s}" key to prevent prototype pollution`);return}if(p&&typeof c=="string"){let d=z(c);if(d)return d}return o?o(s,c):c})}catch(i){if(n)throw i;return e}}function B(e,t={strict:!0}){return X(e,t)}var L=e=>{let t="credentials"in Request.prototype,n=E(e?.baseURL),u=e?.plugins?.flatMap(r=>r.fetchPlugins).filter(r=>r!==void 0)||[],o=Q({baseURL:n,...t?{credentials:"include"}:{},method:"GET",jsonParser(r){return B(r,{strict:!1})},...e?.fetchOptions,plugins:e?.disableDefaultFetchPlugins?[...e?.fetchOptions?.plugins||[],...u]:[w,_,...e?.fetchOptions?.plugins||[],...u]}),{$sessionSignal:p,session:a}=I(o),l=e?.plugins||[],f={},i={$sessionSignal:p,session:a},s={"/sign-out":"POST","/revoke-sessions":"POST","/revoke-other-sessions":"POST","/delete-user":"POST"},c=[{signal:"$sessionSignal",matcher(r){return r==="/sign-out"||r==="/update-user"||r.startsWith("/sign-in")||r.startsWith("/sign-up")}}];for(let r of l)r.getAtoms&&Object.assign(i,r.getAtoms?.(o)),r.pathMethods&&Object.assign(s,r.pathMethods),r.atomListeners&&c.push(...r.atomListeners);let d={notify:r=>{i[r].set(!i[r].get())},listen:(r,O)=>{i[r].subscribe(O)},atoms:i};for(let r of l)r.getActions&&Object.assign(f,r.getActions?.(o,d));return{pluginsActions:f,pluginsAtoms:i,pluginPathMethods:s,atomListeners:c,$fetch:o,$store:d}};function C(e){return e.charAt(0).toUpperCase()+e.slice(1)}function Y(e,t,n){let u=t[e],{fetchOptions:o,query:p,...a}=n||{};return u||(o?.method?o.method:a&&Object.keys(a).length>0?"POST":"GET")}function v(e,t,n,u,o){function p(a=[]){return new Proxy(function(){},{get(l,f){let i=[...a,f],s=e;for(let c of i)if(s&&typeof s=="object"&&c in s)s=s[c];else{s=void 0;break}return typeof s=="function"?s:p(i)},apply:async(l,f,i)=>{let s="/"+a.map(R=>R.replace(/[A-Z]/g,y=>`-${y.toLowerCase()}`)).join("/"),c=i[0]||{},d=i[1]||{},{query:r,fetchOptions:O,...F}=c,h={...d,...O},S=Y(s,n,c);return await t(s,{...h,body:S==="GET"?void 0:{...F,...h?.body||{}},query:r||h?.query,method:S,async onSuccess(R){await h?.onSuccess?.(R);let y=o?.find(k=>k.matcher(s));if(!y)return;let b=u[y.signal];if(!b)return;let $=b.get();setTimeout(()=>{b.set(!$)},10)}})}})}return p()}function we(e){let{pluginPathMethods:t,pluginsActions:n,pluginsAtoms:u,$fetch:o,atomListeners:p,$store:a}=L(e),l={};for(let[s,c]of Object.entries(u))l[`use${C(s)}`]=()=>c;let f={...n,...l,$fetch:o,$store:a};return v(f,o,t,u,p)}export{we as createAuthClient};
