import{Kysely as I,MssqlDialect as V}from"kysely";import{MysqlDialect as N,PostgresDialect as U,SqliteDialect as S}from"kysely";function q(e){if(!e)return null;if("dialect"in e)return q(e.dialect);if("createDriver"in e){if(e instanceof S)return"sqlite";if(e instanceof N)return"mysql";if(e instanceof U)return"postgres";if(e instanceof V)return"mssql"}return"aggregate"in e?"sqlite":"getConnection"in e?"mysql":"connect"in e?"postgres":null}var L=async e=>{let n=e.database;if(!n)return{kysely:null,databaseType:null};if("db"in n)return{kysely:n.db,databaseType:n.type};if("dialect"in n)return{kysely:new I({dialect:n.dialect}),databaseType:n.type};let c,y=q(n);return"createDriver"in n&&(c=n),"aggregate"in n&&(c=new S({database:n})),"getConnection"in n&&(c=new N(n)),"connect"in n&&(c=new U({pool:n})),{kysely:c?new I({dialect:c}):null,databaseType:y}};import{z as d}from"zod";import{APIError as ne}from"better-call";var ie=d.object({id:d.string(),providerId:d.string(),accountId:d.string(),userId:d.string(),accessToken:d.string().nullish(),refreshToken:d.string().nullish(),idToken:d.string().nullish(),accessTokenExpiresAt:d.date().nullish(),refreshTokenExpiresAt:d.date().nullish(),scope:d.string().nullish(),password:d.string().nullish(),createdAt:d.date().default(()=>new Date),updatedAt:d.date().default(()=>new Date)}),se=d.object({id:d.string(),email:d.string().transform(e=>e.toLowerCase()),emailVerified:d.boolean().default(!1),name:d.string(),image:d.string().nullish(),createdAt:d.date().default(()=>new Date),updatedAt:d.date().default(()=>new Date)}),ae=d.object({id:d.string(),userId:d.string(),expiresAt:d.date(),createdAt:d.date().default(()=>new Date),updatedAt:d.date().default(()=>new Date),token:d.string(),ipAddress:d.string().nullish(),userAgent:d.string().nullish()}),oe=d.object({id:d.string(),value:d.string(),createdAt:d.date().default(()=>new Date),updatedAt:d.date().default(()=>new Date),expiresAt:d.date(),identifier:d.string()});var k=Object.create(null),v=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?k:globalThis),B=new Proxy(k,{get(e,n){return v()[n]??k[n]},has(e,n){let c=v();return n in c||n in k},set(e,n,c){let y=v(!0);return y[n]=c,!0},deleteProperty(e,n){if(!n)return!1;let c=v(!0);return delete c[n],!0},ownKeys(){let e=v(!0);return Object.keys(e)}});function P(e){return e?e!=="false":!1}var M=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var _=M==="test"||P(B.TEST);import{createRandomStringGenerator as C}from"@better-auth/utils/random";var R=e=>C("a-z","A-Z","0-9")(e||32);import{z as Ye}from"zod";import{APIError as tt}from"better-call";import{createHash as Ve}from"@better-auth/utils/hash";import{xchacha20poly1305 as Me}from"@noble/ciphers/chacha";import{bytesToHex as Ce,hexToBytes as je,utf8ToBytes as $e}from"@noble/ciphers/utils";import{managedNonce as He}from"@noble/ciphers/webcrypto";import{scryptAsync as De}from"@noble/hashes/scrypt";import{getRandomValues as Ne}from"uncrypto";import{hex as Se}from"@better-auth/utils/hex";import{createRandomStringGenerator as $}from"@better-auth/utils/random";var K=$("a-z","0-9","A-Z","-_");var O=["info","success","warn","error","debug"];function H(e,n){return O.indexOf(n)<=O.indexOf(e)}var w={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fg:{black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"},bg:{black:"\x1B[40m",red:"\x1B[41m",green:"\x1B[42m",yellow:"\x1B[43m",blue:"\x1B[44m",magenta:"\x1B[45m",cyan:"\x1B[46m",white:"\x1B[47m"}},W={info:w.fg.blue,success:w.fg.green,warn:w.fg.yellow,error:w.fg.red,debug:w.fg.magenta},J=(e,n)=>{let c=new Date().toISOString();return`${w.dim}${c}${w.reset} ${W[e]}${e.toUpperCase()}${w.reset} ${w.bright}Better Auth${w.reset} ${n}`},E=e=>{let n=e?.disabled!==!0,c=e?.level??"error",y=(g,x,A=[])=>{if(!n||!H(c,g))return;let h=J(g,x);if(!e||typeof e.log!="function"){g==="error"?console.error(h,...A):g==="warn"?console.warn(h,...A):console.log(h,...A);return}e.log(g==="success"?"info":g,h,...A)};return Object.fromEntries(O.map(g=>[g,(...[x,...A])=>y(g,x,A)]))},z=E();var T=e=>{let n=e.plugins?.reduce((b,i)=>{let t=i.schema;if(!t)return b;for(let[a,u]of Object.entries(t))b[a]={fields:{...b[a]?.fields,...u.fields},modelName:u.modelName||a};return b},{}),c=e.rateLimit?.storage==="database",y={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:g,session:x,account:A,...h}=n||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:()=>!1,required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...g?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},token:{type:"string",required:!0,fieldName:e.session?.fields?.token||"token",unique:!0},createdAt:{type:"date",required:!0,fieldName:e.session?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.session?.fields?.updatedAt||"updatedAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...x?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},accessTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"accessTokenExpiresAt"},refreshTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"refreshTokenExpiresAt"},scope:{type:"string",required:!1,fieldName:e.account?.fields?.scope||"scope"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},createdAt:{type:"date",required:!0,fieldName:e.account?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.account?.fields?.updatedAt||"updatedAt"},...A?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.updatedAt||"updatedAt"}},order:4},...h,...c?y:{}}};import{z as Nt}from"zod";function D(e,n,c){return c==="update"?e:e==null&&n.defaultValue?typeof n.defaultValue=="function"?n.defaultValue():n.defaultValue:e}var Z=(e,n,c)=>{let y=T(n);function g(i,t){if(t==="id")return t;let a=y[i].fields[t];return a||console.log("Field not found",i,t),a.fieldName||t}function x(i,t,a){let{type:u="sqlite"}=c||{},o=y[t].fields[a];return o.type==="boolean"&&u==="sqlite"&&i!==null&&i!==void 0?i?1:0:o.type==="date"&&i&&i instanceof Date&&u==="sqlite"?i.toISOString():i}function A(i,t,a){let{type:u="sqlite"}=c||{},o=y[t].fields[a];return o.type==="boolean"&&u==="sqlite"&&i!==null?i===1:o.type==="date"&&i?new Date(i):i}function h(i){return y[i].modelName}let b=n?.advanced?.generateId===!1;return{transformInput(i,t,a){let u=b||a==="update"?{}:{id:n.advanced?.generateId?n.advanced.generateId({model:t}):i.id||R()},o=y[t].fields;for(let r in o){let s=i[r];u[o[r].fieldName||r]=D(x(s,t,r),o[r],a)}return u},transformOutput(i,t,a=[]){if(!i)return null;let u=i.id?a.length===0||a.includes("id")?{id:i.id}:{}:{},o=y[t].fields;for(let r in o){if(a.length&&!a.includes(r))continue;let s=o[r];s&&(u[r]=A(i[s.fieldName||r],t,r))}return u},convertWhereClause(i,t){if(!t)return{and:null,or:null};let a={and:[],or:[]};return t.forEach(u=>{let{field:o,value:r,operator:s="=",connector:f="AND"}=u,l=g(i,o),m=p=>s.toLowerCase()==="in"?p(l,"in",Array.isArray(r)?r:[r]):s==="contains"?p(l,"like",`%${r}%`):s==="starts_with"?p(l,"like",`${r}%`):s==="ends_with"?p(l,"like",`%${r}`):s==="eq"?p(l,"=",r):s==="ne"?p(l,"<>",r):s==="gt"?p(l,">",r):s==="gte"?p(l,">=",r):s==="lt"?p(l,"<",r):s==="lte"?p(l,"<=",r):p(l,s,r);f==="OR"?a.or.push(m):a.and.push(m)}),{and:a.and.length?a.and:null,or:a.or.length?a.or:null}},async withReturning(i,t,a,u){let o;if(c?.type!=="mysql")o=await t.returningAll().executeTakeFirst();else{await t.execute();let r=i.id?"id":u[0].field?u[0].field:"id",s=i[r]||u[0].value;o=await e.selectFrom(h(a)).selectAll().where(g(a,r),"=",s).executeTakeFirst()}return o},getModelName:h,getField:g}},G=(e,n)=>c=>{let{transformInput:y,withReturning:g,transformOutput:x,convertWhereClause:A,getModelName:h,getField:b}=Z(e,c,n);return{id:"kysely",async create(i){let{model:t,data:a,select:u}=i,o=y(a,t,"create"),r=e.insertInto(h(t)).values(o);return x(await g(o,r,t,[]),t,u)},async findOne(i){let{model:t,where:a,select:u}=i,{and:o,or:r}=A(t,a),s=e.selectFrom(h(t)).selectAll();o&&(s=s.where(l=>l.and(o.map(m=>m(l))))),r&&(s=s.where(l=>l.or(r.map(m=>m(l)))));let f=await s.executeTakeFirst();return f?x(f,t,u):null},async findMany(i){let{model:t,where:a,limit:u,offset:o,sortBy:r}=i,{and:s,or:f}=A(t,a),l=e.selectFrom(h(t));s&&(l=l.where(p=>p.and(s.map(F=>F(p))))),f&&(l=l.where(p=>p.or(f.map(F=>F(p))))),l=l.limit(u||100),o&&(l=l.offset(o)),r&&(l=l.orderBy(b(t,r.field),r.direction));let m=await l.selectAll().execute();return m?m.map(p=>x(p,t)):[]},async update(i){let{model:t,where:a,update:u}=i,{and:o,or:r}=A(t,a),s=y(u,t,"update"),f=e.updateTable(h(t)).set(s);return o&&(f=f.where(m=>m.and(o.map(p=>p(m))))),r&&(f=f.where(m=>m.or(r.map(p=>p(m))))),await x(await g(s,f,t,a),t)},async updateMany(i){let{model:t,where:a,update:u}=i,{and:o,or:r}=A(t,a),s=y(u,t,"update"),f=e.updateTable(h(t)).set(s);return o&&(f=f.where(m=>m.and(o.map(p=>p(m))))),r&&(f=f.where(m=>m.or(r.map(p=>p(m))))),(await f.execute()).length},async delete(i){let{model:t,where:a}=i,{and:u,or:o}=A(t,a),r=e.deleteFrom(h(t));u&&(r=r.where(s=>s.and(u.map(f=>f(s))))),o&&(r=r.where(s=>s.or(o.map(f=>f(s))))),await r.execute()},async deleteMany(i){let{model:t,where:a}=i,{and:u,or:o}=A(t,a),r=e.deleteFrom(h(t));return u&&(r=r.where(s=>s.and(u.map(f=>f(s))))),o&&(r=r.where(s=>s.or(o.map(f=>f(s))))),(await r.execute()).length},options:n}};export{L as createKyselyAdapter,G as kyselyAdapter};
