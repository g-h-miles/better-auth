var P=Object.defineProperty;var i=(e,n)=>P(e,"name",{value:n,configurable:!0});import{Kysely as N,MssqlDialect as M}from"kysely";import{MysqlDialect as U,PostgresDialect as S,SqliteDialect as q}from"kysely";function L(e){if(!e)return null;if("dialect"in e)return L(e.dialect);if("createDriver"in e){if(e instanceof q)return"sqlite";if(e instanceof U)return"mysql";if(e instanceof S)return"postgres";if(e instanceof M)return"mssql"}return"aggregate"in e?"sqlite":"getConnection"in e?"mysql":"connect"in e?"postgres":null}i(L,"getDatabaseType");var B=i(async e=>{let n=e.database;if(!n)return{kysely:null,databaseType:null};if("db"in n)return{kysely:n.db,databaseType:n.type};if("dialect"in n)return{kysely:new N({dialect:n.dialect}),databaseType:n.type};let f,g=L(n);return"createDriver"in n&&(f=n),"aggregate"in n&&(f=new q({database:n})),"getConnection"in n&&(f=new U(n)),"connect"in n&&(f=new S({pool:n})),{kysely:f?new N({dialect:f}):null,databaseType:g}},"createKyselyAdapter");import{z as u}from"zod";import{APIError as de}from"better-call";var ue=u.object({id:u.string(),providerId:u.string(),accountId:u.string(),userId:u.string(),accessToken:u.string().nullish(),refreshToken:u.string().nullish(),idToken:u.string().nullish(),accessTokenExpiresAt:u.date().nullish(),refreshTokenExpiresAt:u.date().nullish(),scope:u.string().nullish(),password:u.string().nullish(),createdAt:u.date().default(()=>new Date),updatedAt:u.date().default(()=>new Date)}),le=u.object({id:u.string(),email:u.string().transform(e=>e.toLowerCase()),emailVerified:u.boolean().default(!1),name:u.string(),image:u.string().nullish(),createdAt:u.date().default(()=>new Date),updatedAt:u.date().default(()=>new Date)}),ce=u.object({id:u.string(),userId:u.string(),expiresAt:u.date(),createdAt:u.date().default(()=>new Date),updatedAt:u.date().default(()=>new Date),token:u.string(),ipAddress:u.string().nullish(),userAgent:u.string().nullish()}),fe=u.object({id:u.string(),value:u.string(),createdAt:u.date().default(()=>new Date),updatedAt:u.date().default(()=>new Date),expiresAt:u.date(),identifier:u.string()});var R=Object.create(null),T=i(e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?R:globalThis),"_getEnv"),E=new Proxy(R,{get(e,n){return T()[n]??R[n]},has(e,n){let f=T();return n in f||n in R},set(e,n,f){let g=T(!0);return g[n]=f,!0},deleteProperty(e,n){if(!n)return!1;let f=T(!0);return delete f[n],!0},ownKeys(){let e=T(!0);return Object.keys(e)}});function _(e){return e?e!=="false":!1}i(_,"toBoolean");var C=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var j=C==="test"||_(E.TEST);import{createRandomStringGenerator as $}from"@better-auth/utils/random";var F=i(e=>$("a-z","A-Z","0-9")(e||32),"generateId");import{z as gt}from"zod";import{APIError as ht}from"better-call";import{createHash as Ye}from"@better-auth/utils/hash";import{xchacha20poly1305 as tt}from"@noble/ciphers/chacha";import{bytesToHex as nt,hexToBytes as it,utf8ToBytes as st}from"@noble/ciphers/utils";import{managedNonce as ot}from"@noble/ciphers/webcrypto";import{scryptAsync as $e}from"@noble/hashes/scrypt";import{getRandomValues as He}from"uncrypto";import{hex as Je}from"@better-auth/utils/hex";import{createRandomStringGenerator as H}from"@better-auth/utils/random";var W=H("a-z","0-9","A-Z","-_");var D=["info","success","warn","error","debug"];function J(e,n){return D.indexOf(n)<=D.indexOf(e)}i(J,"shouldPublishLog");var b={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fg:{black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"},bg:{black:"\x1B[40m",red:"\x1B[41m",green:"\x1B[42m",yellow:"\x1B[43m",blue:"\x1B[44m",magenta:"\x1B[45m",cyan:"\x1B[46m",white:"\x1B[47m"}},z={info:b.fg.blue,success:b.fg.green,warn:b.fg.yellow,error:b.fg.red,debug:b.fg.magenta},G=i((e,n)=>{let f=new Date().toISOString();return`${b.dim}${f}${b.reset} ${z[e]}${e.toUpperCase()}${b.reset} ${b.bright}Better Auth${b.reset} ${n}`},"formatMessage"),V=i(e=>{let n=e?.disabled!==!0,f=e?.level??"error",g=i((A,w,h=[])=>{if(!n||!J(f,A))return;let x=G(A,w);if(!e||typeof e.log!="function"){A==="error"?console.error(x,...h):A==="warn"?console.warn(x,...h):console.log(x,...h);return}e.log(A==="success"?"info":A,x,...h)},"LogFunc");return Object.fromEntries(D.map(A=>[A,(...[w,...h])=>g(A,w,h)]))},"createLogger"),Z=V();var k=i(e=>{let n=e.plugins?.reduce((v,s)=>{let t=s.schema;if(!t)return v;for(let[o,l]of Object.entries(t))v[o]={fields:{...v[o]?.fields,...l.fields},modelName:l.modelName||o};return v},{}),f=e.rateLimit?.storage==="database",g={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:A,session:w,account:h,...x}=n||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:i(()=>!1,"defaultValue"),required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:i(()=>new Date,"defaultValue"),required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:i(()=>new Date,"defaultValue"),required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...A?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},token:{type:"string",required:!0,fieldName:e.session?.fields?.token||"token",unique:!0},createdAt:{type:"date",required:!0,fieldName:e.session?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.session?.fields?.updatedAt||"updatedAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...w?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},accessTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"accessTokenExpiresAt"},refreshTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"refreshTokenExpiresAt"},scope:{type:"string",required:!1,fieldName:e.account?.fields?.scope||"scope"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},createdAt:{type:"date",required:!0,fieldName:e.account?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.account?.fields?.updatedAt||"updatedAt"},...h?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:i(()=>new Date,"defaultValue"),fieldName:e.verification?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!1,defaultValue:i(()=>new Date,"defaultValue"),fieldName:e.verification?.fields?.updatedAt||"updatedAt"}},order:4},...x,...f?g:{}}},"getAuthTables");import{z as Xt}from"zod";function I(e,n,f){return f==="update"?e:e==null&&n.defaultValue?typeof n.defaultValue=="function"?n.defaultValue():n.defaultValue:e}i(I,"withApplyDefault");var X=i((e,n,f)=>{let g=k(n);function A(s,t){if(t==="id")return t;let o=g[s].fields[t];return o||console.log("Field not found",s,t),o.fieldName||t}i(A,"getField");function w(s,t,o){let{type:l="sqlite"}=f||{},d=g[t].fields[o];return d.type==="boolean"&&l==="sqlite"&&s!==null&&s!==void 0?s?1:0:d.type==="date"&&s&&s instanceof Date&&l==="sqlite"?s.toISOString():s}i(w,"transformValueToDB");function h(s,t,o){let{type:l="sqlite"}=f||{},d=g[t].fields[o];return d.type==="boolean"&&l==="sqlite"&&s!==null?s===1:d.type==="date"&&s?new Date(s):s}i(h,"transformValueFromDB");function x(s){return g[s].modelName}i(x,"getModelName");let v=n?.advanced?.generateId===!1;return{transformInput(s,t,o){let l=v||o==="update"?{}:{id:n.advanced?.generateId?n.advanced.generateId({model:t}):s.id||F()},d=g[t].fields;for(let r in d){let a=s[r];l[d[r].fieldName||r]=I(w(a,t,r),d[r],o)}return l},transformOutput(s,t,o=[]){if(!s)return null;let l=s.id?o.length===0||o.includes("id")?{id:s.id}:{}:{},d=g[t].fields;for(let r in d){if(o.length&&!o.includes(r))continue;let a=d[r];a&&(l[r]=h(s[a.fieldName||r],t,r))}return l},convertWhereClause(s,t){if(!t)return{and:null,or:null};let o={and:[],or:[]};return t.forEach(l=>{let{field:d,value:r,operator:a="=",connector:p="AND"}=l,c=A(s,d),y=i(m=>a.toLowerCase()==="in"?m(c,"in",Array.isArray(r)?r:[r]):a==="contains"?m(c,"like",`%${r}%`):a==="starts_with"?m(c,"like",`${r}%`):a==="ends_with"?m(c,"like",`%${r}`):a==="eq"?m(c,"=",r):a==="ne"?m(c,"<>",r):a==="gt"?m(c,">",r):a==="gte"?m(c,">=",r):a==="lt"?m(c,"<",r):a==="lte"?m(c,"<=",r):m(c,a,r),"expr");p==="OR"?o.or.push(y):o.and.push(y)}),{and:o.and.length?o.and:null,or:o.or.length?o.or:null}},async withReturning(s,t,o,l){let d;if(f?.type!=="mysql")d=await t.returningAll().executeTakeFirst();else{await t.execute();let r=s.id?"id":l[0].field?l[0].field:"id",a=s[r]||l[0].value;d=await e.selectFrom(x(o)).selectAll().where(A(o,r),"=",a).executeTakeFirst()}return d},getModelName:x,getField:A}},"createTransform"),Q=i((e,n)=>f=>{let{transformInput:g,withReturning:A,transformOutput:w,convertWhereClause:h,getModelName:x,getField:v}=X(e,f,n);return{id:"kysely",async create(s){let{model:t,data:o,select:l}=s,d=g(o,t,"create"),r=e.insertInto(x(t)).values(d);return w(await A(d,r,t,[]),t,l)},async findOne(s){let{model:t,where:o,select:l}=s,{and:d,or:r}=h(t,o),a=e.selectFrom(x(t)).selectAll();d&&(a=a.where(c=>c.and(d.map(y=>y(c))))),r&&(a=a.where(c=>c.or(r.map(y=>y(c)))));let p=await a.executeTakeFirst();return p?w(p,t,l):null},async findMany(s){let{model:t,where:o,limit:l,offset:d,sortBy:r}=s,{and:a,or:p}=h(t,o),c=e.selectFrom(x(t));a&&(c=c.where(m=>m.and(a.map(O=>O(m))))),p&&(c=c.where(m=>m.or(p.map(O=>O(m))))),c=c.limit(l||100),d&&(c=c.offset(d)),r&&(c=c.orderBy(v(t,r.field),r.direction));let y=await c.selectAll().execute();return y?y.map(m=>w(m,t)):[]},async update(s){let{model:t,where:o,update:l}=s,{and:d,or:r}=h(t,o),a=g(l,t,"update"),p=e.updateTable(x(t)).set(a);return d&&(p=p.where(y=>y.and(d.map(m=>m(y))))),r&&(p=p.where(y=>y.or(r.map(m=>m(y))))),await w(await A(a,p,t,o),t)},async updateMany(s){let{model:t,where:o,update:l}=s,{and:d,or:r}=h(t,o),a=g(l,t,"update"),p=e.updateTable(x(t)).set(a);return d&&(p=p.where(y=>y.and(d.map(m=>m(y))))),r&&(p=p.where(y=>y.or(r.map(m=>m(y))))),(await p.execute()).length},async delete(s){let{model:t,where:o}=s,{and:l,or:d}=h(t,o),r=e.deleteFrom(x(t));l&&(r=r.where(a=>a.and(l.map(p=>p(a))))),d&&(r=r.where(a=>a.or(d.map(p=>p(a))))),await r.execute()},async deleteMany(s){let{model:t,where:o}=s,{and:l,or:d}=h(t,o),r=e.deleteFrom(x(t));return l&&(r=r.where(a=>a.and(l.map(p=>p(a))))),d&&(r=r.where(a=>a.or(d.map(p=>p(a))))),(await r.execute()).length},options:n}},"kyselyAdapter");export{B as createKyselyAdapter,Q as kyselyAdapter};
