"use strict";var T=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var M=(e,a)=>{for(var n in a)T(e,n,{get:a[n],enumerable:!0})},V=(e,a,n,c)=>{if(a&&typeof a=="object"||typeof a=="function")for(let r of L(a))!E.call(e,r)&&r!==n&&T(e,r,{get:()=>a[r],enumerable:!(c=B(a,r))||c.enumerable});return e};var P=e=>V(T({},"__esModule",{value:!0}),e);var ue={};M(ue,{mongodbAdapter:()=>de});module.exports=P(ue);var h=require("mongodb");var o=require("zod"),_=require("better-call"),fe=o.z.object({id:o.z.string(),providerId:o.z.string(),accountId:o.z.string(),userId:o.z.string(),accessToken:o.z.string().nullish(),refreshToken:o.z.string().nullish(),idToken:o.z.string().nullish(),accessTokenExpiresAt:o.z.date().nullish(),refreshTokenExpiresAt:o.z.date().nullish(),scope:o.z.string().nullish(),password:o.z.string().nullish(),createdAt:o.z.date().default(()=>new Date),updatedAt:o.z.date().default(()=>new Date)}),pe=o.z.object({id:o.z.string(),email:o.z.string().transform(e=>e.toLowerCase()),emailVerified:o.z.boolean().default(!1),name:o.z.string(),image:o.z.string().nullish(),createdAt:o.z.date().default(()=>new Date),updatedAt:o.z.date().default(()=>new Date)}),me=o.z.object({id:o.z.string(),userId:o.z.string(),expiresAt:o.z.date(),createdAt:o.z.date().default(()=>new Date),updatedAt:o.z.date().default(()=>new Date),token:o.z.string(),ipAddress:o.z.string().nullish(),userAgent:o.z.string().nullish()}),ye=o.z.object({id:o.z.string(),value:o.z.string(),createdAt:o.z.date().default(()=>new Date),updatedAt:o.z.date().default(()=>new Date),expiresAt:o.z.date(),identifier:o.z.string()});var b=Object.create(null),w=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?b:globalThis),F=new Proxy(b,{get(e,a){return w()[a]??b[a]},has(e,a){let n=w();return a in n||a in b},set(e,a,n){let c=w(!0);return c[a]=n,!0},deleteProperty(e,a){if(!a)return!1;let n=w(!0);return delete n[a],!0},ownKeys(){let e=w(!0);return Object.keys(e)}});function C(e){return e?e!=="false":!1}var $=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var j=$==="test"||C(F.TEST);var K=require("@better-auth/utils/random");var Y=require("zod"),ee=require("better-call");var Z=require("@better-auth/utils/hash"),Q=require("@noble/ciphers/chacha"),k=require("@noble/ciphers/utils"),X=require("@noble/ciphers/webcrypto");var H=require("@noble/hashes/scrypt"),J=require("uncrypto"),z=require("@better-auth/utils/hex");var I=require("@better-auth/utils/random"),G=(0,I.createRandomStringGenerator)("a-z","0-9","A-Z","-_");var O=["info","success","warn","error","debug"];function te(e,a){return O.indexOf(a)<=O.indexOf(e)}var g={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fg:{black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"},bg:{black:"\x1B[40m",red:"\x1B[41m",green:"\x1B[42m",yellow:"\x1B[43m",blue:"\x1B[44m",magenta:"\x1B[45m",cyan:"\x1B[46m",white:"\x1B[47m"}},re={info:g.fg.blue,success:g.fg.green,warn:g.fg.yellow,error:g.fg.red,debug:g.fg.magenta},ne=(e,a)=>{let n=new Date().toISOString();return`${g.dim}${n}${g.reset} ${re[e]}${e.toUpperCase()}${g.reset} ${g.bright}Better Auth${g.reset} ${a}`},N=e=>{let a=e?.disabled!==!0,n=e?.level??"error",c=(r,s,t=[])=>{if(!a||!te(n,r))return;let i=ne(r,s);if(!e||typeof e.log!="function"){r==="error"?console.error(i,...t):r==="warn"?console.warn(i,...t):console.log(i,...t);return}e.log(r==="success"?"info":r,i,...t)};return Object.fromEntries(O.map(r=>[r,(...[s,...t])=>c(r,s,t)]))},se=N();var x=e=>{let a=e.plugins?.reduce((d,l)=>{let u=l.schema;if(!u)return d;for(let[f,A]of Object.entries(u))d[f]={fields:{...d[f]?.fields,...A.fields},modelName:A.modelName||f};return d},{}),n=e.rateLimit?.storage==="database",c={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:r,session:s,account:t,...i}=a||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:()=>!1,required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...r?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},token:{type:"string",required:!0,fieldName:e.session?.fields?.token||"token",unique:!0},createdAt:{type:"date",required:!0,fieldName:e.session?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.session?.fields?.updatedAt||"updatedAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...s?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},accessTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"accessTokenExpiresAt"},refreshTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"refreshTokenExpiresAt"},scope:{type:"string",required:!1,fieldName:e.account?.fields?.scope||"scope"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},createdAt:{type:"date",required:!0,fieldName:e.account?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.account?.fields?.updatedAt||"updatedAt"},...t?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.updatedAt||"updatedAt"}},order:4},...i,...n?c:{}}};var ie=require("zod");var S=require("kysely"),D=require("kysely");function v(e,a,n){return n==="update"?e:e==null&&a.defaultValue?typeof a.defaultValue=="function"?a.defaultValue():a.defaultValue:e}var oe=e=>{let a=x(e);function n(s,t,i){if(s==="id"||s==="_id"||a[i].fields[s].references?.field==="id"){if(typeof t!="string"){if(t instanceof h.ObjectId)return t;if(Array.isArray(t))return t.map(d=>{if(typeof d=="string")try{return new h.ObjectId(d)}catch{return d}if(d instanceof h.ObjectId)return d;throw new Error("Invalid id value")});throw new Error("Invalid id value")}try{return new h.ObjectId(t)}catch{return t}}return t}function c(s,t,i){return s==="id"||a[i].fields[s].references?.field==="id"?t instanceof h.ObjectId?t.toHexString():Array.isArray(t)?t.map(d=>d instanceof h.ObjectId?d.toHexString():d):t:t}function r(s,t){return s==="id"?"_id":a[t].fields[s].fieldName||s}return{transformInput(s,t,i){let d=i==="update"?{}:{_id:new h.ObjectId},l=a[t].fields;for(let u in l){let f=s[u];f===void 0&&(!l[u].defaultValue||i==="update")||(d[l[u].fieldName||u]=v(n(u,f,t),l[u],i))}return d},transformOutput(s,t,i=[]){let d=s.id||s._id?i.length===0||i.includes("id")?{id:s.id?s.id.toString():s._id.toString()}:{}:{},l=a[t].fields;for(let u in l){if(i.length&&!i.includes(u))continue;let f=l[u];f&&(d[u]=c(u,s[f.fieldName||u],t))}return d},convertWhereClause(s,t){if(!s.length)return{};let i=s.map(f=>{let{field:A,value:p,operator:R="eq",connector:q="AND"}=f,m,y=r(A,t);switch(R.toLowerCase()){case"eq":m={[y]:n(A,p,t)};break;case"in":m={[y]:{$in:Array.isArray(p)?n(A,p,t):[n(A,p,t)]}};break;case"gt":m={[y]:{$gt:p}};break;case"gte":m={[y]:{$gte:p}};break;case"lt":m={[y]:{$lt:p}};break;case"lte":m={[y]:{$lte:p}};break;case"ne":m={[y]:{$ne:p}};break;case"contains":m={[y]:{$regex:`.*${p}.*`}};break;case"starts_with":m={[y]:{$regex:`${p}.*`}};break;case"ends_with":m={[y]:{$regex:`.*${p}`}};break;default:throw new Error(`Unsupported operator: ${R}`)}return{condition:m,connector:q}});if(i.length===1)return i[0].condition;let d=i.filter(f=>f.connector==="AND").map(f=>f.condition),l=i.filter(f=>f.connector==="OR").map(f=>f.condition),u={};return d.length&&(u={...u,$and:d}),l.length&&(u={...u,$or:l}),u},getModelName:s=>a[s].modelName,getField:r}},de=e=>a=>{let n=oe(a);return{id:"mongodb-adapter",async create(c){let{model:r,data:s,select:t}=c,i=n.transformInput(s,r,"create");i.id&&delete i.id;let l=(await e.collection(n.getModelName(r)).insertOne(i)).insertedId,u={...i,id:l.toString()};return n.transformOutput(u,r,t)},async findOne(c){let{model:r,where:s,select:t}=c,i=n.convertWhereClause(s,r),d=await e.collection(n.getModelName(r)).findOne(i);return d?n.transformOutput(d,r,t):null},async findMany(c){let{model:r,where:s,limit:t,offset:i,sortBy:d}=c,l=s?n.convertWhereClause(s,r):{},u=e.collection(n.getModelName(r)).find(l);return t&&u.limit(t),i&&u.skip(i),d&&u.sort(n.getField(d.field,r),d.direction==="desc"?-1:1),(await u.toArray()).map(A=>n.transformOutput(A,r))},async update(c){let{model:r,where:s,update:t}=c,i=n.convertWhereClause(s,r),d=n.transformInput(t,r,"update"),l=await e.collection(n.getModelName(r)).findOneAndUpdate(i,{$set:d},{returnDocument:"after"});return l?n.transformOutput(l,r):null},async updateMany(c){let{model:r,where:s,update:t}=c,i=n.convertWhereClause(s,r),d=n.transformInput(t,r,"update");return(await e.collection(n.getModelName(r)).updateMany(i,{$set:d})).modifiedCount},async delete(c){let{model:r,where:s}=c,t=n.convertWhereClause(s,r),i=await e.collection(n.getModelName(r)).findOneAndDelete(t);return i?n.transformOutput(i,r):null},async deleteMany(c){let{model:r,where:s}=c,t=n.convertWhereClause(s,r);return(await e.collection(n.getModelName(r)).deleteMany(t)).deletedCount}}};0&&(module.exports={mongodbAdapter});
