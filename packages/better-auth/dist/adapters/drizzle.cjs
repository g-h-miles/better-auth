"use strict";var O=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var $=Object.prototype.hasOwnProperty;var r=(e,n)=>O(e,"name",{value:n,configurable:!0});var j=(e,n)=>{for(var u in n)O(e,u,{get:n[u],enumerable:!0})},K=(e,n,u,m)=>{if(n&&typeof n=="object"||typeof n=="function")for(let l of C(n))!$.call(e,l)&&l!==u&&O(e,l,{get:()=>n[l],enumerable:!(m=_(n,l))||m.enumerable});return e};var H=e=>K(O({},"__esModule",{value:!0}),e);var me={};j(me,{drizzleAdapter:()=>pe});module.exports=H(me);var g=require("drizzle-orm");var a=require("zod"),z=require("better-call");var we=a.z.object({id:a.z.string(),providerId:a.z.string(),accountId:a.z.string(),userId:a.z.string(),accessToken:a.z.string().nullish(),refreshToken:a.z.string().nullish(),idToken:a.z.string().nullish(),accessTokenExpiresAt:a.z.date().nullish(),refreshTokenExpiresAt:a.z.date().nullish(),scope:a.z.string().nullish(),password:a.z.string().nullish(),createdAt:a.z.date().default(()=>new Date),updatedAt:a.z.date().default(()=>new Date)}),xe=a.z.object({id:a.z.string(),email:a.z.string().transform(e=>e.toLowerCase()),emailVerified:a.z.boolean().default(!1),name:a.z.string(),image:a.z.string().nullish(),createdAt:a.z.date().default(()=>new Date),updatedAt:a.z.date().default(()=>new Date)}),be=a.z.object({id:a.z.string(),userId:a.z.string(),expiresAt:a.z.date(),createdAt:a.z.date().default(()=>new Date),updatedAt:a.z.date().default(()=>new Date),token:a.z.string(),ipAddress:a.z.string().nullish(),userAgent:a.z.string().nullish()}),ve=a.z.object({id:a.z.string(),value:a.z.string(),createdAt:a.z.date().default(()=>new Date),updatedAt:a.z.date().default(()=>new Date),expiresAt:a.z.date(),identifier:a.z.string()});var F=Object.create(null),R=r(e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?F:globalThis),"_getEnv"),B=new Proxy(F,{get(e,n){return R()[n]??F[n]},has(e,n){let u=R();return n in u||n in F},set(e,n,u){let m=R(!0);return m[n]=u,!0},deleteProperty(e,n){if(!n)return!1;let u=R(!0);return delete u[n],!0},ownKeys(){let e=R(!0);return Object.keys(e)}});function W(e){return e?e!=="false":!1}r(W,"toBoolean");var G=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var J=G==="test"||W(B.TEST);var L=require("@better-auth/utils/random");var D=r(e=>(0,L.createRandomStringGenerator)("a-z","A-Z","0-9")(e||32),"generateId");var ne=require("zod"),se=require("better-call");var x=class extends Error{static{r(this,"BetterAuthError")}constructor(n,u){super(n),this.name="BetterAuthError",this.message=n,this.cause=u,this.stack=""}};var ee=require("@better-auth/utils/hash"),te=require("@noble/ciphers/chacha"),N=require("@noble/ciphers/utils"),re=require("@noble/ciphers/webcrypto");var Q=require("@noble/hashes/scrypt"),Z=require("uncrypto"),X=require("@better-auth/utils/hex");var M=require("@better-auth/utils/random"),Y=(0,M.createRandomStringGenerator)("a-z","0-9","A-Z","-_");var S=["info","success","warn","error","debug"];function ie(e,n){return S.indexOf(n)<=S.indexOf(e)}r(ie,"shouldPublishLog");var v={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fg:{black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"},bg:{black:"\x1B[40m",red:"\x1B[41m",green:"\x1B[42m",yellow:"\x1B[43m",blue:"\x1B[44m",magenta:"\x1B[45m",cyan:"\x1B[46m",white:"\x1B[47m"}},ae={info:v.fg.blue,success:v.fg.green,warn:v.fg.yellow,error:v.fg.red,debug:v.fg.magenta},oe=r((e,n)=>{let u=new Date().toISOString();return`${v.dim}${u}${v.reset} ${ae[e]}${e.toUpperCase()}${v.reset} ${v.bright}Better Auth${v.reset} ${n}`},"formatMessage"),E=r(e=>{let n=e?.disabled!==!0,u=e?.level??"error",m=r((l,h,y=[])=>{if(!n||!ie(u,l))return;let b=oe(l,h);if(!e||typeof e.log!="function"){l==="error"?console.error(b,...y):l==="warn"?console.warn(b,...y):console.log(b,...y);return}e.log(l==="success"?"info":l,b,...y)},"LogFunc");return Object.fromEntries(S.map(l=>[l,(...[h,...y])=>m(l,h,y)]))},"createLogger"),de=E();var k=r(e=>{let n=e.plugins?.reduce((o,f)=>{let i=f.schema;if(!i)return o;for(let[t,c]of Object.entries(i))o[t]={fields:{...o[t]?.fields,...c.fields},modelName:c.modelName||t};return o},{}),u=e.rateLimit?.storage==="database",m={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:l,session:h,account:y,...b}=n||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:r(()=>!1,"defaultValue"),required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:r(()=>new Date,"defaultValue"),required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:r(()=>new Date,"defaultValue"),required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...l?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},token:{type:"string",required:!0,fieldName:e.session?.fields?.token||"token",unique:!0},createdAt:{type:"date",required:!0,fieldName:e.session?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.session?.fields?.updatedAt||"updatedAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...h?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},accessTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"accessTokenExpiresAt"},refreshTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"refreshTokenExpiresAt"},scope:{type:"string",required:!1,fieldName:e.account?.fields?.scope||"scope"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},createdAt:{type:"date",required:!0,fieldName:e.account?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.account?.fields?.updatedAt||"updatedAt"},...y?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:r(()=>new Date,"defaultValue"),fieldName:e.verification?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!1,defaultValue:r(()=>new Date,"defaultValue"),fieldName:e.verification?.fields?.updatedAt||"updatedAt"}},order:4},...b,...u?m:{}}},"getAuthTables");var ue=require("zod");var P=require("kysely"),U=require("kysely");function I(e,n,u){return u==="update"?e:e==null&&n.defaultValue?typeof n.defaultValue=="function"?n.defaultValue():n.defaultValue:e}r(I,"withApplyDefault");var le=r((e,n,u)=>{let m=k(u);function l(o,f){return f==="id"?f:m[o].fields[f].fieldName||f}r(l,"getField");function h(o){let f=n.schema||e._.fullSchema;if(!f)throw new x("Drizzle adapter failed to initialize. Schema not found. Please provide a schema object in the adapter options object.");let i=y(o),t=f[i];if(!t)throw new x(`[# Drizzle Adapter]: The model "${i}" was not found in the schema object. Please pass the schema directly to the adapter options.`);return t}r(h,"getSchema");let y=r(o=>m[o].modelName!==o?m[o].modelName:n.usePlural?`${o}s`:o,"getModelName"),b=u?.advanced?.generateId===!1;return{getSchema:h,transformInput(o,f,i){let t=b||i==="update"?{}:{id:u.advanced?.generateId?u.advanced.generateId({model:f}):o.id||D()},c=m[f].fields;for(let d in c){let p=o[d];p===void 0&&!c[d].defaultValue||(t[c[d].fieldName||d]=I(p,c[d],i))}return t},transformOutput(o,f,i=[]){if(!o)return null;let t=o.id||o._id?i.length===0||i.includes("id")?{id:o.id}:{}:{},c=m[f].fields;for(let d in c){if(i.length&&!i.includes(d))continue;let p=c[d];p&&(t[d]=o[p.fieldName||d])}return t},convertWhereClause(o,f){let i=h(f);if(!o)return[];if(o.length===1){let s=o[0];if(!s)return[];let A=l(f,s.field);if(!i[A])throw new x(`The field "${s.field}" does not exist in the schema for the model "${f}". Please update your schema.`);if(s.operator==="in"){if(!Array.isArray(s.value))throw new x(`The value for the field "${s.field}" must be an array when using the "in" operator.`);return[(0,g.inArray)(i[A],s.value)]}return s.operator==="contains"?[(0,g.like)(i[A],`%${s.value}%`)]:s.operator==="starts_with"?[(0,g.like)(i[A],`${s.value}%`)]:s.operator==="ends_with"?[(0,g.like)(i[A],`%${s.value}`)]:[(0,g.eq)(i[A],s.value)]}let t=o.filter(s=>s.connector==="AND"||!s.connector),c=o.filter(s=>s.connector==="OR"),d=(0,g.and)(...t.map(s=>{let A=l(f,s.field);if(s.operator==="in"){if(!Array.isArray(s.value))throw new x(`The value for the field "${s.field}" must be an array when using the "in" operator.`);return(0,g.inArray)(i[A],s.value)}return(0,g.eq)(i[A],s.value)})),p=(0,g.or)(...c.map(s=>{let A=l(f,s.field);return(0,g.eq)(i[A],s.value)})),w=[];return t.length&&w.push(d),c.length&&w.push(p),w},withReturning:r(async(o,f,i)=>{if(n.provider!=="mysql")return(await f.returning())[0];await f;let t=h(y(o));return(await e.select().from(t).where((0,g.eq)(t.id,i.id)))[0]},"withReturning"),getField:l,getModelName:y}},"createTransform");function fe(e,n,u){if(!e)throw new x("Drizzle adapter failed to initialize. Schema not found. Please provide a schema object in the adapter options object.");for(let m in u)if(!e[m])throw new x(`The field "${m}" does not exist in the "${n}" schema. Please update your drizzle schema or re-generate using "npx @better-auth/cli generate".`)}r(fe,"checkMissingFields");var pe=r((e,n)=>u=>{let{transformInput:m,transformOutput:l,convertWhereClause:h,getSchema:y,withReturning:b,getField:o,getModelName:f}=le(e,n,u);return{id:"drizzle",async create(i){let{model:t,data:c}=i,d=m(c,t,"create"),p=y(t);fe(p,f(t),d);let w=e.insert(p).values(d),s=await b(t,w,d);return l(s,t)},async findOne(i){let{model:t,where:c,select:d}=i,p=y(t),w=h(c,t),s=await e.select().from(p).where(...w);return s.length?l(s[0],t,d):null},async findMany(i){let{model:t,where:c,sortBy:d,limit:p,offset:w}=i,s=y(t),A=c?h(c,t):[],T=d?.direction==="desc"?g.desc:g.asc,q=e.select().from(s).limit(p||100).offset(w||0);return d?.field&&q.orderBy(T(s[o(t,d?.field)])),(await q.where(...A)).map(V=>l(V,t))},async update(i){let{model:t,where:c,update:d}=i,p=y(t),w=h(c,t),s=m(d,t,"update"),A=e.update(p).set(s).where(...w),T=await b(t,A,s);return l(T,t)},async updateMany(i){let{model:t,where:c,update:d}=i,p=y(t),w=h(c,t),s=m(d,t,"update"),T=await e.update(p).set(s).where(...w);return T?T.changes:0},async delete(i){let{model:t,where:c}=i,d=y(t),p=h(c,t);await e.delete(d).where(...p)},async deleteMany(i){let{model:t,where:c}=i,d=y(t),p=h(c,t),s=await e.delete(d).where(...p);return s?s.length:0},options:n}},"drizzleAdapter");0&&(module.exports={drizzleAdapter});
