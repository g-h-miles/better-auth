var kt=Object.defineProperty;var a=(e,i)=>kt(e,"name",{value:i,configurable:!0});import{APIError as tt}from"better-call";import{z as Se}from"zod";import{createEndpointCreator as Dt,createMiddleware as xo,createMiddlewareCreator as Pt}from"better-call";var Bo=xo(async()=>({})),P=Pt({use:[Bo,xo(async()=>({}))]}),p=Dt({use:[Bo]});import{APIError as Q}from"better-call";import{z as V}from"zod";var re=class extends Error{static{a(this,"BetterAuthError")}constructor(i,r){super(i),this.name="BetterAuthError",this.message=i,this.cause=r,this.stack=""}};var N=a((e,i="ms")=>new Date(Date.now()+(i==="sec"?e*1e3:e)),"getDate");var We=Object.create(null),Le=a(e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?We:globalThis),"_getEnv"),le=new Proxy(We,{get(e,i){return Le()[i]??We[i]},has(e,i){let r=Le();return i in r||i in We},set(e,i,r){let o=Le(!0);return o[i]=r,!0},deleteProperty(e,i){if(!i)return!1;let r=Le(!0);return delete r[i],!0},ownKeys(){let e=Le(!0);return Object.keys(e)}});function Nt(e){return e?e!=="false":!1}a(Nt,"toBoolean");var lo=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var Je=lo==="dev"||lo==="development",Lt=lo==="test"||Nt(le.TEST);import{base64Url as jt}from"@better-auth/utils/base64";import{createHMAC as zt}from"@better-auth/utils/hmac";function ye(e){let i=new Map;return e.split(", ").forEach(o=>{let t=o.split(";").map(m=>m.trim()),[n,...s]=t,[d,...A]=n.split("="),c=A.join("=");if(!d||c===void 0)return;let K={value:c};s.forEach(m=>{let[u,...l]=m.split("="),w=l.join("="),y=u.trim().toLowerCase();switch(y){case"max-age":K["max-age"]=w?parseInt(w.trim(),10):void 0;break;case"expires":K.expires=w?new Date(w.trim()):void 0;break;case"domain":K.domain=w?w.trim():void 0;break;case"path":K.path=w?w.trim():void 0;break;case"secure":K.secure=!0;break;case"httponly":K.httponly=!0;break;case"samesite":K.samesite=w?w.trim().toLowerCase():void 0;break;default:K[y]=w?w.trim():!0;break}}),i.set(d,K)}),i}a(ye,"parseSetCookieHeader");async function mo(e,i){if(e.context.options.session?.cookieCache?.enabled){let o=jt.encode(JSON.stringify({session:i,expiresAt:N(e.context.authCookies.sessionData.options.maxAge||60,"sec").getTime(),signature:await zt("SHA-256","base64urlnopad").sign(e.context.secret,JSON.stringify(i))}),{padding:!1});if(o.length>4093)throw new re("Session data is too large to store in the cookie. Please disable session cookie caching or reduce the size of the session data");e.setCookie(e.context.authCookies.sessionData.name,o,e.context.authCookies.sessionData.options)}}a(mo,"setCookieCache");async function C(e,i,r,o){let t=e.context.authCookies.sessionToken.options,n=r?void 0:e.context.sessionConfig.expiresIn;await e.setSignedCookie(e.context.authCookies.sessionToken.name,i.session.token,e.context.secret,{...t,maxAge:n,...o}),r&&await e.setSignedCookie(e.context.authCookies.dontRememberToken.name,"true",e.context.secret,e.context.authCookies.dontRememberToken.options),await mo(e,i),e.context.setNewSession(i),e.context.options.secondaryStorage&&await e.context.secondaryStorage?.set(i.session.token,JSON.stringify({user:i.user,session:i.session}),Math.floor((new Date(i.session.expiresAt).getTime()-Date.now())/1e3))}a(C,"setSessionCookie");function $(e){e.setCookie(e.context.authCookies.sessionToken.name,"",{...e.context.authCookies.sessionToken.options,maxAge:0}),e.setCookie(e.context.authCookies.sessionData.name,"",{...e.context.authCookies.sessionData.options,maxAge:0}),e.setCookie(e.context.authCookies.dontRememberToken.name,"",{...e.context.authCookies.dontRememberToken.options,maxAge:0})}a($,"deleteSessionCookie");function je(e){let i=e.split("; "),r=new Map;return i.forEach(o=>{let[t,n]=o.split("=");r.set(t,n)}),r}a(je,"parseCookies");import{betterFetch as $t}from"@better-fetch/fetch";import{APIError as Zt}from"better-call";import{decodeJwt as Qt,decodeProtectedHeader as Gt,importJWK as Wt,jwtVerify as Jt}from"jose";import{createHash as xt}from"@better-auth/utils/hash";import{base64Url as Bt}from"@better-auth/utils/base64";async function Fo(e){let i=await xt("SHA-256").digest(e);return Bt.encode(new Uint8Array(i),{padding:!1})}a(Fo,"generateCodeChallenge");function Xe(e){return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?N(e.expires_in,"sec"):void 0,scopes:e?.scope?typeof e.scope=="string"?e.scope.split(" "):e.scope:[],idToken:e.id_token}}a(Xe,"getOAuth2Tokens");async function D({id:e,options:i,authorizationEndpoint:r,state:o,codeVerifier:t,scopes:n,claims:s,redirectURI:d,duration:A}){let c=new URL(r);if(c.searchParams.set("response_type","code"),c.searchParams.set("client_id",i.clientId),c.searchParams.set("state",o),c.searchParams.set("scope",n.join(" ")),c.searchParams.set("redirect_uri",i.redirectURI||d),t){let K=await Fo(t);c.searchParams.set("code_challenge_method","S256"),c.searchParams.set("code_challenge",K)}if(s){let K=s.reduce((m,u)=>(m[u]=null,m),{});c.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...K}}))}return A&&c.searchParams.set("duration",A),c}a(D,"createAuthorizationURL");import{betterFetch as Ft}from"@better-fetch/fetch";import{jwtVerify as ns}from"jose";async function S({code:e,codeVerifier:i,redirectURI:r,options:o,tokenEndpoint:t,authentication:n}){let s=new URLSearchParams,d={"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth"};if(s.set("grant_type","authorization_code"),s.set("code",e),i&&s.set("code_verifier",i),s.set("redirect_uri",r),n==="basic"){let m=btoa(`${o.clientId}:${o.clientSecret}`);d.authorization=`Basic ${m}`}else s.set("client_id",o.clientId),s.set("client_secret",o.clientSecret);let{data:A,error:c}=await Ft(t,{method:"POST",body:s,headers:d});if(c)throw c;return Xe(A)}a(S,"validateAuthorizationCode");import{z as me}from"zod";import{APIError as $o}from"better-call";function Te(e){try{return new URL(e).origin}catch{return null}}a(Te,"getOrigin");function Mo(e){return e.includes("://")?new URL(e).host:e}a(Mo,"getHost");import{createHash as Vo}from"@better-auth/utils/hash";import{xchacha20poly1305 as qo}from"@noble/ciphers/chacha";import{bytesToHex as Vt,hexToBytes as qt,utf8ToBytes as Ht}from"@noble/ciphers/utils";import{managedNonce as Ho}from"@noble/ciphers/webcrypto";import{scryptAsync as fs}from"@noble/hashes/scrypt";import{getRandomValues as ys}from"uncrypto";import{hex as Cs}from"@better-auth/utils/hex";import{createRandomStringGenerator as Mt}from"@better-auth/utils/random";var R=Mt("a-z","0-9","A-Z","-_");var Ae=a(async({key:e,data:i})=>{let r=await Vo("SHA-256").digest(e),o=Ht(i),t=Ho(qo)(new Uint8Array(r));return Vt(t.encrypt(o))},"symmetricEncrypt"),we=a(async({key:e,data:i})=>{let r=await Vo("SHA-256").digest(e),o=qt(i),t=Ho(qo)(new Uint8Array(r));return new TextDecoder().decode(t.decrypt(o))},"symmetricDecrypt");async function Ee(e,i){let r=e.body?.callbackURL||(e.query?.currentURL?Te(e.query?.currentURL):"")||e.context.options.baseURL;if(!r)throw new $o("BAD_REQUEST",{message:"callbackURL is required"});let o=R(128),t=R(32),n=JSON.stringify({callbackURL:r,codeVerifier:o,errorURL:e.body?.errorCallbackURL||e.query?.currentURL,newUserURL:e.body?.newUserCallbackURL,link:i,expiresAt:Date.now()+10*60*1e3}),s=new Date;s.setMinutes(s.getMinutes()+10);let d=await e.context.internalAdapter.createVerificationValue({value:n,identifier:t,expiresAt:s});if(!d)throw e.context.logger.error("Unable to create verification. Make sure the database adapter is properly working and there is a verification table in the database"),new $o("INTERNAL_SERVER_ERROR",{message:"Unable to create verification"});return{state:d.identifier,codeVerifier:o}}a(Ee,"generateState");async function Ye(e){let i=e.query.state||e.body.state,r=await e.context.internalAdapter.findVerificationValue(i);if(!r)throw e.context.logger.error("State Mismatch. Verification not found",{state:i}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);let o=me.object({callbackURL:me.string(),codeVerifier:me.string(),errorURL:me.string().optional(),newUserURL:me.string().optional(),expiresAt:me.number(),link:me.object({email:me.string(),userId:me.string()}).optional()}).parse(JSON.parse(r.value));if(o.errorURL||(o.errorURL=`${e.context.baseURL}/error`),o.expiresAt<Date.now())throw await e.context.internalAdapter.deleteVerificationValue(r.id),e.context.logger.error("State expired.",{state:i}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);return await e.context.internalAdapter.deleteVerificationValue(r.id),o}a(Ye,"parseState");var Zo=a(e=>{let i="https://appleid.apple.com/auth/token";return{id:"apple",name:"Apple",createAuthorizationURL({state:r,scopes:o,redirectURI:t}){let n=o||["email","name"];return e.scope&&n.push(...e.scope),new URL(`https://appleid.apple.com/auth/authorize?client_id=${e.clientId}&response_type=code&redirect_uri=${e.redirectURI||t}&scope=${n.join(" ")}&state=${r}&response_mode=form_post`)},validateAuthorizationCode:a(async({code:r,codeVerifier:o,redirectURI:t})=>S({code:r,codeVerifier:o,redirectURI:e.redirectURI||t,options:e,tokenEndpoint:i}),"validateAuthorizationCode"),async verifyIdToken(r,o){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(r,o);let t=Gt(r),{kid:n,alg:s}=t;if(!n||!s)return!1;let d=await Xt(n),{payload:A}=await Jt(r,d,{algorithms:[s],issuer:"https://appleid.apple.com",audience:e.appBundleIdentifier||e.clientId,maxTokenAge:"1h"});return["email_verified","is_private_email"].forEach(c=>{A[c]!==void 0&&(A[c]=!!A[c])}),o&&A.nonce!==o?!1:!!A},async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);if(!r.idToken)return null;let o=Qt(r.idToken);if(!o)return null;let t=o.user?`${o.user.name.firstName} ${o.user.name.lastName}`:o.email,n=await e.mapProfileToUser?.(o);return{user:{id:o.sub,name:t,emailVerified:!1,email:o.email,...n},data:o}}}},"apple"),Xt=a(async e=>{let i="https://appleid.apple.com",r="/auth/keys",{data:o}=await $t(`${i}${r}`);if(!o?.keys)throw new Zt("BAD_REQUEST",{message:"Keys not found"});let t=o.keys.find(n=>n.kid===e);if(!t)throw new Error(`JWK with kid ${e} not found`);return await Wt(t,t.alg)},"getApplePublicKey");import{betterFetch as Yt}from"@better-fetch/fetch";var Qo=a(e=>({id:"discord",name:"Discord",createAuthorizationURL({state:i,scopes:r,redirectURI:o}){let t=r||["identify","email"];return e.scope&&t.push(...e.scope),new URL(`https://discord.com/api/oauth2/authorize?scope=${t.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||o)}&state=${i}&prompt=${e.prompt||"none"}`)},validateAuthorizationCode:a(async({code:i,redirectURI:r})=>S({code:i,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://discord.com/api/oauth2/token"}),"validateAuthorizationCode"),async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);let{data:r,error:o}=await Yt("https://discord.com/api/users/@me",{headers:{authorization:`Bearer ${i.accessToken}`}});if(o)return null;if(r.avatar===null){let n=r.discriminator==="0"?Number(BigInt(r.id)>>BigInt(22))%6:parseInt(r.discriminator)%5;r.image_url=`https://cdn.discordapp.com/embed/avatars/${n}.png`}else{let n=r.avatar.startsWith("a_")?"gif":"png";r.image_url=`https://cdn.discordapp.com/avatars/${r.id}/${r.avatar}.${n}`}let t=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.display_name||r.username||"",email:r.email,emailVerified:r.verified,image:r.image_url,...t},data:r}}}),"discord");import{betterFetch as er}from"@better-fetch/fetch";var Go=a(e=>({id:"facebook",name:"Facebook",async createAuthorizationURL({state:i,scopes:r,redirectURI:o}){let t=r||["email","public_profile"];return e.scope&&t.push(...e.scope),await D({id:"facebook",options:e,authorizationEndpoint:"https://www.facebook.com/v21.0/dialog/oauth",scopes:t,state:i,redirectURI:o})},validateAuthorizationCode:a(async({code:i,redirectURI:r})=>S({code:i,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://graph.facebook.com/oauth/access_token"}),"validateAuthorizationCode"),async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);let{data:r,error:o}=await er("https://graph.facebook.com/me?fields=id,name,email,picture",{auth:{type:"Bearer",token:i.accessToken}});if(o)return null;let t=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.name,email:r.email,image:r.picture.data.url,emailVerified:r.email_verified,...t},data:r}}}),"facebook");import{betterFetch as Wo}from"@better-fetch/fetch";var Jo=a(e=>{let i="https://github.com/login/oauth/access_token";return{id:"github",name:"GitHub",createAuthorizationURL({state:r,scopes:o,codeVerifier:t,redirectURI:n}){let s=o||["user:email"];return e.scope&&s.push(...e.scope),D({id:"github",options:e,authorizationEndpoint:"https://github.com/login/oauth/authorize",scopes:s,state:r,redirectURI:n})},validateAuthorizationCode:a(async({code:r,redirectURI:o})=>S({code:r,redirectURI:e.redirectURI||o,options:e,tokenEndpoint:i}),"validateAuthorizationCode"),async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);let{data:o,error:t}=await Wo("https://api.github.com/user",{headers:{"User-Agent":"better-auth",authorization:`Bearer ${r.accessToken}`}});if(t)return null;let n=!1,{data:s}=await Wo("https://api.github.com/user/emails",{headers:{authorization:`Bearer ${r.accessToken}`,"User-Agent":"better-auth"}});s&&(o.email=(s.find(A=>A.primary)??s[0])?.email,n=s.find(A=>A.email===o.email)?.verified??!1);let d=await e.mapProfileToUser?.(o);return{user:{id:o.id.toString(),name:o.name||o.login,email:o.email,image:o.avatar_url,emailVerified:n,...d},data:o}}}},"github");var go=["info","success","warn","error","debug"];function or(e,i){return go.indexOf(i)<=go.indexOf(e)}a(or,"shouldPublishLog");var ce={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fg:{black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"},bg:{black:"\x1B[40m",red:"\x1B[41m",green:"\x1B[42m",yellow:"\x1B[43m",blue:"\x1B[44m",magenta:"\x1B[45m",cyan:"\x1B[46m",white:"\x1B[47m"}},ir={info:ce.fg.blue,success:ce.fg.green,warn:ce.fg.yellow,error:ce.fg.red,debug:ce.fg.magenta},tr=a((e,i)=>{let r=new Date().toISOString();return`${ce.dim}${r}${ce.reset} ${ir[e]}${e.toUpperCase()}${ce.reset} ${ce.bright}Better Auth${ce.reset} ${i}`},"formatMessage"),Xo=a(e=>{let i=e?.disabled!==!0,r=e?.level??"error",o=a((t,n,s=[])=>{if(!i||!or(r,t))return;let d=tr(t,n);if(!e||typeof e.log!="function"){t==="error"?console.error(d,...s):t==="warn"?console.warn(d,...s):console.log(d,...s);return}e.log(t==="success"?"info":t,d,...s)},"LogFunc");return Object.fromEntries(go.map(t=>[t,(...[n,...s])=>o(t,n,s)]))},"createLogger"),ie=Xo();import{betterFetch as rr}from"@better-fetch/fetch";import{decodeJwt as nr}from"jose";var Yo=a(e=>({id:"google",name:"Google",async createAuthorizationURL({state:i,scopes:r,codeVerifier:o,redirectURI:t}){if(!e.clientId||!e.clientSecret)throw ie.error("Client Id and Client Secret is required for Google. Make sure to provide them in the options."),new re("CLIENT_ID_AND_SECRET_REQUIRED");if(!o)throw new re("codeVerifier is required for Google");let n=r||["email","profile","openid"];e.scope&&n.push(...e.scope);let s=await D({id:"google",options:e,authorizationEndpoint:"https://accounts.google.com/o/oauth2/auth",scopes:n,state:i,codeVerifier:o,redirectURI:t});return e.accessType&&s.searchParams.set("access_type",e.accessType),e.prompt&&s.searchParams.set("prompt",e.prompt),s},validateAuthorizationCode:a(async({code:i,codeVerifier:r,redirectURI:o})=>S({code:i,codeVerifier:r,redirectURI:e.redirectURI||o,options:e,tokenEndpoint:"https://oauth2.googleapis.com/token"}),"validateAuthorizationCode"),async verifyIdToken(i,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(i,r);let o=`https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=${i}`,{data:t}=await rr(o);return t?t.aud===e.clientId&&t.iss==="https://accounts.google.com":!1},async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);if(!i.idToken)return null;let r=nr(i.idToken),o=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:r.email_verified,...o},data:r}}}),"google");import{betterFetch as sr}from"@better-fetch/fetch";import{decodeJwt as ar}from"jose";var ei=a(e=>{let i=e.tenantId||"common",r=`https://login.microsoftonline.com/${i}/oauth2/v2.0/authorize`,o=`https://login.microsoftonline.com/${i}/oauth2/v2.0/token`;return{id:"microsoft",name:"Microsoft EntraID",createAuthorizationURL(t){let n=t.scopes||["openid","profile","email","User.Read"];return e.scope&&n.push(...e.scope),D({id:"microsoft",options:e,authorizationEndpoint:r,state:t.state,codeVerifier:t.codeVerifier,scopes:n,redirectURI:t.redirectURI})},validateAuthorizationCode({code:t,codeVerifier:n,redirectURI:s}){return S({code:t,codeVerifier:n,redirectURI:e.redirectURI||s,options:e,tokenEndpoint:o})},async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.idToken)return null;let n=ar(t.idToken),s=e.profilePhotoSize||48;await sr(`https://graph.microsoft.com/v1.0/me/photos/${s}x${s}/$value`,{headers:{Authorization:`Bearer ${t.accessToken}`},async onResponse(A){if(!(e.disableProfilePhoto||!A.response.ok))try{let K=await A.response.clone().arrayBuffer(),m=Buffer.from(K).toString("base64");n.picture=`data:image/jpeg;base64, ${m}`}catch(c){ie.error(c&&typeof c=="object"&&"name"in c?c.name:"",c)}}});let d=await e.mapProfileToUser?.(n);return{user:{id:n.sub,name:n.name,email:n.email,image:n.picture,emailVerified:!0,...d},data:n}}}},"microsoft");import{betterFetch as dr}from"@better-fetch/fetch";var oi=a(e=>({id:"spotify",name:"Spotify",createAuthorizationURL({state:i,scopes:r,codeVerifier:o,redirectURI:t}){let n=r||["user-read-email"];return e.scope&&n.push(...e.scope),D({id:"spotify",options:e,authorizationEndpoint:"https://accounts.spotify.com/authorize",scopes:n,state:i,codeVerifier:o,redirectURI:t})},validateAuthorizationCode:a(async({code:i,codeVerifier:r,redirectURI:o})=>S({code:i,codeVerifier:r,redirectURI:e.redirectURI||o,options:e,tokenEndpoint:"https://accounts.spotify.com/api/token"}),"validateAuthorizationCode"),async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);let{data:r,error:o}=await dr("https://api.spotify.com/v1/me",{method:"GET",headers:{Authorization:`Bearer ${i.accessToken}`}});if(o)return null;let t=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.display_name,email:r.email,image:r.images[0]?.url,emailVerified:!1,...t},data:r}}}),"spotify");var Ie={isAction:!1};import{createRandomStringGenerator as Ar}from"@better-auth/utils/random";var X=a(e=>Ar("a-z","A-Z","0-9")(e||32),"generateId");import{decodeJwt as cr}from"jose";var ii=a(e=>({id:"twitch",name:"Twitch",createAuthorizationURL({state:i,scopes:r,redirectURI:o}){let t=r||["user:read:email","openid"];return e.scope&&t.push(...e.scope),D({id:"twitch",redirectURI:o,options:e,authorizationEndpoint:"https://id.twitch.tv/oauth2/authorize",scopes:t,state:i,claims:e.claims||["email","email_verified","preferred_username","picture"]})},validateAuthorizationCode:a(async({code:i,redirectURI:r})=>S({code:i,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),"validateAuthorizationCode"),async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);let r=i.idToken;if(!r)return ie.error("No idToken found in token"),null;let o=cr(r),t=await e.mapProfileToUser?.(o);return{user:{id:o.sub,name:o.preferred_username,email:o.email,image:o.picture,emailVerified:!1,...t},data:o}}}),"twitch");import{betterFetch as Kr}from"@better-fetch/fetch";var ti=a(e=>({id:"twitter",name:"Twitter",createAuthorizationURL(i){let r=i.scopes||["users.read","tweet.read","offline.access"];return e.scope&&r.push(...e.scope),D({id:"twitter",options:e,authorizationEndpoint:"https://x.com/i/oauth2/authorize",scopes:r,state:i.state,codeVerifier:i.codeVerifier,redirectURI:i.redirectURI})},validateAuthorizationCode:a(async({code:i,codeVerifier:r,redirectURI:o})=>S({code:i,codeVerifier:r,authentication:"basic",redirectURI:e.redirectURI||o,options:e,tokenEndpoint:"https://api.x.com/2/oauth2/token"}),"validateAuthorizationCode"),async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);let{data:r,error:o}=await Kr("https://api.x.com/2/users/me?user.fields=profile_image_url",{method:"GET",headers:{Authorization:`Bearer ${i.accessToken}`}});if(o)return null;let t=await e.mapProfileToUser?.(r);return{user:{id:r.data.id,name:r.data.name,email:r.data.username||null,image:r.data.profile_image_url,emailVerified:r.data.verified||!1,...t},data:r}}}),"twitter");import{betterFetch as pr}from"@better-fetch/fetch";var ri=a(e=>{let i="https://api.dropboxapi.com/oauth2/token";return{id:"dropbox",name:"Dropbox",createAuthorizationURL:a(async({state:r,scopes:o,codeVerifier:t,redirectURI:n})=>{let s=o||["account_info.read"];return e.scope&&s.push(...e.scope),await D({id:"dropbox",options:e,authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",scopes:s,state:r,redirectURI:n,codeVerifier:t})},"createAuthorizationURL"),validateAuthorizationCode:a(async({code:r,codeVerifier:o,redirectURI:t})=>await S({code:r,codeVerifier:o,redirectURI:e.redirectURI||t,options:e,tokenEndpoint:i}),"validateAuthorizationCode"),async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);let{data:o,error:t}=await pr("https://api.dropboxapi.com/2/users/get_current_account",{method:"POST",headers:{Authorization:`Bearer ${r.accessToken}`}});if(t)return null;let n=await e.mapProfileToUser?.(o);return{user:{id:o.account_id,name:o.name?.display_name,email:o.email,emailVerified:o.email_verified||!1,image:o.profile_photo_url,...n},data:o}}}},"dropbox");import{betterFetch as ur}from"@better-fetch/fetch";var ni=a(e=>{let i="https://www.linkedin.com/oauth/v2/authorization",r="https://www.linkedin.com/oauth/v2/accessToken";return{id:"linkedin",name:"Linkedin",createAuthorizationURL:a(async({state:o,scopes:t,redirectURI:n})=>{let s=t||["profile","email","openid"];return e.scope&&s.push(...e.scope),await D({id:"linkedin",options:e,authorizationEndpoint:i,scopes:s,state:o,redirectURI:n})},"createAuthorizationURL"),validateAuthorizationCode:a(async({code:o,redirectURI:t})=>await S({code:o,redirectURI:e.redirectURI||t,options:e,tokenEndpoint:r}),"validateAuthorizationCode"),async getUserInfo(o){let{data:t,error:n}=await ur("https://api.linkedin.com/v2/userinfo",{method:"GET",headers:{Authorization:`Bearer ${o.accessToken}`}});if(n)return null;let s=await e.mapProfileToUser?.(t);return{user:{id:t.sub,name:t.name,email:t.email,emailVerified:t.email_verified||!1,image:t.picture,...s},data:t}}}},"linkedin");import{betterFetch as lr}from"@better-fetch/fetch";var fo=a((e="")=>e.split("://").map(i=>i.replace(/\/{2,}/g,"/")).join("://"),"cleanDoubleSlashes"),mr=a(e=>{let i=e||"https://gitlab.com";return{authorizationEndpoint:fo(`${i}/oauth/authorize`),tokenEndpoint:fo(`${i}/oauth/token`),userinfoEndpoint:fo(`${i}/api/v4/user`)}},"issuerToEndpoints"),si=a(e=>{let{authorizationEndpoint:i,tokenEndpoint:r,userinfoEndpoint:o}=mr(e.issuer),t="gitlab";return{id:t,name:"Gitlab",createAuthorizationURL:a(async({state:s,scopes:d,codeVerifier:A,redirectURI:c})=>{let K=d||["read_user"];return e.scope&&K.push(...e.scope),await D({id:t,options:e,authorizationEndpoint:i,scopes:K,state:s,redirectURI:c,codeVerifier:A})},"createAuthorizationURL"),validateAuthorizationCode:a(async({code:s,redirectURI:d,codeVerifier:A})=>S({code:s,redirectURI:e.redirectURI||d,options:e,codeVerifier:A,tokenEndpoint:r}),"validateAuthorizationCode"),async getUserInfo(s){if(e.getUserInfo)return e.getUserInfo(s);let{data:d,error:A}=await lr(o,{headers:{authorization:`Bearer ${s.accessToken}`}});if(A||d.state!=="active"||d.locked)return null;let c=await e.mapProfileToUser?.(d);return{user:{id:d.id.toString(),name:d.name??d.username,email:d.email,image:d.avatar_url,emailVerified:!0,...c},data:d}}}},"gitlab");import{betterFetch as ai}from"@better-fetch/fetch";var di=a(e=>({id:"reddit",name:"Reddit",createAuthorizationURL({state:i,scopes:r,redirectURI:o}){let t=r||["identity"];return e.scope&&t.push(...e.scope),D({id:"reddit",options:e,authorizationEndpoint:"https://www.reddit.com/api/v1/authorize",scopes:t,state:i,redirectURI:o,duration:e.duration})},validateAuthorizationCode:a(async({code:i,redirectURI:r})=>{let o=new URLSearchParams({grant_type:"authorization_code",code:i,redirect_uri:e.redirectURI||r}),t={"content-type":"application/x-www-form-urlencoded",accept:"text/plain","user-agent":"better-auth",Authorization:`Basic ${Buffer.from(`${e.clientId}:${e.clientSecret}`).toString("base64")}`},{data:n,error:s}=await ai("https://www.reddit.com/api/v1/access_token",{method:"POST",headers:t,body:o.toString()});if(s)throw s;return Xe(n)},"validateAuthorizationCode"),async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);let{data:r,error:o}=await ai("https://oauth.reddit.com/api/v1/me",{headers:{Authorization:`Bearer ${i.accessToken}`,"User-Agent":"better-auth"}});if(o)return null;let t=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.name,email:r.oauth_client_id,emailVerified:r.has_verified_email,image:r.icon_img?.split("?")[0],...t},data:r}}}),"reddit");import{z as gr}from"zod";var fr={apple:Zo,discord:Qo,facebook:Go,github:Jo,microsoft:ei,google:Yo,spotify:oi,twitch:ii,twitter:ti,dropbox:ri,linkedin:ni,gitlab:si,reddit:di},ho=Object.keys(fr),Ai=gr.enum(ho,{description:"OAuth2 provider to use"});import{z as ne}from"zod";import{APIError as ze}from"better-call";import{APIError as ge}from"better-call";import{z as Ce}from"zod";function yo(e){try{return JSON.parse(e)}catch{return null}}a(yo,"safeJSONParse");var h={USER_NOT_FOUND:"User not found",FAILED_TO_CREATE_USER:"Failed to create user",FAILED_TO_CREATE_SESSION:"Failed to create session",FAILED_TO_UPDATE_USER:"Failed to update user",FAILED_TO_GET_SESSION:"Failed to get session",INVALID_PASSWORD:"Invalid password",INVALID_EMAIL:"Invalid email",INVALID_EMAIL_OR_PASSWORD:"Invalid email or password",SOCIAL_ACCOUNT_ALREADY_LINKED:"Social account already linked",PROVIDER_NOT_FOUND:"Provider not found",INVALID_TOKEN:"invalid token",ID_TOKEN_NOT_SUPPORTED:"id_token not supported",FAILED_TO_GET_USER_INFO:"Failed to get user info",USER_EMAIL_NOT_FOUND:"User email not found",EMAIL_NOT_VERIFIED:"Email not verified",PASSWORD_TOO_SHORT:"Password too short",PASSWORD_TOO_LONG:"Password too long",USER_ALREADY_EXISTS:"User already exists",EMAIL_CAN_NOT_BE_UPDATED:"Email can not be updated",CREDENTIAL_ACCOUNT_NOT_FOUND:"Credential account not found",SESSION_EXPIRED:"Session expired. Re-authenticate to perform this action."};import{createHMAC as hr}from"@better-auth/utils/hmac";import{base64 as yr}from"@better-auth/utils/base64";import{binary as wr}from"@better-auth/utils/binary";var wo=a(()=>p("/get-session",{method:"GET",query:Ce.optional(Ce.object({disableCookieCache:Ce.boolean({description:"Disable cookie cache and fetch session from database"}).or(Ce.string().transform(e=>e==="true")).optional(),disableRefresh:Ce.boolean({description:"Disable session refresh. Useful for checking session status, without updating the session"}).optional()})),requireHeaders:!0,metadata:{openapi:{description:"Get the current session",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{type:"object",properties:{token:{type:"string"},userId:{type:"string"},expiresAt:{type:"string"}}},user:{type:"object",$ref:"#/components/schemas/User"}}}}}}}}}},async e=>{try{let i=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!i)return e.json(null);let r=e.getCookie(e.context.authCookies.sessionData.name),o=r?yo(wr.decode(yr.decode(r))):null;if(o&&!await hr("SHA-256","base64urlnopad").verify(e.context.secret,JSON.stringify(o.session),o.signature))return $(e),e.json(null);let t=await e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret);if(o?.session&&e.context.options.session?.cookieCache?.enabled&&!e.query?.disableCookieCache){let K=o.session;if(o.expiresAt<Date.now()||K.session.expiresAt<new Date){let u=e.context.authCookies.sessionData.name;e.setCookie(u,"",{maxAge:0})}else return e.json(K)}let n=await e.context.internalAdapter.findSession(i);if(e.context.session=n,!n||n.session.expiresAt<new Date)return $(e),n&&await e.context.internalAdapter.deleteSession(n.session.token),e.json(null);if(t||e.query?.disableRefresh)return e.json(n);let s=e.context.sessionConfig.expiresIn,d=e.context.sessionConfig.updateAge;if(n.session.expiresAt.valueOf()-s*1e3+d*1e3<=Date.now()){let K=await e.context.internalAdapter.updateSession(n.session.token,{expiresAt:N(e.context.sessionConfig.expiresIn,"sec")});if(!K)return $(e),e.json(null,{status:401});let m=(K.expiresAt.valueOf()-Date.now())/1e3;return await C(e,{session:K,user:n.user},!1,{maxAge:m}),e.json({session:K,user:n.user})}return await mo(e,n),e.json(n)}catch(i){throw e.context.logger.error("INTERNAL_SERVER_ERROR",i),new ge("INTERNAL_SERVER_ERROR",{message:h.FAILED_TO_GET_SESSION})}}),"getSession"),_=a(async(e,i)=>{if(e.context.session)return e.context.session;let r=await wo()({...e,_flag:"json",headers:e.headers,query:i}).catch(o=>null);return e.context.session=r,r},"getSessionFromCtx"),I=P(async e=>{let i=await _(e);if(!i?.session)throw new ge("UNAUTHORIZED");return{session:i}}),tA=P(async e=>{let i=await _(e);if(!i?.session)throw new ge("UNAUTHORIZED");if(e.context.sessionConfig.freshAge===0)return{session:i};let r=e.context.sessionConfig.freshAge,o=i.session.updatedAt?.valueOf()||i.session.createdAt.valueOf();if(!(Date.now()-o<r*1e3))throw new ge("FORBIDDEN",{message:"Session is not fresh"});return{session:i}}),ci=a(()=>p("/list-sessions",{method:"GET",use:[I],requireHeaders:!0,metadata:{openapi:{description:"List all active sessions for the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{type:"object",properties:{token:{type:"string"},userId:{type:"string"},expiresAt:{type:"string"}}}}}}}}}}},async e=>{let r=(await e.context.internalAdapter.listSessions(e.context.session.user.id)).filter(o=>o.expiresAt>new Date);return e.json(r)}),"listSessions"),Ki=p("/revoke-session",{method:"POST",body:Ce.object({token:Ce.string({description:"The token to revoke"})}),use:[I],requireHeaders:!0,metadata:{openapi:{description:"Revoke a single session",requestBody:{content:{"application/json":{schema:{type:"object",properties:{token:{type:"string"}},required:["token"]}}}}}}},async e=>{let i=e.body.token,r=await e.context.internalAdapter.findSession(i);if(!r)throw new ge("BAD_REQUEST",{message:"Session not found"});if(r.session.userId!==e.context.session.user.id)throw new ge("UNAUTHORIZED");try{await e.context.internalAdapter.deleteSession(i)}catch(o){throw e.context.logger.error(o&&typeof o=="object"&&"name"in o?o.name:"",o),new ge("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),pi=p("/revoke-sessions",{method:"POST",use:[I],requireHeaders:!0,metadata:{openapi:{description:"Revoke all sessions for the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}},required:["status"]}}}}}}}},async e=>{try{await e.context.internalAdapter.deleteSessions(e.context.session.user.id)}catch(i){throw e.context.logger.error(i&&typeof i=="object"&&"name"in i?i.name:"",i),new ge("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),ui=p("/revoke-other-sessions",{method:"POST",requireHeaders:!0,use:[I],metadata:{openapi:{description:"Revoke all other sessions for the user except the current one",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{let i=e.context.session;if(!i.user)throw new ge("UNAUTHORIZED");let t=(await e.context.internalAdapter.listSessions(i.user.id)).filter(n=>n.expiresAt>new Date).filter(n=>n.token!==e.context.session.session.token);return await Promise.all(t.map(n=>e.context.internalAdapter.deleteSession(n.token))),e.json({status:!0})});import{jwtVerify as br}from"jose";import{SignJWT as Cr}from"jose";async function li(e,i,r=3600){return await new Cr(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(Math.floor(Date.now()/1e3)+r).sign(new TextEncoder().encode(i))}a(li,"signJWT");async function Ke(e,i,r){return await li({email:i.toLowerCase(),updateTo:r},e)}a(Ke,"createEmailVerificationToken");async function Co(e,i){if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new ze("BAD_REQUEST",{message:"Verification email isn't enabled"});let r=await Ke(e.context.secret,i.email),o=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||e.query?.currentURL||"/"}`;await e.context.options.emailVerification.sendVerificationEmail({user:i,url:o,token:r},e.request)}a(Co,"sendVerificationEmailFn");var mi=p("/send-verification-email",{method:"POST",query:ne.object({currentURL:ne.string({description:"The URL to use for email verification callback"}).optional()}).optional(),body:ne.object({email:ne.string({description:"The email to send the verification email to"}).email(),callbackURL:ne.string({description:"The URL to use for email verification callback"}).optional()}),metadata:{openapi:{description:"Send a verification email to the user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{email:{type:"string",description:"The email to send the verification email to"},callbackURL:{type:"string",description:"The URL to use for email verification callback"}},required:["email"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new ze("BAD_REQUEST",{message:"Verification email isn't enabled"});let{email:i}=e.body,r=await e.context.internalAdapter.findUserByEmail(i);if(!r)throw new ze("BAD_REQUEST",{message:h.USER_NOT_FOUND});return await Co(e,r.user),e.json({status:!0})}),gi=p("/verify-email",{method:"GET",query:ne.object({token:ne.string({description:"The token to verify the email"}),callbackURL:ne.string({description:"The URL to redirect to after email verification"}).optional()}),metadata:{openapi:{description:"Verify the email of the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object"},status:{type:"boolean"}},required:["user","status"]}}}}}}}},async e=>{function i(d){throw e.query.callbackURL?e.query.callbackURL.includes("?")?e.redirect(`${e.query.callbackURL}&error=${d}`):e.redirect(`${e.query.callbackURL}?error=${d}`):new ze("UNAUTHORIZED",{message:d})}a(i,"redirectOnError");let{token:r}=e.query,o;try{o=await br(r,new TextEncoder().encode(e.context.secret),{algorithms:["HS256"]})}catch(d){return e.context.logger.error("Failed to verify email",d),i("invalid_token")}let n=ne.object({email:ne.string().email(),updateTo:ne.string().optional()}).parse(o.payload),s=await e.context.internalAdapter.findUserByEmail(n.email);if(!s)return i("user_not_found");if(n.updateTo){let d=await _(e);if(!d){if(e.query.callbackURL)throw e.redirect(`${e.query.callbackURL}?error=unauthorized`);return i("unauthorized")}if(d.user.email!==n.email){if(e.query.callbackURL)throw e.redirect(`${e.query.callbackURL}?error=unauthorized`);return i("unauthorized")}let A=await e.context.internalAdapter.updateUserByEmail(n.email,{email:n.updateTo,emailVerified:!1}),c=await Ke(e.context.secret,n.updateTo);if(await e.context.options.emailVerification?.sendVerificationEmail?.({user:A,url:`${e.context.baseURL}/verify-email?token=${c}`,token:c},e.request),e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0})}if(await e.context.internalAdapter.updateUserByEmail(n.email,{emailVerified:!0}),e.context.options.emailVerification?.autoSignInAfterVerification&&!await _(e)){let A=await e.context.internalAdapter.createSession(s.user.id,e.request);if(!A)throw new ze("INTERNAL_SERVER_ERROR",{message:"Failed to create session"});await C(e,{session:A,user:s.user})}if(e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0})});import{APIError as _e,createRouter as Kc,getCookie as kr,getSignedCookie as Dr,setCookie as Pr,setSignedCookie as Nr}from"better-call";import{APIError as Er}from"better-call";function bo(e){return e==="-"||e==="^"||e==="$"||e==="+"||e==="."||e==="("||e===")"||e==="|"||e==="["||e==="]"||e==="{"||e==="}"||e==="*"||e==="?"||e==="\\"?`\\${e}`:e}a(bo,"escapeRegExpChar");function Or(e){let i="";for(let r=0;r<e.length;r++)i+=bo(e[r]);return i}a(Or,"escapeRegExpString");function fi(e,i=!0){if(Array.isArray(e))return`(?:${e.map(K=>`^${fi(K,i)}$`).join("|")})`;let r="",o="",t=".";i===!0?(r="/",o="[/\\\\]",t="[^/\\\\]"):i&&(r=i,o=Or(r),o.length>1?(o=`(?:${o})`,t=`((?!${o}).)`):t=`[^${o}]`);let n=i?`${o}+?`:"",s=i?`${o}*?`:"",d=i?e.split(r):[e],A="";for(let c=0;c<d.length;c++){let K=d[c],m=d[c+1],u="";if(!(!K&&c>0)){if(i&&(c===d.length-1?u=s:m!=="**"?u=n:u=""),i&&K==="**"){u&&(A+=c===0?"":u,A+=`(?:${t}*?${u})*?`);continue}for(let l=0;l<K.length;l++){let w=K[l];w==="\\"?l<K.length-1&&(A+=bo(K[l+1]),l++):w==="?"?A+=t:w==="*"?A+=`${t}*?`:A+=bo(w)}A+=u}}return A}a(fi,"transform");function Tr(e,i){if(typeof i!="string")throw new TypeError(`Sample must be a string, but ${typeof i} given`);return e.test(i)}a(Tr,"isMatch");function Oo(e,i){if(typeof e!="string"&&!Array.isArray(e))throw new TypeError(`The first argument must be a single pattern string or an array of patterns, but ${typeof e} given`);if((typeof i=="string"||typeof i=="boolean")&&(i={separator:i}),arguments.length===2&&!(typeof i>"u"||typeof i=="object"&&i!==null&&!Array.isArray(i)))throw new TypeError(`The second argument must be an options object or a string/boolean separator, but ${typeof i} given`);if(i=i||{},i.separator==="\\")throw new Error("\\ is not a valid separator because it is used for escaping. Try setting the separator to `true` instead");let r=fi(e,i.separator),o=new RegExp(`^${r}$`,i.flags),t=Tr.bind(null,o);return t.options=i,t.pattern=e,t.regexp=o,t}a(Oo,"wildcardMatch");var Ir=P(async e=>{if(e.request?.method!=="POST")return;let{body:i,query:r,context:o}=e,t=e.headers?.get("origin")||e.headers?.get("referer")||"",n=i?.callbackURL||r?.callbackURL,s=i?.redirectTo,d=r?.currentURL,A=i?.errorCallbackURL,c=i?.newUserCallbackURL,K=o.trustedOrigins,m=e.headers?.has("cookie"),u=a((w,y)=>w.startsWith("/")?!1:y.includes("*")?Oo(y)(Mo(w)):w.startsWith(y),"matchesPattern"),l=a((w,y)=>{if(!w)return;if(!K.some(F=>u(w,F)||w?.startsWith("/")&&y!=="origin"&&!w.includes(":")))throw e.context.logger.error(`Invalid ${y}: ${w}`),e.context.logger.info(`If it's a valid URL, please add ${w} to trustedOrigins in your auth config
`,`Current list of trustedOrigins: ${K}`),new Er("FORBIDDEN",{message:`Invalid ${y}`})},"validateURL");m&&!e.context.options.advanced?.disableCSRFCheck&&l(t,"origin"),n&&l(n,"callbackURL"),s&&l(s,"redirectURL"),d&&l(d,"currentURL"),A&&l(A,"errorCallbackURL"),c&&l(s,"newUserCallbackURL")});var hi=p("/ok",{method:"GET",metadata:{...Ie,openapi:{description:"Check if the API is working",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{ok:{type:"boolean"}}}}}}}}}},async e=>e.json({ok:!0}));import{z as Re}from"zod";import{APIError as fe}from"better-call";import{z as E}from"zod";import{APIError as Rr}from"better-call";var kA=E.object({id:E.string(),providerId:E.string(),accountId:E.string(),userId:E.string(),accessToken:E.string().nullish(),refreshToken:E.string().nullish(),idToken:E.string().nullish(),accessTokenExpiresAt:E.date().nullish(),refreshTokenExpiresAt:E.date().nullish(),scope:E.string().nullish(),password:E.string().nullish(),createdAt:E.date().default(()=>new Date),updatedAt:E.date().default(()=>new Date)}),DA=E.object({id:E.string(),email:E.string().transform(e=>e.toLowerCase()),emailVerified:E.boolean().default(!1),name:E.string(),image:E.string().nullish(),createdAt:E.date().default(()=>new Date),updatedAt:E.date().default(()=>new Date)}),PA=E.object({id:E.string(),userId:E.string(),expiresAt:E.date(),createdAt:E.date().default(()=>new Date),updatedAt:E.date().default(()=>new Date),token:E.string(),ipAddress:E.string().nullish(),userAgent:E.string().nullish()}),NA=E.object({id:E.string(),value:E.string(),createdAt:E.date().default(()=>new Date),updatedAt:E.date().default(()=>new Date),expiresAt:E.date(),identifier:E.string()});function _r(e,i){let r={...i==="user"?e.user?.additionalFields:{},...i==="session"?e.session?.additionalFields:{}};for(let o of e.plugins||[])o.schema&&o.schema[i]&&(r={...r,...o.schema[i].fields});return r}a(_r,"getAllFields");function Ur(e,i){let r=i.action||"create",o=i.fields,t={};for(let n in o){if(n in e){if(o[n].input===!1){if(o[n].defaultValue){t[n]=o[n].defaultValue;continue}continue}if(o[n].validator?.input&&e[n]!==void 0){t[n]=o[n].validator.input.parse(e[n]);continue}if(o[n].transform?.input&&e[n]!==void 0){t[n]=o[n].transform?.input(e[n]);continue}t[n]=e[n];continue}if(o[n].defaultValue&&r==="create"){t[n]=o[n].defaultValue;continue}if(o[n].required&&r==="create")throw new Rr("BAD_REQUEST",{message:`${n} is required`})}return t}a(Ur,"parseInputData");function eo(e,i,r){let o=_r(e,"user");return Ur(i||{},{fields:o,action:r})}a(eo,"parseUserInput");function pe(e,i){if(!i)return e;for(let r in i){let o=i[r]?.modelName;o&&(e[r].modelName=o);for(let t in e[r].fields){let n=i[r]?.fields?.[t];n&&(e[r].fields[t].fieldName=n)}}return e}a(pe,"mergeSchema");var yi=a(()=>p("/sign-up/email",{method:"POST",query:Re.object({currentURL:Re.string().optional()}).optional(),body:Re.record(Re.string(),Re.any()),metadata:{openapi:{description:"Sign up a user using email and password",requestBody:{content:{"application/json":{schema:{type:"object",properties:{name:{type:"string",description:"The name of the user"},email:{type:"string",description:"The email of the user"},password:{type:"string",description:"The password of the user"},callbackURL:{type:"string",description:"The URL to use for email verification callback"}},required:["name","email","password"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string",description:"The id of the user"},email:{type:"string",description:"The email of the user"},name:{type:"string",description:"The name of the user"},image:{type:"string",description:"The image of the user"},emailVerified:{type:"boolean",description:"If the email is verified"}}}}}}}}}},async e=>{if(!e.context.options.emailAndPassword?.enabled)throw new fe("BAD_REQUEST",{message:"Email and password sign up is not enabled"});let i=e.body,{name:r,email:o,password:t,image:n,callbackURL:s,...d}=i;if(!Re.string().email().safeParse(o).success)throw new fe("BAD_REQUEST",{message:h.INVALID_EMAIL});let c=e.context.password.config.minPasswordLength;if(t.length<c)throw e.context.logger.error("Password is too short"),new fe("BAD_REQUEST",{message:h.PASSWORD_TOO_SHORT});let K=e.context.password.config.maxPasswordLength;if(t.length>K)throw e.context.logger.error("Password is too long"),new fe("BAD_REQUEST",{message:h.PASSWORD_TOO_LONG});if((await e.context.internalAdapter.findUserByEmail(o))?.user)throw e.context.logger.info(`Sign-up attempt for existing email: ${o}`),new fe("UNPROCESSABLE_ENTITY",{message:h.USER_ALREADY_EXISTS});let u=eo(e.context.options,d),l;try{if(l=await e.context.internalAdapter.createUser({email:o.toLowerCase(),name:r,image:n,...u,emailVerified:!1}),!l)throw new fe("BAD_REQUEST",{message:h.FAILED_TO_CREATE_USER})}catch(j){throw Je&&e.context.logger.error("Failed to create user",j),new fe("UNPROCESSABLE_ENTITY",{message:h.FAILED_TO_CREATE_USER,details:j})}if(!l)throw new fe("UNPROCESSABLE_ENTITY",{message:h.FAILED_TO_CREATE_USER});let w=await e.context.password.hash(t);if(await e.context.internalAdapter.linkAccount({userId:l.id,providerId:"credential",accountId:l.id,password:w}),e.context.options.emailVerification?.sendOnSignUp){let j=await Ke(e.context.secret,l.email),F=`${e.context.baseURL}/verify-email?token=${j}&callbackURL=${i.callbackURL||e.query?.currentURL||"/"}`;await e.context.options.emailVerification?.sendVerificationEmail?.({user:l,url:F,token:j},e.request)}if(!e.context.options.emailAndPassword.autoSignIn||e.context.options.emailAndPassword.requireEmailVerification)return e.json({token:null});let y=await e.context.internalAdapter.createSession(l.id,e.request);if(!y)throw new fe("BAD_REQUEST",{message:h.FAILED_TO_CREATE_SESSION});return await C(e,{session:y,user:l}),e.json({token:y.token})}),"signUpEmail");var Sr=a((e="Unknown")=>`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Error</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --accent-color: #000000;
            --error-color: #dc3545;
            --border-color: #e9ecef;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            line-height: 1.5;
        }
        .error-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
        }
        h1 {
            color: var(--error-color);
            font-size: 1.75rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        p {
            margin-bottom: 1.5rem;
            color: #495057;
        }
        .btn {
            background-color: var(--accent-color);
            color: #ffffff;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: inline-block;
            font-weight: 500;
            border: 2px solid var(--accent-color);
        }
        .btn:hover {
            background-color: #131721;
        }
        .error-code {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="icon">\u26A0\uFE0F</div>
        <h1>Better Auth Error</h1>
        <p>We encountered an issue while processing your request. Please try again or contact the application owner if the problem persists.</p>
        <a href="/" id="returnLink" class="btn">Return to Application</a>
        <div class="error-code">Error Code: <span id="errorCode">${e}</span></div>
    </div>
</body>
</html>`,"html"),wi=p("/error",{method:"GET",metadata:{...Ie,openapi:{description:"Displays an error page",responses:{200:{description:"Success",content:{"text/html":{schema:{type:"string"}}}}}}}},async e=>{let i=new URL(e.request?.url||"").searchParams.get("error")||"Unknown";return new Response(Sr(i),{headers:{"Content-Type":"text/html"}})});import"defu";import{APIError as g}from"better-call";function To(e,i){let r=i.plugins?.reduce((d,A)=>({...d,...A.endpoints}),{}),o=i.plugins?.map(d=>d.middlewares?.map(A=>{let c=a(async K=>A.middleware({...K,context:{...e,...K.context}}),"middleware");return c.path=A.path,c.options=A.middleware.options,c.headers=A.middleware.headers,{path:A.path,middleware:c}})).filter(d=>d!==void 0).flat()||[],n={...{signInSocial:Ci,callbackOAuth:Oi,getSession:wo(),signOut:Ti,signUpEmail:yi(),signInEmail:bi,forgetPassword:Ei,resetPassword:Ri,verifyEmail:gi,sendVerificationEmail:mi,changeEmail:ki,changePassword:Ui,setPassword:Si,updateUser:_i(),deleteUser:vi,forgetPasswordCallback:Ii,listSessions:ci(),revokeSession:Ki,revokeSessions:pi,revokeOtherSessions:ui,linkSocialAccount:Pi,listUserAccounts:Di,deleteUserCallback:Eo},...r,ok:hi,error:wi},s={};for(let[d,A]of Object.entries(n))s[d]=async(c={})=>{A.headers=new Headers;let K={setHeader(f,T){A.headers.set(f,T)},setCookie(f,T,k){Pr(A.headers,f,T,k)},getCookie(f,T){let U=c.headers?.get("cookie");return kr(U||"",f,T)},getSignedCookie(f,T,k){let U=c.headers;return U?Dr(U,T,f,k):null},async setSignedCookie(f,T,k,U){await Nr(A.headers,f,T,k,U)},redirect(f){return A.headers.set("Location",f),new _e("FOUND")},responseHeader:A.headers},m=await e,u=null,l={...K,...c,path:A.path,context:{...m,...c.context,session:null,setNewSession:a(function(f){this.newSession=f,u=f},"setNewSession")}},w=i.plugins||[],y=w.map(f=>{if(f.hooks?.before)return f.hooks.before}).filter(f=>f!==void 0).flat(),j=w.map(f=>{if(f.hooks?.after)return f.hooks.after}).filter(f=>f!==void 0).flat();i.hooks?.before&&y.push({matcher:a(()=>!0,"matcher"),handler:i.hooks.before}),i.hooks?.after&&j.push({matcher:a(()=>!0,"matcher"),handler:i.hooks.after});for(let f of y){if(!f.matcher(l))continue;let T=await f.handler(l);if(T&&"context"in T){l={...l,...T.context};continue}if(T)return T}let F;try{F=await A(l),u&&(l.context.newSession=u)}catch(f){if(u&&(l.context.newSession=u),f instanceof _e){if(!j?.length)throw f.headers=A.headers,f;l.context.returned=f,l.context.returned.headers=A.headers;for(let T of j||[])if(T.matcher(l))try{let U=await T.handler(l);U&&"response"in U&&(l.context.returned=U.response)}catch(U){if(U instanceof _e){l.context.returned=U;continue}throw U}if(l.context.returned instanceof _e)throw l.context.returned.headers=A.headers,l.context.returned;return l.context.returned}throw f}l.context.returned=F,l.responseHeader=A.headers;for(let f of j)if(f.matcher(l))try{let k=await f.handler(l);if(k)if("responseHeader"in k){let U=k.responseHeader;l.responseHeader=U}else l.context.returned=k}catch(k){if(k instanceof _e){l.context.returned=k;continue}throw k}let M=l.context.returned;if(M instanceof Response&&A.headers.forEach((f,T)=>{T==="set-cookie"?M.headers.append(T,f):M.headers.set(T,f)}),M instanceof _e)throw M.headers=A.headers,M;return M},s[d].path=A.path,s[d].method=A.method,s[d].options=A.options,s[d].headers=A.headers;return{api:s,middlewares:o}}a(To,"getEndpoints");async function Ue(e,{userInfo:i,account:r,callbackURL:o}){let t=await e.context.internalAdapter.findOAuthUser(i.email.toLowerCase(),r.accountId,r.providerId).catch(A=>{throw ie.error(`Better auth was unable to query your database.
Error: `,A),e.redirect(`${e.context.baseURL}/error?error=internal_server_error`)}),n=t?.user,s=!n;if(t){let A=t.accounts.find(c=>c.providerId===r.providerId);if(A){let c=Object.fromEntries(Object.entries({accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt}).filter(([K,m])=>m!==void 0));Object.keys(c).length>0&&await e.context.internalAdapter.updateAccount(A.id,c)}else{if(!e.context.options.account?.accountLinking?.trustedProviders?.includes(r.providerId)&&!i.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)return Je&&ie.warn(`User already exist but account isn't linked to ${r.providerId}. To read more about how account linking works in Better Auth see https://www.better-auth.com/docs/concepts/users-accounts#account-linking.`),{error:"account not linked",data:null};try{await e.context.internalAdapter.linkAccount({providerId:r.providerId,accountId:i.id.toString(),userId:t.user.id,accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope})}catch(m){return ie.error("Unable to link account",m),{error:"unable to link account",data:null}}}}else try{if(n=await e.context.internalAdapter.createOAuthUser({...i,email:i.email.toLowerCase(),id:void 0},{accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope,providerId:r.providerId,accountId:i.id.toString()}).then(A=>A?.user),!i.emailVerified&&n&&e.context.options.emailVerification?.sendOnSignUp){let A=await Ke(e.context.secret,n.email),c=`${e.context.baseURL}/verify-email?token=${A}&callbackURL=${o}`;await e.context.options.emailVerification?.sendVerificationEmail?.({user:n,url:c,token:A},e.request)}}catch(A){return A instanceof g?{error:A.message,data:null,isRegister:!1}:{error:"unable to create user",data:null,isRegister:!1}}if(!n)return{error:"unable to create user",data:null,isRegister:!1};let d=await e.context.internalAdapter.createSession(n.id,e.request);return d?{data:{session:d,user:n},error:null,isRegister:s}:{error:"unable to create session",data:null,isRegister:!1}}a(Ue,"handleOAuthUserInfo");var Ci=p("/sign-in/social",{method:"POST",query:V.object({currentURL:V.string().optional()}).optional(),body:V.object({callbackURL:V.string({description:"Callback URL to redirect to after the user has signed in"}).optional(),newUserCallbackURL:V.string().optional(),errorCallbackURL:V.string({description:"Callback URL to redirect to if an error happens"}).optional(),provider:Ai,disableRedirect:V.boolean({description:"Disable automatic redirection to the provider. Useful for handling the redirection yourself"}).optional(),idToken:V.optional(V.object({token:V.string({description:"ID token from the provider"}),nonce:V.string({description:"Nonce used to generate the token"}).optional(),accessToken:V.string({description:"Access token from the provider"}).optional(),refreshToken:V.string({description:"Refresh token from the provider"}).optional(),expiresAt:V.number({description:"Expiry date of the token"}).optional()}),{description:"ID token from the provider to sign in the user with id token"})}),metadata:{openapi:{description:"Sign in with a social provider",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{type:"string"},user:{type:"object"},url:{type:"string"},redirect:{type:"boolean"}},required:["session","user","url","redirect"]}}}}}}}},async e=>{let i=e.context.socialProviders.find(n=>n.id===e.body.provider);if(!i)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new Q("NOT_FOUND",{message:h.PROVIDER_NOT_FOUND});if(e.body.idToken){if(!i.verifyIdToken)throw e.context.logger.error("Provider does not support id token verification",{provider:e.body.provider}),new Q("NOT_FOUND",{message:h.ID_TOKEN_NOT_SUPPORTED});let{token:n,nonce:s}=e.body.idToken;if(!await i.verifyIdToken(n,s))throw e.context.logger.error("Invalid id token",{provider:e.body.provider}),new Q("UNAUTHORIZED",{message:h.INVALID_TOKEN});let A=await i.getUserInfo({idToken:n,accessToken:e.body.idToken.accessToken,refreshToken:e.body.idToken.refreshToken});if(!A||!A?.user)throw e.context.logger.error("Failed to get user info",{provider:e.body.provider}),new Q("UNAUTHORIZED",{message:h.FAILED_TO_GET_USER_INFO});if(!A.user.email)throw e.context.logger.error("User email not found",{provider:e.body.provider}),new Q("UNAUTHORIZED",{message:h.USER_EMAIL_NOT_FOUND});let c=await Ue(e,{userInfo:{email:A.user.email,id:A.user.id,name:A.user.name||"",image:A.user.image,emailVerified:A.user.emailVerified||!1},account:{providerId:i.id,accountId:A.user.id,accessToken:e.body.idToken.accessToken}});if(c.error)throw new Q("UNAUTHORIZED",{message:c.error});return await C(e,c.data),e.json({token:c.data.session.token,url:void 0,redirect:!1})}let{codeVerifier:r,state:o}=await Ee(e),t=await i.createAuthorizationURL({state:o,codeVerifier:r,redirectURI:`${e.context.baseURL}/callback/${i.id}`});return e.json({url:t.toString(),redirect:!e.body.disableRedirect})}),bi=p("/sign-in/email",{method:"POST",body:V.object({email:V.string({description:"Email of the user"}),password:V.string({description:"Password of the user"}),callbackURL:V.string({description:"Callback URL to use as a redirect for email verification"}).optional(),rememberMe:V.boolean({description:"If this is false, the session will not be remembered. Default is `true`."}).default(!0).optional()}),metadata:{openapi:{description:"Sign in with email and password",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object"},url:{type:"string"},redirect:{type:"boolean"}},required:["session","user","url","redirect"]}}}}}}}},async e=>{if(!e.context.options?.emailAndPassword?.enabled)throw e.context.logger.error("Email and password is not enabled. Make sure to enable it in the options on you `auth.ts` file. Check `https://better-auth.com/docs/authentication/email-password` for more!"),new Q("BAD_REQUEST",{message:"Email and password is not enabled"});let{email:i,password:r}=e.body;if(!V.string().email().safeParse(i).success)throw new Q("BAD_REQUEST",{message:h.INVALID_EMAIL});let t=await e.context.internalAdapter.findUserByEmail(i,{includeAccounts:!0});if(!t)throw await e.context.password.hash(r),e.context.logger.error("User not found",{email:i}),new Q("UNAUTHORIZED",{message:h.INVALID_EMAIL_OR_PASSWORD});let n=t.accounts.find(c=>c.providerId==="credential");if(!n)throw e.context.logger.error("Credential account not found",{email:i}),new Q("UNAUTHORIZED",{message:h.INVALID_EMAIL_OR_PASSWORD});let s=n?.password;if(!s)throw e.context.logger.error("Password not found",{email:i}),new Q("UNAUTHORIZED",{message:h.INVALID_EMAIL_OR_PASSWORD});if(!await e.context.password.verify({hash:s,password:r}))throw e.context.logger.error("Invalid password"),new Q("UNAUTHORIZED",{message:h.INVALID_EMAIL_OR_PASSWORD});if(e.context.options?.emailAndPassword?.requireEmailVerification&&!t.user.emailVerified){if(!e.context.options?.emailVerification?.sendVerificationEmail)throw new Q("UNAUTHORIZED",{message:h.EMAIL_NOT_VERIFIED});let c=await Ke(e.context.secret,t.user.email),K=`${e.context.baseURL}/verify-email?token=${c}&callbackURL=${e.body.callbackURL||"/"}`;throw await e.context.options.emailVerification.sendVerificationEmail({user:t.user,url:K,token:c},e.request),e.context.logger.error("Email not verified",{email:i}),new Q("FORBIDDEN",{message:h.EMAIL_NOT_VERIFIED})}let A=await e.context.internalAdapter.createSession(t.user.id,e.headers,e.body.rememberMe===!1);if(!A)throw e.context.logger.error("Failed to create session"),new Q("UNAUTHORIZED",{message:h.FAILED_TO_CREATE_SESSION});return await C(e,{session:A,user:t.user},e.body.rememberMe===!1),e.json({user:{id:t.user.id,email:t.user.email,name:t.user.name,image:t.user.image,emailVerified:t.user.emailVerified,createdAt:t.user.createdAt,updatedAt:t.user.updatedAt},redirect:!!e.body.callbackURL,url:e.body.callbackURL})});import{z as xe}from"zod";var oo=xe.object({code:xe.string().optional(),error:xe.string().optional(),error_description:xe.string().optional(),state:xe.string().optional()}),Oi=p("/callback/:id",{method:["GET","POST"],body:oo.optional(),query:oo.optional(),metadata:Ie},async e=>{let i;try{if(e.method==="GET")i=oo.parse(e.query);else if(e.method==="POST")i=oo.parse(e.body);else throw new Error("Unsupported method")}catch(f){throw e.context.logger.error("INVALID_CALLBACK_REQUEST",f),e.redirect(`${e.context.baseURL}/error?error=invalid_callback_request`)}let{code:r,error:o,state:t,error_description:n}=i;if(!t)throw e.context.logger.error("State not found",o),e.redirect(`${e.context.baseURL}/error?error=state_not_found`);if(!r)throw e.context.logger.error("Code not found"),e.redirect(`${e.context.baseURL}/error?error=${o||"no_code"}&error_description=${n}`);let s=e.context.socialProviders.find(f=>f.id===e.params.id);if(!s)throw e.context.logger.error("Oauth provider with id",e.params.id,"not found"),e.redirect(`${e.context.baseURL}/error?error=oauth_provider_not_found`);let{codeVerifier:d,callbackURL:A,link:c,errorURL:K,newUserURL:m}=await Ye(e),u;try{u=await s.validateAuthorizationCode({code:r,codeVerifier:d,redirectURI:`${e.context.baseURL}/callback/${s.id}`})}catch(f){throw e.context.logger.error("",f),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`)}let l=await s.getUserInfo(u).then(f=>f?.user);function w(f){let T=K||A||`${e.context.baseURL}/error`;throw T.includes("?")?T=`${T}&error=${f}`:T=`${T}?error=${f}`,e.redirect(T)}if(a(w,"redirectOnError"),!l)return e.context.logger.error("Unable to get user info"),w("unable_to_get_user_info");if(!l.email)return e.context.logger.error("Provider did not return email. This could be due to misconfiguration in the provider settings."),w("email_not_found");if(!A)throw e.context.logger.error("No callback URL found"),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);if(c){if(c.email!==l.email.toLowerCase())return w("email_doesn't_match");if(!await e.context.internalAdapter.createAccount({userId:c.userId,providerId:s.id,accountId:l.id}))return w("unable_to_link_account");let T;try{T=A.toString()}catch{T=A}throw e.redirect(T)}let y=await Ue(e,{userInfo:{...l,email:l.email,name:l.name||l.email},account:{providerId:s.id,accountId:l.id,...u,scope:u.scopes?.join(",")},callbackURL:A});if(y.error)return e.context.logger.error(y.error.split(" ").join("_")),w(y.error.split(" ").join("_"));let{session:j,user:F}=y.data;await C(e,{session:j,user:F});let M;try{M=(y.isRegister&&m||A).toString()}catch{M=y.isRegister&&m||A}throw e.redirect(M)});import"zod";import{APIError as Lr}from"better-call";var Ti=p("/sign-out",{method:"POST",requireHeaders:!0,metadata:{openapi:{description:"Sign out the current user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async e=>{let i=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!i)throw $(e),new Lr("BAD_REQUEST",{message:h.FAILED_TO_GET_SESSION});return await e.context.internalAdapter.deleteSession(i),$(e),e.json({success:!0})});import{z as te}from"zod";import{APIError as Be}from"better-call";function Ni(e,i,r){let o=i?new URL(i,e.baseURL):new URL(`${e.baseURL}/error`);return r&&Object.entries(r).forEach(([t,n])=>o.searchParams.set(t,n)),o.href}a(Ni,"redirectError");function jr(e,i,r){let o=new URL(i,e.baseURL);return r&&Object.entries(r).forEach(([t,n])=>o.searchParams.set(t,n)),o.href}a(jr,"redirectCallback");var Ei=p("/forget-password",{method:"POST",body:te.object({email:te.string({description:"The email address of the user to send a password reset email to"}).email(),redirectTo:te.string({description:"The URL to redirect the user to reset their password. If the token isn't valid or expired, it'll be redirected with a query parameter `?error=INVALID_TOKEN`. If the token is valid, it'll be redirected with a query parameter `?token=VALID_TOKEN"}).optional()}),metadata:{openapi:{description:"Send a password reset email to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{if(!e.context.options.emailAndPassword?.sendResetPassword)throw e.context.logger.error("Reset password isn't enabled.Please pass an emailAndPassword.sendResetPasswordToken function in your auth config!"),new Be("BAD_REQUEST",{message:"Reset password isn't enabled"});let{email:i,redirectTo:r}=e.body,o=await e.context.internalAdapter.findUserByEmail(i,{includeAccounts:!0});if(!o)return e.context.logger.error("Reset Password: User not found",{email:i}),e.json({status:!1},{body:{status:!0}});let t=60*60*1,n=N(e.context.options.emailAndPassword.resetPasswordTokenExpiresIn||t,"sec"),s=X(24);await e.context.internalAdapter.createVerificationValue({value:o.user.id.toString(),identifier:`reset-password:${s}`,expiresAt:n});let d=`${e.context.baseURL}/reset-password/${s}?callbackURL=${r}`;return await e.context.options.emailAndPassword.sendResetPassword({user:o.user,url:d,token:s},e.request),e.json({status:!0})}),Ii=p("/reset-password/:token",{method:"GET",query:te.object({callbackURL:te.string({description:"The URL to redirect the user to reset their password"})}),metadata:{openapi:{description:"Redirects the user to the callback URL with the token",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string"}}}}}}}}}},async e=>{let{token:i}=e.params,{callbackURL:r}=e.query;if(!i||!r)throw e.redirect(Ni(e.context,r,{error:"INVALID_TOKEN"}));let o=await e.context.internalAdapter.findVerificationValue(`reset-password:${i}`);throw!o||o.expiresAt<new Date?e.redirect(Ni(e.context,r,{error:"INVALID_TOKEN"})):e.redirect(jr(e.context,r,{token:i}))}),Ri=p("/reset-password",{query:te.optional(te.object({token:te.string().optional(),currentURL:te.string().optional()})),method:"POST",body:te.object({newPassword:te.string({description:"The new password to set"}),token:te.string({description:"The token to reset the password"}).optional()}),metadata:{openapi:{description:"Reset the password for a user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{let i=e.body.token||e.query?.token||(e.query?.currentURL?new URL(e.query.currentURL).searchParams.get("token"):"");if(!i)throw new Be("BAD_REQUEST",{message:h.INVALID_TOKEN});let{newPassword:r}=e.body,o=e.context.password?.config.minPasswordLength,t=e.context.password?.config.maxPasswordLength;if(r.length<o)throw new Be("BAD_REQUEST",{message:h.PASSWORD_TOO_SHORT});if(r.length>t)throw new Be("BAD_REQUEST",{message:h.PASSWORD_TOO_LONG});let n=`reset-password:${i}`,s=await e.context.internalAdapter.findVerificationValue(n);if(!s||s.expiresAt<new Date)throw new Be("BAD_REQUEST",{message:h.INVALID_TOKEN});await e.context.internalAdapter.deleteVerificationValue(s.id);let d=s.value,A=await e.context.password.hash(r);return(await e.context.internalAdapter.findAccounts(d)).find(m=>m.providerId==="credential")?(await e.context.internalAdapter.updatePassword(d,A),e.json({status:!0})):(await e.context.internalAdapter.createAccount({userId:d,providerId:"credential",password:A,accountId:d}),e.json({status:!0}))});import{z}from"zod";import{APIError as x}from"better-call";var _i=a(()=>p("/update-user",{method:"POST",body:z.record(z.string(),z.any()),use:[I],metadata:{openapi:{description:"Update the current user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{name:{type:"string",description:"The name of the user"},image:{type:"string",description:"The image of the user"}}}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object"}}}}}}}}}},async e=>{let i=e.body;if(i.email)throw new x("BAD_REQUEST",{message:h.EMAIL_CAN_NOT_BE_UPDATED});let{name:r,image:o,...t}=i,n=e.context.session;if(o===void 0&&r===void 0&&Object.keys(t).length===0)return e.json({status:!0});let s=eo(e.context.options,t,"update"),d=await e.context.internalAdapter.updateUserByEmail(n.user.email,{name:r,image:o,...s});return await C(e,{session:n.session,user:d}),e.json({status:!0})}),"updateUser"),Ui=p("/change-password",{method:"POST",body:z.object({newPassword:z.string({description:"The new password to set"}),currentPassword:z.string({description:"The current password"}),revokeOtherSessions:z.boolean({description:"Revoke all other sessions"}).optional()}),use:[I],metadata:{openapi:{description:"Change the password of the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{description:"The user object",$ref:"#/components/schemas/User"}}}}}}}}}},async e=>{let{newPassword:i,currentPassword:r,revokeOtherSessions:o}=e.body,t=e.context.session,n=e.context.password.config.minPasswordLength;if(i.length<n)throw e.context.logger.error("Password is too short"),new x("BAD_REQUEST",{message:h.PASSWORD_TOO_SHORT});let s=e.context.password.config.maxPasswordLength;if(i.length>s)throw e.context.logger.error("Password is too long"),new x("BAD_REQUEST",{message:h.PASSWORD_TOO_LONG});let A=(await e.context.internalAdapter.findAccounts(t.user.id)).find(u=>u.providerId==="credential"&&u.password);if(!A||!A.password)throw new x("BAD_REQUEST",{message:h.CREDENTIAL_ACCOUNT_NOT_FOUND});let c=await e.context.password.hash(i);if(!await e.context.password.verify({hash:A.password,password:r}))throw new x("BAD_REQUEST",{message:h.INVALID_PASSWORD});await e.context.internalAdapter.updateAccount(A.id,{password:c});let m=null;if(o){await e.context.internalAdapter.deleteSessions(t.user.id);let u=await e.context.internalAdapter.createSession(t.user.id,e.headers);if(!u)throw new x("INTERNAL_SERVER_ERROR",{message:h.FAILED_TO_GET_SESSION});await C(e,{session:u,user:t.user}),m=u.token}return e.json({token:m})}),Si=p("/set-password",{method:"POST",body:z.object({newPassword:z.string()}),metadata:{SERVER_ONLY:!0},use:[I]},async e=>{let{newPassword:i}=e.body,r=e.context.session,o=e.context.password.config.minPasswordLength;if(i.length<o)throw e.context.logger.error("Password is too short"),new x("BAD_REQUEST",{message:h.PASSWORD_TOO_SHORT});let t=e.context.password.config.maxPasswordLength;if(i.length>t)throw e.context.logger.error("Password is too long"),new x("BAD_REQUEST",{message:h.PASSWORD_TOO_LONG});let s=(await e.context.internalAdapter.findAccounts(r.user.id)).find(A=>A.providerId==="credential"&&A.password),d=await e.context.password.hash(i);if(!s)return await e.context.internalAdapter.linkAccount({userId:r.user.id,providerId:"credential",accountId:r.user.id,password:d}),e.json({status:!0});throw new x("BAD_REQUEST",{message:"user already has a password"})}),vi=p("/delete-user",{method:"POST",use:[I],body:z.object({callbackURL:z.string().optional(),password:z.string().optional(),token:z.string().optional()}),metadata:{openapi:{description:"Delete the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object"}}}}}}}},async e=>{if(!e.context.options.user?.deleteUser?.enabled)throw e.context.logger.error("Delete user is disabled. Enable it in the options",{session:e.context.session}),new x("NOT_FOUND");let i=e.context.session;if(e.body.password){let n=(await e.context.internalAdapter.findAccounts(i.user.id)).find(d=>d.providerId==="credential"&&d.password);if(!n||!n.password)throw new x("BAD_REQUEST",{message:h.CREDENTIAL_ACCOUNT_NOT_FOUND});if(!await e.context.password.verify({hash:n.password,password:e.body.password}))throw new x("BAD_REQUEST",{message:h.INVALID_PASSWORD})}else if(e.context.options.session?.freshAge){let t=i.session.createdAt.getTime(),n=e.context.options.session.freshAge;if(Date.now()-t>n)throw new x("BAD_REQUEST",{message:h.SESSION_EXPIRED})}if(e.body.token)return await Eo({query:{token:e.body.token},...e}),e.json({success:!0,message:"User deleted"});if(e.context.options.user.deleteUser?.sendDeleteAccountVerification){let t=R(32,"0-9","a-z");await e.context.internalAdapter.createVerificationValue({value:i.user.id,identifier:`delete-account-${t}`,expiresAt:new Date(Date.now()+1e3*60*60*24)});let n=`${e.context.baseURL}/delete-user/callback?token=${t}&callbackURL=${e.body.callbackURL||"/"}`;return await e.context.options.user.deleteUser.sendDeleteAccountVerification({user:i.user,url:n,token:t},e.request),e.json({success:!0,message:"Verification email sent"})}let r=e.context.options.user.deleteUser?.beforeDelete;r&&await r(i.user,e.request),await e.context.internalAdapter.deleteUser(i.user.id),await e.context.internalAdapter.deleteSessions(i.user.id),await e.context.internalAdapter.deleteAccounts(i.user.id),$(e);let o=e.context.options.user.deleteUser?.afterDelete;return o&&await o(i.user,e.request),e.json({success:!0,message:"User deleted"})}),Eo=p("/delete-user/callback",{method:"GET",query:z.object({token:z.string(),callbackURL:z.string().optional()})},async e=>{if(!e.context.options.user?.deleteUser?.enabled)throw e.context.logger.error("Delete user is disabled. Enable it in the options"),new x("NOT_FOUND");let i=await _(e);if(!i)throw new x("NOT_FOUND",{message:h.FAILED_TO_GET_USER_INFO});let r=await e.context.internalAdapter.findVerificationValue(`delete-account-${e.query.token}`);if(!r||r.expiresAt<new Date)throw r&&await e.context.internalAdapter.deleteVerificationValue(r.id),new x("NOT_FOUND",{message:h.INVALID_TOKEN});if(r.value!==i.user.id)throw new x("NOT_FOUND",{message:h.INVALID_TOKEN});let o=e.context.options.user.deleteUser?.beforeDelete;o&&await o(i.user,e.request),await e.context.internalAdapter.deleteUser(i.user.id),await e.context.internalAdapter.deleteSessions(i.user.id),await e.context.internalAdapter.deleteAccounts(i.user.id),await e.context.internalAdapter.deleteVerificationValue(r.id),$(e);let t=e.context.options.user.deleteUser?.afterDelete;if(t&&await t(i.user,e.request),e.query.callbackURL)throw e.redirect(e.query.callbackURL||"/");return e.json({success:!0,message:"User deleted"})}),ki=p("/change-email",{method:"POST",query:z.object({currentURL:z.string().optional()}).optional(),body:z.object({newEmail:z.string({description:"The new email to set"}).email(),callbackURL:z.string({description:"The URL to redirect to after email verification"}).optional()}),use:[I],metadata:{openapi:{responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object"},status:{type:"boolean"}}}}}}}}}},async e=>{if(!e.context.options.user?.changeEmail?.enabled)throw e.context.logger.error("Change email is disabled."),new x("BAD_REQUEST",{message:"Change email is disabled"});if(e.body.newEmail===e.context.session.user.email)throw e.context.logger.error("Email is the same"),new x("BAD_REQUEST",{message:"Email is the same"});if(await e.context.internalAdapter.findUserByEmail(e.body.newEmail))throw e.context.logger.error("Email already exists"),new x("BAD_REQUEST",{message:"Couldn't update your email"});if(e.context.session.user.emailVerified!==!0){let t=await e.context.internalAdapter.updateUserByEmail(e.context.session.user.email,{email:e.body.newEmail});return e.json({status:!0})}if(!e.context.options.user.changeEmail.sendChangeEmailVerification)throw e.context.logger.error("Verification email isn't enabled."),new x("BAD_REQUEST",{message:"Verification email isn't enabled"});let r=await Ke(e.context.secret,e.context.session.user.email,e.body.newEmail),o=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||e.query?.currentURL||"/"}`;return await e.context.options.user.changeEmail.sendChangeEmailVerification({user:e.context.session.user,newEmail:e.body.newEmail,url:o,token:r},e.request),e.json({status:!0})});import{z as Fe}from"zod";import{APIError as Li}from"better-call";var Di=p("/list-accounts",{method:"GET",use:[I],metadata:{openapi:{description:"List all accounts linked to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{type:"object",properties:{id:{type:"string"},provider:{type:"string"}}}}}}}}}}},async e=>{let i=e.context.session,r=await e.context.internalAdapter.findAccounts(i.user.id);return e.json(r.map(o=>({id:o.id,provider:o.providerId})))}),Pi=p("/link-social",{method:"POST",requireHeaders:!0,query:Fe.object({currentURL:Fe.string().optional()}).optional(),body:Fe.object({callbackURL:Fe.string({description:"The URL to redirect to after the user has signed in"}).optional(),provider:Fe.enum(ho,{description:"The OAuth2 provider to use"})}),use:[I],metadata:{openapi:{description:"Link a social account to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string"},redirect:{type:"boolean"}},required:["url","redirect"]}}}}}}}},async e=>{let i=e.context.session;if((await e.context.internalAdapter.findAccounts(i.user.id)).find(d=>d.providerId===e.body.provider))throw new Li("BAD_REQUEST",{message:h.SOCIAL_ACCOUNT_ALREADY_LINKED});let t=e.context.socialProviders.find(d=>d.id===e.body.provider);if(!t)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new Li("NOT_FOUND",{message:h.PROVIDER_NOT_FOUND});let n=await Ee(e,{userId:i.user.id,email:i.user.email}),s=await t.createAuthorizationURL({state:n.state,codeVerifier:n.codeVerifier,redirectURI:`${e.context.baseURL}/callback/${t.id}`});return e.json({url:s.toString(),redirect:!0})});var ji=a((e,i)=>{let r={};for(let[o,t]of Object.entries(e))r[o]=n=>t({...n,context:{...i,...n.context}}),r[o].path=t.path,r[o].method=t.method,r[o].options=t.options,r[o].headers=t.headers;return r},"shimContext");function io(e){let i=e;return{newRole(r){return zr(r)}}}a(io,"createAccessControl");function zr(e){return{statements:e,authorize(i,r){for(let[o,t]of Object.entries(i)){let n=e[o];return n?(r==="OR"?t.some(d=>n.includes(d)):t.every(d=>n.includes(d)))?{success:!0}:{success:!1,error:`Unauthorized to access resource "${o}"`}:{success:!1,error:`You are not allowed to access resource: ${o}`}}return{success:!1,error:"Not authorized"}}}}a(zr,"role");var xr={organization:["update","delete"],member:["create","update","delete"],invitation:["create","cancel"]},Io=io(xr),Br=Io.newRole({organization:["update"],invitation:["create","cancel"],member:["create","update","delete"]}),Fr=Io.newRole({organization:["update","delete"],member:["create","update","delete"],invitation:["create","cancel"]}),Mr=Io.newRole({organization:[],member:[],invitation:[]}),zi={admin:Br,owner:Fr,member:Mr};var Vr={proto:/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,constructor:/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,protoShort:/"__proto__"\s*:/,constructorShort:/"constructor"\s*:/},qr=/^\s*["[{]|^\s*-?\d{1,16}(\.\d{1,17})?([Ee][+-]?\d+)?\s*$/,xi={true:!0,false:!1,null:null,undefined:void 0,nan:Number.NaN,infinity:Number.POSITIVE_INFINITY,"-infinity":Number.NEGATIVE_INFINITY},Hr=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d{1,7}))?(?:Z|([+-])(\d{2}):(\d{2}))$/;function $r(e){return e instanceof Date&&!isNaN(e.getTime())}a($r,"isValidDate");function Zr(e){let i=Hr.exec(e);if(!i)return null;let[,r,o,t,n,s,d,A,c,K,m]=i,u=new Date(Date.UTC(parseInt(r,10),parseInt(o,10)-1,parseInt(t,10),parseInt(n,10),parseInt(s,10),parseInt(d,10),A?parseInt(A.padEnd(3,"0"),10):0));if(c){let l=(parseInt(K,10)*60+parseInt(m,10))*(c==="+"?-1:1);u.setUTCMinutes(u.getUTCMinutes()+l)}return $r(u)?u:null}a(Zr,"parseISODate");function Qr(e,i={}){let{strict:r=!1,warnings:o=!1,reviver:t,parseDates:n=!0}=i;if(typeof e!="string")return e;let s=e.trim();if(s[0]==='"'&&s.endsWith('"')&&!s.slice(1,-1).includes('"'))return s.slice(1,-1);let d=s.toLowerCase();if(d.length<=9&&d in xi)return xi[d];if(!qr.test(s)){if(r)throw new SyntaxError("[better-json] Invalid JSON");return e}if(Object.entries(Vr).some(([c,K])=>{let m=K.test(s);return m&&o&&console.warn(`[better-json] Detected potential prototype pollution attempt using ${c} pattern`),m})&&r)throw new Error("[better-json] Potential prototype pollution attempt detected");try{return JSON.parse(s,a((K,m)=>{if(K==="__proto__"||K==="constructor"&&m&&typeof m=="object"&&"prototype"in m){o&&console.warn(`[better-json] Dropping "${K}" key to prevent prototype pollution`);return}if(n&&typeof m=="string"){let u=Zr(m);if(u)return u}return t?t(K,m):m},"secureReviver"))}catch(c){if(r)throw c;return e}}a(Qr,"betterJSONParse");function Gr(e,i={strict:!0}){return Qr(e,i)}a(Gr,"parseJSON");var Bi=Gr;var q=a((e,i)=>{let r=e.adapter;return{findOrganizationBySlug:a(async o=>await r.findOne({model:"organization",where:[{field:"slug",value:o}]}),"findOrganizationBySlug"),createOrganization:a(async o=>{let t=await r.create({model:"organization",data:{...o.organization,metadata:o.organization.metadata?JSON.stringify(o.organization.metadata):void 0}}),n=await r.create({model:"member",data:{organizationId:t.id,userId:o.user.id,createdAt:new Date,role:i?.creatorRole||"owner"}});return{...t,metadata:t.metadata?JSON.parse(t.metadata):void 0,members:[{...n,user:{id:o.user.id,name:o.user.name,email:o.user.email,image:o.user.image}}]}},"createOrganization"),findMemberByEmail:a(async o=>{let t=await r.findOne({model:"user",where:[{field:"email",value:o.email}]});if(!t)return null;let n=await r.findOne({model:"member",where:[{field:"organizationId",value:o.organizationId},{field:"userId",value:t.id}]});return n?{...n,user:{id:t.id,name:t.name,email:t.email,image:t.image}}:null},"findMemberByEmail"),findMemberByOrgId:a(async o=>{let[t,n]=await Promise.all([await r.findOne({model:"member",where:[{field:"userId",value:o.userId},{field:"organizationId",value:o.organizationId}]}),await r.findOne({model:"user",where:[{field:"id",value:o.userId}]})]);return!n||!t?null:{...t,user:{id:n.id,name:n.name,email:n.email,image:n.image}}},"findMemberByOrgId"),findMemberById:a(async o=>{let t=await r.findOne({model:"member",where:[{field:"id",value:o}]});if(!t)return null;let n=await r.findOne({model:"user",where:[{field:"id",value:t.userId}]});return n?{...t,user:{id:n.id,name:n.name,email:n.email,image:n.image}}:null},"findMemberById"),createMember:a(async o=>await r.create({model:"member",data:o}),"createMember"),updateMember:a(async(o,t)=>await r.update({model:"member",where:[{field:"id",value:o}],update:{role:t}}),"updateMember"),deleteMember:a(async o=>await r.delete({model:"member",where:[{field:"id",value:o}]}),"deleteMember"),updateOrganization:a(async(o,t)=>{let n=await r.update({model:"organization",where:[{field:"id",value:o}],update:{...t,metadata:typeof t.metadata=="object"?JSON.stringify(t.metadata):t.metadata}});return n?{...n,metadata:n.metadata?Bi(n.metadata):void 0}:null},"updateOrganization"),deleteOrganization:a(async o=>(await r.delete({model:"member",where:[{field:"organizationId",value:o}]}),await r.delete({model:"invitation",where:[{field:"organizationId",value:o}]}),await r.delete({model:"organization",where:[{field:"id",value:o}]}),o),"deleteOrganization"),setActiveOrganization:a(async(o,t)=>await e.internalAdapter.updateSession(o,{activeOrganizationId:t}),"setActiveOrganization"),findOrganizationById:a(async o=>await r.findOne({model:"organization",where:[{field:"id",value:o}]}),"findOrganizationById"),findFullOrganization:a(async({organizationId:o,isSlug:t})=>{let n=await r.findOne({model:"organization",where:[{field:t?"slug":"id",value:o}]});if(!n)return null;let[s,d]=await Promise.all([r.findMany({model:"invitation",where:[{field:"organizationId",value:n.id}]}),r.findMany({model:"member",where:[{field:"organizationId",value:n.id}]})]);if(!n)return null;let A=d.map(u=>u.userId),c=await r.findMany({model:"user",where:[{field:"id",value:A,operator:"in"}]}),K=new Map(c.map(u=>[u.id,u])),m=d.map(u=>{let l=K.get(u.userId);if(!l)throw new re("Unexpected error: User not found for member");return{...u,user:{id:l.id,name:l.name,email:l.email,image:l.image}}});return{...n,invitations:s,members:m}},"findFullOrganization"),listOrganizations:a(async o=>{let t=await r.findMany({model:"member",where:[{field:"userId",value:o}]});if(!t||t.length===0)return[];let n=t.map(d=>d.organizationId);return await r.findMany({model:"organization",where:[{field:"id",value:n,operator:"in"}]})},"listOrganizations"),createInvitation:a(async({invitation:o,user:t})=>{let s=N(i?.invitationExpiresIn||1728e5);return await r.create({model:"invitation",data:{email:o.email,role:o.role,organizationId:o.organizationId,status:"pending",expiresAt:s,inviterId:t.id}})},"createInvitation"),findInvitationById:a(async o=>await r.findOne({model:"invitation",where:[{field:"id",value:o}]}),"findInvitationById"),findPendingInvitation:a(async o=>(await r.findMany({model:"invitation",where:[{field:"email",value:o.email},{field:"organizationId",value:o.organizationId},{field:"status",value:"pending"}]})).filter(n=>new Date(n.expiresAt)>new Date),"findPendingInvitation"),updateInvitation:a(async o=>await r.update({model:"invitation",where:[{field:"id",value:o.invitationId}],update:{status:o.status}}),"updateInvitation")}},"getOrgAdapter");import"better-call";var Z=P(async e=>({})),G=P({use:[I]},async e=>({session:e.context.session}));import{z as Y}from"zod";import{z as L}from"zod";var Fi=L.string(),Wr=L.enum(["pending","accepted","rejected","canceled"]).default("pending"),gp=L.object({id:L.string().default(X),name:L.string(),slug:L.string(),logo:L.string().nullish(),metadata:L.record(L.string()).or(L.string().transform(e=>JSON.parse(e))).nullish(),createdAt:L.date()}),fp=L.object({id:L.string().default(X),organizationId:L.string(),userId:L.string(),role:Fi,createdAt:L.date()}),hp=L.object({id:L.string().default(X),organizationId:L.string(),email:L.string(),role:Fi,status:Wr,inviterId:L.string(),expiresAt:L.date()});import{APIError as H}from"better-call";var b={YOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_ORGANIZATION:"You are not allowed to create a new organization",YOU_HAVE_REACHED_THE_MAXIMUM_NUMBER_OF_ORGANIZATIONS:"You have reached the maximum number of organizations",ORGANIZATION_ALREADY_EXISTS:"Organization already exists",ORGANIZATION_NOT_FOUND:"Organization not found",USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION:"User is not a member of the organization",YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_ORGANIZATION:"You are not allowed to update this organization",YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_ORGANIZATION:"You are not allowed to delete this organization",NO_ACTIVE_ORGANIZATION:"No active organization",USER_IS_ALREADY_A_MEMBER_OF_THIS_ORGANIZATION:"User is already a member of this organization",MEMBER_NOT_FOUND:"Member not found",ROLE_NOT_FOUND:"Role not found",YOU_CANNOT_LEAVE_THE_ORGANIZATION_AS_THE_ONLY_OWNER:"You cannot leave the organization as the only owner",YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_MEMBER:"You are not allowed to delete this member",YOU_ARE_NOT_ALLOWED_TO_INVITE_USERS_TO_THIS_ORGANIZATION:"You are not allowed to invite users to this organization",USER_IS_ALREADY_INVITED_TO_THIS_ORGANIZATION:"User is already invited to this organization",INVITATION_NOT_FOUND:"Invitation not found",YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION:"You are not the recipient of the invitation",YOU_ARE_NOT_ALLOWED_TO_CANCEL_THIS_INVITATION:"You are not allowed to cancel this invitation",INVITER_IS_NO_LONGER_A_MEMBER_OF_THE_ORGANIZATION:"Inviter is no longer a member of the organization"};var Mi=a(e=>p("/organization/invite-member",{method:"POST",use:[Z,G],body:Y.object({email:Y.string({description:"The email address of the user to invite"}),role:Y.string({description:"The role to assign to the user"}),organizationId:Y.string({description:"The organization ID to invite the user to"}).optional(),resend:Y.boolean({description:"Resend the invitation email, if the user is already invited"}).optional()}),metadata:{openapi:{description:"Invite a user to an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string"},email:{type:"string"},role:{type:"string"},organizationId:{type:"string"},inviterId:{type:"string"},status:{type:"string"},expiresAt:{type:"string"}},required:["id","email","role","organizationId","inviterId","status","expiresAt"]}}}}}}}},async i=>{if(!i.context.orgOptions.sendInvitationEmail)throw i.context.logger.warn("Invitation email is not enabled. Pass `sendInvitationEmail` to the plugin options to enable it."),new H("BAD_REQUEST",{message:"Invitation email is not enabled"});let r=i.context.session,o=i.body.organizationId||r.session.activeOrganizationId;if(!o)throw new H("BAD_REQUEST",{message:b.ORGANIZATION_NOT_FOUND});let t=q(i.context,i.context.orgOptions),n=await t.findMemberByOrgId({userId:r.user.id,organizationId:o});if(!n)throw new H("BAD_REQUEST",{message:b.MEMBER_NOT_FOUND});let s=i.context.roles[n.role];if(!s)throw new H("BAD_REQUEST",{message:b.ROLE_NOT_FOUND});if(s.authorize({invitation:["create"]}).error)throw new H("FORBIDDEN",{message:b.YOU_ARE_NOT_ALLOWED_TO_INVITE_USERS_TO_THIS_ORGANIZATION});if(await t.findMemberByEmail({email:i.body.email,organizationId:o}))throw new H("BAD_REQUEST",{message:b.USER_IS_ALREADY_A_MEMBER_OF_THIS_ORGANIZATION});if((await t.findPendingInvitation({email:i.body.email,organizationId:o})).length&&!i.body.resend)throw new H("BAD_REQUEST",{message:b.USER_IS_ALREADY_INVITED_TO_THIS_ORGANIZATION});let K=await t.createInvitation({invitation:{role:i.body.role,email:i.body.email,organizationId:o},user:r.user}),m=await t.findOrganizationById(o);if(!m)throw new H("BAD_REQUEST",{message:b.ORGANIZATION_NOT_FOUND});return await i.context.orgOptions.sendInvitationEmail?.({id:K.id,role:K.role,email:K.email,organization:m,inviter:{...n,user:r.user}},i.request),i.json(K)}),"createInvitation"),Vi=p("/organization/accept-invitation",{method:"POST",body:Y.object({invitationId:Y.string({description:"The ID of the invitation to accept"})}),use:[Z,G],metadata:{openapi:{description:"Accept an invitation to an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{invitation:{type:"object"},member:{type:"object"}}}}}}}}}},async e=>{let i=e.context.session,r=q(e.context,e.context.orgOptions),o=await r.findInvitationById(e.body.invitationId);if(!o||o.expiresAt<new Date||o.status!=="pending")throw new H("BAD_REQUEST",{message:b.INVITATION_NOT_FOUND});if(o.email!==i.user.email)throw new H("FORBIDDEN",{message:b.YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION});let t=await r.updateInvitation({invitationId:e.body.invitationId,status:"accepted"}),n=await r.createMember({organizationId:o.organizationId,userId:i.user.id,role:o.role,createdAt:new Date});return await r.setActiveOrganization(i.session.token,o.organizationId),t?e.json({invitation:t,member:n}):e.json(null,{status:400,body:{message:b.INVITATION_NOT_FOUND}})}),qi=p("/organization/reject-invitation",{method:"POST",body:Y.object({invitationId:Y.string({description:"The ID of the invitation to reject"})}),use:[Z,G],metadata:{openapi:{description:"Reject an invitation to an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{invitation:{type:"object"},member:{type:"null"}}}}}}}}}},async e=>{let i=e.context.session,r=q(e.context,e.context.orgOptions),o=await r.findInvitationById(e.body.invitationId);if(!o||o.expiresAt<new Date||o.status!=="pending")throw new H("BAD_REQUEST",{message:"Invitation not found!"});if(o.email!==i.user.email)throw new H("FORBIDDEN",{message:b.YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION});let t=await r.updateInvitation({invitationId:e.body.invitationId,status:"rejected"});return e.json({invitation:t,member:null})}),Hi=p("/organization/cancel-invitation",{method:"POST",body:Y.object({invitationId:Y.string({description:"The ID of the invitation to cancel"})}),use:[Z,G],openapi:{description:"Cancel an invitation to an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{invitation:{type:"object"}}}}}}}}},async e=>{let i=e.context.session,r=q(e.context,e.context.orgOptions),o=await r.findInvitationById(e.body.invitationId);if(!o)throw new H("BAD_REQUEST",{message:b.INVITATION_NOT_FOUND});let t=await r.findMemberByOrgId({userId:i.user.id,organizationId:o.organizationId});if(!t)throw new H("BAD_REQUEST",{message:b.MEMBER_NOT_FOUND});if(e.context.roles[t.role].authorize({invitation:["cancel"]}).error)throw new H("FORBIDDEN",{message:b.YOU_ARE_NOT_ALLOWED_TO_CANCEL_THIS_INVITATION});let s=await r.updateInvitation({invitationId:e.body.invitationId,status:"canceled"});return e.json(s)}),$i=p("/organization/get-invitation",{method:"GET",use:[Z],requireHeaders:!0,query:Y.object({id:Y.string({description:"The ID of the invitation to get"})}),metadata:{openapi:{description:"Get an invitation by ID",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string"},email:{type:"string"},role:{type:"string"},organizationId:{type:"string"},inviterId:{type:"string"},status:{type:"string"},expiresAt:{type:"string"},organizationName:{type:"string"},organizationSlug:{type:"string"},inviterEmail:{type:"string"}},required:["id","email","role","organizationId","inviterId","status","expiresAt","organizationName","organizationSlug","inviterEmail"]}}}}}}}},async e=>{let i=await _(e);if(!i)throw new H("UNAUTHORIZED",{message:"Not authenticated"});let r=q(e.context,e.context.orgOptions),o=await r.findInvitationById(e.query.id);if(!o||o.status!=="pending"||o.expiresAt<new Date)throw new H("BAD_REQUEST",{message:"Invitation not found!"});if(o.email!==i.user.email)throw new H("FORBIDDEN",{message:b.YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION});let t=await r.findOrganizationById(o.organizationId);if(!t)throw new H("BAD_REQUEST",{message:b.ORGANIZATION_NOT_FOUND});let n=await r.findMemberByOrgId({userId:o.inviterId,organizationId:o.organizationId});if(!n)throw new H("BAD_REQUEST",{message:b.INVITER_IS_NO_LONGER_A_MEMBER_OF_THE_ORGANIZATION});return e.json({...o,organizationName:t.name,organizationSlug:t.slug,inviterEmail:n.user.email})});import{z as se}from"zod";import{APIError as be}from"better-call";var Zi=a(()=>p("/organization/add-member",{method:"POST",body:se.object({userId:se.string(),role:se.string(),organizationId:se.string().optional()}),use:[Z],metadata:{SERVER_ONLY:!0}},async e=>{let i=e.body.userId?await _(e).catch(d=>null):null,r=e.body.organizationId||i?.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:b.NO_ACTIVE_ORGANIZATION}});let o=q(e.context,e.context.orgOptions),t=await e.context.internalAdapter.findUserById(e.body.userId);if(!t)throw new be("BAD_REQUEST",{message:h.USER_NOT_FOUND});if(await o.findMemberByEmail({email:t.email,organizationId:r}))throw new be("BAD_REQUEST",{message:b.USER_IS_ALREADY_A_MEMBER_OF_THIS_ORGANIZATION});let s=await o.createMember({id:X(),organizationId:r,userId:t.id,role:e.body.role,createdAt:new Date});return e.json(s)}),"addMember"),Qi=p("/organization/remove-member",{method:"POST",body:se.object({memberIdOrEmail:se.string({description:"The ID or email of the member to remove"}),organizationId:se.string({description:"The ID of the organization to remove the member from. If not provided, the active organization will be used"}).optional()}),use:[Z,G],metadata:{openapi:{description:"Remove a member from an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{member:{type:"object",properties:{id:{type:"string"},userId:{type:"string"},organizationId:{type:"string"},role:{type:"string"}},required:["id","userId","organizationId","role"]}},required:["member"]}}}}}}}},async e=>{let i=e.context.session,r=e.body.organizationId||i.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:b.NO_ACTIVE_ORGANIZATION}});let o=q(e.context,e.context.orgOptions),t=await o.findMemberByOrgId({userId:i.user.id,organizationId:r});if(!t)throw new be("BAD_REQUEST",{message:b.MEMBER_NOT_FOUND});let n=e.context.roles[t.role];if(!n)throw new be("BAD_REQUEST",{message:b.ROLE_NOT_FOUND});let s=i.user.email===e.body.memberIdOrEmail||t.id===e.body.memberIdOrEmail;if(s&&t.role===(e.context.orgOptions?.creatorRole||"owner"))throw new be("BAD_REQUEST",{message:b.YOU_CANNOT_LEAVE_THE_ORGANIZATION_AS_THE_ONLY_OWNER});if(!(s||n.authorize({member:["delete"]}).success))throw new be("UNAUTHORIZED",{message:b.YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_MEMBER});let c=null;if(e.body.memberIdOrEmail.includes("@")?c=await o.findMemberByEmail({email:e.body.memberIdOrEmail,organizationId:r}):c=await o.findMemberById(e.body.memberIdOrEmail),c?.organizationId!==r)throw new be("BAD_REQUEST",{message:b.MEMBER_NOT_FOUND});return await o.deleteMember(c.id),i.user.id===c.userId&&i.session.activeOrganizationId===c.organizationId&&await o.setActiveOrganization(i.session.token,null),e.json({member:c})}),Gi=a(e=>p("/organization/update-member-role",{method:"POST",body:se.object({role:se.string(),memberId:se.string(),organizationId:se.string().optional()}),use:[Z,G],metadata:{openapi:{description:"Update the role of a member in an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{member:{type:"object",properties:{id:{type:"string"},userId:{type:"string"},organizationId:{type:"string"},role:{type:"string"}},required:["id","userId","organizationId","role"]}},required:["member"]}}}}}}}},async i=>{let r=i.context.session,o=i.body.organizationId||r.session.activeOrganizationId;if(!o)return i.json(null,{status:400,body:{message:b.NO_ACTIVE_ORGANIZATION}});let t=q(i.context,i.context.orgOptions),n=await t.findMemberByOrgId({userId:r.user.id,organizationId:o});if(!n)return i.json(null,{status:400,body:{message:b.MEMBER_NOT_FOUND}});let s=i.context.roles[n.role];if(!s)return i.json(null,{status:400,body:{message:b.ROLE_NOT_FOUND}});if(s.authorize({member:["update"]}).error||i.body.role==="owner"&&n.role!=="owner")return i.json(null,{body:{message:"You are not allowed to update this member"},status:403});let A=await t.updateMember(i.body.memberId,i.body.role);return A?i.json(A):i.json(null,{status:400,body:{message:b.MEMBER_NOT_FOUND}})}),"updateMemberRole"),Wi=p("/organization/get-active-member",{method:"GET",use:[Z,G],metadata:{openapi:{description:"Get the active member in the organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string"},userId:{type:"string"},organizationId:{type:"string"},role:{type:"string"}},required:["id","userId","organizationId","role"]}}}}}}}},async e=>{let i=e.context.session,r=i.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:b.NO_ACTIVE_ORGANIZATION}});let t=await q(e.context,e.context.orgOptions).findMemberByOrgId({userId:i.user.id,organizationId:r});return t?e.json(t):e.json(null,{status:400,body:{message:b.MEMBER_NOT_FOUND}})});import{z as v}from"zod";import{APIError as ue}from"better-call";var Ji=p("/organization/create",{method:"POST",body:v.object({name:v.string({description:"The name of the organization"}),slug:v.string({description:"The slug of the organization"}),userId:v.string({description:"The user id of the organization creator. If not provided, the current user will be used. Should only be used by admins or when called by the server."}).optional(),logo:v.string({description:"The logo of the organization"}).optional(),metadata:v.record(v.string(),v.any(),{description:"The metadata of the organization"}).optional()}),use:[Z],metadata:{openapi:{description:"Create an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",description:"The organization that was created",$ref:"#/components/schemas/Organization"}}}}}}}},async e=>{let i=await _(e);if(!i&&(e.request||e.headers))throw new ue("UNAUTHORIZED");let r=i?.user||null;if(!r){if(!e.body.userId)throw new ue("UNAUTHORIZED");r=await e.context.internalAdapter.findUserById(e.body.userId)}if(!r)return e.json(null,{status:401});let o=e.context.orgOptions;if(!(typeof o?.allowUserToCreateOrganization=="function"?await o.allowUserToCreateOrganization(r):o?.allowUserToCreateOrganization===void 0?!0:o.allowUserToCreateOrganization))throw new ue("FORBIDDEN",{message:b.YOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_ORGANIZATION});let n=q(e.context,o),s=await n.listOrganizations(r.id);if(typeof o.organizationLimit=="number"?s.length>=o.organizationLimit:typeof o.organizationLimit=="function"?await o.organizationLimit(r):!1)throw new ue("FORBIDDEN",{message:b.YOU_HAVE_REACHED_THE_MAXIMUM_NUMBER_OF_ORGANIZATIONS});if(await n.findOrganizationBySlug(e.body.slug))throw new ue("BAD_REQUEST",{message:b.ORGANIZATION_ALREADY_EXISTS});let c=await n.createOrganization({organization:{id:X(),slug:e.body.slug,name:e.body.name,logo:e.body.logo,createdAt:new Date,metadata:e.body.metadata},user:r});return e.context.session&&await n.setActiveOrganization(e.context.session.session.token,c.id),e.json(c)}),Xi=p("/organization/update",{method:"POST",body:v.object({data:v.object({name:v.string({description:"The name of the organization"}).optional(),slug:v.string({description:"The slug of the organization"}).optional(),logo:v.string({description:"The logo of the organization"}).optional(),metadata:v.record(v.string(),v.any(),{description:"The metadata of the organization"}).optional()}).partial(),organizationId:v.string().optional()}),requireHeaders:!0,use:[Z],metadata:{openapi:{description:"Update an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",description:"The updated organization",$ref:"#/components/schemas/Organization"}}}}}}}},async e=>{let i=await e.context.getSession(e);if(!i)throw new ue("UNAUTHORIZED",{message:"User not found"});let r=e.body.organizationId||i.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:b.ORGANIZATION_NOT_FOUND}});let o=q(e.context,e.context.orgOptions),t=await o.findMemberByOrgId({userId:i.user.id,organizationId:r});if(!t)return e.json(null,{status:400,body:{message:b.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION}});let n=e.context.roles[t.role];if(!n)return e.json(null,{status:400,body:{message:"Role not found!"}});if(n.authorize({organization:["update"]}).error)return e.json(null,{body:{message:b.YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_ORGANIZATION},status:403});let d=await o.updateOrganization(r,e.body.data);return e.json(d)}),Yi=p("/organization/delete",{method:"POST",body:v.object({organizationId:v.string({description:"The organization id to delete"})}),requireHeaders:!0,use:[Z],metadata:{openapi:{description:"Delete an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"string",description:"The organization id that was deleted"}}}}}}}},async e=>{let i=await e.context.getSession(e);if(!i)return e.json(null,{status:401});let r=e.body.organizationId;if(!r)return e.json(null,{status:400,body:{message:b.ORGANIZATION_NOT_FOUND}});let o=q(e.context,e.context.orgOptions),t=await o.findMemberByOrgId({userId:i.user.id,organizationId:r});if(!t)return e.json(null,{status:400,body:{message:b.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION}});let n=e.context.roles[t.role];if(!n)return e.json(null,{status:400,body:{message:"Role not found!"}});if(n.authorize({organization:["delete"]}).error)throw new ue("FORBIDDEN",{message:b.YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_ORGANIZATION});return r===i.session.activeOrganizationId&&await o.setActiveOrganization(i.session.token,null),await o.deleteOrganization(r),e.json(r)}),et=p("/organization/get-full-organization",{method:"GET",query:v.optional(v.object({organizationId:v.string({description:"The organization id to get"}).optional(),organizationSlug:v.string({description:"The organization slug to get"}).optional()})),requireHeaders:!0,use:[Z,G],metadata:{openapi:{description:"Get the full organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",description:"The organization",$ref:"#/components/schemas/Organization"}}}}}}}},async e=>{let i=e.context.session,r=e.query?.organizationSlug||e.query?.organizationId||i.session.activeOrganizationId;if(!r)return e.json(null,{status:200});let t=await q(e.context,e.context.orgOptions).findFullOrganization({organizationId:r,isSlug:!!e.query?.organizationSlug});if(!t)throw new ue("BAD_REQUEST",{message:b.ORGANIZATION_NOT_FOUND});return e.json(t)}),ot=p("/organization/set-active",{method:"POST",body:v.object({organizationId:v.string({description:"The organization id to set as active. It can be null to unset the active organization"}).nullable().optional(),organizationSlug:v.string({description:"The organization slug to set as active. It can be null to unset the active organization if organizationId is not provided"}).optional()}),use:[G,Z],metadata:{openapi:{description:"Set the active organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",description:"The organization",$ref:"#/components/schemas/Organization"}}}}}}}},async e=>{let i=q(e.context,e.context.orgOptions),r=e.context.session,o=e.body.organizationSlug||e.body.organizationId;if(o===null){if(!r.session.activeOrganizationId)return e.json(null);let A=await i.setActiveOrganization(r.session.token,null);return await C(e,{session:A,user:r.user}),e.json(null)}if(!o){let d=r.session.activeOrganizationId;if(!d)return e.json(null);o=d}let t=await i.findFullOrganization({organizationId:o,isSlug:!!e.body.organizationSlug});if(!t?.members.find(d=>d.userId===r.user.id))throw await i.setActiveOrganization(r.session.token,null),new ue("FORBIDDEN",{message:b.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION});if(!t)throw new ue("BAD_REQUEST",{message:b.ORGANIZATION_NOT_FOUND});let s=await i.setActiveOrganization(r.session.token,t.id);return await C(e,{session:s,user:r.user}),e.json(t)}),it=p("/organization/list",{method:"GET",use:[Z,G],metadata:{openapi:{description:"List all organizations",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{$ref:"#/components/schemas/Organization"}}}}}}}}},async e=>{let r=await q(e.context,e.context.orgOptions).listOrganizations(e.context.session.user.id);return e.json(r)});var Jr=io({name:["action"]}),Ku=Jr.newRole({name:["action"]}),pu=a(e=>{let i={createOrganization:Ji,updateOrganization:Xi,deleteOrganization:Yi,setActiveOrganization:ot,getFullOrganization:et,listOrganizations:it,createInvitation:Mi(e),cancelInvitation:Hi,acceptInvitation:Vi,getInvitation:$i,rejectInvitation:qi,addMember:Zi(),removeMember:Qi,updateMemberRole:Gi(e),getActiveMember:Wi},r={...zi,...e?.roles};return{id:"organization",endpoints:{...ji(i,{orgOptions:e||{},roles:r,getSession:a(async t=>await _(t),"getSession")}),hasPermission:p("/organization/has-permission",{method:"POST",requireHeaders:!0,body:Se.object({organizationId:Se.string().optional(),permission:Se.record(Se.string(),Se.array(Se.string()))}),use:[G],metadata:{openapi:{description:"Check if the user has permission",requestBody:{content:{"application/json":{schema:{type:"object",properties:{permission:{type:"object",description:"The permission to check"}},required:["permission"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{error:{type:"string"},success:{type:"boolean"}},required:["success"]}}}}}}}},async t=>{let n=t.body.organizationId||t.context.session.session.activeOrganizationId;if(!n)throw new tt("BAD_REQUEST",{message:b.NO_ACTIVE_ORGANIZATION});let d=await q(t.context).findMemberByOrgId({userId:t.context.session.user.id,organizationId:n});if(!d)throw new tt("UNAUTHORIZED",{message:b.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION});let c=r[d.role].authorize(t.body.permission);return c.error?t.json({error:c.error,success:!1},{status:403}):t.json({error:null,success:!0})})},schema:{session:{fields:{activeOrganizationId:{type:"string",required:!1,fieldName:e?.schema?.session?.fields?.activeOrganizationId}}},organization:{modelName:e?.schema?.organization?.modelName,fields:{name:{type:"string",required:!0,fieldName:e?.schema?.organization?.fields?.name},slug:{type:"string",unique:!0,fieldName:e?.schema?.organization?.fields?.slug},logo:{type:"string",required:!1,fieldName:e?.schema?.organization?.fields?.logo},createdAt:{type:"date",required:!0,fieldName:e?.schema?.organization?.fields?.createdAt},metadata:{type:"string",required:!1,fieldName:e?.schema?.organization?.fields?.metadata}}},member:{modelName:e?.schema?.member?.modelName,fields:{organizationId:{type:"string",required:!0,references:{model:"organization",field:"id"},fieldName:e?.schema?.member?.fields?.organizationId},userId:{type:"string",required:!0,fieldName:e?.schema?.member?.fields?.userId,references:{model:"user",field:"id"}},role:{type:"string",required:!0,defaultValue:"member",fieldName:e?.schema?.member?.fields?.role},createdAt:{type:"date",required:!0,fieldName:e?.schema?.member?.fields?.createdAt}}},invitation:{modelName:e?.schema?.invitation?.modelName,fields:{organizationId:{type:"string",required:!0,references:{model:"organization",field:"id"},fieldName:e?.schema?.invitation?.fields?.organizationId},email:{type:"string",required:!0,fieldName:e?.schema?.invitation?.fields?.email},role:{type:"string",required:!1,fieldName:e?.schema?.invitation?.fields?.role},status:{type:"string",required:!0,defaultValue:"pending",fieldName:e?.schema?.invitation?.fields?.status},expiresAt:{type:"date",required:!0,fieldName:e?.schema?.invitation?.fields?.expiresAt},inviterId:{type:"string",references:{model:"user",field:"id"},fieldName:e?.schema?.invitation?.fields?.inviterId,required:!0}}}},$Infer:{Organization:{},Invitation:{},Member:{},ActiveOrganization:{}},$ERROR_CODES:b}},"organization");import{z as so}from"zod";import{z as he}from"zod";import{APIError as Me}from"better-call";var to="two_factor";var ro="trust_device";import{z as rt}from"zod";import{createHMAC as Xr}from"@better-auth/utils/hmac";import"@better-auth/utils/base64";var Oe=P({body:rt.object({trustDevice:rt.boolean().optional()})},async e=>{let i=await _(e);if(!i){let r=e.context.createAuthCookie(to),o=await e.getSignedCookie(r.name,e.context.secret);if(!o)throw new Me("UNAUTHORIZED",{message:"invalid two factor cookie"});let t=await e.context.internalAdapter.findUserById(o);if(!t)throw new Me("UNAUTHORIZED",{message:"invalid two factor cookie"});let n=await e.context.internalAdapter.createSession(o,e.request);if(!n)throw new Me("INTERNAL_SERVER_ERROR",{message:"failed to create session"});return{valid:a(async()=>{if(await C(e,{session:n,user:t}),e.body.trustDevice){let s=e.context.createAuthCookie(ro,{maxAge:2592e3}),d=await Xr("SHA-256","base64urlnopad").sign(e.context.secret,`${t.id}!${n.token}`);await e.setSignedCookie(s.name,`${d}!${n.token}`,e.context.secret,s.attributes)}return e.json({token:n.token})},"valid"),invalid:a(async()=>{throw new Me("UNAUTHORIZED",{message:"invalid two factor authentication"})},"invalid"),session:{session:n,user:t}}}return{valid:a(async()=>e.json({token:i.session.token}),"valid"),invalid:a(async()=>{throw new Me("UNAUTHORIZED",{message:"invalid two factor authentication"})},"invalid"),session:i}});import{APIError as Ve}from"better-call";var W={OTP_NOT_ENABLED:"OTP not enabled",OTP_HAS_EXPIRED:"OTP has expired",TOTP_NOT_ENABLED:"TOTP not enabled",TWO_FACTOR_NOT_ENABLED:"Two factor isn't enabled",BACKUP_CODES_NOT_ENABLED:"Backup codes aren't enabled",INVALID_BACKUP_CODE:"Invalid backup code"};function Yr(e){return Array.from({length:e?.amount??10}).fill(null).map(()=>R(e?.length??10,"a-z","0-9","A-Z")).map(i=>`${i.slice(0,5)}-${i.slice(5)}`)}a(Yr,"generateBackupCodesFn");async function Ro(e,i){let r=e,o=i?.customBackupCodesGenerate?i.customBackupCodesGenerate():Yr(),t=await Ae({data:JSON.stringify(o),key:r});return{backupCodes:o,encryptedBackupCodes:t}}a(Ro,"generateBackupCodes");async function en(e,i){let r=await nt(e.backupCodes,i);return r?{status:r.includes(e.code),updated:r.filter(o=>o!==e.code)}:{status:!1,updated:null}}a(en,"verifyBackupCode");async function nt(e,i){let r=Buffer.from(await we({key:i,data:e})).toString("utf-8"),o=JSON.parse(r),t=he.array(he.string()).safeParse(o);return t.success?t.data:null}a(nt,"getBackupCodes");var st=a(e=>{let i="twoFactor";return{id:"backup_code",endpoints:{verifyBackupCode:p("/two-factor/verify-backup-code",{method:"POST",body:he.object({code:he.string(),disableSession:he.boolean().optional()}),use:[Oe]},async r=>{let o=r.context.session.user,t=await r.context.adapter.findOne({model:i,where:[{field:"userId",value:o.id}]});if(!t)throw new Ve("BAD_REQUEST",{message:W.BACKUP_CODES_NOT_ENABLED});let n=await en({backupCodes:t.backupCodes,code:r.body.code},r.context.secret);if(!n.status)throw new Ve("UNAUTHORIZED",{message:W.INVALID_BACKUP_CODE});let s=await Ae({key:r.context.secret,data:JSON.stringify(n.updated)});return await r.context.adapter.updateMany({model:i,update:{backupCodes:s},where:[{field:"userId",value:o.id}]}),r.body.disableSession||await C(r,{session:r.context.session.session,user:o}),r.json({user:o,session:r.context.session})}),generateBackupCodes:p("/two-factor/generate-backup-codes",{method:"POST",body:he.object({password:he.string()}),use:[I]},async r=>{let o=r.context.session.user;if(!o.twoFactorEnabled)throw new Ve("BAD_REQUEST",{message:W.TWO_FACTOR_NOT_ENABLED});await r.context.password.checkPassword(o.id,r);let t=await Ro(r.context.secret,e);return await r.context.adapter.update({model:i,update:{backupCodes:t.encryptedBackupCodes},where:[{field:"userId",value:r.context.session.user.id}]}),r.json({status:!0,backupCodes:t.backupCodes})}),viewBackupCodes:p("/two-factor/view-backup-codes",{method:"GET",body:he.object({userId:he.string()}),metadata:{SERVER_ONLY:!0}},async r=>{let o=await r.context.adapter.findOne({model:i,where:[{field:"userId",value:r.body.userId}]});if(!o)throw new Ve("BAD_REQUEST",{message:"Backup codes aren't enabled"});let t=await nt(o.backupCodes,r.context.secret);if(!t)throw new Ve("BAD_REQUEST",{message:W.BACKUP_CODES_NOT_ENABLED});return r.json({status:!0,backupCodes:t})})}}},"backupCode2fa");import{APIError as qe}from"better-call";import{z as at}from"zod";var dt=a(e=>{let i={...e,digits:e?.digits||6,period:(e?.period||3)*60*1e3},r="twoFactor",o=p("/two-factor/send-otp",{method:"POST",use:[Oe],metadata:{openapi:{summary:"Send two factor OTP",description:"Send two factor OTP to the user",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async n=>{if(!e||!e.sendOTP)throw n.context.logger.error("send otp isn't configured. Please configure the send otp function on otp options."),new qe("BAD_REQUEST",{message:"otp isn't configured"});let s=n.context.session.user;if(!await n.context.adapter.findOne({model:r,where:[{field:"userId",value:s.id}]}))throw new qe("BAD_REQUEST",{message:W.OTP_NOT_ENABLED});let A=R(i.digits,"0-9");return await n.context.internalAdapter.createVerificationValue({value:A,identifier:`2fa-otp-${s.id}`,expiresAt:new Date(Date.now()+i.period)}),await e.sendOTP({user:s,otp:A},n.request),n.json({status:!0})}),t=p("/two-factor/verify-otp",{method:"POST",body:at.object({code:at.string({description:"The otp code to verify"})}),use:[Oe],metadata:{openapi:{summary:"Verify two factor OTP",description:"Verify two factor OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async n=>{let s=n.context.session.user;if(!s.twoFactorEnabled)throw new qe("BAD_REQUEST",{message:"two factor isn't enabled"});if(!await n.context.adapter.findOne({model:r,where:[{field:"userId",value:s.id}]}))throw new qe("BAD_REQUEST",{message:W.OTP_NOT_ENABLED});let A=await n.context.internalAdapter.findVerificationValue(`2fa-otp-${s.id}`);if(!A||A.expiresAt<new Date)throw new qe("BAD_REQUEST",{message:W.OTP_HAS_EXPIRED});return A.value===n.body.code?n.context.valid():n.context.invalid()});return{id:"otp",endpoints:{sendTwoFactorOTP:o,verifyTwoFactorOTP:t}}},"otp2fa");import{APIError as ve}from"better-call";import{z as no}from"zod";import{createOTP as _o}from"@better-auth/utils/otp";var At=a(e=>{let i={...e,digits:e?.digits||6,period:e?.period||30},r="twoFactor",o=p("/totp/generate",{method:"POST",use:[I],metadata:{openapi:{summary:"Generate TOTP code",description:"Use this endpoint to generate a TOTP code",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{code:{type:"string"}}}}}}}}}},async s=>{if(e?.disable)throw s.context.logger.error("totp isn't configured. please pass totp option on two factor plugin to enable totp"),new ve("BAD_REQUEST",{message:"totp isn't configured"});let d=s.context.session.user,A=await s.context.adapter.findOne({model:r,where:[{field:"userId",value:d.id}]});if(!A)throw new ve("BAD_REQUEST",{message:W.TOTP_NOT_ENABLED});return{code:await _o(A.secret,{period:i.period,digits:i.digits}).totp()}}),t=p("/two-factor/get-totp-uri",{method:"POST",use:[I],body:no.object({password:no.string({description:"User password"})}),metadata:{openapi:{summary:"Get TOTP URI",description:"Use this endpoint to get the TOTP URI",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{totpURI:{type:"string"}}}}}}}}}},async s=>{if(e?.disable)throw s.context.logger.error("totp isn't configured. please pass totp option on two factor plugin to enable totp"),new ve("BAD_REQUEST",{message:"totp isn't configured"});let d=s.context.session.user,A=await s.context.adapter.findOne({model:r,where:[{field:"userId",value:d.id}]});if(!A||!d.twoFactorEnabled)throw new ve("BAD_REQUEST",{message:W.TOTP_NOT_ENABLED});return await s.context.password.checkPassword(d.id,s),{totpURI:_o(A.secret,{digits:i.digits,period:i.period}).url(e?.issuer||s.context.appName,d.email)}}),n=p("/two-factor/verify-totp",{method:"POST",body:no.object({code:no.string({description:"The otp code to verify"})}),use:[Oe],metadata:{openapi:{summary:"Verify two factor TOTP",description:"Verify two factor TOTP",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async s=>{if(e?.disable)throw s.context.logger.error("totp isn't configured. please pass totp option on two factor plugin to enable totp"),new ve("BAD_REQUEST",{message:"totp isn't configured"});let d=s.context.session.user,A=await s.context.adapter.findOne({model:r,where:[{field:"userId",value:d.id}]});if(!A)throw new ve("BAD_REQUEST",{message:W.TOTP_NOT_ENABLED});let c=await we({key:s.context.secret,data:A.secret});if(!await _o(c,{period:i.period,digits:i.digits}).verify(s.body.code))return s.context.invalid();if(!d.twoFactorEnabled){let m=await s.context.internalAdapter.updateUser(d.id,{twoFactorEnabled:!0}),u=await s.context.internalAdapter.createSession(d.id,s.request,!1,s.context.session.session).catch(l=>{throw console.log(l),l});await s.context.internalAdapter.deleteSession(s.context.session.session.token),await C(s,{session:u,user:m})}return s.context.valid()});return{id:"totp",endpoints:{generateTOTP:o,getTOTPURI:t,verifyTOTP:n}}},"totp2fa");import{APIError as al}from"better-call";async function Uo(e,i){let o=(await e.context.internalAdapter.findAccounts(i.userId))?.find(s=>s.providerId==="credential"),t=o?.password;return!o||!t?!1:await e.context.password.verify({hash:t,password:i.password})}a(Uo,"validatePassword");import{APIError as Kt}from"better-call";var ct={user:{fields:{twoFactorEnabled:{type:"boolean",required:!1,defaultValue:!1,input:!1}}},twoFactor:{fields:{secret:{type:"string",required:!0,returned:!1},backupCodes:{type:"string",required:!0,returned:!1},userId:{type:"string",required:!0,returned:!1,references:{model:"user",field:"id"}}}}};import{createOTP as on}from"@better-auth/utils/otp";import"@better-auth/utils/base64";import{createHMAC as pt}from"@better-auth/utils/hmac";var Kl=a(e=>({id:"two-factor",$InferServerPlugin:{},atomListeners:[{matcher:a(i=>i.startsWith("/two-factor/"),"matcher"),signal:"$sessionSignal"}],pathMethods:{"/two-factor/disable":"POST","/two-factor/enable":"POST","/two-factor/send-otp":"POST","/two-factor/generate-backup-codes":"POST"},fetchPlugins:[{id:"two-factor",name:"two-factor",hooks:{async onSuccess(i){i.data?.twoFactorRedirect&&e?.onTwoFactorRedirect&&await e.onTwoFactorRedirect()}}}]}),"twoFactorClient");var Dl=a(e=>{let i={twoFactorTable:"twoFactor"},r=At(e?.totpOptions),o=st(e?.backupCodeOptions),t=dt(e?.otpOptions);return{id:"two-factor",endpoints:{...r.endpoints,...t.endpoints,...o.endpoints,enableTwoFactor:p("/two-factor/enable",{method:"POST",body:so.object({password:so.string({description:"User password"}).min(8)}),use:[I],metadata:{openapi:{summary:"Enable two factor authentication",description:"Use this endpoint to enable two factor authentication. This will generate a TOTP URI and backup codes. Once the user verifies the TOTP URI, the two factor authentication will be enabled.",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{totpURI:{type:"string",description:"TOTP URI"},backupCodes:{type:"array",items:{type:"string"},description:"Backup codes"}}}}}}}}}},async n=>{let s=n.context.session.user,{password:d}=n.body;if(!await Uo(n,{password:d,userId:s.id}))throw new Kt("BAD_REQUEST",{message:h.INVALID_PASSWORD});let c=R(32),K=await Ae({key:n.context.secret,data:c}),m=await Ro(n.context.secret,e?.backupCodeOptions);if(e?.skipVerificationOnEnable){let l=await n.context.internalAdapter.updateUser(s.id,{twoFactorEnabled:!0}),w=await n.context.internalAdapter.createSession(l.id,n.request,!1,n.context.session.session);await C(n,{session:w,user:s}),await n.context.internalAdapter.deleteSession(n.context.session.session.token)}await n.context.adapter.deleteMany({model:i.twoFactorTable,where:[{field:"userId",value:s.id}]}),await n.context.adapter.create({model:i.twoFactorTable,data:{secret:K,backupCodes:m.encryptedBackupCodes,userId:s.id}});let u=on(c,{digits:e?.totpOptions?.digits||6,period:e?.totpOptions?.period}).url(e?.issuer||"Better Auth",s.email);return n.json({totpURI:u,backupCodes:m.backupCodes})}),disableTwoFactor:p("/two-factor/disable",{method:"POST",body:so.object({password:so.string({description:"User password"}).min(8)}),use:[I],metadata:{openapi:{summary:"Disable two factor authentication",description:"Use this endpoint to disable two factor authentication.",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async n=>{let s=n.context.session.user,{password:d}=n.body;if(!await Uo(n,{password:d,userId:s.id}))throw new Kt("BAD_REQUEST",{message:"Invalid password"});await n.context.internalAdapter.updateUser(s.id,{twoFactorEnabled:!1}),await n.context.adapter.delete({model:i.twoFactorTable,where:[{field:"userId",value:s.id}]});let c=await n.context.internalAdapter.createSession(s.id,n.request,!1,n.context.session.session);return await C(n,{session:c,user:s}),await n.context.internalAdapter.deleteSession(n.context.session.session.token),n.json({status:!0})})},options:e,hooks:{after:[{matcher(n){return n.path==="/sign-in/email"||n.path==="/sign-in/username"||n.path==="/sign-in/phone-number"},handler:P(async n=>{let s=n.context.newSession;if(!s||!s?.user.twoFactorEnabled)return;let d=n.context.createAuthCookie(ro),A=await n.getSignedCookie(d.name,n.context.secret);if(A){let[K,m]=A.split("!"),u=await pt("SHA-256","base64urlnopad").sign(n.context.secret,`${s.user.id}!${m}`);if(K===u){let l=await pt("SHA-256","base64urlnopad").sign(n.context.secret,`${s.user.id}!${m}`);await n.setSignedCookie(d.name,`${l}!${s.session.token}`,n.context.secret,d.attributes);return}}$(n),await n.context.internalAdapter.deleteSession(s.session.token);let c=n.context.createAuthCookie(to,{maxAge:60*10});return await n.setSignedCookie(c.name,s.user.id,n.context.secret,c.attributes),n.json({twoFactorRedirect:!0})})}]},schema:pe(ct,e?.schema),rateLimit:[{pathMatcher(n){return n.startsWith("/two-factor/")},window:10,max:3}]}},"twoFactor");import{z as ao}from"zod";import{APIError as ke}from"better-call";var ut=a(()=>{let e={INVALID_USERNAME_OR_PASSWORD:"invalid username or password",EMAIL_NOT_VERIFIED:"email not verified",UNEXPECTED_ERROR:"unexpected error",USERNAME_IS_ALREADY_TAKEN:"username is already taken. please try another."};return{id:"username",endpoints:{signInUsername:p("/sign-in/username",{method:"POST",body:ao.object({username:ao.string({description:"The username of the user"}),password:ao.string({description:"The password of the user"}),rememberMe:ao.boolean({description:"Remember the user session"}).optional()}),metadata:{openapi:{summary:"Sign in with username",description:"Sign in with username",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"},session:{$ref:"#/components/schemas/Session"}}}}}}}}}},async i=>{let r=await i.context.adapter.findOne({model:"user",where:[{field:"username",value:i.body.username.toLowerCase()}]});if(!r)throw await i.context.password.hash(i.body.password),i.context.logger.error("User not found",{username:ut}),new ke("UNAUTHORIZED",{message:e.INVALID_USERNAME_OR_PASSWORD});if(!r.emailVerified&&i.context.options.emailAndPassword?.requireEmailVerification)throw await Co(i,r),new ke("UNAUTHORIZED",{message:e.INVALID_USERNAME_OR_PASSWORD});let o=await i.context.adapter.findOne({model:"account",where:[{field:"userId",value:r.id},{field:"providerId",value:"credential"}]});if(!o)throw new ke("UNAUTHORIZED",{message:e.INVALID_USERNAME_OR_PASSWORD});let t=o?.password;if(!t)throw i.context.logger.error("Password not found",{username:ut}),new ke("UNAUTHORIZED",{message:e.INVALID_USERNAME_OR_PASSWORD});if(!await i.context.password.verify({hash:t,password:i.body.password}))throw i.context.logger.error("Invalid password"),new ke("UNAUTHORIZED",{message:e.INVALID_USERNAME_OR_PASSWORD});let s=await i.context.internalAdapter.createSession(r.id,i.request,i.body.rememberMe===!1);return s?(await C(i,{session:s,user:r},i.body.rememberMe===!1),i.json({token:s.token})):i.json(null,{status:500,body:{message:h.FAILED_TO_CREATE_SESSION,status:500}})})},schema:{user:{fields:{username:{type:"string",required:!1,unique:!0,returned:!0,transform:{input(i){return i?.toString().toLowerCase()}}}}}},hooks:{before:[{matcher(i){return i.path==="/sign-up/email"},async handler(i){let r=i.body.username;if(r&&await i.context.adapter.findOne({model:"user",where:[{field:"username",value:r.toLowerCase()}]}))throw new ke("UNPROCESSABLE_ENTITY",{message:e.USERNAME_IS_ALREADY_TAKEN})}}]},$ERROR_CODES:W}},"username");import{serializeSigned as tn}from"better-call";import{createHMAC as rn}from"@better-auth/utils/hmac";var Jl=a(e=>({id:"bearer",hooks:{before:[{matcher(i){return!!(i.request?.headers.get("authorization")||i.headers?.get("authorization"))},handler:a(async i=>{let r=i.request?.headers.get("authorization")?.replace("Bearer ","")||i.headers?.get("authorization")?.replace("Bearer ","");if(!r)return;let o="";if(r.includes("."))o=r.replace("=","");else{if(e?.requireSignature)return;o=(await tn("",r,i.context.secret)).replace("=","")}try{let t=decodeURIComponent(o);if(!await rn("SHA-256","base64urlnopad").verify(i.context.secret,t.split(".")[0],t.split(".")[1]))return}catch{return}return i.request&&i.request.headers.append("cookie",`${i.context.authCookies.sessionToken.name}=${o}`),i.headers&&i.headers.append("cookie",`${i.context.authCookies.sessionToken.name}=${o}`),{context:i}},"handler")}],after:[{matcher(i){return!!i.responseHeader.get("set-cookie")},handler:P(async i=>{let r=i.responseHeader.get("set-cookie");if(!r)return;let o=ye(r),t=i.context.authCookies.sessionToken.name,n=o.get(t);if(!n||!n.value||n["max-age"]===0)return;let s=n.value;return i.responseHeader.set("set-auth-token",s),{responseHeader:i.responseHeader}})}]}}),"bearer");import{z as De}from"zod";import{APIError as nn}from"better-call";var sm=a(e=>({id:"magic-link",endpoints:{signInMagicLink:p("/sign-in/magic-link",{method:"POST",requireHeaders:!0,body:De.object({email:De.string({description:"Email address to send the magic link"}).email(),callbackURL:De.string({description:"URL to redirect after magic link verification"}).optional()}),metadata:{openapi:{description:"Sign in with magic link",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async i=>{let{email:r}=i.body;if(e.disableSignUp&&!await i.context.internalAdapter.findUserByEmail(r))throw new nn("BAD_REQUEST",{message:h.USER_NOT_FOUND});let o=R(32,"a-z","A-Z");await i.context.internalAdapter.createVerificationValue({identifier:o,value:r,expiresAt:new Date(Date.now()+(e.expiresIn||60*5)*1e3)});let t=`${i.context.baseURL}/magic-link/verify?token=${o}&callbackURL=${i.body.callbackURL||"/"}`;return await e.sendMagicLink({email:r,url:t,token:o},i.request),i.json({status:!0})}),magicLinkVerify:p("/magic-link/verify",{method:"GET",query:De.object({token:De.string({description:"Verification token"}),callbackURL:De.string({description:"URL to redirect after magic link verification, if not provided will return session"}).optional()}),requireHeaders:!0,metadata:{openapi:{description:"Verify magic link",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"},user:{$ref:"#/components/schemas/User"}}}}}}}}}},async i=>{let{token:r,callbackURL:o}=i.query,t=o?.startsWith("http")?o:o?`${i.context.options.baseURL}${o}`:i.context.options.baseURL,n=await i.context.internalAdapter.findVerificationValue(r);if(!n)throw i.redirect(`${t}?error=INVALID_TOKEN`);if(n.expiresAt<new Date)throw await i.context.internalAdapter.deleteVerificationValue(n.id),i.redirect(`${t}?error=EXPIRED_TOKEN`);await i.context.internalAdapter.deleteVerificationValue(n.id);let s=n.value,d=await i.context.internalAdapter.findUserByEmail(s),A=d?.user.id||"";if(!d){if(e.disableSignUp)throw i.redirect(`${t}?error=failed_to_create_user`);if(A=(await i.context.internalAdapter.createUser({email:s,emailVerified:!0,name:s})).id,!A)throw i.redirect(`${t}?error=failed_to_create_user`)}let c=await i.context.internalAdapter.createSession(A,i.headers);if(!c)throw i.redirect(`${t}?error=failed_to_create_session`);if(await C(i,{session:c,user:d?.user}),!o)return i.json({token:c.token});throw i.redirect(o)})},rateLimit:[{pathMatcher(i){return i.startsWith("/sign-in/magic-link")||i.startsWith("/magic-link/verify")},window:e.rateLimit?.window||60,max:e.rateLimit?.max||5}]}),"magicLink");import{z as ae}from"zod";import{APIError as J}from"better-call";function sn(e){return R(e,"0-9")}a(sn,"generateOTP");var hm=a(e=>{let i={expiresIn:e?.expiresIn||300,otpLength:e?.otpLength||6,...e,phoneNumber:"phoneNumber",phoneNumberVerified:"phoneNumberVerified",code:"code",createdAt:"createdAt"},r={INVALID_PHONE_NUMBER:"Invalid phone number",INVALID_PHONE_NUMBER_OR_PASSWORD:"Invalid phone number or password",UNEXPECTED_ERROR:"Unexpected error",OTP_NOT_FOUND:"OTP not found"};return{id:"phone-number",endpoints:{signInPhoneNumber:p("/sign-in/phone-number",{method:"POST",body:ae.object({phoneNumber:ae.string({description:"Phone number to sign in"}),password:ae.string({description:"Password to use for sign in"}),rememberMe:ae.boolean({description:"Remember the session"}).optional()}),metadata:{openapi:{summary:"Sign in with phone number",description:"Use this endpoint to sign in with phone number",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"},session:{$ref:"#/components/schemas/Session"}}}}}},400:{description:"Invalid phone number or password"}}}}},async o=>{let{password:t,phoneNumber:n}=o.body;if(i.phoneNumberValidator&&!await i.phoneNumberValidator(o.body.phoneNumber))throw new J("BAD_REQUEST",{message:r.INVALID_PHONE_NUMBER});let s=await o.context.adapter.findOne({model:"user",where:[{field:"phoneNumber",value:n}]});if(!s)throw new J("UNAUTHORIZED",{message:r.INVALID_PHONE_NUMBER_OR_PASSWORD});let A=(await o.context.internalAdapter.findAccountByUserId(s.id)).find(u=>u.providerId==="credential");if(!A)throw o.context.logger.error("Credential account not found",{phoneNumber:n}),new J("UNAUTHORIZED",{message:r.INVALID_PHONE_NUMBER_OR_PASSWORD});let c=A?.password;if(!c)throw o.context.logger.error("Password not found",{phoneNumber:n}),new J("UNAUTHORIZED",{message:r.UNEXPECTED_ERROR});if(!await o.context.password.verify({hash:c,password:t}))throw o.context.logger.error("Invalid password"),new J("UNAUTHORIZED",{message:r.INVALID_PHONE_NUMBER_OR_PASSWORD});let m=await o.context.internalAdapter.createSession(s.id,o.headers,o.body.rememberMe===!1);if(!m)throw o.context.logger.error("Failed to create session"),new J("UNAUTHORIZED",{message:h.FAILED_TO_CREATE_SESSION});return await C(o,{session:m,user:s},o.body.rememberMe===!1),o.json({token:m.token})}),sendPhoneNumberOTP:p("/phone-number/send-otp",{method:"POST",body:ae.object({phoneNumber:ae.string({description:"Phone number to send OTP"})}),metadata:{openapi:{summary:"Send OTP to phone number",description:"Use this endpoint to send OTP to phone number",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}}}}}}},async o=>{if(!e?.sendOTP)throw o.context.logger.warn("sendOTP not implemented"),new J("NOT_IMPLEMENTED",{message:"sendOTP not implemented"});if(i.phoneNumberValidator&&!await i.phoneNumberValidator(o.body.phoneNumber))throw new J("BAD_REQUEST",{message:r.INVALID_PHONE_NUMBER});let t=sn(i.otpLength);return await o.context.internalAdapter.createVerificationValue({value:t,identifier:o.body.phoneNumber,expiresAt:N(i.expiresIn,"sec")}),await e.sendOTP({phoneNumber:o.body.phoneNumber,code:t},o.request),o.json({code:t},{body:{message:"Code sent"}})}),verifyPhoneNumber:p("/phone-number/verify",{method:"POST",body:ae.object({phoneNumber:ae.string({description:"Phone number to verify"}),code:ae.string({description:"OTP code"}),disableSession:ae.boolean({description:"Disable session creation after verification"}).optional(),updatePhoneNumber:ae.boolean({description:"Check if there is a session and update the phone number"}).optional()}),metadata:{openapi:{summary:"Verify phone number",description:"Use this endpoint to verify phone number",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"},session:{$ref:"#/components/schemas/Session"}}}}}},400:{description:"Invalid OTP"}}}}},async o=>{let t=await o.context.internalAdapter.findVerificationValue(o.body.phoneNumber);if(!t||t.expiresAt<new Date)throw t&&t.expiresAt<new Date?(await o.context.internalAdapter.deleteVerificationValue(t.id),new J("BAD_REQUEST",{message:"OTP expired"})):new J("BAD_REQUEST",{message:r.OTP_NOT_FOUND});if(t.value!==o.body.code)throw new J("BAD_REQUEST",{message:"Invalid OTP"});if(await o.context.internalAdapter.deleteVerificationValue(t.id),o.body.updatePhoneNumber){let s=await _(o);if(!s)throw new J("UNAUTHORIZED",{message:h.USER_NOT_FOUND});return await o.context.internalAdapter.updateUser(s.user.id,{[i.phoneNumber]:o.body.phoneNumber,[i.phoneNumberVerified]:!0}),o.json({token:s.session.token,status:!0})}let n=await o.context.adapter.findOne({model:"user",where:[{value:o.body.phoneNumber,field:i.phoneNumber}]});if(await e?.callbackOnVerification?.({phoneNumber:o.body.phoneNumber,user:n},o.request),n)n=await o.context.internalAdapter.updateUser(n.id,{[i.phoneNumberVerified]:!0});else if(e?.signUpOnVerification){if(n=await o.context.internalAdapter.createUser({email:e.signUpOnVerification.getTempEmail(o.body.phoneNumber),name:e.signUpOnVerification.getTempName?e.signUpOnVerification.getTempName(o.body.phoneNumber):o.body.phoneNumber,[i.phoneNumber]:o.body.phoneNumber,[i.phoneNumberVerified]:!0}),!n)throw new J("INTERNAL_SERVER_ERROR",{message:h.FAILED_TO_CREATE_USER})}else return o.json(null);if(!n)throw new J("INTERNAL_SERVER_ERROR",{message:h.FAILED_TO_UPDATE_USER});if(!o.body.disableSession){let s=await o.context.internalAdapter.createSession(n.id,o.request);if(!s)throw new J("INTERNAL_SERVER_ERROR",{message:h.FAILED_TO_CREATE_SESSION});return await C(o,{session:s,user:n}),o.json({token:s.token,status:!0})}return o.json({token:null,status:!0})})},schema:pe(an,e?.schema),$ERROR_CODES:r}},"phoneNumber"),an={user:{fields:{phoneNumber:{type:"string",required:!1,unique:!0,returned:!0},phoneNumberVerified:{type:"boolean",required:!1,returned:!0,input:!1}}}};var dn={user:{fields:{isAnonymous:{type:"boolean",required:!1}}}},Em=a(e=>{let i={FAILED_TO_CREATE_USER:"Failed to create user",COULD_NOT_CREATE_SESSION:"Could not create session",ANONYMOUS_USERS_CANNOT_SIGN_IN_AGAIN_ANONYMOUSLY:"Anonymous users cannot sign in again anonymously"};return{id:"anonymous",endpoints:{signInAnonymous:p("/sign-in/anonymous",{method:"POST",metadata:{openapi:{description:"Sign in anonymously",responses:{200:{description:"Sign in anonymously",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"},session:{$ref:"#/components/schemas/Session"}}}}}}}}}},async r=>{let{emailDomainName:o=Te(r.context.baseURL)}=e||{},t=r.context.generateId({model:"user"}),n=`temp-${t}@${o}`,s=await r.context.internalAdapter.createUser({id:t,email:n,emailVerified:!1,isAnonymous:!0,name:"Anonymous",createdAt:new Date,updatedAt:new Date});if(!s)return r.json(null,{status:500,body:{message:i.FAILED_TO_CREATE_USER,status:500}});let d=await r.context.internalAdapter.createSession(s.id,r.request);return d?(await C(r,{session:d,user:s}),r.json({token:d.token})):r.json(null,{status:400,body:{message:i.COULD_NOT_CREATE_SESSION}})})},hooks:{after:[{matcher(r){return!!r.responseHeader.get("set-cookie")?.includes(r.context.authCookies.sessionToken.name)},handler:P(async r=>{let t=r.responseHeader.get("set-cookie"),n=r.context.authCookies.sessionToken.name;if(!ye(t||"").get(n)?.value.split(".")[0])return;let d=await _(r,{disableRefresh:!0});if(!d||!d.user.isAnonymous)return;if(r.path==="/sign-in/anonymous")throw new g("BAD_REQUEST",{message:i.ANONYMOUS_USERS_CANNOT_SIGN_IN_AGAIN_ANONYMOUSLY});let A=r.context.newSession;A&&(e?.onLinkAccount&&await e?.onLinkAccount?.({anonymousUser:d,newUser:A}),e?.disableDeleteAnonymousUser||await r.context.internalAdapter.deleteUser(d.user.id))})}]},schema:pe(dn,e?.schema),$ERROR_CODES:i}},"anonymous");import{z as O}from"zod";import{APIError as An}from"better-call";var lt=a(async e=>{let i=e.context.returned;return i?i instanceof Response?i.status!==200?null:await i.clone().json():i instanceof An?null:i:null},"getEndpointResponse");var Fm=a(e=>{let i={defaultRole:"user",adminRole:"admin",...e},r={FAILED_TO_CREATE_USER:"Failed to create user",USER_ALREADY_EXISTS:"User already exists",USER_NOT_FOUND:"User not found",YOU_CANNOT_BAN_YOURSELF:"You cannot ban yourself",ONLY_ADMINS_CAN_ACCESS_THIS_ENDPOINT:"Only admins can access this endpoint"},o=P(async t=>{let n=await _(t);if(!n?.session)throw new g("UNAUTHORIZED");let s=n.user;if(!s.role||(Array.isArray(i.adminRole)?!i.adminRole.includes(s.role):s.role!==i.adminRole))throw new g("FORBIDDEN",{message:"Only admins can access this endpoint"});return{session:{user:s,session:n.session}}});return{id:"admin",init(t){return{options:{databaseHooks:{user:{create:{async before(n){if(e?.defaultRole!==!1)return{data:{role:e?.defaultRole??"user",...n}}}}},session:{create:{async before(n){let s=await t.internalAdapter.findUserById(n.userId);if(s.banned){if(s.banExpires&&s.banExpires.getTime()<Date.now()){await t.internalAdapter.updateUser(n.userId,{banned:!1,banReason:null,banExpires:null});return}return!1}}}}}}}},hooks:{after:[{matcher(t){return t.path==="/list-sessions"},handler:P(async t=>{let n=await lt(t);if(!n)return;let s=n.filter(d=>!d.impersonatedBy);return t.json(s)})}]},endpoints:{setRole:p("/admin/set-role",{method:"POST",body:O.object({userId:O.string({description:"The user id"}),role:O.string({description:"The role to set. `admin` or `user` by default"})}),use:[o],metadata:{openapi:{operationId:"setRole",summary:"Set the role of a user",description:"Set the role of a user",responses:{200:{description:"User role updated",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async t=>{let n=await t.context.internalAdapter.updateUser(t.body.userId,{role:t.body.role});return t.json({user:n})}),createUser:p("/admin/create-user",{method:"POST",body:O.object({email:O.string({description:"The email of the user"}),password:O.string({description:"The password of the user"}),name:O.string({description:"The name of the user"}),role:O.string({description:"The role of the user"}),data:O.optional(O.record(O.any(),{description:"Extra fields for the user. Including custom additional fields."}))}),use:[o],metadata:{openapi:{operationId:"createUser",summary:"Create a new user",description:"Create a new user",responses:{200:{description:"User created",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async t=>{if(await t.context.internalAdapter.findUserByEmail(t.body.email))throw new g("BAD_REQUEST",{message:r.USER_ALREADY_EXISTS});let s=await t.context.internalAdapter.createUser({email:t.body.email,name:t.body.name,role:t.body.role,...t.body.data});if(!s)throw new g("INTERNAL_SERVER_ERROR",{message:r.FAILED_TO_CREATE_USER});let d=await t.context.password.hash(t.body.password);return await t.context.internalAdapter.linkAccount({accountId:s.id,providerId:"credential",password:d,userId:s.id}),t.json({user:s})}),listUsers:p("/admin/list-users",{method:"GET",use:[o],query:O.object({searchValue:O.string({description:"The value to search for"}).optional(),searchField:O.enum(["email","name"],{description:"The field to search in, defaults to email. Can be `email` or `name`"}).optional(),searchOperator:O.enum(["contains","starts_with","ends_with"],{description:"The operator to use for the search. Can be `contains`, `starts_with` or `ends_with`"}).optional(),limit:O.string({description:"The number of users to return"}).or(O.number()).optional(),offset:O.string({description:"The offset to start from"}).or(O.number()).optional(),sortBy:O.string({description:"The field to sort by"}).optional(),sortDirection:O.enum(["asc","desc"],{description:"The direction to sort by"}).optional(),filterField:O.string({description:"The field to filter by"}).optional(),filterValue:O.string({description:"The value to filter by"}).or(O.number()).or(O.boolean()).optional(),filterOperator:O.enum(["eq","ne","lt","lte","gt","gte"],{description:"The operator to use for the filter"}).optional()}),metadata:{openapi:{operationId:"listUsers",summary:"List users",description:"List users",responses:{200:{description:"List of users",content:{"application/json":{schema:{type:"object",properties:{users:{type:"array",items:{$ref:"#/components/schemas/User"}}}}}}}}}}},async t=>{let n=[];t.query?.searchValue&&n.push({field:t.query.searchField||"email",operator:t.query.searchOperator||"contains",value:t.query.searchValue}),t.query?.filterValue&&n.push({field:t.query.filterField||"email",operator:t.query.filterOperator||"eq",value:t.query.filterValue});try{let s=await t.context.internalAdapter.listUsers(Number(t.query?.limit)||void 0,Number(t.query?.offset)||void 0,t.query?.sortBy?{field:t.query.sortBy,direction:t.query.sortDirection||"asc"}:void 0,n.length?n:void 0);return t.json({users:s})}catch(s){return console.log(s),t.json({users:[]})}}),listUserSessions:p("/admin/list-user-sessions",{method:"POST",use:[o],body:O.object({userId:O.string({description:"The user id"})}),metadata:{openapi:{operationId:"listUserSessions",summary:"List user sessions",description:"List user sessions",responses:{200:{description:"List of user sessions",content:{"application/json":{schema:{type:"object",properties:{sessions:{type:"array",items:{$ref:"#/components/schemas/Session"}}}}}}}}}}},async t=>({sessions:await t.context.internalAdapter.listSessions(t.body.userId)})),unbanUser:p("/admin/unban-user",{method:"POST",body:O.object({userId:O.string({description:"The user id"})}),use:[o],metadata:{openapi:{operationId:"unbanUser",summary:"Unban a user",description:"Unban a user",responses:{200:{description:"User unbanned",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async t=>{let n=await t.context.internalAdapter.updateUser(t.body.userId,{banned:!1});return t.json({user:n})}),banUser:p("/admin/ban-user",{method:"POST",body:O.object({userId:O.string({description:"The user id"}),banReason:O.string({description:"The reason for the ban"}).optional(),banExpiresIn:O.number({description:"The number of seconds until the ban expires"}).optional()}),use:[o],metadata:{openapi:{operationId:"banUser",summary:"Ban a user",description:"Ban a user",responses:{200:{description:"User banned",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async t=>{if(t.body.userId===t.context.session.user.id)throw new g("BAD_REQUEST",{message:r.YOU_CANNOT_BAN_YOURSELF});let n=await t.context.internalAdapter.updateUser(t.body.userId,{banned:!0,banReason:t.body.banReason||e?.defaultBanReason||"No reason",banExpires:t.body.banExpiresIn?N(t.body.banExpiresIn,"sec"):e?.defaultBanExpiresIn?N(e.defaultBanExpiresIn,"sec"):void 0});return await t.context.internalAdapter.deleteSessions(t.body.userId),t.json({user:n})}),impersonateUser:p("/admin/impersonate-user",{method:"POST",body:O.object({userId:O.string({description:"The user id"})}),use:[o],metadata:{openapi:{operationId:"impersonateUser",summary:"Impersonate a user",description:"Impersonate a user",responses:{200:{description:"Impersonation session created",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"},user:{$ref:"#/components/schemas/User"}}}}}}}}}},async t=>{let n=await t.context.internalAdapter.findUserById(t.body.userId);if(!n)throw new g("NOT_FOUND",{message:"User not found"});let s=await t.context.internalAdapter.createSession(n.id,void 0,!0,{impersonatedBy:t.context.session.user.id,expiresAt:e?.impersonationSessionDuration?N(e.impersonationSessionDuration,"sec"):N(60*60,"sec")});if(!s)throw new g("INTERNAL_SERVER_ERROR",{message:r.FAILED_TO_CREATE_USER});let d=t.context.authCookies;return $(t),await t.setSignedCookie("admin_session",t.context.session.session.token,t.context.secret,d.sessionToken.options),await C(t,{session:s,user:n},!0),t.json({session:s,user:n})}),stopImpersonating:p("/admin/stop-impersonating",{method:"POST"},async t=>{let n=await _(t);if(!n)throw new g("UNAUTHORIZED");if(!n.session.impersonatedBy)throw new g("BAD_REQUEST",{message:"You are not impersonating anyone"});let s=await t.context.internalAdapter.findUserById(n.session.impersonatedBy);if(!s)throw new g("INTERNAL_SERVER_ERROR",{message:"Failed to find user"});let d=await t.getSignedCookie("admin_session",t.context.secret);if(!d)throw new g("INTERNAL_SERVER_ERROR",{message:"Failed to find admin session"});let A=await t.context.internalAdapter.findSession(d);if(!A||A.session.userId!==s.id)throw new g("INTERNAL_SERVER_ERROR",{message:"Failed to find admin session"});return await C(t,A),t.json(A)}),revokeUserSession:p("/admin/revoke-user-session",{method:"POST",body:O.object({sessionToken:O.string({description:"The session token"})}),use:[o],metadata:{openapi:{operationId:"revokeUserSession",summary:"Revoke a user session",description:"Revoke a user session",responses:{200:{description:"Session revoked",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async t=>(await t.context.internalAdapter.deleteSession(t.body.sessionToken),t.json({success:!0}))),revokeUserSessions:p("/admin/revoke-user-sessions",{method:"POST",body:O.object({userId:O.string({description:"The user id"})}),use:[o],metadata:{openapi:{operationId:"revokeUserSessions",summary:"Revoke all user sessions",description:"Revoke all user sessions",responses:{200:{description:"Sessions revoked",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async t=>(await t.context.internalAdapter.deleteSessions(t.body.userId),t.json({success:!0}))),removeUser:p("/admin/remove-user",{method:"POST",body:O.object({userId:O.string({description:"The user id"})}),use:[o],metadata:{openapi:{operationId:"removeUser",summary:"Remove a user",description:"Delete a user and all their sessions and accounts. Cannot be undone.",responses:{200:{description:"User removed",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async t=>(await t.context.internalAdapter.deleteUser(t.body.userId),t.json({success:!0})))},$ERROR_CODES:r,schema:pe(cn,i.schema)}},"admin"),cn={user:{fields:{role:{type:"string",required:!1,input:!1},banned:{type:"boolean",defaultValue:!1,required:!1,input:!1},banReason:{type:"string",required:!1,input:!1},banExpires:{type:"date",required:!1,input:!1}}},session:{fields:{impersonatedBy:{type:"string",required:!1}}}};import{betterFetch as Ao}from"@better-fetch/fetch";import{APIError as Pe}from"better-call";import{z as de}from"zod";import{decodeJwt as Kn}from"jose";async function mt(e,i){if(e.idToken){let o=Kn(e.idToken);if(o&&o.sub&&o.email)return{id:o.sub,emailVerified:o.email_verified,image:o.picture,...o}}if(!i)return null;let r=await Ao(i,{method:"GET",headers:{Authorization:`Bearer ${e.accessToken}`}});return{id:r.data?.sub,emailVerified:r.data?.email_verified,email:r.data?.email,image:r.data?.picture,name:r.data?.name,...r.data}}a(mt,"getUserInfo");var Ym=a(e=>{let i={INVALID_OAUTH_CONFIGURATION:"Invalid OAuth configuration"};return{id:"generic-oauth",init:a(r=>({context:{socialProviders:e.config.map(t=>{let n=t.userInfoUrl;return{id:t.providerId,name:t.providerId,createAuthorizationURL(s){return D({id:t.providerId,options:{clientId:t.clientId,clientSecret:t.clientSecret,redirectURI:t.redirectURI},authorizationEndpoint:t.authorizationUrl,state:s.state,codeVerifier:t.pkce?s.codeVerifier:void 0,scopes:t.scopes||[],redirectURI:`${r.baseURL}/oauth2/callback/${t.providerId}`})},async validateAuthorizationCode(s){let d=t.tokenUrl;if(t.discoveryUrl){let A=await Ao(t.discoveryUrl,{method:"GET"});A.data&&(d=A.data.token_endpoint,n=A.data.userinfo_endpoint)}if(!d)throw new Pe("BAD_REQUEST",{message:"Invalid OAuth configuration. Token URL not found."});return S({code:s.code,codeVerifier:s.codeVerifier,redirectURI:s.redirectURI,options:{clientId:t.clientId,clientSecret:t.clientSecret},tokenEndpoint:d})},async getUserInfo(s){if(!n)return null;let d=t.getUserInfo?await t.getUserInfo(s):await mt(s,n);return d?{user:{id:d?.id,email:d?.email,emailVerified:d?.emailVerified,image:d?.image,name:d?.name,...t.mapProfileToUser?.(d)},data:d}:null}}}).concat(r.socialProviders)}}),"init"),endpoints:{signInWithOAuth2:p("/sign-in/oauth2",{method:"POST",query:de.object({currentURL:de.string({description:"Redirect to the current URL after sign in"}).optional()}).optional(),body:de.object({providerId:de.string({description:"The provider ID for the OAuth provider"}),callbackURL:de.string({description:"The URL to redirect to after sign in"}).optional(),errorCallbackURL:de.string({description:"The URL to redirect to if an error occurs"}).optional(),disableRedirect:de.boolean({description:"Disable redirect"}).optional()}),metadata:{openapi:{description:"Sign in with OAuth2",responses:{200:{description:"Sign in with OAuth2",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string"},redirect:{type:"boolean"}}}}}}}}}},async r=>{let{providerId:o}=r.body,t=e.config.find(k=>k.providerId===o);if(!t)throw new Pe("BAD_REQUEST",{message:`No config found for provider ${o}`});let{discoveryUrl:n,authorizationUrl:s,tokenUrl:d,clientId:A,clientSecret:c,scopes:K,redirectURI:m,responseType:u,pkce:l,prompt:w,accessType:y}=t,j=s,F=d;if(n){let k=await Ao(n,{onError(U){r.context.logger.error(U.error.message,U.error,{discoveryUrl:n})}});k.data&&(j=k.data.authorization_endpoint,F=k.data.token_endpoint)}if(!j||!F)throw new Pe("BAD_REQUEST",{message:i.INVALID_OAUTH_CONFIGURATION});let{state:M,codeVerifier:f}=await Ee(r),T=await D({id:o,options:{clientId:A,clientSecret:c,redirectURI:m},authorizationEndpoint:j,state:M,codeVerifier:l?f:void 0,scopes:K||[],redirectURI:`${r.context.baseURL}/oauth2/callback/${o}`});return u&&u!=="code"&&T.searchParams.set("response_type",u),w&&T.searchParams.set("prompt",w),y&&T.searchParams.set("access_type",y),r.json({url:T.toString(),redirect:!r.body.disableRedirect})}),oAuth2Callback:p("/oauth2/callback/:providerId",{method:"GET",query:de.object({code:de.string({description:"The OAuth2 code"}).optional(),error:de.string({description:"The error message, if any"}).optional(),state:de.string({description:"The state parameter from the OAuth2 request"}).optional()}),metadata:{openapi:{description:"OAuth2 callback",responses:{200:{description:"OAuth2 callback",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string"}}}}}}}}}},async r=>{if(r.query.error||!r.query.code)throw r.redirect(`${r.context.options.baseURL}?error=${r.query.error||"oAuth_code_missing"}`);let o=e.config.find(f=>f.providerId===r.params.providerId);if(!o)throw new Pe("BAD_REQUEST",{message:`No config found for provider ${r.params.providerId}`});let t,n=await Ye(r),{callbackURL:s,codeVerifier:d,errorURL:A}=n,c=r.query.code,K=o.tokenUrl,m=o.userInfoUrl;if(o.discoveryUrl){let f=await Ao(o.discoveryUrl,{method:"GET"});f.data&&(K=f.data.token_endpoint,m=f.data.userinfo_endpoint)}try{if(!K)throw new Pe("BAD_REQUEST",{message:"Invalid OAuth configuration."});t=await S({code:c,codeVerifier:d,redirectURI:`${r.context.baseURL}/oauth2/callback/${o.providerId}`,options:{clientId:o.clientId,clientSecret:o.clientSecret},tokenEndpoint:K})}catch(f){throw r.context.logger.error(f&&typeof f=="object"&&"name"in f?f.name:"",f),r.redirect(`${A}?error=oauth_code_verification_failed`)}if(!t)throw new Pe("BAD_REQUEST",{message:"Invalid OAuth configuration."});let u=o.getUserInfo?await o.getUserInfo(t):await mt(t,m);if(!u?.email)throw r.context.logger.error("Unable to get user info",u),r.redirect(`${r.context.baseURL}/error?error=email_is_missing`);let l=o.mapProfileToUser?await o.mapProfileToUser(u):null,w=await Ue(r,{userInfo:{...u,...l},account:{providerId:o.providerId,accountId:u.id,...t,scope:t.scopes?.join(",")}});function y(f){throw r.redirect(`${A||s||`${r.context.baseURL}/error`}?error=${f}`)}if(a(y,"redirectOnError"),w.error)return y(w.error.split(" ").join("_"));let{session:j,user:F}=w.data;await C(r,{session:j,user:F});let M;try{M=new URL(s).toString()}catch{M=s}throw r.redirect(M)})},$ERROR_CODES:i}},"genericOAuth");import{z as He}from"zod";var gt={jwks:{fields:{publicKey:{type:"string",required:!0},privateKey:{type:"string",required:!0},createdAt:{type:"date",required:!0}}}},tg=He.object({id:He.string(),publicKey:He.string(),privateKey:He.string(),createdAt:He.date()});var So=a(e=>({getAllKeys:a(async()=>await e.findMany({model:"jwks"}),"getAllKeys"),getLatestKey:a(async()=>(await e.findMany({model:"jwks",sortBy:{field:"createdAt",direction:"desc"},limit:1}))[0],"getLatestKey"),createJwk:a(async i=>await e.create({model:"jwks",data:{...i,createdAt:new Date}}),"createJwk")}),"getJwksAdapter");import{exportJWK as co,generateKeyPair as ft,importJWK as pn,SignJWT as un}from"jose";var ug=a(e=>({id:"jwt",endpoints:{getJwks:p("/jwks",{method:"GET",metadata:{openapi:{description:"Get the JSON Web Key Set",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{keys:{type:"array",items:{type:"object",properties:{kid:{type:"string"},kty:{type:"string"},use:{type:"string"},alg:{type:"string"},n:{type:"string"},e:{type:"string"}}}}}}}}}}}}},async i=>{let r=So(i.context.adapter),o=await r.getAllKeys();if(o.length===0){let{publicKey:t,privateKey:n}=await ft(e?.jwks?.keyPairConfig?.alg??"EdDSA",e?.jwks?.keyPairConfig??{crv:"Ed25519",extractable:!0}),s=await co(t),d=await co(n),A=JSON.stringify(d),c=!e?.jwks?.disablePrivateKeyEncryption,K={id:i.context.generateId({model:"jwks"}),publicKey:JSON.stringify(s),privateKey:c?JSON.stringify(await Ae({key:i.context.options.secret,data:A})):A,createdAt:new Date};return await r.createJwk(K),i.json({keys:[{...s,kid:K.id}]})}return i.json({keys:o.map(t=>({...JSON.parse(t.publicKey),kid:t.id}))})}),getToken:p("/token",{method:"GET",requireHeaders:!0,use:[I],metadata:{openapi:{description:"Get a JWT token",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string"}}}}}}}}}},async i=>{let r=So(i.context.adapter),o=await r.getLatestKey(),t=!e?.jwks?.disablePrivateKeyEncryption;if(o===void 0){let{publicKey:c,privateKey:K}=await ft(e?.jwks?.keyPairConfig?.alg??"EdDSA",e?.jwks?.keyPairConfig??{crv:"Ed25519",extractable:!0}),m=await co(c),u=await co(K),l=JSON.stringify(u),w={id:i.context.generateId({model:"jwks"}),publicKey:JSON.stringify(m),privateKey:t?JSON.stringify(await Ae({key:i.context.options.secret,data:l})):l,createdAt:new Date};o=await r.createJwk(w)}let n=t?await we({key:i.context.options.secret,data:JSON.parse(o.privateKey)}):o.privateKey,s=await pn(JSON.parse(n)),d=e?.jwt?.definePayload?await e?.jwt.definePayload(i.context.session):i.context.session.user,A=await new un({...d,...i.context.session.session.impersonatedBy?{impersonatedBy:i.context.session.session.impersonatedBy}:{}}).setProtectedHeader({alg:e?.jwks?.keyPairConfig?.alg??"EdDSA",kid:o.id}).setIssuedAt().setIssuer(e?.jwt?.issuer??i.context.options.baseURL).setAudience(e?.jwt?.audience??i.context.options.baseURL).setExpirationTime(e?.jwt?.expirationTime??"15m").setSubject(i.context.session.user.id).sign(s);return i.json({token:A})})},schema:pe(gt,e?.schema)}),"jwt");import{z as Ko}from"zod";var yg=a(e=>{let i={maximumSessions:5,...e},r=a(t=>t.includes("_multi-"),"isMultiSessionCookie"),o={INVALID_SESSION_TOKEN:"Invalid session token"};return{id:"multi-session",endpoints:{listDeviceSessions:p("/multi-session/list-device-sessions",{method:"GET",requireHeaders:!0},async t=>{let n=t.headers?.get("cookie");if(!n)return t.json([]);let s=Object.fromEntries(je(n)),d=(await Promise.all(Object.entries(s).filter(([K])=>r(K)).map(async([K])=>await t.getSignedCookie(K,t.context.secret)))).filter(K=>K!==void 0);if(!d.length)return t.json([]);let c=(await t.context.internalAdapter.findSessions(d)).filter(K=>K&&K.session.expiresAt>new Date);return t.json(c)}),setActiveSession:p("/multi-session/set-active",{method:"POST",body:Ko.object({sessionToken:Ko.string({description:"The session token to set as active"})}),requireHeaders:!0,use:[I],metadata:{openapi:{description:"Set the active session",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"}}}}}}}}}},async t=>{let n=t.body.sessionToken,s=`${t.context.authCookies.sessionToken.name}_multi-${n}`;if(!await t.getSignedCookie(s,t.context.secret))throw new g("UNAUTHORIZED",{message:o.INVALID_SESSION_TOKEN});let A=await t.context.internalAdapter.findSession(n);if(!A||A.session.expiresAt<new Date)throw t.setCookie(s,"",{...t.context.authCookies.sessionToken.options,maxAge:0}),new g("UNAUTHORIZED",{message:o.INVALID_SESSION_TOKEN});return await C(t,A),t.json(A)}),revokeDeviceSession:p("/multi-session/revoke",{method:"POST",body:Ko.object({sessionToken:Ko.string({description:"The session token to revoke"})}),requireHeaders:!0,use:[I],metadata:{openapi:{description:"Revoke a device session",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async t=>{let n=t.body.sessionToken,s=`${t.context.authCookies.sessionToken.name}_multi-${n}`;if(!await t.getSignedCookie(s,t.context.secret))throw new g("UNAUTHORIZED",{message:o.INVALID_SESSION_TOKEN});if(await t.context.internalAdapter.deleteSession(n),t.setCookie(s,"",{...t.context.authCookies.sessionToken.options,maxAge:0}),!(t.context.session?.session.token===n))return t.json({status:!0});let c=t.headers?.get("cookie");if(c){let K=Object.fromEntries(je(c)),m=(await Promise.all(Object.entries(K).filter(([l])=>r(l)).map(async([l])=>await t.getSignedCookie(l,t.context.secret)))).filter(l=>l!==void 0),u=t.context.internalAdapter;if(m.length>0){let w=(await u.findSessions(m)).filter(y=>y&&y.session.expiresAt>new Date);if(w.length>0){let y=w[0];await C(t,y)}else $(t)}else $(t)}else $(t);return t.json({status:!0})})},hooks:{after:[{matcher:a(()=>!0,"matcher"),handler:P(async t=>{let n=t.responseHeader.get("set-cookie");if(!n)return;let s=ye(n),d=t.context.authCookies.sessionToken,A=s.get(d.name)?.value;if(!A)return;let c=je(t.headers?.get("cookie")||""),K=A.split(".")[0];if(!K)return;let m=`${d.name}_multi-${K}`;s.get(m)||c.get(m)||Object.keys(Object.fromEntries(c)).filter(r).length+(n.includes("session_token")?1:0)>i.maximumSessions||await t.setSignedCookie(m,K,t.context.secret,d.options)})},{matcher:a(t=>t.path==="/sign-out","matcher"),handler:P(async t=>{let n=t.headers?.get("cookie");if(!n)return;let s=Object.fromEntries(je(n)),d=Object.keys(s).map(A=>r(A)?(t.setCookie(A,"",{maxAge:0}),A.split("_multi-")[1]):null).filter(A=>A!==null);await t.context.internalAdapter.deleteSessions(d)})}]},$ERROR_CODES:o}},"multiSession");import{z as B}from"zod";var vo=["email-verification","sign-in","forget-password"],Rg=a(e=>{let i={expireIn:300,otpLength:6,...e},r={OTP_EXPIRED:"otp expired",INVALID_OTP:"invalid otp",INVALID_EMAIL:"invalid email",USER_NOT_FOUND:"user not found"};return{id:"email-otp",endpoints:{sendVerificationOTP:p("/email-otp/send-verification-otp",{method:"POST",body:B.object({email:B.string({description:"Email address to send the OTP"}),type:B.enum(vo,{description:"Type of the OTP"})}),metadata:{openapi:{description:"Send verification OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async o=>{if(!e?.sendVerificationOTP)throw o.context.logger.error("send email verification is not implemented"),new g("BAD_REQUEST",{message:"send email verification is not implemented"});let t=o.body.email;if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(t))throw new g("BAD_REQUEST",{message:r.INVALID_EMAIL});let s=R(i.otpLength,"0-9");return await o.context.internalAdapter.createVerificationValue({value:s,identifier:`${o.body.type}-otp-${t}`,expiresAt:N(i.expireIn,"sec")}).catch(async d=>{await o.context.internalAdapter.deleteVerificationByIdentifier(`${o.body.type}-otp-${t}`),await o.context.internalAdapter.createVerificationValue({value:s,identifier:`${o.body.type}-otp-${t}`,expiresAt:N(i.expireIn,"sec")})}),await e.sendVerificationOTP({email:t,otp:s,type:o.body.type},o.request),o.json({success:!0})}),createVerificationOTP:p("/email-otp/create-verification-otp",{method:"POST",body:B.object({email:B.string({description:"Email address to send the OTP"}),type:B.enum(vo,{description:"Type of the OTP"})}),metadata:{SERVER_ONLY:!0,openapi:{description:"Create verification OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"string"}}}}}}}},async o=>{let t=o.body.email,n=R(i.otpLength,"0-9");return await o.context.internalAdapter.createVerificationValue({value:n,identifier:`${o.body.type}-otp-${t}`,expiresAt:N(i.expireIn,"sec")}),n}),getVerificationOTP:p("/email-otp/get-verification-otp",{method:"GET",query:B.object({email:B.string({description:"Email address to get the OTP"}),type:B.enum(vo)}),metadata:{SERVER_ONLY:!0,openapi:{description:"Get verification OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{otp:{type:"string"}}}}}}}}}},async o=>{let t=o.query.email,n=await o.context.internalAdapter.findVerificationValue(`${o.query.type}-otp-${t}`);return!n||n.expiresAt<new Date?o.json({otp:null}):o.json({otp:n.value})}),verifyEmailOTP:p("/email-otp/verify-email",{method:"POST",body:B.object({email:B.string({description:"Email address to verify"}),otp:B.string({description:"OTP to verify"})}),metadata:{openapi:{description:"Verify email OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async o=>{let t=o.body.email;if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(t))throw new g("BAD_REQUEST",{message:r.INVALID_EMAIL});let s=await o.context.internalAdapter.findVerificationValue(`email-verification-otp-${t}`);if(!s)throw new g("BAD_REQUEST",{message:r.INVALID_OTP});if(s.expiresAt<new Date)throw await o.context.internalAdapter.deleteVerificationValue(s.id),new g("BAD_REQUEST",{message:r.OTP_EXPIRED});let d=o.body.otp;if(s.value!==d)throw new g("BAD_REQUEST",{message:r.INVALID_OTP});await o.context.internalAdapter.deleteVerificationValue(s.id);let A=await o.context.internalAdapter.findUserByEmail(t);if(!A)throw new g("BAD_REQUEST",{message:r.USER_NOT_FOUND});let c=await o.context.internalAdapter.updateUser(A.user.id,{email:t,emailVerified:!0});if(o.context.options.emailVerification?.autoSignInAfterVerification){let K=await o.context.internalAdapter.createSession(c.id,o.request);return await C(o,{session:K,user:c}),o.json({token:K.token,status:!0})}return o.json({status:!0,token:null})}),signInEmailOTP:p("/sign-in/email-otp",{method:"POST",body:B.object({email:B.string({description:"Email address to sign in"}),otp:B.string({description:"OTP sent to the email"})}),metadata:{openapi:{description:"Sign in with email OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"},session:{$ref:"#/components/schemas/Session"}}}}}}}}}},async o=>{let t=o.body.email,n=await o.context.internalAdapter.findVerificationValue(`sign-in-otp-${t}`);if(!n)throw new g("BAD_REQUEST",{message:r.INVALID_OTP});if(n.expiresAt<new Date)throw await o.context.internalAdapter.deleteVerificationValue(n.id),new g("BAD_REQUEST",{message:r.OTP_EXPIRED});let s=o.body.otp;if(n.value!==s)throw new g("BAD_REQUEST",{message:r.INVALID_OTP});await o.context.internalAdapter.deleteVerificationValue(n.id);let d=await o.context.internalAdapter.findUserByEmail(t);if(!d){if(i.disableSignUp)throw new g("BAD_REQUEST",{message:r.USER_NOT_FOUND});let c=await o.context.internalAdapter.createUser({email:t,emailVerified:!0,name:t}),K=await o.context.internalAdapter.createSession(c.id,o.request);return await C(o,{session:K,user:c}),o.json({token:K.token})}d.user.emailVerified||await o.context.internalAdapter.updateUser(d.user.id,{emailVerified:!0});let A=await o.context.internalAdapter.createSession(d.user.id,o.request);return await C(o,{session:A,user:d.user}),o.json({token:A.token})}),forgetPasswordEmailOTP:p("/forget-password/email-otp",{method:"POST",body:B.object({email:B.string({description:"Email address to send the OTP"})}),metadata:{openapi:{description:"Forget password with email OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async o=>{let t=o.body.email;if(!await o.context.internalAdapter.findUserByEmail(t))throw new g("BAD_REQUEST",{message:r.USER_NOT_FOUND});let s=R(i.otpLength,"0-9");return await o.context.internalAdapter.createVerificationValue({value:s,identifier:`forget-password-otp-${t}`,expiresAt:N(i.expireIn,"sec")}),await e.sendVerificationOTP({email:t,otp:s,type:"forget-password"},o.request),o.json({success:!0})}),resetPasswordEmailOTP:p("/email-otp/reset-password",{method:"POST",body:B.object({email:B.string({description:"Email address to reset the password"}),otp:B.string({description:"OTP sent to the email"}),password:B.string({description:"New password"})}),metadata:{openapi:{description:"Reset password with email OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async o=>{let t=o.body.email,n=await o.context.internalAdapter.findUserByEmail(t);if(!n)throw new g("BAD_REQUEST",{message:r.USER_NOT_FOUND});let s=await o.context.internalAdapter.findVerificationValue(`forget-password-otp-${t}`);if(!s)throw new g("BAD_REQUEST",{message:r.INVALID_OTP});if(s.expiresAt<new Date)throw await o.context.internalAdapter.deleteVerificationValue(s.id),new g("BAD_REQUEST",{message:r.OTP_EXPIRED});let d=o.body.otp;if(s.value!==d)throw new g("BAD_REQUEST",{message:r.INVALID_OTP});await o.context.internalAdapter.deleteVerificationValue(s.id);let A=await o.context.password.hash(o.body.password);return await o.context.internalAdapter.updatePassword(n.user.id,A),o.json({success:!0})})},hooks:{after:[{matcher(o){return!!(o.path?.startsWith("/sign-up")&&i.sendVerificationOnSignUp)},async handler(o){let t=o.context.returned;if(t instanceof g)return;let n=t&&"email"in t?t.email:t instanceof Response&&t.status===200?o.body.email:null;if(n){let s=R(i.otpLength,"0-9");await o.context.internalAdapter.createVerificationValue({value:s,identifier:`email-verification-otp-${n}`,expiresAt:N(i.expireIn,"sec")}),await e.sendVerificationOTP({email:n,otp:s,type:"email-verification"},o.request)}}}]},$ERROR_CODES:r}},"emailOTP");import{z as yt}from"zod";import{betterFetch as ln}from"@better-fetch/fetch";function ht(e){return e==="true"||e===!0}a(ht,"toBoolean");var jg=a(e=>({id:"one-tap",endpoints:{oneTapCallback:p("/one-tap/callback",{method:"POST",body:yt.object({idToken:yt.string({description:"Google ID token, which the client obtains from the One Tap API"})}),metadata:{openapi:{summary:"One tap callback",description:"Use this endpoint to authenticate with Google One Tap",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"},user:{$ref:"#/components/schemas/User"}}}}}},400:{description:"Invalid token"}}}}},async i=>{let{idToken:r}=i.body,{data:o,error:t}=await ln("https://oauth2.googleapis.com/tokeninfo?id_token="+r);if(t)return i.json({error:"Invalid token"});let n=await i.context.internalAdapter.findUserByEmail(o.email);if(!n){if(e?.disableSignup)throw new g("BAD_GATEWAY",{message:"User not found"});let d=await i.context.internalAdapter.createOAuthUser({email:o.email,emailVerified:ht(o.email_verified),name:o.name,image:o.picture},{providerId:"google",accountId:o.sub});if(!d)throw new g("INTERNAL_SERVER_ERROR",{message:"Could not create user"});let A=await i.context.internalAdapter.createSession(d?.user.id,i.request);return await C(i,{user:d.user,session:A}),i.json({session:A,user:d})}let s=await i.context.internalAdapter.createSession(n.user.id,i.request);return await C(i,{user:n.user,session:s}),i.json({token:s.token})})}}),"oneTap");import{z as ko}from"zod";function mn(){let e=le.VERCEL_URL,i=le.NETLIFY_URL,r=le.RENDER_URL,o=le.AWS_LAMBDA_FUNCTION_NAME,t=le.GOOGLE_CLOUD_FUNCTION_NAME,n=le.AZURE_FUNCTION_NAME;return e||i||r||o||t||n}a(mn,"getVenderBaseURL");var Hg=a(e=>({id:"oauth-proxy",endpoints:{oAuthProxy:p("/oauth-proxy-callback",{method:"GET",query:ko.object({callbackURL:ko.string({description:"The URL to redirect to after the proxy"}),cookies:ko.string({description:"The cookies to set after the proxy"})}),metadata:{openapi:{description:"OAuth Proxy Callback",parameters:[{in:"query",name:"callbackURL",required:!0,description:"The URL to redirect to after the proxy"},{in:"query",name:"cookies",required:!0,description:"The cookies to set after the proxy"}],responses:{302:{description:"Redirect",headers:{Location:{description:"The URL to redirect to",schema:{type:"string"}}}}}}}},async i=>{let r=i.query.cookies,o=await we({key:i.context.secret,data:r});throw i.setHeader("set-cookie",o),i.redirect(i.query.callbackURL)})},hooks:{after:[{matcher(i){return i.path?.startsWith("/callback")},handler:P(async i=>{let r=i.context.returned,o=r instanceof g?r.headers:null,t=o?.get("location");if(t?.includes("/oauth-proxy-callback?callbackURL")){if(!t.startsWith("http"))return;let n=new URL(t);if(n.origin===Te(i.context.baseURL)){let K=n.searchParams.get("callbackURL");if(!K)return;i.setHeader("location",K);return}let d=o?.get("set-cookie");if(!d)return;let A=await Ae({key:i.context.secret,data:d}),c=`${t}&cookies=${encodeURIComponent(A)}`;i.setHeader("location",c)}})}],before:[{matcher(i){return i.path?.startsWith("/sign-in/social")},async handler(i){let r=new URL(e?.currentURL||i.request?.url||mn()||i.context.baseURL);return i.body.callbackURL=`${r.origin}${i.context.options.basePath||"/api/auth"}/oauth-proxy-callback?callbackURL=${encodeURIComponent(i.body.callbackURL||i.context.baseURL)}`,{context:i}}}]}}),"oAuthProxy");import{z as $e}from"zod";var Wg=a((e,i)=>({id:"custom-session",endpoints:{getSession:p("/get-session",{method:"GET",metadata:{CUSTOM_SESSION:!0},query:$e.optional($e.object({disableCookieCache:$e.boolean({description:"Disable cookie cache and fetch session from database"}).or($e.string().transform(r=>r==="true")).optional(),disableRefresh:$e.boolean({description:"Disable session refresh. Useful for checking session status, without updating the session"}).optional()}))},async r=>{let o=await _(r);if(!o)return r.json(null);let t=await e(o);return r.json(t)})}}),"customSession");import{ZodObject as Ct,ZodOptional as Do,ZodSchema as bt}from"zod";var Ne=a(e=>{let i=e.plugins?.reduce((A,c)=>{let K=c.schema;if(!K)return A;for(let[m,u]of Object.entries(K))A[m]={fields:{...A[m]?.fields,...u.fields},modelName:u.modelName||m};return A},{}),r=e.rateLimit?.storage==="database",o={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:t,session:n,account:s,...d}=i||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:a(()=>!1,"defaultValue"),required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:a(()=>new Date,"defaultValue"),required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:a(()=>new Date,"defaultValue"),required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...t?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},token:{type:"string",required:!0,fieldName:e.session?.fields?.token||"token",unique:!0},createdAt:{type:"date",required:!0,fieldName:e.session?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.session?.fields?.updatedAt||"updatedAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...n?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},accessTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"accessTokenExpiresAt"},refreshTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"refreshTokenExpiresAt"},scope:{type:"string",required:!1,fieldName:e.account?.fields?.scope||"scope"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},createdAt:{type:"date",required:!0,fieldName:e.account?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.account?.fields?.updatedAt||"updatedAt"},...s?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:a(()=>new Date,"defaultValue"),fieldName:e.verification?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!1,defaultValue:a(()=>new Date,"defaultValue"),fieldName:e.verification?.fields?.updatedAt||"updatedAt"}},order:4},...d,...r?o:{}}},"getAuthTables");import{z as yf}from"zod";import{Kysely as Of,MssqlDialect as Tf}from"kysely";import{MysqlDialect as If,PostgresDialect as Rf,SqliteDialect as _f}from"kysely";var Ze={};function Ot(e){switch(e.constructor.name){case"ZodString":return"string";case"ZodNumber":return"number";case"ZodBoolean":return"boolean";case"ZodObject":return"object";case"ZodArray":return"array";default:return"string"}}a(Ot,"getTypeFromZodType");function po(e){let i=[];return e.metadata?.openapi?.parameters?(i.push(...e.metadata.openapi.parameters),i):(e.query instanceof Ct&&Object.entries(e.query.shape).forEach(([r,o])=>{o instanceof bt&&i.push({name:r,in:"query",schema:{type:Ot(o),..."minLength"in o&&o.minLength?{minLength:o.minLength}:{},description:o.description}})}),i)}a(po,"getParameters");function wt(e){if(e.metadata?.openapi?.requestBody)return e.metadata.openapi.requestBody;if(e.body&&(e.body instanceof Ct||e.body instanceof Do)){let i=e.body.shape;if(!i)return;let r={},o=[];return Object.entries(i).forEach(([t,n])=>{n instanceof bt&&(r[t]={type:Ot(n),description:n.description},n instanceof Do||o.push(t))}),{required:e.body instanceof Do?!1:!!e.body,content:{"application/json":{schema:{type:"object",properties:r,required:o}}}}}}a(wt,"getRequestBody");function uo(e){return{400:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}},required:["message"]}}},description:"Bad Request. Usually due to missing parameters, or invalid parameters."},401:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}},required:["message"]}}},description:"Unauthorized. Due to missing or invalid authentication."},403:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Forbidden. You do not have permission to access this resource or to perform this action."},404:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Not Found. The requested resource was not found."},429:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Too Many Requests. You have exceeded the rate limit. Try again later."},500:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Internal Server Error. This is a problem with the server that you cannot fix."},...e}}a(uo,"getResponse");async function Po(e,i){let r=To(e,{...i,plugins:[]}),o=Ne(i),n={schemas:{...Object.entries(o).reduce((d,[A,c])=>{let K=A.charAt(0).toUpperCase()+A.slice(1);return d[K]={type:"object",properties:Object.entries(c.fields).reduce((m,[u,l])=>(m[u]={type:l.type},m),{})},d},{})}};Object.entries(r.api).forEach(([d,A])=>{let c=A.options;if(!c.metadata?.SERVER_ONLY&&(c.method==="GET"&&(Ze[A.path]={get:{tags:["Default",...c.metadata?.openapi?.tags||[]],description:c.metadata?.openapi?.description,operationId:c.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:po(c),responses:uo(c.metadata?.openapi?.responses)}}),c.method==="POST")){let K=wt(c);Ze[A.path]={post:{tags:["Default",...c.metadata?.openapi?.tags||[]],description:c.metadata?.openapi?.description,operationId:c.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:po(c),...K?{requestBody:K}:{requestBody:{content:{"application/json":{schema:{type:"object",properties:{}}}}}},responses:uo(c.metadata?.openapi?.responses)}}}});for(let d of i.plugins||[]){if(d.id==="open-api")continue;let A=To(e,{...i,plugins:[d]}),c=Object.keys(A.api).map(K=>r.api[K]===void 0?A.api[K]:null).filter(K=>K!==null);Object.entries(c).forEach(([K,m])=>{let u=m.options;u.metadata?.SERVER_ONLY||(u.method==="GET"&&(Ze[m.path]={get:{tags:u.metadata?.openapi?.tags||[d.id.charAt(0).toUpperCase()+d.id.slice(1)],description:u.metadata?.openapi?.description,operationId:u.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:po(u),responses:uo(u.metadata?.openapi?.responses)}}),u.method==="POST"&&(Ze[m.path]={post:{tags:u.metadata?.openapi?.tags||[d.id.charAt(0).toUpperCase()+d.id.slice(1)],description:u.metadata?.openapi?.description,operationId:u.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:po(u),requestBody:wt(u),responses:uo(u.metadata?.openapi?.responses)}}))})}return{openapi:"3.1.1",info:{title:"Better Auth",description:"API Reference for your Better Auth Instance"},components:n,security:[{apiKeyCookie:[]}],servers:[{url:e.baseURL}],tags:[{name:"Default",description:"Default endpoints that are included with Better Auth by default. These endpoints are not part of any plugin."}],paths:Ze}}a(Po,"generator");var Tt=`<svg width="75" height="75" viewBox="0 0 75 75" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<rect width="75" height="75" fill="url(#pattern0_21_12)"/>
<defs>
<pattern id="pattern0_21_12" patternContentUnits="objectBoundingBox" width="1" height="1">
<use xlink:href="#image0_21_12" transform="scale(0.00094697)"/>
</pattern>
<image id="image0_21_12" width="1056" height="1056" xlink:href="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAASABIAAD/4QBARXhpZgAATU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAEIKADAAQAAAABAAAEIAAAAAD/7QA4UGhvdG9zaG9wIDMuMAA4QklNBAQAAAAAAAA4QklNBCUAAAAAABDUHYzZjwCyBOmACZjs+EJ+/+ICKElDQ19QUk9GSUxFAAEBAAACGGFwcGwEAAAAbW50clJHQiBYWVogB+YAAQABAAAAAAAAYWNzcEFQUEwAAAAAQVBQTAAAAAAAAAAAAAAAAAAAAAAAAPbWAAEAAAAA0y1hcHBs7P2jjjiFR8NttL1PetoYLwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKZGVzYwAAAPwAAAAwY3BydAAAASwAAABQd3RwdAAAAXwAAAAUclhZWgAAAZAAAAAUZ1hZWgAAAaQAAAAUYlhZWgAAAbgAAAAUclRSQwAAAcwAAAAgY2hhZAAAAewAAAAsYlRSQwAAAcwAAAAgZ1RSQwAAAcwAAAAgbWx1YwAAAAAAAAABAAAADGVuVVMAAAAUAAAAHABEAGkAcwBwAGwAYQB5ACAAUAAzbWx1YwAAAAAAAAABAAAADGVuVVMAAAA0AAAAHABDAG8AcAB5AHIAaQBnAGgAdAAgAEEAcABwAGwAZQAgAEkAbgBjAC4ALAAgADIAMAAyADJYWVogAAAAAAAA9tUAAQAAAADTLFhZWiAAAAAAAACD3wAAPb////+7WFlaIAAAAAAAAEq/AACxNwAACrlYWVogAAAAAAAAKDgAABELAADIuXBhcmEAAAAAAAMAAAACZmYAAPKnAAANWQAAE9AAAApbc2YzMgAAAAAAAQxCAAAF3v//8yYAAAeTAAD9kP//+6L///2jAAAD3AAAwG7/wAARCAQgBCADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9sAQwACAgICAgIDAgIDBAMDAwQFBAQEBAUHBQUFBQUHCAcHBwcHBwgICAgICAgICgoKCgoKCwsLCwsNDQ0NDQ0NDQ0N/9sAQwECAgIDAwMGAwMGDQkHCQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0N/90ABABC/9oADAMBAAIRAxEAPwD9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//Q/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9L9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//T/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9X9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//W/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//R/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9P9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//U/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9b9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//X/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9H9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//S/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9T9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//V/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Ln/gq38a/in8Dvgp4T8R/CfxFdeG9SvvFMdlcXFoELyW5srqQxnzEcY3op4Gciv1Gr8Z/+C2X/JvXgj/sc4v/AE33lAH4z/8ADwv9tD/oq2tf9823/wAZo/4eF/tof9FW1r/vm2/+M18Z0UAfZn/Dwv8AbQ/6KtrX/fNt/wDGaP8Ah4X+2h/0VbWv++bb/wCM18Z0UAfZn/Dwv9tD/oq2tf8AfNt/8Zo/4eF/tof9FW1r/vm2/wDjNfGdFAH2Z/w8L/bQ/wCira1/3zbf/GaP+Hhf7aH/AEVbWv8Avm2/+M18Z0UAfZn/AA8L/bQ/6KtrX/fNt/8AGaP+Hhf7aH/RVta/75tv/jNfGdFAH2Z/w8L/AG0P+ira1/3zbf8Axmj/AIeF/tof9FW1r/vm2/8AjNfGdFAH63/sVftq/tTfEb9qb4deCfG3xF1TVtD1bVGgvbKdYBHPGIJW2ttiVsblB4I6V/UbX8Z//BPT/k9D4U/9hpv/AEmmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+M/wD4eF/tof8ARVta/wC+bb/4zR/w8L/bQ/6KtrX/AHzbf/Ga+M6KAPsz/h4X+2h/0VbWv++bb/4zR/w8L/bQ/wCira1/3zbf/Ga+M6KAPsz/AIeF/tof9FW1r/vm2/8AjNH/AA8L/bQ/6KtrX/fNt/8AGa+M6KAPsz/h4X+2h/0VbWv++bb/AOM0f8PC/wBtD/oq2tf9823/AMZr4zooA+zP+Hhf7aH/AEVbWv8Avm2/+M0f8PC/20P+ira1/wB823/xmvjOigD7M/4eF/tof9FW1r/vm2/+M0f8PC/20P8Aoq2tf9823/xmvjOigD7M/wCHhf7aH/RVta/75tv/AIzR/wAPC/20P+ira1/3zbf/ABmvjOigD7M/4eF/tof9FW1r/vm2/wDjNH/Dwv8AbQ/6KtrX/fNt/wDGa+M6KAPsz/h4X+2h/wBFW1r/AL5tv/jNH/Dwv9tD/oq2tf8AfNt/8Zr4zooA+zP+Hhf7aH/RVta/75tv/jNH/Dwv9tD/AKKtrX/fNt/8Zr4zooA+zP8Ah4X+2h/0VbWv++bb/wCM0f8ADwv9tD/oq2tf9823/wAZr4zooA+zP+Hhf7aH/RVta/75tv8A4zR/w8L/AG0P+ira1/3zbf8AxmvjOigD7M/4eF/tof8ARVta/wC+bb/4zR/w8L/bQ/6KtrX/AHzbf/Ga+M6KAP6tv+CUnxr+Kfxx+CnizxH8WPEV14k1Kx8UyWVvcXYQPHbiytZBGPLRBje7HkZya/Uavxn/AOCJv/JvXjf/ALHOX/032dfsxQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAf//X/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooA+zP+Cen/J6Hwp/7DTf+k01f2YV/Gf8A8E9P+T0PhT/2Gm/9Jpq/swoAKKKKACiiigAooooAKKKKACiiigAooooA/gDooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD7M/4J6f8nofCn/sNN/6TTV/ZhX8Z/wDwT0/5PQ+FP/Yab/0mmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+AOiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/0f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKAPsz/gnp/yeh8Kf+w03/pNNX9mFfxn/APBPT/k9D4U/9hpv/Saav7MKACiiigAooooAKKKKACiiigAooooAKKKKAP4A6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/JvXjf/ALHOX/032dfsxX4z/wDBE3/k3rxv/wBjnL/6b7Ov2YoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/S/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooA+zP+Cen/J6Hwp/7DTf+k01f2YV/Gf8A8E9P+T0PhT/2Gm/9Jpq/swoAKKKKACiiigAooooAKKKKACiiigAooooA/gDooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9P9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD7M/4J6f8nofCn/sNN/6TTV/ZhX8Z/wDwT0/5PQ+FP/Yab/0mmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+AOiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/1P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKAPsz/gnp/yeh8Kf+w03/pNNX9mFfwq/BT4r638Dvin4d+LHhy0tb7UvDd0bu3t70ObeRzG0eJBGyPjDnowOa/Ub/h9l+0L/ANCR4M/79ah/8m0Af0yUV/M3/wAPsv2hf+hI8Gf9+tQ/+TaP+H2X7Qv/AEJHgz/v1qH/AMm0Af0yUV/M3/w+y/aF/wChI8Gf9+tQ/wDk2j/h9l+0L/0JHgz/AL9ah/8AJtAH9MlFfzN/8Psv2hf+hI8Gf9+tQ/8Ak2j/AIfZftC/9CR4M/79ah/8m0Af0yUV/M3/AMPsv2hf+hI8Gf8AfrUP/k2j/h9l+0L/ANCR4M/79ah/8m0Af0yUV/M3/wAPsv2hf+hI8Gf9+tQ/+TaP+H2X7Qv/AEJHgz/v1qH/AMm0Af0yUV/M3/w+y/aF/wChI8Gf9+tQ/wDk2j/h9l+0L/0JHgz/AL9ah/8AJtAH4z0V/TJ/w5N/Z6/6Hfxn/wB/dP8A/kKj/hyb+z1/0O/jP/v7p/8A8hUAfzN0V/TJ/wAOTf2ev+h38Z/9/dP/APkKj/hyb+z1/wBDv4z/AO/un/8AyFQB/M3RX9Mn/Dk39nr/AKHfxn/390//AOQqP+HJv7PX/Q7+M/8Av7p//wAhUAfzN0V/TJ/w5N/Z6/6Hfxn/AN/dP/8AkKj/AIcm/s9f9Dv4z/7+6f8A/IVAH8zdFf0yf8OTf2ev+h38Z/8Af3T/AP5Co/4cm/s9f9Dv4z/7+6f/APIVAH8zdFf0yf8ADk39nr/od/Gf/f3T/wD5Co/4cm/s9f8AQ7+M/wDv7p//AMhUAfzN0V/TJ/w5N/Z6/wCh38Z/9/dP/wDkKvwV/ag+FGifA74++M/hP4cu7q+03w3fi0t7i9KG4kQxRyZkMaomcueigYoA8FooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/AOxzl/8ATfZ1+zFfjP8A8ETf+TevG/8A2Ocv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//9X9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v8ooooAKKKKACiiigAooooAKKKKACiiigAr+M//goX/wAnofFb/sNL/wCk0Nf2YV/Gf/wUL/5PQ+K3/YaX/wBJoaAPjOiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/JvXjf/ALHOX/032dfsxX4z/wDBE3/k3rxv/wBjnL/6b7Ov2YoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/W/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP7/KKKKACiiigAooooAKKKKACiiigAooooAK/jP/4KF/8AJ6HxW/7DS/8ApNDX9mFfxn/8FC/+T0Pit/2Gl/8ASaGgD4zooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/1/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+/yiiigAooooAKKKKACiiigAooooAKKKKACv4z/+Chf/ACeh8Vv+w0v/AKTQ1/ZhX8Z//BQv/k9D4rf9hpf/AEmhoA+M6KKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v8ooooAKKKKACiiigAooooAKKKKACiiigAr+M//goX/wAnofFb/sNL/wCk0Nf2YV/Gf/wUL/5PQ+K3/YaX/wBJoaAPjOiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/JvXjf/ALHOX/032dfsxX4z/wDBE3/k3rxv/wBjnL/6b7Ov2YoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/R/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP7/KKKKACiiigAooooAKKKKACiiigAooooAK/jP/4KF/8AJ6HxW/7DS/8ApNDX9mFfxn/8FC/+T0Pit/2Gl/8ASaGgD4zooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/0v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+/yiiigAooooAKKKKACiiigAooooAKKKKACv4z/+Chf/ACeh8Vv+w0v/AKTQ1/ZhX8Z//BQv/k9D4rf9hpf/AEmhoA+M6KKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9P9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD1L4KfCjW/jj8U/Dvwn8OXdrY6l4kujaW9xelxbxuI2kzIY1d8YQ9FJzX6jf8OTf2hf8Aod/Bn/f3UP8A5Cr4z/4J6f8AJ6Hwp/7DTf8ApNNX9mFAH8zf/Dk39oX/AKHfwZ/391D/AOQqP+HJv7Qv/Q7+DP8Av7qH/wAhV/TJRQB/M3/w5N/aF/6HfwZ/391D/wCQqP8Ahyb+0L/0O/gz/v7qH/yFX9MlFAH8zf8Aw5N/aF/6HfwZ/wB/dQ/+QqP+HJv7Qv8A0O/gz/v7qH/yFX9MlFAH8zf/AA5N/aF/6HfwZ/391D/5Co/4cm/tC/8AQ7+DP+/uof8AyFX9MlFAH8zf/Dk39oX/AKHfwZ/391D/AOQqP+HJv7Qv/Q7+DP8Av7qH/wAhV/TJRQB/M3/w5N/aF/6HfwZ/391D/wCQqP8Ahyb+0L/0O/gz/v7qH/yFX9MlFAH4z/8AD7L9nr/oSPGf/frT/wD5No/4fZfs9f8AQkeM/wDv1p//AMm1/M3RQB/TJ/w+y/Z6/wChI8Z/9+tP/wDk2j/h9l+z1/0JHjP/AL9af/8AJtfzN0UAf0yf8Psv2ev+hI8Z/wDfrT//AJNo/wCH2X7PX/QkeM/+/Wn/APybX8zdFAH9Mn/D7L9nr/oSPGf/AH60/wD+TaP+H2X7PX/QkeM/+/Wn/wDybX8zdFAH9Mn/AA+y/Z6/6Ejxn/360/8A+TaP+H2X7PX/AEJHjP8A79af/wDJtfzN0UAf0yf8Psv2ev8AoSPGf/frT/8A5No/4fZfs9f9CR4z/wC/Wn//ACbX8zdFAH9Mn/D7L9nr/oSPGf8A360//wCTa/BX9qD4r6J8cfj74z+LHhy0urHTfEl+Lu3t70ILiNBFHHiQRs6Zyh6MRivBaKACiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/ACb143/7HOX/ANN9nX7MV+M//BE3/k3rxv8A9jnL/wCm+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//U/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooA+zP+Cen/J6Hwp/7DTf+k01f2YV/Gf8A8E9P+T0PhT/2Gm/9Jpq/swoAKKKKACiiigAooooAKKKKACiiigAooooA/gDooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9X9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD7M/4J6f8nofCn/sNN/6TTV/ZhX8Z/wDwT0/5PQ+FP/Yab/0mmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+AOiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/1v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKAPsz/gnp/yeh8Kf+w03/pNNX9mFfxn/APBPT/k9D4U/9hpv/Saav7MKACiiigAooooAKKKKACiiigAooooAKKKKAP4A6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/JvXjf/ALHOX/032dfsxX4z/wDBE3/k3rxv/wBjnL/6b7Ov2YoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/X/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooA+zP+Cen/J6Hwp/7DTf+k01f2YV/Gf8A8E9P+T0PhT/2Gm/9Jpq/swoAKKKKACiiigAooooAKKKKACiiigAooooA/gDooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD7M/4J6f8nofCn/sNN/6TTV/ZhX8Z/wDwT0/5PQ+FP/Yab/0mmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+AOiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/0f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+XP/BVv4KfFP44/BTwn4c+E/h268SalY+KY724t7QoHjtxZXUZkPmOgxvdRwc5NAH8pNFfZn/DvT9tD/olOtf99W3/AMeo/wCHen7aH/RKda/76tv/AI9QB8Z0V9mf8O9P20P+iU61/wB9W3/x6j/h3p+2h/0SnWv++rb/AOPUAfGdFfZn/DvT9tD/AKJTrX/fVt/8eo/4d6ftof8ARKda/wC+rb/49QB8Z0V9mf8ADvT9tD/olOtf99W3/wAeo/4d6ftof9Ep1r/vq2/+PUAfGdFfZn/DvT9tD/olOtf99W3/AMeo/wCHen7aH/RKda/76tv/AI9QB8Z0V9mf8O9P20P+iU61/wB9W3/x6j/h3p+2h/0SnWv++rb/AOPUAH/BPT/k9D4U/wDYab/0mmr+zCv5cv2Kv2Kv2pvhz+1N8OvG3jb4dappOh6TqjT3t7O0BjgjMEq7m2ys2NzAcA9a/qNoAKKKKACiiigAooooAKKKKACiiigAooooA/gDor7M/wCHen7aH/RKda/76tv/AI9R/wAO9P20P+iU61/31bf/AB6gD4zor7M/4d6ftof9Ep1r/vq2/wDj1H/DvT9tD/olOtf99W3/AMeoA+M6K+zP+Hen7aH/AESnWv8Avq2/+PUf8O9P20P+iU61/wB9W3/x6gD4zor7M/4d6ftof9Ep1r/vq2/+PUf8O9P20P8AolOtf99W3/x6gD4zor7M/wCHen7aH/RKda/76tv/AI9R/wAO9P20P+iU61/31bf/AB6gD4zor7M/4d6ftof9Ep1r/vq2/wDj1H/DvT9tD/olOtf99W3/AMeoA+M6K+zP+Hen7aH/AESnWv8Avq2/+PUf8O9P20P+iU61/wB9W3/x6gD4zor7M/4d6ftof9Ep1r/vq2/+PUf8O9P20P8AolOtf99W3/x6gD4zor7M/wCHen7aH/RKda/76tv/AI9R/wAO9P20P+iU61/31bf/AB6gD4zor7M/4d6ftof9Ep1r/vq2/wDj1H/DvT9tD/olOtf99W3/AMeoA+M6K+zP+Hen7aH/AESnWv8Avq2/+PUf8O9P20P+iU61/wB9W3/x6gD4zor7M/4d6ftof9Ep1r/vq2/+PUf8O9P20P8AolOtf99W3/x6gD4zor7M/wCHen7aH/RKda/76tv/AI9R/wAO9P20P+iU61/31bf/AB6gD9mP+CJv/JvXjf8A7HOX/wBN9nX7MV+XP/BKT4KfFP4HfBTxZ4c+LHh268N6lfeKZL23t7soXktzZWsYkHlu4xvRhyc5FfqNQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAf/9L9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//T/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9X9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//W/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//R/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9P9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//U/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9b9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//X/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9H9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//S/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9T9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//V/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9f9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//Q/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/2Q=="/>
</defs>
</svg>
`;var hn=a(e=>`<!doctype html>
<html>
  <head>
    <title>Scalar API Reference</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <script
      id="api-reference"
      type="application/json">
    ${JSON.stringify(e)}
    </script>
	 <script>
      var configuration = {
	  	favicon: "data:image/svg+xml;utf8,${encodeURIComponent(Tt)}",
	   	theme: "saturn",
        metaData: {
			title: "Better Auth API",
			description: "API Reference for your Better Auth Instance",
		}
      }

      document.getElementById('api-reference').dataset.configuration =
        JSON.stringify(configuration)
    </script>
	  <script src="https://cdn.jsdelivr.net/npm/@scalar/api-reference"></script>
  </body>
</html>`,"getHTML"),kh=a(e=>{let i=e?.path??"/reference";return{id:"open-api",endpoints:{generateOpenAPISchema:p("/open-api/generate-schema",{method:"GET"},async r=>{let o=await Po(r.context,r.context.options);return r.json(o)}),openAPIReference:p(i,{method:"GET",metadata:{isAction:!1}},async r=>{if(e?.disableDefaultReference)throw new g("NOT_FOUND");let o=await Po(r.context,r.context.options);return new Response(hn(o),{headers:{"Content-Type":"text/html"}})})}}},"openAPI");import{SignJWT as yn}from"jose";import{z as ee}from"zod";var Et={oauthApplication:{modelName:"oauthApplication",fields:{name:{type:"string"},icon:{type:"string",required:!1},metadata:{type:"string",required:!1},clientId:{type:"string",unique:!0},clientSecret:{type:"string"},redirectURLs:{type:"string"},type:{type:"string"},disabled:{type:"boolean",required:!1,defaultValue:!1},userId:{type:"string",required:!1},createdAt:{type:"date"},updatedAt:{type:"date"}}},oauthAccessToken:{modelName:"oauthAccessToken",fields:{accessToken:{type:"string",unique:!0},refreshToken:{type:"string",unique:!0},accessTokenExpiresAt:{type:"date"},refreshTokenExpiresAt:{type:"date"},clientId:{type:"string"},userId:{type:"string",required:!1},scopes:{type:"string"},createdAt:{type:"date"},updatedAt:{type:"date"}}},oauthConsent:{modelName:"oauthConsent",fields:{clientId:{type:"string"},userId:{type:"string"},scopes:{type:"string"},createdAt:{type:"date"},updatedAt:{type:"date"},consentGiven:{type:"boolean"}}}};import{APIError as No}from"better-call";function Qe(e,i,r){return`${e.includes("?")?"&":"?"}error=${i}&error_description=${r}`}a(Qe,"redirectErrorURL");async function Lo(e,i){let r={codeExpiresIn:600,defaultScope:"openid",...i,scopes:["openid","profile","email","offline_access",...i?.scopes||[]]};if(!e.request)throw new No("UNAUTHORIZED",{error_description:"request not found",error:"invalid_request"});let o=await _(e);if(!o){await e.setSignedCookie("oidc_login_prompt",JSON.stringify(e.query),e.context.secret,{maxAge:600});let y=e.request.url?.split("?")[1];throw e.redirect(`${i.loginPage}?${y}`)}let t=e.query;if(!t.client_id)throw e.redirect(`${e.context.baseURL}/error?error=invalid_client`);if(!t.response_type)throw e.redirect(Qe(`${e.context.baseURL}/error`,"invalid_request","response_type is required"));let n=await e.context.adapter.findOne({model:"oauthApplication",where:[{field:"clientId",value:e.query.client_id}]}).then(y=>y?{...y,redirectURLs:y.redirectURLs.split(","),metadata:y.metadata?JSON.parse(y.metadata):{}}:null);if(!n)throw e.redirect(`${e.context.baseURL}/error?error=invalid_client`);let s=n.redirectURLs.find(y=>y===e.query.redirect_uri);if(!s||!t.redirect_uri)throw new No("BAD_REQUEST",{message:"Invalid redirect URI"});if(n.disabled)throw e.redirect(`${e.context.baseURL}/error?error=client_disabled`);if(t.response_type!=="code")throw e.redirect(`${e.context.baseURL}/error?error=unsupported_response_type`);let d=t.scope?.split(" ").filter(y=>y)||r.defaultScope.split(" "),A=d.filter(y=>!r.scopes.includes(y)||y==="offline_access"&&t.prompt!=="consent");if(A.length)throw e.redirect(Qe(t.redirect_uri,"invalid_scope",`The following scopes are invalid: ${A.join(", ")}`));if((!t.code_challenge||!t.code_challenge_method)&&i.requirePKCE)throw e.redirect(Qe(t.redirect_uri,"invalid_request","pkce is required"));if(!["s256",i.allowPlainCodeChallengeMethod?"plain":"s256"].includes(t.code_challenge_method?.toLowerCase()||""))throw e.redirect(Qe(t.redirect_uri,"invalid_request","invalid code_challenge method"));let c=R(32,"a-z","A-Z","0-9"),K=r.codeExpiresIn*1e3,m=new Date(Date.now()+K);try{await e.context.internalAdapter.createVerificationValue({value:JSON.stringify({clientId:n.clientId,redirectURI:t.redirect_uri,scope:d,userId:o.user.id,authTime:o.session.createdAt.getTime(),requireConsent:t.prompt==="consent",state:t.prompt==="consent"?t.state:null,codeChallenge:t.code_challenge,codeChallengeMethod:t.code_challenge_method}),identifier:c,expiresAt:m})}catch{throw e.redirect(Qe(t.redirect_uri,"server_error","An error occurred while processing the request"))}let u=new URL(s);if(u.searchParams.set("code",c),u.searchParams.set("state",e.query.state),t.prompt!=="consent"||await e.context.adapter.findOne({model:"oauthConsent",where:[{field:"clientId",value:n.clientId},{field:"userId",value:o.user.id}]}).then(y=>!!y?.consentGiven))throw e.redirect(u.toString());if(i?.consentPage){await e.setSignedCookie("oidc_consent_prompt",c,e.context.secret,{maxAge:600});let y=`${i.consentPage}?client_id=${n.clientId}&scope=${d.join(" ")}`;throw e.redirect(y)}let w=i?.getConsentHTML;if(!w)throw new No("INTERNAL_SERVER_ERROR",{message:"No consent page provided"});return new Response(w({scopes:d,clientMetadata:n.metadata,clientIcon:n?.icon,clientId:n.clientId,clientName:n.name,code:c}),{headers:{"content-type":"text/html"}})}a(Lo,"authorize");import{createHash as wn}from"@better-auth/utils/hash";var Cn=a((e,i)=>{let r=e.context.options.baseURL,o=e.context.baseURL;return{issuer:r,authorization_endpoint:`${o}/oauth2/authorize`,token_endpoint:`${o}/oauth2/token`,userInfo_endpoint:`${o}/oauth2/userinfo`,jwks_uri:`${o}/jwks`,registration_endpoint:`${o}/oauth2/register`,scopes_supported:["openid","profile","email","offline_access"],response_types_supported:["code"],response_modes_supported:["query"],grant_types_supported:["authorization_code"],acr_values_supported:["urn:mace:incommon:iap:silver","urn:mace:incommon:iap:bronze"],subject_types_supported:["public"],id_token_signing_alg_values_supported:["RS256","none"],token_endpoint_auth_methods_supported:["client_secret_basic","client_secret_post"],claims_supported:["sub","iss","aud","exp","nbf","iat","jti","email","email_verified","name"],...i?.metadata}},"getMetadata"),Xh=a(e=>{let i={oauthClient:"oauthApplication",oauthAccessToken:"oauthAccessToken",oauthConsent:"oauthConsent"},r={codeExpiresIn:600,defaultScope:"openid",accessTokenExpiresIn:3600,refreshTokenExpiresIn:604800,...e,scopes:["openid","profile","email","offline_access",...e?.scopes||[]]};return{id:"oidc",hooks:{after:[{matcher(){return!0},handler:a(async o=>{let t=await o.getSignedCookie("oidc_login_prompt",o.context.secret),n=o.context.authCookies.sessionToken.name,s=ye(o.responseHeader.get("set-cookie")||""),d=s.has(n);if(!t||!d)return;o.setCookie("oidc_login_prompt","",{maxAge:0});let c=s.get(n)?.value?.split(".")[0];if(!c)return;let K=await o.context.internalAdapter.findSession(c);return K?(o.query=JSON.parse(t),o.query.prompt="consent",o.context.session=K,await Lo(o,r)):void 0},"handler")}]},endpoints:{getOpenIdConfig:p("/.well-known/openid-configuration",{method:"GET"},async o=>Cn(o,e)),oAuth2authorize:p("/oauth2/authorize",{method:"GET",query:ee.record(ee.string(),ee.any())},async o=>Lo(o,r)),oAuthConsent:p("/oauth2/consent",{method:"POST",body:ee.object({accept:ee.boolean()}),use:[I]},async o=>{let t=await o.getSignedCookie("oidc_consent_prompt",o.context.secret);if(!t)throw new g("UNAUTHORIZED",{error_description:"No consent prompt found",error:"invalid_grant"});let n=await o.context.internalAdapter.findVerificationValue(t);if(!n)throw new g("UNAUTHORIZED",{error_description:"Invalid code",error:"invalid_grant"});if(n.expiresAt<new Date)throw await o.context.internalAdapter.deleteVerificationValue(n.id),new g("UNAUTHORIZED",{error_description:"Code expired",error:"invalid_grant"});let s=JSON.parse(n.value);if(!s.requireConsent||!s.state)throw new g("UNAUTHORIZED",{error_description:"Consent not required",error:"invalid_grant"});if(!o.body.accept)return await o.context.internalAdapter.deleteVerificationValue(n.id),o.json({redirectURI:`${s.redirectURI}?error=access_denied&error_description=User denied access`});let d=R(32,"a-z","A-Z","0-9"),A=r.codeExpiresIn*1e3,c=new Date(Date.now()+A);await o.context.internalAdapter.updateVerificationValue(n.id,{value:JSON.stringify({...s,requireConsent:!1}),identifier:d,expiresAt:c}),await o.context.adapter.create({model:i.oauthConsent,data:{clientId:s.clientId,userId:s.userId,scopes:s.scope.join(" "),consentGiven:!0,createdAt:new Date,updatedAt:new Date}});let K=new URL(s.redirectURI);return K.searchParams.set("code",d),K.searchParams.set("state",s.state),o.json({redirectURI:K.toString()})}),oAuth2token:p("/oauth2/token",{method:"POST",body:ee.any(),metadata:{isAction:!1}},async o=>{let{body:t}=o;if(!t)throw new g("BAD_REQUEST",{error_description:"request body not found",error:"invalid_request"});if(t instanceof FormData&&(t=Object.fromEntries(t.entries())),!(t instanceof Object))throw new g("BAD_REQUEST",{error_description:"request body is not an object",error:"invalid_request"});let{client_id:n,client_secret:s,grant_type:d,code:A,redirect_uri:c,refresh_token:K,code_verifier:m}=t;if(d==="refresh_token"){if(!K)throw new g("BAD_REQUEST",{error_description:"refresh_token is required",error:"invalid_request"});let oe=await o.context.adapter.findOne({model:i.oauthAccessToken,where:[{field:"refreshToken",value:K.toString()}]});if(!oe)throw new g("UNAUTHORIZED",{error_description:"invalid refresh token",error:"invalid_grant"});if(oe.clientId!==n?.toString())throw new g("UNAUTHORIZED",{error_description:"invalid client_id",error:"invalid_client"});if(oe.refreshTokenExpiresAt<new Date)throw new g("UNAUTHORIZED",{error_description:"refresh token expired",error:"invalid_grant"});let jo=R(32,"a-z","A-Z"),zo=R(32,"a-z","A-Z"),St=new Date(Date.now()+r.accessTokenExpiresIn*1e3),vt=new Date(Date.now()+r.refreshTokenExpiresIn*1e3);return await o.context.adapter.create({model:i.oauthAccessToken,data:{accessToken:jo,refreshToken:zo,accessTokenExpiresAt:St,refreshTokenExpiresAt:vt,clientId:n.toString(),userId:oe.userId,scopes:oe.scopes,createdAt:new Date,updatedAt:new Date}}),o.json({access_token:jo,token_type:"bearer",expires_in:r.accessTokenExpiresIn,refresh_token:zo,scope:oe.scopes})}if(!A)throw new g("BAD_REQUEST",{error_description:"code is required",error:"invalid_request"});if(e.requirePKCE&&!m)throw new g("BAD_REQUEST",{error_description:"code verifier is missing",error:"invalid_request"});let u=await o.context.internalAdapter.findVerificationValue(A.toString());if(!u)throw new g("UNAUTHORIZED",{error_description:"invalid code",error:"invalid_grant"});if(u.expiresAt<new Date)throw await o.context.internalAdapter.deleteVerificationValue(u.id),new g("UNAUTHORIZED",{error_description:"code expired",error:"invalid_grant"});if(await o.context.internalAdapter.deleteVerificationValue(u.id),!n||!s)throw new g("UNAUTHORIZED",{error_description:"client_id and client_secret are required",error:"invalid_client"});if(!d)throw new g("BAD_REQUEST",{error_description:"grant_type is required",error:"invalid_request"});if(d!=="authorization_code")throw new g("BAD_REQUEST",{error_description:"grant_type must be 'authorization_code'",error:"unsupported_grant_type"});if(!c)throw new g("BAD_REQUEST",{error_description:"redirect_uri is required",error:"invalid_request"});let l=await o.context.adapter.findOne({model:i.oauthClient,where:[{field:"clientId",value:n.toString()}]}).then(oe=>oe?{...oe,redirectURLs:oe.redirectURLs.split(","),metadata:oe.metadata?JSON.parse(oe.metadata):{}}:null);if(!l)throw new g("UNAUTHORIZED",{error_description:"invalid client_id",error:"invalid_client"});if(l.disabled)throw new g("UNAUTHORIZED",{error_description:"client is disabled",error:"invalid_client"});if(!(l.clientSecret===s.toString()))throw new g("UNAUTHORIZED",{error_description:"invalid client_secret",error:"invalid_client"});let y=JSON.parse(u.value);if(y.clientId!==n.toString())throw new g("UNAUTHORIZED",{error_description:"invalid client_id",error:"invalid_client"});if(y.redirectURI!==c.toString())throw new g("UNAUTHORIZED",{error_description:"invalid redirect_uri",error:"invalid_client"});if(y.codeChallenge&&!m)throw new g("BAD_REQUEST",{error_description:"code verifier is missing",error:"invalid_request"});if((y.codeChallengeMethod==="plain"?m:await wn("SHA-256","base64urlnopad").digest(m))!==y.codeChallenge)throw new g("UNAUTHORIZED",{error_description:"code verification failed",error:"invalid_request"});let F=y.scope;await o.context.internalAdapter.deleteVerificationValue(A.toString());let M=R(32,"a-z","A-Z"),f=R(32,"A-Z","a-z"),T=new Date(Date.now()+r.accessTokenExpiresIn*1e3),k=new Date(Date.now()+r.refreshTokenExpiresIn*1e3);await o.context.adapter.create({model:i.oauthAccessToken,data:{accessToken:M,refreshToken:f,accessTokenExpiresAt:T,refreshTokenExpiresAt:k,clientId:n.toString(),userId:y.userId,scopes:F.join(" "),createdAt:new Date,updatedAt:new Date}});let U=await o.context.internalAdapter.findUserById(y.userId);if(!U)throw new g("UNAUTHORIZED",{error_description:"user not found",error:"invalid_grant"});let Ge={alg:"HS256",key:await crypto.subtle.generateKey({name:"HMAC",hash:"SHA-256"},!0,["sign","verify"])},It={given_name:U.name.split(" ")[0],family_name:U.name.split(" ")[1],name:U.name,profile:U.image,updated_at:U.updatedAt.toISOString()},Rt={email:U.email,email_verified:U.emailVerified},_t={...F.includes("profile")?It:{},...F.includes("email")?Rt:{}},Ut=await new yn({sub:U.id,aud:n.toString(),iat:Date.now(),auth_time:o.context.session?.session.createdAt.getTime(),nonce:t.nonce,acr:"urn:mace:incommon:iap:silver",..._t}).setProtectedHeader({alg:Ge.alg}).setIssuedAt().setExpirationTime(Math.floor(Date.now()/1e3)+r.accessTokenExpiresIn).sign(Ge.key);return o.json({access_token:M,token_type:"Bearer",expires_in:r.accessTokenExpiresIn,refresh_token:F.includes("offline_access")?f:void 0,scope:F.join(" "),id_token:F.includes("openid")?Ut:void 0},{headers:{"Cache-Control":"no-store",Pragma:"no-cache"}})}),oAuth2userInfo:p("/oauth2/userinfo",{method:"GET",metadata:{isAction:!1}},async o=>{if(!o.request)throw new g("UNAUTHORIZED",{error_description:"request not found",error:"invalid_request"});let t=o.request.headers.get("authorization");if(!t)throw new g("UNAUTHORIZED",{error_description:"authorization header not found",error:"invalid_request"});let n=t.replace("Bearer ",""),s=await o.context.adapter.findOne({model:i.oauthAccessToken,where:[{field:"accessToken",value:n}]});if(!s)throw new g("UNAUTHORIZED",{error_description:"invalid access token",error:"invalid_token"});if(s.accessTokenExpiresAt<new Date)throw new g("UNAUTHORIZED",{error_description:"The Access Token expired",error:"invalid_token"});let d=await o.context.internalAdapter.findUserById(s.userId);if(!d)throw new g("UNAUTHORIZED",{error_description:"user not found",error:"invalid_token"});let A=s.scopes.split(" "),c={email:A.includes("email")?d.email:void 0,name:A.includes("profile")?d.name:void 0,picture:A.includes("profile")?d.image:void 0,given_name:A.includes("profile")?d.name.split(" ")[0]:void 0,family_name:A.includes("profile")?d.name.split(" ")[1]:void 0,email_verified:A.includes("email")?d.emailVerified:void 0};return o.json(c)}),registerOAuthApplication:p("/oauth2/register",{method:"POST",body:ee.object({name:ee.string(),icon:ee.string().optional(),metadata:ee.record(ee.any()).optional(),redirectURLs:ee.array(ee.string())})},async o=>{let t=o.body,n=await _(o);if(!n&&!e.allowDynamicClientRegistration)throw new g("UNAUTHORIZED",{message:"Unauthorized"});let s=e.generateClientId?.()||R(32,"a-z","A-Z"),d=e.generateClientSecret?.()||R(32,"a-z","A-Z"),A=await o.context.adapter.create({model:i.oauthClient,data:{name:t.name,icon:t.icon,metadata:t.metadata?JSON.stringify(t.metadata):null,clientId:s,clientSecret:d,redirectURLs:t.redirectURLs.join(","),type:"web",authenticationScheme:"client_secret",disabled:!1,userId:n?.session.userId,createdAt:new Date,updatedAt:new Date}});return o.json({...A,redirectURLs:A.redirectURLs.split(","),metadata:A.metadata?JSON.parse(A.metadata):null})}),getOAuthClient:p("/oauth2/client/:id",{method:"GET",use:[I]},async o=>{let t=await o.context.adapter.findOne({model:i.oauthClient,where:[{field:"clientId",value:o.params.id}]});if(!t)throw new g("NOT_FOUND",{error_description:"client not found",error:"not_found"});return o.json({clientId:t.clientId,name:t.name,icon:t.icon})})},schema:Et}},"oidcProvider");export{Ie as HIDE_METADATA,Fm as admin,Em as anonymous,Jl as bearer,p as createAuthEndpoint,P as createAuthMiddleware,Wg as customSession,Rg as emailOTP,Ym as genericOAuth,ug as jwt,sm as magicLink,yg as multiSession,Hg as oAuthProxy,Xh as oidcProvider,jg as oneTap,kh as openAPI,Bo as optionsMiddleware,pu as organization,hm as phoneNumber,Dl as twoFactor,Kl as twoFactorClient,ut as username};
