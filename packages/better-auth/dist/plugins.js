import{APIError as it}from"better-call";import{z as Ue}from"zod";import{createEndpointCreator as vt,createMiddleware as zo,createMiddlewareCreator as kt}from"better-call";var xo=zo(async()=>({})),D=kt({use:[xo,zo(async()=>({}))]}),K=vt({use:[xo]});import{APIError as Z}from"better-call";import{z as M}from"zod";var te=class extends Error{constructor(i,r){super(i),this.name="BetterAuthError",this.message=i,this.cause=r,this.stack=""}};var P=(e,i="ms")=>new Date(Date.now()+(i==="sec"?e*1e3:e));var Ge=Object.create(null),Ne=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?Ge:globalThis),ue=new Proxy(Ge,{get(e,i){return Ne()[i]??Ge[i]},has(e,i){let r=Ne();return i in r||i in Ge},set(e,i,r){let o=Ne(!0);return o[i]=r,!0},deleteProperty(e,i){if(!i)return!1;let r=Ne(!0);return delete r[i],!0},ownKeys(){let e=Ne(!0);return Object.keys(e)}});function Dt(e){return e?e!=="false":!1}var uo=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var We=uo==="dev"||uo==="development",Pt=uo==="test"||Dt(ue.TEST);import{base64Url as Nt}from"@better-auth/utils/base64";import{createHMAC as Lt}from"@better-auth/utils/hmac";function he(e){let i=new Map;return e.split(", ").forEach(o=>{let t=o.split(";").map(l=>l.trim()),[n,...s]=t,[a,...d]=n.split("="),A=d.join("=");if(!a||A===void 0)return;let c={value:A};s.forEach(l=>{let[p,...u]=l.split("="),y=u.join("="),h=p.trim().toLowerCase();switch(h){case"max-age":c["max-age"]=y?parseInt(y.trim(),10):void 0;break;case"expires":c.expires=y?new Date(y.trim()):void 0;break;case"domain":c.domain=y?y.trim():void 0;break;case"path":c.path=y?y.trim():void 0;break;case"secure":c.secure=!0;break;case"httponly":c.httponly=!0;break;case"samesite":c.samesite=y?y.trim().toLowerCase():void 0;break;default:c[h]=y?y.trim():!0;break}}),i.set(a,c)}),i}async function lo(e,i){if(e.context.options.session?.cookieCache?.enabled){let o=Nt.encode(JSON.stringify({session:i,expiresAt:P(e.context.authCookies.sessionData.options.maxAge||60,"sec").getTime(),signature:await Lt("SHA-256","base64urlnopad").sign(e.context.secret,JSON.stringify(i))}),{padding:!1});if(o.length>4093)throw new te("Session data is too large to store in the cookie. Please disable session cookie caching or reduce the size of the session data");e.setCookie(e.context.authCookies.sessionData.name,o,e.context.authCookies.sessionData.options)}}async function w(e,i,r,o){let t=e.context.authCookies.sessionToken.options,n=r?void 0:e.context.sessionConfig.expiresIn;await e.setSignedCookie(e.context.authCookies.sessionToken.name,i.session.token,e.context.secret,{...t,maxAge:n,...o}),r&&await e.setSignedCookie(e.context.authCookies.dontRememberToken.name,"true",e.context.secret,e.context.authCookies.dontRememberToken.options),await lo(e,i),e.context.setNewSession(i),e.context.options.secondaryStorage&&await e.context.secondaryStorage?.set(i.session.token,JSON.stringify({user:i.user,session:i.session}),Math.floor((new Date(i.session.expiresAt).getTime()-Date.now())/1e3))}function H(e){e.setCookie(e.context.authCookies.sessionToken.name,"",{...e.context.authCookies.sessionToken.options,maxAge:0}),e.setCookie(e.context.authCookies.sessionData.name,"",{...e.context.authCookies.sessionData.options,maxAge:0}),e.setCookie(e.context.authCookies.dontRememberToken.name,"",{...e.context.authCookies.dontRememberToken.options,maxAge:0})}function Le(e){let i=e.split("; "),r=new Map;return i.forEach(o=>{let[t,n]=o.split("=");r.set(t,n)}),r}import{betterFetch as qt}from"@better-fetch/fetch";import{APIError as Ht}from"better-call";import{decodeJwt as $t,decodeProtectedHeader as Zt,importJWK as Qt,jwtVerify as Gt}from"jose";import{createHash as jt}from"@better-auth/utils/hash";import{base64Url as zt}from"@better-auth/utils/base64";async function Bo(e){let i=await jt("SHA-256").digest(e);return zt.encode(new Uint8Array(i),{padding:!1})}function Je(e){return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?P(e.expires_in,"sec"):void 0,scopes:e?.scope?typeof e.scope=="string"?e.scope.split(" "):e.scope:[],idToken:e.id_token}}async function k({id:e,options:i,authorizationEndpoint:r,state:o,codeVerifier:t,scopes:n,claims:s,redirectURI:a,duration:d}){let A=new URL(r);if(A.searchParams.set("response_type","code"),A.searchParams.set("client_id",i.clientId),A.searchParams.set("state",o),A.searchParams.set("scope",n.join(" ")),A.searchParams.set("redirect_uri",i.redirectURI||a),t){let c=await Bo(t);A.searchParams.set("code_challenge_method","S256"),A.searchParams.set("code_challenge",c)}if(s){let c=s.reduce((l,p)=>(l[p]=null,l),{});A.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...c}}))}return d&&A.searchParams.set("duration",d),A}import{betterFetch as xt}from"@better-fetch/fetch";import{jwtVerify as Qn}from"jose";async function U({code:e,codeVerifier:i,redirectURI:r,options:o,tokenEndpoint:t,authentication:n}){let s=new URLSearchParams,a={"content-type":"application/x-www-form-urlencoded",accept:"application/json","user-agent":"better-auth"};if(s.set("grant_type","authorization_code"),s.set("code",e),i&&s.set("code_verifier",i),s.set("redirect_uri",r),n==="basic"){let l=btoa(`${o.clientId}:${o.clientSecret}`);a.authorization=`Basic ${l}`}else s.set("client_id",o.clientId),s.set("client_secret",o.clientSecret);let{data:d,error:A}=await xt(t,{method:"POST",body:s,headers:a});if(A)throw A;return Je(d)}import{z as le}from"zod";import{APIError as Ho}from"better-call";function Oe(e){try{return new URL(e).origin}catch{return null}}function Fo(e){return e.includes("://")?new URL(e).host:e}import{createHash as Mo}from"@better-auth/utils/hash";import{xchacha20poly1305 as Vo}from"@noble/ciphers/chacha";import{bytesToHex as Ft,hexToBytes as Mt,utf8ToBytes as Vt}from"@noble/ciphers/utils";import{managedNonce as qo}from"@noble/ciphers/webcrypto";import{scryptAsync as ts}from"@noble/hashes/scrypt";import{getRandomValues as ns}from"uncrypto";import{hex as as}from"@better-auth/utils/hex";import{createRandomStringGenerator as Bt}from"@better-auth/utils/random";var I=Bt("a-z","0-9","A-Z","-_");var de=async({key:e,data:i})=>{let r=await Mo("SHA-256").digest(e),o=Vt(i),t=qo(Vo)(new Uint8Array(r));return Ft(t.encrypt(o))},ye=async({key:e,data:i})=>{let r=await Mo("SHA-256").digest(e),o=Mt(i),t=qo(Vo)(new Uint8Array(r));return new TextDecoder().decode(t.decrypt(o))};async function Te(e,i){let r=e.body?.callbackURL||(e.query?.currentURL?Oe(e.query?.currentURL):"")||e.context.options.baseURL;if(!r)throw new Ho("BAD_REQUEST",{message:"callbackURL is required"});let o=I(128),t=I(32),n=JSON.stringify({callbackURL:r,codeVerifier:o,errorURL:e.body?.errorCallbackURL||e.query?.currentURL,newUserURL:e.body?.newUserCallbackURL,link:i,expiresAt:Date.now()+10*60*1e3}),s=new Date;s.setMinutes(s.getMinutes()+10);let a=await e.context.internalAdapter.createVerificationValue({value:n,identifier:t,expiresAt:s});if(!a)throw e.context.logger.error("Unable to create verification. Make sure the database adapter is properly working and there is a verification table in the database"),new Ho("INTERNAL_SERVER_ERROR",{message:"Unable to create verification"});return{state:a.identifier,codeVerifier:o}}async function Xe(e){let i=e.query.state||e.body.state,r=await e.context.internalAdapter.findVerificationValue(i);if(!r)throw e.context.logger.error("State Mismatch. Verification not found",{state:i}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);let o=le.object({callbackURL:le.string(),codeVerifier:le.string(),errorURL:le.string().optional(),newUserURL:le.string().optional(),expiresAt:le.number(),link:le.object({email:le.string(),userId:le.string()}).optional()}).parse(JSON.parse(r.value));if(o.errorURL||(o.errorURL=`${e.context.baseURL}/error`),o.expiresAt<Date.now())throw await e.context.internalAdapter.deleteVerificationValue(r.id),e.context.logger.error("State expired.",{state:i}),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);return await e.context.internalAdapter.deleteVerificationValue(r.id),o}var $o=e=>{let i="https://appleid.apple.com/auth/token";return{id:"apple",name:"Apple",createAuthorizationURL({state:r,scopes:o,redirectURI:t}){let n=o||["email","name"];return e.scope&&n.push(...e.scope),new URL(`https://appleid.apple.com/auth/authorize?client_id=${e.clientId}&response_type=code&redirect_uri=${e.redirectURI||t}&scope=${n.join(" ")}&state=${r}&response_mode=form_post`)},validateAuthorizationCode:async({code:r,codeVerifier:o,redirectURI:t})=>U({code:r,codeVerifier:o,redirectURI:e.redirectURI||t,options:e,tokenEndpoint:i}),async verifyIdToken(r,o){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(r,o);let t=Zt(r),{kid:n,alg:s}=t;if(!n||!s)return!1;let a=await Wt(n),{payload:d}=await Gt(r,a,{algorithms:[s],issuer:"https://appleid.apple.com",audience:e.appBundleIdentifier||e.clientId,maxTokenAge:"1h"});return["email_verified","is_private_email"].forEach(A=>{d[A]!==void 0&&(d[A]=!!d[A])}),o&&d.nonce!==o?!1:!!d},async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);if(!r.idToken)return null;let o=$t(r.idToken);if(!o)return null;let t=o.user?`${o.user.name.firstName} ${o.user.name.lastName}`:o.email,n=await e.mapProfileToUser?.(o);return{user:{id:o.sub,name:t,emailVerified:!1,email:o.email,...n},data:o}}}},Wt=async e=>{let i="https://appleid.apple.com",r="/auth/keys",{data:o}=await qt(`${i}${r}`);if(!o?.keys)throw new Ht("BAD_REQUEST",{message:"Keys not found"});let t=o.keys.find(n=>n.kid===e);if(!t)throw new Error(`JWK with kid ${e} not found`);return await Qt(t,t.alg)};import{betterFetch as Jt}from"@better-fetch/fetch";var Zo=e=>({id:"discord",name:"Discord",createAuthorizationURL({state:i,scopes:r,redirectURI:o}){let t=r||["identify","email"];return e.scope&&t.push(...e.scope),new URL(`https://discord.com/api/oauth2/authorize?scope=${t.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||o)}&state=${i}&prompt=${e.prompt||"none"}`)},validateAuthorizationCode:async({code:i,redirectURI:r})=>U({code:i,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://discord.com/api/oauth2/token"}),async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);let{data:r,error:o}=await Jt("https://discord.com/api/users/@me",{headers:{authorization:`Bearer ${i.accessToken}`}});if(o)return null;if(r.avatar===null){let n=r.discriminator==="0"?Number(BigInt(r.id)>>BigInt(22))%6:parseInt(r.discriminator)%5;r.image_url=`https://cdn.discordapp.com/embed/avatars/${n}.png`}else{let n=r.avatar.startsWith("a_")?"gif":"png";r.image_url=`https://cdn.discordapp.com/avatars/${r.id}/${r.avatar}.${n}`}let t=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.display_name||r.username||"",email:r.email,emailVerified:r.verified,image:r.image_url,...t},data:r}}});import{betterFetch as Xt}from"@better-fetch/fetch";var Qo=e=>({id:"facebook",name:"Facebook",async createAuthorizationURL({state:i,scopes:r,redirectURI:o}){let t=r||["email","public_profile"];return e.scope&&t.push(...e.scope),await k({id:"facebook",options:e,authorizationEndpoint:"https://www.facebook.com/v21.0/dialog/oauth",scopes:t,state:i,redirectURI:o})},validateAuthorizationCode:async({code:i,redirectURI:r})=>U({code:i,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://graph.facebook.com/oauth/access_token"}),async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);let{data:r,error:o}=await Xt("https://graph.facebook.com/me?fields=id,name,email,picture",{auth:{type:"Bearer",token:i.accessToken}});if(o)return null;let t=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.name,email:r.email,image:r.picture.data.url,emailVerified:r.email_verified,...t},data:r}}});import{betterFetch as Go}from"@better-fetch/fetch";var Wo=e=>{let i="https://github.com/login/oauth/access_token";return{id:"github",name:"GitHub",createAuthorizationURL({state:r,scopes:o,codeVerifier:t,redirectURI:n}){let s=o||["user:email"];return e.scope&&s.push(...e.scope),k({id:"github",options:e,authorizationEndpoint:"https://github.com/login/oauth/authorize",scopes:s,state:r,redirectURI:n})},validateAuthorizationCode:async({code:r,redirectURI:o})=>U({code:r,redirectURI:e.redirectURI||o,options:e,tokenEndpoint:i}),async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);let{data:o,error:t}=await Go("https://api.github.com/user",{headers:{"User-Agent":"better-auth",authorization:`Bearer ${r.accessToken}`}});if(t)return null;let n=!1,{data:s}=await Go("https://api.github.com/user/emails",{headers:{authorization:`Bearer ${r.accessToken}`,"User-Agent":"better-auth"}});s&&(o.email=(s.find(d=>d.primary)??s[0])?.email,n=s.find(d=>d.email===o.email)?.verified??!1);let a=await e.mapProfileToUser?.(o);return{user:{id:o.id.toString(),name:o.name||o.login,email:o.email,image:o.avatar_url,emailVerified:n,...a},data:o}}}};var mo=["info","success","warn","error","debug"];function Yt(e,i){return mo.indexOf(i)<=mo.indexOf(e)}var Ae={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fg:{black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"},bg:{black:"\x1B[40m",red:"\x1B[41m",green:"\x1B[42m",yellow:"\x1B[43m",blue:"\x1B[44m",magenta:"\x1B[45m",cyan:"\x1B[46m",white:"\x1B[47m"}},er={info:Ae.fg.blue,success:Ae.fg.green,warn:Ae.fg.yellow,error:Ae.fg.red,debug:Ae.fg.magenta},or=(e,i)=>{let r=new Date().toISOString();return`${Ae.dim}${r}${Ae.reset} ${er[e]}${e.toUpperCase()}${Ae.reset} ${Ae.bright}Better Auth${Ae.reset} ${i}`},Jo=e=>{let i=e?.disabled!==!0,r=e?.level??"error",o=(t,n,s=[])=>{if(!i||!Yt(r,t))return;let a=or(t,n);if(!e||typeof e.log!="function"){t==="error"?console.error(a,...s):t==="warn"?console.warn(a,...s):console.log(a,...s);return}e.log(t==="success"?"info":t,a,...s)};return Object.fromEntries(mo.map(t=>[t,(...[n,...s])=>o(t,n,s)]))},oe=Jo();import{betterFetch as ir}from"@better-fetch/fetch";import{decodeJwt as tr}from"jose";var Xo=e=>({id:"google",name:"Google",async createAuthorizationURL({state:i,scopes:r,codeVerifier:o,redirectURI:t}){if(!e.clientId||!e.clientSecret)throw oe.error("Client Id and Client Secret is required for Google. Make sure to provide them in the options."),new te("CLIENT_ID_AND_SECRET_REQUIRED");if(!o)throw new te("codeVerifier is required for Google");let n=r||["email","profile","openid"];e.scope&&n.push(...e.scope);let s=await k({id:"google",options:e,authorizationEndpoint:"https://accounts.google.com/o/oauth2/auth",scopes:n,state:i,codeVerifier:o,redirectURI:t});return e.accessType&&s.searchParams.set("access_type",e.accessType),e.prompt&&s.searchParams.set("prompt",e.prompt),s},validateAuthorizationCode:async({code:i,codeVerifier:r,redirectURI:o})=>U({code:i,codeVerifier:r,redirectURI:e.redirectURI||o,options:e,tokenEndpoint:"https://oauth2.googleapis.com/token"}),async verifyIdToken(i,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(i,r);let o=`https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=${i}`,{data:t}=await ir(o);return t?t.aud===e.clientId&&t.iss==="https://accounts.google.com":!1},async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);if(!i.idToken)return null;let r=tr(i.idToken),o=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:r.email_verified,...o},data:r}}});import{betterFetch as rr}from"@better-fetch/fetch";import{decodeJwt as nr}from"jose";var Yo=e=>{let i=e.tenantId||"common",r=`https://login.microsoftonline.com/${i}/oauth2/v2.0/authorize`,o=`https://login.microsoftonline.com/${i}/oauth2/v2.0/token`;return{id:"microsoft",name:"Microsoft EntraID",createAuthorizationURL(t){let n=t.scopes||["openid","profile","email","User.Read"];return e.scope&&n.push(...e.scope),k({id:"microsoft",options:e,authorizationEndpoint:r,state:t.state,codeVerifier:t.codeVerifier,scopes:n,redirectURI:t.redirectURI})},validateAuthorizationCode({code:t,codeVerifier:n,redirectURI:s}){return U({code:t,codeVerifier:n,redirectURI:e.redirectURI||s,options:e,tokenEndpoint:o})},async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.idToken)return null;let n=nr(t.idToken),s=e.profilePhotoSize||48;await rr(`https://graph.microsoft.com/v1.0/me/photos/${s}x${s}/$value`,{headers:{Authorization:`Bearer ${t.accessToken}`},async onResponse(d){if(!(e.disableProfilePhoto||!d.response.ok))try{let c=await d.response.clone().arrayBuffer(),l=Buffer.from(c).toString("base64");n.picture=`data:image/jpeg;base64, ${l}`}catch(A){oe.error(A&&typeof A=="object"&&"name"in A?A.name:"",A)}}});let a=await e.mapProfileToUser?.(n);return{user:{id:n.sub,name:n.name,email:n.email,image:n.picture,emailVerified:!0,...a},data:n}}}};import{betterFetch as sr}from"@better-fetch/fetch";var ei=e=>({id:"spotify",name:"Spotify",createAuthorizationURL({state:i,scopes:r,codeVerifier:o,redirectURI:t}){let n=r||["user-read-email"];return e.scope&&n.push(...e.scope),k({id:"spotify",options:e,authorizationEndpoint:"https://accounts.spotify.com/authorize",scopes:n,state:i,codeVerifier:o,redirectURI:t})},validateAuthorizationCode:async({code:i,codeVerifier:r,redirectURI:o})=>U({code:i,codeVerifier:r,redirectURI:e.redirectURI||o,options:e,tokenEndpoint:"https://accounts.spotify.com/api/token"}),async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);let{data:r,error:o}=await sr("https://api.spotify.com/v1/me",{method:"GET",headers:{Authorization:`Bearer ${i.accessToken}`}});if(o)return null;let t=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.display_name,email:r.email,image:r.images[0]?.url,emailVerified:!1,...t},data:r}}});var Ee={isAction:!1};import{createRandomStringGenerator as ar}from"@better-auth/utils/random";var J=e=>ar("a-z","A-Z","0-9")(e||32);import{decodeJwt as dr}from"jose";var oi=e=>({id:"twitch",name:"Twitch",createAuthorizationURL({state:i,scopes:r,redirectURI:o}){let t=r||["user:read:email","openid"];return e.scope&&t.push(...e.scope),k({id:"twitch",redirectURI:o,options:e,authorizationEndpoint:"https://id.twitch.tv/oauth2/authorize",scopes:t,state:i,claims:e.claims||["email","email_verified","preferred_username","picture"]})},validateAuthorizationCode:async({code:i,redirectURI:r})=>U({code:i,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);let r=i.idToken;if(!r)return oe.error("No idToken found in token"),null;let o=dr(r),t=await e.mapProfileToUser?.(o);return{user:{id:o.sub,name:o.preferred_username,email:o.email,image:o.picture,emailVerified:!1,...t},data:o}}});import{betterFetch as Ar}from"@better-fetch/fetch";var ii=e=>({id:"twitter",name:"Twitter",createAuthorizationURL(i){let r=i.scopes||["users.read","tweet.read","offline.access"];return e.scope&&r.push(...e.scope),k({id:"twitter",options:e,authorizationEndpoint:"https://x.com/i/oauth2/authorize",scopes:r,state:i.state,codeVerifier:i.codeVerifier,redirectURI:i.redirectURI})},validateAuthorizationCode:async({code:i,codeVerifier:r,redirectURI:o})=>U({code:i,codeVerifier:r,authentication:"basic",redirectURI:e.redirectURI||o,options:e,tokenEndpoint:"https://api.x.com/2/oauth2/token"}),async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);let{data:r,error:o}=await Ar("https://api.x.com/2/users/me?user.fields=profile_image_url",{method:"GET",headers:{Authorization:`Bearer ${i.accessToken}`}});if(o)return null;let t=await e.mapProfileToUser?.(r);return{user:{id:r.data.id,name:r.data.name,email:r.data.username||null,image:r.data.profile_image_url,emailVerified:r.data.verified||!1,...t},data:r}}});import{betterFetch as cr}from"@better-fetch/fetch";var ti=e=>{let i="https://api.dropboxapi.com/oauth2/token";return{id:"dropbox",name:"Dropbox",createAuthorizationURL:async({state:r,scopes:o,codeVerifier:t,redirectURI:n})=>{let s=o||["account_info.read"];return e.scope&&s.push(...e.scope),await k({id:"dropbox",options:e,authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",scopes:s,state:r,redirectURI:n,codeVerifier:t})},validateAuthorizationCode:async({code:r,codeVerifier:o,redirectURI:t})=>await U({code:r,codeVerifier:o,redirectURI:e.redirectURI||t,options:e,tokenEndpoint:i}),async getUserInfo(r){if(e.getUserInfo)return e.getUserInfo(r);let{data:o,error:t}=await cr("https://api.dropboxapi.com/2/users/get_current_account",{method:"POST",headers:{Authorization:`Bearer ${r.accessToken}`}});if(t)return null;let n=await e.mapProfileToUser?.(o);return{user:{id:o.account_id,name:o.name?.display_name,email:o.email,emailVerified:o.email_verified||!1,image:o.profile_photo_url,...n},data:o}}}};import{betterFetch as Kr}from"@better-fetch/fetch";var ri=e=>{let i="https://www.linkedin.com/oauth/v2/authorization",r="https://www.linkedin.com/oauth/v2/accessToken";return{id:"linkedin",name:"Linkedin",createAuthorizationURL:async({state:o,scopes:t,redirectURI:n})=>{let s=t||["profile","email","openid"];return e.scope&&s.push(...e.scope),await k({id:"linkedin",options:e,authorizationEndpoint:i,scopes:s,state:o,redirectURI:n})},validateAuthorizationCode:async({code:o,redirectURI:t})=>await U({code:o,redirectURI:e.redirectURI||t,options:e,tokenEndpoint:r}),async getUserInfo(o){let{data:t,error:n}=await Kr("https://api.linkedin.com/v2/userinfo",{method:"GET",headers:{Authorization:`Bearer ${o.accessToken}`}});if(n)return null;let s=await e.mapProfileToUser?.(t);return{user:{id:t.sub,name:t.name,email:t.email,emailVerified:t.email_verified||!1,image:t.picture,...s},data:t}}}};import{betterFetch as pr}from"@better-fetch/fetch";var go=(e="")=>e.split("://").map(i=>i.replace(/\/{2,}/g,"/")).join("://"),ur=e=>{let i=e||"https://gitlab.com";return{authorizationEndpoint:go(`${i}/oauth/authorize`),tokenEndpoint:go(`${i}/oauth/token`),userinfoEndpoint:go(`${i}/api/v4/user`)}},ni=e=>{let{authorizationEndpoint:i,tokenEndpoint:r,userinfoEndpoint:o}=ur(e.issuer),t="gitlab";return{id:t,name:"Gitlab",createAuthorizationURL:async({state:s,scopes:a,codeVerifier:d,redirectURI:A})=>{let c=a||["read_user"];return e.scope&&c.push(...e.scope),await k({id:t,options:e,authorizationEndpoint:i,scopes:c,state:s,redirectURI:A,codeVerifier:d})},validateAuthorizationCode:async({code:s,redirectURI:a,codeVerifier:d})=>U({code:s,redirectURI:e.redirectURI||a,options:e,codeVerifier:d,tokenEndpoint:r}),async getUserInfo(s){if(e.getUserInfo)return e.getUserInfo(s);let{data:a,error:d}=await pr(o,{headers:{authorization:`Bearer ${s.accessToken}`}});if(d||a.state!=="active"||a.locked)return null;let A=await e.mapProfileToUser?.(a);return{user:{id:a.id.toString(),name:a.name??a.username,email:a.email,image:a.avatar_url,emailVerified:!0,...A},data:a}}}};import{betterFetch as si}from"@better-fetch/fetch";var ai=e=>({id:"reddit",name:"Reddit",createAuthorizationURL({state:i,scopes:r,redirectURI:o}){let t=r||["identity"];return e.scope&&t.push(...e.scope),k({id:"reddit",options:e,authorizationEndpoint:"https://www.reddit.com/api/v1/authorize",scopes:t,state:i,redirectURI:o,duration:e.duration})},validateAuthorizationCode:async({code:i,redirectURI:r})=>{let o=new URLSearchParams({grant_type:"authorization_code",code:i,redirect_uri:e.redirectURI||r}),t={"content-type":"application/x-www-form-urlencoded",accept:"text/plain","user-agent":"better-auth",Authorization:`Basic ${Buffer.from(`${e.clientId}:${e.clientSecret}`).toString("base64")}`},{data:n,error:s}=await si("https://www.reddit.com/api/v1/access_token",{method:"POST",headers:t,body:o.toString()});if(s)throw s;return Je(n)},async getUserInfo(i){if(e.getUserInfo)return e.getUserInfo(i);let{data:r,error:o}=await si("https://oauth.reddit.com/api/v1/me",{headers:{Authorization:`Bearer ${i.accessToken}`,"User-Agent":"better-auth"}});if(o)return null;let t=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.name,email:r.oauth_client_id,emailVerified:r.has_verified_email,image:r.icon_img?.split("?")[0],...t},data:r}}});import{z as lr}from"zod";var mr={apple:$o,discord:Zo,facebook:Qo,github:Wo,microsoft:Yo,google:Xo,spotify:ei,twitch:oi,twitter:ii,dropbox:ti,linkedin:ri,gitlab:ni,reddit:ai},fo=Object.keys(mr),di=lr.enum(fo,{description:"OAuth2 provider to use"});import{z as re}from"zod";import{APIError as je}from"better-call";import{APIError as me}from"better-call";import{z as we}from"zod";function ho(e){try{return JSON.parse(e)}catch{return null}}var f={USER_NOT_FOUND:"User not found",FAILED_TO_CREATE_USER:"Failed to create user",FAILED_TO_CREATE_SESSION:"Failed to create session",FAILED_TO_UPDATE_USER:"Failed to update user",FAILED_TO_GET_SESSION:"Failed to get session",INVALID_PASSWORD:"Invalid password",INVALID_EMAIL:"Invalid email",INVALID_EMAIL_OR_PASSWORD:"Invalid email or password",SOCIAL_ACCOUNT_ALREADY_LINKED:"Social account already linked",PROVIDER_NOT_FOUND:"Provider not found",INVALID_TOKEN:"invalid token",ID_TOKEN_NOT_SUPPORTED:"id_token not supported",FAILED_TO_GET_USER_INFO:"Failed to get user info",USER_EMAIL_NOT_FOUND:"User email not found",EMAIL_NOT_VERIFIED:"Email not verified",PASSWORD_TOO_SHORT:"Password too short",PASSWORD_TOO_LONG:"Password too long",USER_ALREADY_EXISTS:"User already exists",EMAIL_CAN_NOT_BE_UPDATED:"Email can not be updated",CREDENTIAL_ACCOUNT_NOT_FOUND:"Credential account not found",SESSION_EXPIRED:"Session expired. Re-authenticate to perform this action."};import{createHMAC as gr}from"@better-auth/utils/hmac";import{base64 as fr}from"@better-auth/utils/base64";import{binary as hr}from"@better-auth/utils/binary";var yo=()=>K("/get-session",{method:"GET",query:we.optional(we.object({disableCookieCache:we.boolean({description:"Disable cookie cache and fetch session from database"}).or(we.string().transform(e=>e==="true")).optional(),disableRefresh:we.boolean({description:"Disable session refresh. Useful for checking session status, without updating the session"}).optional()})),requireHeaders:!0,metadata:{openapi:{description:"Get the current session",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{type:"object",properties:{token:{type:"string"},userId:{type:"string"},expiresAt:{type:"string"}}},user:{type:"object",$ref:"#/components/schemas/User"}}}}}}}}}},async e=>{try{let i=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!i)return e.json(null);let r=e.getCookie(e.context.authCookies.sessionData.name),o=r?ho(hr.decode(fr.decode(r))):null;if(o&&!await gr("SHA-256","base64urlnopad").verify(e.context.secret,JSON.stringify(o.session),o.signature))return H(e),e.json(null);let t=await e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret);if(o?.session&&e.context.options.session?.cookieCache?.enabled&&!e.query?.disableCookieCache){let c=o.session;if(o.expiresAt<Date.now()||c.session.expiresAt<new Date){let p=e.context.authCookies.sessionData.name;e.setCookie(p,"",{maxAge:0})}else return e.json(c)}let n=await e.context.internalAdapter.findSession(i);if(e.context.session=n,!n||n.session.expiresAt<new Date)return H(e),n&&await e.context.internalAdapter.deleteSession(n.session.token),e.json(null);if(t||e.query?.disableRefresh)return e.json(n);let s=e.context.sessionConfig.expiresIn,a=e.context.sessionConfig.updateAge;if(n.session.expiresAt.valueOf()-s*1e3+a*1e3<=Date.now()){let c=await e.context.internalAdapter.updateSession(n.session.token,{expiresAt:P(e.context.sessionConfig.expiresIn,"sec")});if(!c)return H(e),e.json(null,{status:401});let l=(c.expiresAt.valueOf()-Date.now())/1e3;return await w(e,{session:c,user:n.user},!1,{maxAge:l}),e.json({session:c,user:n.user})}return await lo(e,n),e.json(n)}catch(i){throw e.context.logger.error("INTERNAL_SERVER_ERROR",i),new me("INTERNAL_SERVER_ERROR",{message:f.FAILED_TO_GET_SESSION})}}),R=async(e,i)=>{if(e.context.session)return e.context.session;let r=await yo()({...e,_flag:"json",headers:e.headers,query:i}).catch(o=>null);return e.context.session=r,r},E=D(async e=>{let i=await R(e);if(!i?.session)throw new me("UNAUTHORIZED");return{session:i}}),Od=D(async e=>{let i=await R(e);if(!i?.session)throw new me("UNAUTHORIZED");if(e.context.sessionConfig.freshAge===0)return{session:i};let r=e.context.sessionConfig.freshAge,o=i.session.updatedAt?.valueOf()||i.session.createdAt.valueOf();if(!(Date.now()-o<r*1e3))throw new me("FORBIDDEN",{message:"Session is not fresh"});return{session:i}}),Ai=()=>K("/list-sessions",{method:"GET",use:[E],requireHeaders:!0,metadata:{openapi:{description:"List all active sessions for the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{type:"object",properties:{token:{type:"string"},userId:{type:"string"},expiresAt:{type:"string"}}}}}}}}}}},async e=>{let r=(await e.context.internalAdapter.listSessions(e.context.session.user.id)).filter(o=>o.expiresAt>new Date);return e.json(r)}),ci=K("/revoke-session",{method:"POST",body:we.object({token:we.string({description:"The token to revoke"})}),use:[E],requireHeaders:!0,metadata:{openapi:{description:"Revoke a single session",requestBody:{content:{"application/json":{schema:{type:"object",properties:{token:{type:"string"}},required:["token"]}}}}}}},async e=>{let i=e.body.token,r=await e.context.internalAdapter.findSession(i);if(!r)throw new me("BAD_REQUEST",{message:"Session not found"});if(r.session.userId!==e.context.session.user.id)throw new me("UNAUTHORIZED");try{await e.context.internalAdapter.deleteSession(i)}catch(o){throw e.context.logger.error(o&&typeof o=="object"&&"name"in o?o.name:"",o),new me("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),Ki=K("/revoke-sessions",{method:"POST",use:[E],requireHeaders:!0,metadata:{openapi:{description:"Revoke all sessions for the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}},required:["status"]}}}}}}}},async e=>{try{await e.context.internalAdapter.deleteSessions(e.context.session.user.id)}catch(i){throw e.context.logger.error(i&&typeof i=="object"&&"name"in i?i.name:"",i),new me("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),pi=K("/revoke-other-sessions",{method:"POST",requireHeaders:!0,use:[E],metadata:{openapi:{description:"Revoke all other sessions for the user except the current one",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{let i=e.context.session;if(!i.user)throw new me("UNAUTHORIZED");let t=(await e.context.internalAdapter.listSessions(i.user.id)).filter(n=>n.expiresAt>new Date).filter(n=>n.token!==e.context.session.session.token);return await Promise.all(t.map(n=>e.context.internalAdapter.deleteSession(n.token))),e.json({status:!0})});import{jwtVerify as wr}from"jose";import{SignJWT as yr}from"jose";async function ui(e,i,r=3600){return await new yr(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(Math.floor(Date.now()/1e3)+r).sign(new TextEncoder().encode(i))}async function ce(e,i,r){return await ui({email:i.toLowerCase(),updateTo:r},e)}async function wo(e,i){if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new je("BAD_REQUEST",{message:"Verification email isn't enabled"});let r=await ce(e.context.secret,i.email),o=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||e.query?.currentURL||"/"}`;await e.context.options.emailVerification.sendVerificationEmail({user:i,url:o,token:r},e.request)}var li=K("/send-verification-email",{method:"POST",query:re.object({currentURL:re.string({description:"The URL to use for email verification callback"}).optional()}).optional(),body:re.object({email:re.string({description:"The email to send the verification email to"}).email(),callbackURL:re.string({description:"The URL to use for email verification callback"}).optional()}),metadata:{openapi:{description:"Send a verification email to the user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{email:{type:"string",description:"The email to send the verification email to"},callbackURL:{type:"string",description:"The URL to use for email verification callback"}},required:["email"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new je("BAD_REQUEST",{message:"Verification email isn't enabled"});let{email:i}=e.body,r=await e.context.internalAdapter.findUserByEmail(i);if(!r)throw new je("BAD_REQUEST",{message:f.USER_NOT_FOUND});return await wo(e,r.user),e.json({status:!0})}),mi=K("/verify-email",{method:"GET",query:re.object({token:re.string({description:"The token to verify the email"}),callbackURL:re.string({description:"The URL to redirect to after email verification"}).optional()}),metadata:{openapi:{description:"Verify the email of the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object"},status:{type:"boolean"}},required:["user","status"]}}}}}}}},async e=>{function i(a){throw e.query.callbackURL?e.query.callbackURL.includes("?")?e.redirect(`${e.query.callbackURL}&error=${a}`):e.redirect(`${e.query.callbackURL}?error=${a}`):new je("UNAUTHORIZED",{message:a})}let{token:r}=e.query,o;try{o=await wr(r,new TextEncoder().encode(e.context.secret),{algorithms:["HS256"]})}catch(a){return e.context.logger.error("Failed to verify email",a),i("invalid_token")}let n=re.object({email:re.string().email(),updateTo:re.string().optional()}).parse(o.payload),s=await e.context.internalAdapter.findUserByEmail(n.email);if(!s)return i("user_not_found");if(n.updateTo){let a=await R(e);if(!a){if(e.query.callbackURL)throw e.redirect(`${e.query.callbackURL}?error=unauthorized`);return i("unauthorized")}if(a.user.email!==n.email){if(e.query.callbackURL)throw e.redirect(`${e.query.callbackURL}?error=unauthorized`);return i("unauthorized")}let d=await e.context.internalAdapter.updateUserByEmail(n.email,{email:n.updateTo,emailVerified:!1}),A=await ce(e.context.secret,n.updateTo);if(await e.context.options.emailVerification?.sendVerificationEmail?.({user:d,url:`${e.context.baseURL}/verify-email?token=${A}`,token:A},e.request),e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0})}if(await e.context.internalAdapter.updateUserByEmail(n.email,{emailVerified:!0}),e.context.options.emailVerification?.autoSignInAfterVerification&&!await R(e)){let d=await e.context.internalAdapter.createSession(s.user.id,e.request);if(!d)throw new je("INTERNAL_SERVER_ERROR",{message:"Failed to create session"});await w(e,{session:d,user:s.user})}if(e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0})});import{APIError as Re,createRouter as CA,getCookie as Sr,getSignedCookie as vr,setCookie as kr,setSignedCookie as Dr}from"better-call";import{APIError as Or}from"better-call";function Co(e){return e==="-"||e==="^"||e==="$"||e==="+"||e==="."||e==="("||e===")"||e==="|"||e==="["||e==="]"||e==="{"||e==="}"||e==="*"||e==="?"||e==="\\"?`\\${e}`:e}function Cr(e){let i="";for(let r=0;r<e.length;r++)i+=Co(e[r]);return i}function gi(e,i=!0){if(Array.isArray(e))return`(?:${e.map(c=>`^${gi(c,i)}$`).join("|")})`;let r="",o="",t=".";i===!0?(r="/",o="[/\\\\]",t="[^/\\\\]"):i&&(r=i,o=Cr(r),o.length>1?(o=`(?:${o})`,t=`((?!${o}).)`):t=`[^${o}]`);let n=i?`${o}+?`:"",s=i?`${o}*?`:"",a=i?e.split(r):[e],d="";for(let A=0;A<a.length;A++){let c=a[A],l=a[A+1],p="";if(!(!c&&A>0)){if(i&&(A===a.length-1?p=s:l!=="**"?p=n:p=""),i&&c==="**"){p&&(d+=A===0?"":p,d+=`(?:${t}*?${p})*?`);continue}for(let u=0;u<c.length;u++){let y=c[u];y==="\\"?u<c.length-1&&(d+=Co(c[u+1]),u++):y==="?"?d+=t:y==="*"?d+=`${t}*?`:d+=Co(y)}d+=p}}return d}function br(e,i){if(typeof i!="string")throw new TypeError(`Sample must be a string, but ${typeof i} given`);return e.test(i)}function bo(e,i){if(typeof e!="string"&&!Array.isArray(e))throw new TypeError(`The first argument must be a single pattern string or an array of patterns, but ${typeof e} given`);if((typeof i=="string"||typeof i=="boolean")&&(i={separator:i}),arguments.length===2&&!(typeof i>"u"||typeof i=="object"&&i!==null&&!Array.isArray(i)))throw new TypeError(`The second argument must be an options object or a string/boolean separator, but ${typeof i} given`);if(i=i||{},i.separator==="\\")throw new Error("\\ is not a valid separator because it is used for escaping. Try setting the separator to `true` instead");let r=gi(e,i.separator),o=new RegExp(`^${r}$`,i.flags),t=br.bind(null,o);return t.options=i,t.pattern=e,t.regexp=o,t}var Tr=D(async e=>{if(e.request?.method!=="POST")return;let{body:i,query:r,context:o}=e,t=e.headers?.get("origin")||e.headers?.get("referer")||"",n=i?.callbackURL||r?.callbackURL,s=i?.redirectTo,a=r?.currentURL,d=i?.errorCallbackURL,A=i?.newUserCallbackURL,c=o.trustedOrigins,l=e.headers?.has("cookie"),p=(y,h)=>y.startsWith("/")?!1:h.includes("*")?bo(h)(Fo(y)):y.startsWith(h),u=(y,h)=>{if(!y)return;if(!c.some(B=>p(y,B)||y?.startsWith("/")&&h!=="origin"&&!y.includes(":")))throw e.context.logger.error(`Invalid ${h}: ${y}`),e.context.logger.info(`If it's a valid URL, please add ${y} to trustedOrigins in your auth config
`,`Current list of trustedOrigins: ${c}`),new Or("FORBIDDEN",{message:`Invalid ${h}`})};l&&!e.context.options.advanced?.disableCSRFCheck&&u(t,"origin"),n&&u(n,"callbackURL"),s&&u(s,"redirectURL"),a&&u(a,"currentURL"),d&&u(d,"errorCallbackURL"),A&&u(s,"newUserCallbackURL")});var fi=K("/ok",{method:"GET",metadata:{...Ee,openapi:{description:"Check if the API is working",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{ok:{type:"boolean"}}}}}}}}}},async e=>e.json({ok:!0}));import{z as Ie}from"zod";import{APIError as ge}from"better-call";import{z as T}from"zod";import{APIError as Er}from"better-call";var Zd=T.object({id:T.string(),providerId:T.string(),accountId:T.string(),userId:T.string(),accessToken:T.string().nullish(),refreshToken:T.string().nullish(),idToken:T.string().nullish(),accessTokenExpiresAt:T.date().nullish(),refreshTokenExpiresAt:T.date().nullish(),scope:T.string().nullish(),password:T.string().nullish(),createdAt:T.date().default(()=>new Date),updatedAt:T.date().default(()=>new Date)}),Qd=T.object({id:T.string(),email:T.string().transform(e=>e.toLowerCase()),emailVerified:T.boolean().default(!1),name:T.string(),image:T.string().nullish(),createdAt:T.date().default(()=>new Date),updatedAt:T.date().default(()=>new Date)}),Gd=T.object({id:T.string(),userId:T.string(),expiresAt:T.date(),createdAt:T.date().default(()=>new Date),updatedAt:T.date().default(()=>new Date),token:T.string(),ipAddress:T.string().nullish(),userAgent:T.string().nullish()}),Wd=T.object({id:T.string(),value:T.string(),createdAt:T.date().default(()=>new Date),updatedAt:T.date().default(()=>new Date),expiresAt:T.date(),identifier:T.string()});function Ir(e,i){let r={...i==="user"?e.user?.additionalFields:{},...i==="session"?e.session?.additionalFields:{}};for(let o of e.plugins||[])o.schema&&o.schema[i]&&(r={...r,...o.schema[i].fields});return r}function Rr(e,i){let r=i.action||"create",o=i.fields,t={};for(let n in o){if(n in e){if(o[n].input===!1){if(o[n].defaultValue){t[n]=o[n].defaultValue;continue}continue}if(o[n].validator?.input&&e[n]!==void 0){t[n]=o[n].validator.input.parse(e[n]);continue}if(o[n].transform?.input&&e[n]!==void 0){t[n]=o[n].transform?.input(e[n]);continue}t[n]=e[n];continue}if(o[n].defaultValue&&r==="create"){t[n]=o[n].defaultValue;continue}if(o[n].required&&r==="create")throw new Er("BAD_REQUEST",{message:`${n} is required`})}return t}function Ye(e,i,r){let o=Ir(e,"user");return Rr(i||{},{fields:o,action:r})}function Ke(e,i){if(!i)return e;for(let r in i){let o=i[r]?.modelName;o&&(e[r].modelName=o);for(let t in e[r].fields){let n=i[r]?.fields?.[t];n&&(e[r].fields[t].fieldName=n)}}return e}var hi=()=>K("/sign-up/email",{method:"POST",query:Ie.object({currentURL:Ie.string().optional()}).optional(),body:Ie.record(Ie.string(),Ie.any()),metadata:{openapi:{description:"Sign up a user using email and password",requestBody:{content:{"application/json":{schema:{type:"object",properties:{name:{type:"string",description:"The name of the user"},email:{type:"string",description:"The email of the user"},password:{type:"string",description:"The password of the user"},callbackURL:{type:"string",description:"The URL to use for email verification callback"}},required:["name","email","password"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string",description:"The id of the user"},email:{type:"string",description:"The email of the user"},name:{type:"string",description:"The name of the user"},image:{type:"string",description:"The image of the user"},emailVerified:{type:"boolean",description:"If the email is verified"}}}}}}}}}},async e=>{if(!e.context.options.emailAndPassword?.enabled)throw new ge("BAD_REQUEST",{message:"Email and password sign up is not enabled"});let i=e.body,{name:r,email:o,password:t,image:n,callbackURL:s,...a}=i;if(!Ie.string().email().safeParse(o).success)throw new ge("BAD_REQUEST",{message:f.INVALID_EMAIL});let A=e.context.password.config.minPasswordLength;if(t.length<A)throw e.context.logger.error("Password is too short"),new ge("BAD_REQUEST",{message:f.PASSWORD_TOO_SHORT});let c=e.context.password.config.maxPasswordLength;if(t.length>c)throw e.context.logger.error("Password is too long"),new ge("BAD_REQUEST",{message:f.PASSWORD_TOO_LONG});if((await e.context.internalAdapter.findUserByEmail(o))?.user)throw e.context.logger.info(`Sign-up attempt for existing email: ${o}`),new ge("UNPROCESSABLE_ENTITY",{message:f.USER_ALREADY_EXISTS});let p=Ye(e.context.options,a),u;try{if(u=await e.context.internalAdapter.createUser({email:o.toLowerCase(),name:r,image:n,...p,emailVerified:!1}),!u)throw new ge("BAD_REQUEST",{message:f.FAILED_TO_CREATE_USER})}catch(L){throw We&&e.context.logger.error("Failed to create user",L),new ge("UNPROCESSABLE_ENTITY",{message:f.FAILED_TO_CREATE_USER,details:L})}if(!u)throw new ge("UNPROCESSABLE_ENTITY",{message:f.FAILED_TO_CREATE_USER});let y=await e.context.password.hash(t);if(await e.context.internalAdapter.linkAccount({userId:u.id,providerId:"credential",accountId:u.id,password:y}),e.context.options.emailVerification?.sendOnSignUp){let L=await ce(e.context.secret,u.email),B=`${e.context.baseURL}/verify-email?token=${L}&callbackURL=${i.callbackURL||e.query?.currentURL||"/"}`;await e.context.options.emailVerification?.sendVerificationEmail?.({user:u,url:B,token:L},e.request)}if(!e.context.options.emailAndPassword.autoSignIn||e.context.options.emailAndPassword.requireEmailVerification)return e.json({token:null});let h=await e.context.internalAdapter.createSession(u.id,e.request);if(!h)throw new ge("BAD_REQUEST",{message:f.FAILED_TO_CREATE_SESSION});return await w(e,{session:h,user:u}),e.json({token:h.token})});var _r=(e="Unknown")=>`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Error</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --accent-color: #000000;
            --error-color: #dc3545;
            --border-color: #e9ecef;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            line-height: 1.5;
        }
        .error-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
        }
        h1 {
            color: var(--error-color);
            font-size: 1.75rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        p {
            margin-bottom: 1.5rem;
            color: #495057;
        }
        .btn {
            background-color: var(--accent-color);
            color: #ffffff;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: inline-block;
            font-weight: 500;
            border: 2px solid var(--accent-color);
        }
        .btn:hover {
            background-color: #131721;
        }
        .error-code {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="icon">\u26A0\uFE0F</div>
        <h1>Better Auth Error</h1>
        <p>We encountered an issue while processing your request. Please try again or contact the application owner if the problem persists.</p>
        <a href="/" id="returnLink" class="btn">Return to Application</a>
        <div class="error-code">Error Code: <span id="errorCode">${e}</span></div>
    </div>
</body>
</html>`,yi=K("/error",{method:"GET",metadata:{...Ee,openapi:{description:"Displays an error page",responses:{200:{description:"Success",content:{"text/html":{schema:{type:"string"}}}}}}}},async e=>{let i=new URL(e.request?.url||"").searchParams.get("error")||"Unknown";return new Response(_r(i),{headers:{"Content-Type":"text/html"}})});import"defu";import{APIError as m}from"better-call";function Oo(e,i){let r=i.plugins?.reduce((a,d)=>({...a,...d.endpoints}),{}),o=i.plugins?.map(a=>a.middlewares?.map(d=>{let A=async c=>d.middleware({...c,context:{...e,...c.context}});return A.path=d.path,A.options=d.middleware.options,A.headers=d.middleware.headers,{path:d.path,middleware:A}})).filter(a=>a!==void 0).flat()||[],n={...{signInSocial:wi,callbackOAuth:bi,getSession:yo(),signOut:Oi,signUpEmail:hi(),signInEmail:Ci,forgetPassword:Ti,resetPassword:Ii,verifyEmail:mi,sendVerificationEmail:li,changeEmail:vi,changePassword:_i,setPassword:Ui,updateUser:Ri(),deleteUser:Si,forgetPasswordCallback:Ei,listSessions:Ai(),revokeSession:ci,revokeSessions:Ki,revokeOtherSessions:pi,linkSocialAccount:Di,listUserAccounts:ki,deleteUserCallback:To},...r,ok:fi,error:yi},s={};for(let[a,d]of Object.entries(n))s[a]=async(A={})=>{d.headers=new Headers;let c={setHeader(g,O){d.headers.set(g,O)},setCookie(g,O,v){kr(d.headers,g,O,v)},getCookie(g,O){let _=A.headers?.get("cookie");return Sr(_||"",g,O)},getSignedCookie(g,O,v){let _=A.headers;return _?vr(_,O,g,v):null},async setSignedCookie(g,O,v,_){await Dr(d.headers,g,O,v,_)},redirect(g){return d.headers.set("Location",g),new Re("FOUND")},responseHeader:d.headers},l=await e,p=null,u={...c,...A,path:d.path,context:{...l,...A.context,session:null,setNewSession:function(g){this.newSession=g,p=g}}},y=i.plugins||[],h=y.map(g=>{if(g.hooks?.before)return g.hooks.before}).filter(g=>g!==void 0).flat(),L=y.map(g=>{if(g.hooks?.after)return g.hooks.after}).filter(g=>g!==void 0).flat();i.hooks?.before&&h.push({matcher:()=>!0,handler:i.hooks.before}),i.hooks?.after&&L.push({matcher:()=>!0,handler:i.hooks.after});for(let g of h){if(!g.matcher(u))continue;let O=await g.handler(u);if(O&&"context"in O){u={...u,...O.context};continue}if(O)return O}let B;try{B=await d(u),p&&(u.context.newSession=p)}catch(g){if(p&&(u.context.newSession=p),g instanceof Re){if(!L?.length)throw g.headers=d.headers,g;u.context.returned=g,u.context.returned.headers=d.headers;for(let O of L||[])if(O.matcher(u))try{let _=await O.handler(u);_&&"response"in _&&(u.context.returned=_.response)}catch(_){if(_ instanceof Re){u.context.returned=_;continue}throw _}if(u.context.returned instanceof Re)throw u.context.returned.headers=d.headers,u.context.returned;return u.context.returned}throw g}u.context.returned=B,u.responseHeader=d.headers;for(let g of L)if(g.matcher(u))try{let v=await g.handler(u);if(v)if("responseHeader"in v){let _=v.responseHeader;u.responseHeader=_}else u.context.returned=v}catch(v){if(v instanceof Re){u.context.returned=v;continue}throw v}let F=u.context.returned;if(F instanceof Response&&d.headers.forEach((g,O)=>{O==="set-cookie"?F.headers.append(O,g):F.headers.set(O,g)}),F instanceof Re)throw F.headers=d.headers,F;return F},s[a].path=d.path,s[a].method=d.method,s[a].options=d.options,s[a].headers=d.headers;return{api:s,middlewares:o}}async function _e(e,{userInfo:i,account:r,callbackURL:o}){let t=await e.context.internalAdapter.findOAuthUser(i.email.toLowerCase(),r.accountId,r.providerId).catch(d=>{throw oe.error(`Better auth was unable to query your database.
Error: `,d),e.redirect(`${e.context.baseURL}/error?error=internal_server_error`)}),n=t?.user,s=!n;if(t){let d=t.accounts.find(A=>A.providerId===r.providerId);if(d){let A=Object.fromEntries(Object.entries({accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt}).filter(([c,l])=>l!==void 0));Object.keys(A).length>0&&await e.context.internalAdapter.updateAccount(d.id,A)}else{if(!e.context.options.account?.accountLinking?.trustedProviders?.includes(r.providerId)&&!i.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)return We&&oe.warn(`User already exist but account isn't linked to ${r.providerId}. To read more about how account linking works in Better Auth see https://www.better-auth.com/docs/concepts/users-accounts#account-linking.`),{error:"account not linked",data:null};try{await e.context.internalAdapter.linkAccount({providerId:r.providerId,accountId:i.id.toString(),userId:t.user.id,accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope})}catch(l){return oe.error("Unable to link account",l),{error:"unable to link account",data:null}}}}else try{if(n=await e.context.internalAdapter.createOAuthUser({...i,email:i.email.toLowerCase(),id:void 0},{accessToken:r.accessToken,idToken:r.idToken,refreshToken:r.refreshToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scope,providerId:r.providerId,accountId:i.id.toString()}).then(d=>d?.user),!i.emailVerified&&n&&e.context.options.emailVerification?.sendOnSignUp){let d=await ce(e.context.secret,n.email),A=`${e.context.baseURL}/verify-email?token=${d}&callbackURL=${o}`;await e.context.options.emailVerification?.sendVerificationEmail?.({user:n,url:A,token:d},e.request)}}catch(d){return d instanceof m?{error:d.message,data:null,isRegister:!1}:{error:"unable to create user",data:null,isRegister:!1}}if(!n)return{error:"unable to create user",data:null,isRegister:!1};let a=await e.context.internalAdapter.createSession(n.id,e.request);return a?{data:{session:a,user:n},error:null,isRegister:s}:{error:"unable to create session",data:null,isRegister:!1}}var wi=K("/sign-in/social",{method:"POST",query:M.object({currentURL:M.string().optional()}).optional(),body:M.object({callbackURL:M.string({description:"Callback URL to redirect to after the user has signed in"}).optional(),newUserCallbackURL:M.string().optional(),errorCallbackURL:M.string({description:"Callback URL to redirect to if an error happens"}).optional(),provider:di,disableRedirect:M.boolean({description:"Disable automatic redirection to the provider. Useful for handling the redirection yourself"}).optional(),idToken:M.optional(M.object({token:M.string({description:"ID token from the provider"}),nonce:M.string({description:"Nonce used to generate the token"}).optional(),accessToken:M.string({description:"Access token from the provider"}).optional(),refreshToken:M.string({description:"Refresh token from the provider"}).optional(),expiresAt:M.number({description:"Expiry date of the token"}).optional()}),{description:"ID token from the provider to sign in the user with id token"})}),metadata:{openapi:{description:"Sign in with a social provider",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{type:"string"},user:{type:"object"},url:{type:"string"},redirect:{type:"boolean"}},required:["session","user","url","redirect"]}}}}}}}},async e=>{let i=e.context.socialProviders.find(n=>n.id===e.body.provider);if(!i)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new Z("NOT_FOUND",{message:f.PROVIDER_NOT_FOUND});if(e.body.idToken){if(!i.verifyIdToken)throw e.context.logger.error("Provider does not support id token verification",{provider:e.body.provider}),new Z("NOT_FOUND",{message:f.ID_TOKEN_NOT_SUPPORTED});let{token:n,nonce:s}=e.body.idToken;if(!await i.verifyIdToken(n,s))throw e.context.logger.error("Invalid id token",{provider:e.body.provider}),new Z("UNAUTHORIZED",{message:f.INVALID_TOKEN});let d=await i.getUserInfo({idToken:n,accessToken:e.body.idToken.accessToken,refreshToken:e.body.idToken.refreshToken});if(!d||!d?.user)throw e.context.logger.error("Failed to get user info",{provider:e.body.provider}),new Z("UNAUTHORIZED",{message:f.FAILED_TO_GET_USER_INFO});if(!d.user.email)throw e.context.logger.error("User email not found",{provider:e.body.provider}),new Z("UNAUTHORIZED",{message:f.USER_EMAIL_NOT_FOUND});let A=await _e(e,{userInfo:{email:d.user.email,id:d.user.id,name:d.user.name||"",image:d.user.image,emailVerified:d.user.emailVerified||!1},account:{providerId:i.id,accountId:d.user.id,accessToken:e.body.idToken.accessToken}});if(A.error)throw new Z("UNAUTHORIZED",{message:A.error});return await w(e,A.data),e.json({token:A.data.session.token,url:void 0,redirect:!1})}let{codeVerifier:r,state:o}=await Te(e),t=await i.createAuthorizationURL({state:o,codeVerifier:r,redirectURI:`${e.context.baseURL}/callback/${i.id}`});return e.json({url:t.toString(),redirect:!e.body.disableRedirect})}),Ci=K("/sign-in/email",{method:"POST",body:M.object({email:M.string({description:"Email of the user"}),password:M.string({description:"Password of the user"}),callbackURL:M.string({description:"Callback URL to use as a redirect for email verification"}).optional(),rememberMe:M.boolean({description:"If this is false, the session will not be remembered. Default is `true`."}).default(!0).optional()}),metadata:{openapi:{description:"Sign in with email and password",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object"},url:{type:"string"},redirect:{type:"boolean"}},required:["session","user","url","redirect"]}}}}}}}},async e=>{if(!e.context.options?.emailAndPassword?.enabled)throw e.context.logger.error("Email and password is not enabled. Make sure to enable it in the options on you `auth.ts` file. Check `https://better-auth.com/docs/authentication/email-password` for more!"),new Z("BAD_REQUEST",{message:"Email and password is not enabled"});let{email:i,password:r}=e.body;if(!M.string().email().safeParse(i).success)throw new Z("BAD_REQUEST",{message:f.INVALID_EMAIL});let t=await e.context.internalAdapter.findUserByEmail(i,{includeAccounts:!0});if(!t)throw await e.context.password.hash(r),e.context.logger.error("User not found",{email:i}),new Z("UNAUTHORIZED",{message:f.INVALID_EMAIL_OR_PASSWORD});let n=t.accounts.find(A=>A.providerId==="credential");if(!n)throw e.context.logger.error("Credential account not found",{email:i}),new Z("UNAUTHORIZED",{message:f.INVALID_EMAIL_OR_PASSWORD});let s=n?.password;if(!s)throw e.context.logger.error("Password not found",{email:i}),new Z("UNAUTHORIZED",{message:f.INVALID_EMAIL_OR_PASSWORD});if(!await e.context.password.verify({hash:s,password:r}))throw e.context.logger.error("Invalid password"),new Z("UNAUTHORIZED",{message:f.INVALID_EMAIL_OR_PASSWORD});if(e.context.options?.emailAndPassword?.requireEmailVerification&&!t.user.emailVerified){if(!e.context.options?.emailVerification?.sendVerificationEmail)throw new Z("UNAUTHORIZED",{message:f.EMAIL_NOT_VERIFIED});let A=await ce(e.context.secret,t.user.email),c=`${e.context.baseURL}/verify-email?token=${A}&callbackURL=${e.body.callbackURL||"/"}`;throw await e.context.options.emailVerification.sendVerificationEmail({user:t.user,url:c,token:A},e.request),e.context.logger.error("Email not verified",{email:i}),new Z("FORBIDDEN",{message:f.EMAIL_NOT_VERIFIED})}let d=await e.context.internalAdapter.createSession(t.user.id,e.headers,e.body.rememberMe===!1);if(!d)throw e.context.logger.error("Failed to create session"),new Z("UNAUTHORIZED",{message:f.FAILED_TO_CREATE_SESSION});return await w(e,{session:d,user:t.user},e.body.rememberMe===!1),e.json({user:{id:t.user.id,email:t.user.email,name:t.user.name,image:t.user.image,emailVerified:t.user.emailVerified,createdAt:t.user.createdAt,updatedAt:t.user.updatedAt},redirect:!!e.body.callbackURL,url:e.body.callbackURL})});import{z as ze}from"zod";var eo=ze.object({code:ze.string().optional(),error:ze.string().optional(),error_description:ze.string().optional(),state:ze.string().optional()}),bi=K("/callback/:id",{method:["GET","POST"],body:eo.optional(),query:eo.optional(),metadata:Ee},async e=>{let i;try{if(e.method==="GET")i=eo.parse(e.query);else if(e.method==="POST")i=eo.parse(e.body);else throw new Error("Unsupported method")}catch(g){throw e.context.logger.error("INVALID_CALLBACK_REQUEST",g),e.redirect(`${e.context.baseURL}/error?error=invalid_callback_request`)}let{code:r,error:o,state:t,error_description:n}=i;if(!t)throw e.context.logger.error("State not found",o),e.redirect(`${e.context.baseURL}/error?error=state_not_found`);if(!r)throw e.context.logger.error("Code not found"),e.redirect(`${e.context.baseURL}/error?error=${o||"no_code"}&error_description=${n}`);let s=e.context.socialProviders.find(g=>g.id===e.params.id);if(!s)throw e.context.logger.error("Oauth provider with id",e.params.id,"not found"),e.redirect(`${e.context.baseURL}/error?error=oauth_provider_not_found`);let{codeVerifier:a,callbackURL:d,link:A,errorURL:c,newUserURL:l}=await Xe(e),p;try{p=await s.validateAuthorizationCode({code:r,codeVerifier:a,redirectURI:`${e.context.baseURL}/callback/${s.id}`})}catch(g){throw e.context.logger.error("",g),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`)}let u=await s.getUserInfo(p).then(g=>g?.user);function y(g){let O=c||d||`${e.context.baseURL}/error`;throw O.includes("?")?O=`${O}&error=${g}`:O=`${O}?error=${g}`,e.redirect(O)}if(!u)return e.context.logger.error("Unable to get user info"),y("unable_to_get_user_info");if(!u.email)return e.context.logger.error("Provider did not return email. This could be due to misconfiguration in the provider settings."),y("email_not_found");if(!d)throw e.context.logger.error("No callback URL found"),e.redirect(`${e.context.baseURL}/error?error=please_restart_the_process`);if(A){if(A.email!==u.email.toLowerCase())return y("email_doesn't_match");if(!await e.context.internalAdapter.createAccount({userId:A.userId,providerId:s.id,accountId:u.id}))return y("unable_to_link_account");let O;try{O=d.toString()}catch{O=d}throw e.redirect(O)}let h=await _e(e,{userInfo:{...u,email:u.email,name:u.name||u.email},account:{providerId:s.id,accountId:u.id,...p,scope:p.scopes?.join(",")},callbackURL:d});if(h.error)return e.context.logger.error(h.error.split(" ").join("_")),y(h.error.split(" ").join("_"));let{session:L,user:B}=h.data;await w(e,{session:L,user:B});let F;try{F=(h.isRegister&&l||d).toString()}catch{F=h.isRegister&&l||d}throw e.redirect(F)});import"zod";import{APIError as Pr}from"better-call";var Oi=K("/sign-out",{method:"POST",requireHeaders:!0,metadata:{openapi:{description:"Sign out the current user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async e=>{let i=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!i)throw H(e),new Pr("BAD_REQUEST",{message:f.FAILED_TO_GET_SESSION});return await e.context.internalAdapter.deleteSession(i),H(e),e.json({success:!0})});import{z as ie}from"zod";import{APIError as xe}from"better-call";function Pi(e,i,r){let o=i?new URL(i,e.baseURL):new URL(`${e.baseURL}/error`);return r&&Object.entries(r).forEach(([t,n])=>o.searchParams.set(t,n)),o.href}function Nr(e,i,r){let o=new URL(i,e.baseURL);return r&&Object.entries(r).forEach(([t,n])=>o.searchParams.set(t,n)),o.href}var Ti=K("/forget-password",{method:"POST",body:ie.object({email:ie.string({description:"The email address of the user to send a password reset email to"}).email(),redirectTo:ie.string({description:"The URL to redirect the user to reset their password. If the token isn't valid or expired, it'll be redirected with a query parameter `?error=INVALID_TOKEN`. If the token is valid, it'll be redirected with a query parameter `?token=VALID_TOKEN"}).optional()}),metadata:{openapi:{description:"Send a password reset email to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{if(!e.context.options.emailAndPassword?.sendResetPassword)throw e.context.logger.error("Reset password isn't enabled.Please pass an emailAndPassword.sendResetPasswordToken function in your auth config!"),new xe("BAD_REQUEST",{message:"Reset password isn't enabled"});let{email:i,redirectTo:r}=e.body,o=await e.context.internalAdapter.findUserByEmail(i,{includeAccounts:!0});if(!o)return e.context.logger.error("Reset Password: User not found",{email:i}),e.json({status:!1},{body:{status:!0}});let t=60*60*1,n=P(e.context.options.emailAndPassword.resetPasswordTokenExpiresIn||t,"sec"),s=J(24);await e.context.internalAdapter.createVerificationValue({value:o.user.id.toString(),identifier:`reset-password:${s}`,expiresAt:n});let a=`${e.context.baseURL}/reset-password/${s}?callbackURL=${r}`;return await e.context.options.emailAndPassword.sendResetPassword({user:o.user,url:a,token:s},e.request),e.json({status:!0})}),Ei=K("/reset-password/:token",{method:"GET",query:ie.object({callbackURL:ie.string({description:"The URL to redirect the user to reset their password"})}),metadata:{openapi:{description:"Redirects the user to the callback URL with the token",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string"}}}}}}}}}},async e=>{let{token:i}=e.params,{callbackURL:r}=e.query;if(!i||!r)throw e.redirect(Pi(e.context,r,{error:"INVALID_TOKEN"}));let o=await e.context.internalAdapter.findVerificationValue(`reset-password:${i}`);throw!o||o.expiresAt<new Date?e.redirect(Pi(e.context,r,{error:"INVALID_TOKEN"})):e.redirect(Nr(e.context,r,{token:i}))}),Ii=K("/reset-password",{query:ie.optional(ie.object({token:ie.string().optional(),currentURL:ie.string().optional()})),method:"POST",body:ie.object({newPassword:ie.string({description:"The new password to set"}),token:ie.string({description:"The token to reset the password"}).optional()}),metadata:{openapi:{description:"Reset the password for a user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{let i=e.body.token||e.query?.token||(e.query?.currentURL?new URL(e.query.currentURL).searchParams.get("token"):"");if(!i)throw new xe("BAD_REQUEST",{message:f.INVALID_TOKEN});let{newPassword:r}=e.body,o=e.context.password?.config.minPasswordLength,t=e.context.password?.config.maxPasswordLength;if(r.length<o)throw new xe("BAD_REQUEST",{message:f.PASSWORD_TOO_SHORT});if(r.length>t)throw new xe("BAD_REQUEST",{message:f.PASSWORD_TOO_LONG});let n=`reset-password:${i}`,s=await e.context.internalAdapter.findVerificationValue(n);if(!s||s.expiresAt<new Date)throw new xe("BAD_REQUEST",{message:f.INVALID_TOKEN});await e.context.internalAdapter.deleteVerificationValue(s.id);let a=s.value,d=await e.context.password.hash(r);return(await e.context.internalAdapter.findAccounts(a)).find(l=>l.providerId==="credential")?(await e.context.internalAdapter.updatePassword(a,d),e.json({status:!0})):(await e.context.internalAdapter.createAccount({userId:a,providerId:"credential",password:d,accountId:a}),e.json({status:!0}))});import{z as j}from"zod";import{APIError as z}from"better-call";var Ri=()=>K("/update-user",{method:"POST",body:j.record(j.string(),j.any()),use:[E],metadata:{openapi:{description:"Update the current user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{name:{type:"string",description:"The name of the user"},image:{type:"string",description:"The image of the user"}}}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object"}}}}}}}}}},async e=>{let i=e.body;if(i.email)throw new z("BAD_REQUEST",{message:f.EMAIL_CAN_NOT_BE_UPDATED});let{name:r,image:o,...t}=i,n=e.context.session;if(o===void 0&&r===void 0&&Object.keys(t).length===0)return e.json({status:!0});let s=Ye(e.context.options,t,"update"),a=await e.context.internalAdapter.updateUserByEmail(n.user.email,{name:r,image:o,...s});return await w(e,{session:n.session,user:a}),e.json({status:!0})}),_i=K("/change-password",{method:"POST",body:j.object({newPassword:j.string({description:"The new password to set"}),currentPassword:j.string({description:"The current password"}),revokeOtherSessions:j.boolean({description:"Revoke all other sessions"}).optional()}),use:[E],metadata:{openapi:{description:"Change the password of the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{description:"The user object",$ref:"#/components/schemas/User"}}}}}}}}}},async e=>{let{newPassword:i,currentPassword:r,revokeOtherSessions:o}=e.body,t=e.context.session,n=e.context.password.config.minPasswordLength;if(i.length<n)throw e.context.logger.error("Password is too short"),new z("BAD_REQUEST",{message:f.PASSWORD_TOO_SHORT});let s=e.context.password.config.maxPasswordLength;if(i.length>s)throw e.context.logger.error("Password is too long"),new z("BAD_REQUEST",{message:f.PASSWORD_TOO_LONG});let d=(await e.context.internalAdapter.findAccounts(t.user.id)).find(p=>p.providerId==="credential"&&p.password);if(!d||!d.password)throw new z("BAD_REQUEST",{message:f.CREDENTIAL_ACCOUNT_NOT_FOUND});let A=await e.context.password.hash(i);if(!await e.context.password.verify({hash:d.password,password:r}))throw new z("BAD_REQUEST",{message:f.INVALID_PASSWORD});await e.context.internalAdapter.updateAccount(d.id,{password:A});let l=null;if(o){await e.context.internalAdapter.deleteSessions(t.user.id);let p=await e.context.internalAdapter.createSession(t.user.id,e.headers);if(!p)throw new z("INTERNAL_SERVER_ERROR",{message:f.FAILED_TO_GET_SESSION});await w(e,{session:p,user:t.user}),l=p.token}return e.json({token:l})}),Ui=K("/set-password",{method:"POST",body:j.object({newPassword:j.string()}),metadata:{SERVER_ONLY:!0},use:[E]},async e=>{let{newPassword:i}=e.body,r=e.context.session,o=e.context.password.config.minPasswordLength;if(i.length<o)throw e.context.logger.error("Password is too short"),new z("BAD_REQUEST",{message:f.PASSWORD_TOO_SHORT});let t=e.context.password.config.maxPasswordLength;if(i.length>t)throw e.context.logger.error("Password is too long"),new z("BAD_REQUEST",{message:f.PASSWORD_TOO_LONG});let s=(await e.context.internalAdapter.findAccounts(r.user.id)).find(d=>d.providerId==="credential"&&d.password),a=await e.context.password.hash(i);if(!s)return await e.context.internalAdapter.linkAccount({userId:r.user.id,providerId:"credential",accountId:r.user.id,password:a}),e.json({status:!0});throw new z("BAD_REQUEST",{message:"user already has a password"})}),Si=K("/delete-user",{method:"POST",use:[E],body:j.object({callbackURL:j.string().optional(),password:j.string().optional(),token:j.string().optional()}),metadata:{openapi:{description:"Delete the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object"}}}}}}}},async e=>{if(!e.context.options.user?.deleteUser?.enabled)throw e.context.logger.error("Delete user is disabled. Enable it in the options",{session:e.context.session}),new z("NOT_FOUND");let i=e.context.session;if(e.body.password){let n=(await e.context.internalAdapter.findAccounts(i.user.id)).find(a=>a.providerId==="credential"&&a.password);if(!n||!n.password)throw new z("BAD_REQUEST",{message:f.CREDENTIAL_ACCOUNT_NOT_FOUND});if(!await e.context.password.verify({hash:n.password,password:e.body.password}))throw new z("BAD_REQUEST",{message:f.INVALID_PASSWORD})}else if(e.context.options.session?.freshAge){let t=i.session.createdAt.getTime(),n=e.context.options.session.freshAge;if(Date.now()-t>n)throw new z("BAD_REQUEST",{message:f.SESSION_EXPIRED})}if(e.body.token)return await To({query:{token:e.body.token},...e}),e.json({success:!0,message:"User deleted"});if(e.context.options.user.deleteUser?.sendDeleteAccountVerification){let t=I(32,"0-9","a-z");await e.context.internalAdapter.createVerificationValue({value:i.user.id,identifier:`delete-account-${t}`,expiresAt:new Date(Date.now()+1e3*60*60*24)});let n=`${e.context.baseURL}/delete-user/callback?token=${t}&callbackURL=${e.body.callbackURL||"/"}`;return await e.context.options.user.deleteUser.sendDeleteAccountVerification({user:i.user,url:n,token:t},e.request),e.json({success:!0,message:"Verification email sent"})}let r=e.context.options.user.deleteUser?.beforeDelete;r&&await r(i.user,e.request),await e.context.internalAdapter.deleteUser(i.user.id),await e.context.internalAdapter.deleteSessions(i.user.id),await e.context.internalAdapter.deleteAccounts(i.user.id),H(e);let o=e.context.options.user.deleteUser?.afterDelete;return o&&await o(i.user,e.request),e.json({success:!0,message:"User deleted"})}),To=K("/delete-user/callback",{method:"GET",query:j.object({token:j.string(),callbackURL:j.string().optional()})},async e=>{if(!e.context.options.user?.deleteUser?.enabled)throw e.context.logger.error("Delete user is disabled. Enable it in the options"),new z("NOT_FOUND");let i=await R(e);if(!i)throw new z("NOT_FOUND",{message:f.FAILED_TO_GET_USER_INFO});let r=await e.context.internalAdapter.findVerificationValue(`delete-account-${e.query.token}`);if(!r||r.expiresAt<new Date)throw r&&await e.context.internalAdapter.deleteVerificationValue(r.id),new z("NOT_FOUND",{message:f.INVALID_TOKEN});if(r.value!==i.user.id)throw new z("NOT_FOUND",{message:f.INVALID_TOKEN});let o=e.context.options.user.deleteUser?.beforeDelete;o&&await o(i.user,e.request),await e.context.internalAdapter.deleteUser(i.user.id),await e.context.internalAdapter.deleteSessions(i.user.id),await e.context.internalAdapter.deleteAccounts(i.user.id),await e.context.internalAdapter.deleteVerificationValue(r.id),H(e);let t=e.context.options.user.deleteUser?.afterDelete;if(t&&await t(i.user,e.request),e.query.callbackURL)throw e.redirect(e.query.callbackURL||"/");return e.json({success:!0,message:"User deleted"})}),vi=K("/change-email",{method:"POST",query:j.object({currentURL:j.string().optional()}).optional(),body:j.object({newEmail:j.string({description:"The new email to set"}).email(),callbackURL:j.string({description:"The URL to redirect to after email verification"}).optional()}),use:[E],metadata:{openapi:{responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object"},status:{type:"boolean"}}}}}}}}}},async e=>{if(!e.context.options.user?.changeEmail?.enabled)throw e.context.logger.error("Change email is disabled."),new z("BAD_REQUEST",{message:"Change email is disabled"});if(e.body.newEmail===e.context.session.user.email)throw e.context.logger.error("Email is the same"),new z("BAD_REQUEST",{message:"Email is the same"});if(await e.context.internalAdapter.findUserByEmail(e.body.newEmail))throw e.context.logger.error("Email already exists"),new z("BAD_REQUEST",{message:"Couldn't update your email"});if(e.context.session.user.emailVerified!==!0){let t=await e.context.internalAdapter.updateUserByEmail(e.context.session.user.email,{email:e.body.newEmail});return e.json({status:!0})}if(!e.context.options.user.changeEmail.sendChangeEmailVerification)throw e.context.logger.error("Verification email isn't enabled."),new z("BAD_REQUEST",{message:"Verification email isn't enabled"});let r=await ce(e.context.secret,e.context.session.user.email,e.body.newEmail),o=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||e.query?.currentURL||"/"}`;return await e.context.options.user.changeEmail.sendChangeEmailVerification({user:e.context.session.user,newEmail:e.body.newEmail,url:o,token:r},e.request),e.json({status:!0})});import{z as Be}from"zod";import{APIError as Ni}from"better-call";var ki=K("/list-accounts",{method:"GET",use:[E],metadata:{openapi:{description:"List all accounts linked to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{type:"object",properties:{id:{type:"string"},provider:{type:"string"}}}}}}}}}}},async e=>{let i=e.context.session,r=await e.context.internalAdapter.findAccounts(i.user.id);return e.json(r.map(o=>({id:o.id,provider:o.providerId})))}),Di=K("/link-social",{method:"POST",requireHeaders:!0,query:Be.object({currentURL:Be.string().optional()}).optional(),body:Be.object({callbackURL:Be.string({description:"The URL to redirect to after the user has signed in"}).optional(),provider:Be.enum(fo,{description:"The OAuth2 provider to use"})}),use:[E],metadata:{openapi:{description:"Link a social account to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string"},redirect:{type:"boolean"}},required:["url","redirect"]}}}}}}}},async e=>{let i=e.context.session;if((await e.context.internalAdapter.findAccounts(i.user.id)).find(a=>a.providerId===e.body.provider))throw new Ni("BAD_REQUEST",{message:f.SOCIAL_ACCOUNT_ALREADY_LINKED});let t=e.context.socialProviders.find(a=>a.id===e.body.provider);if(!t)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new Ni("NOT_FOUND",{message:f.PROVIDER_NOT_FOUND});let n=await Te(e,{userId:i.user.id,email:i.user.email}),s=await t.createAuthorizationURL({state:n.state,codeVerifier:n.codeVerifier,redirectURI:`${e.context.baseURL}/callback/${t.id}`});return e.json({url:s.toString(),redirect:!0})});var Li=(e,i)=>{let r={};for(let[o,t]of Object.entries(e))r[o]=n=>t({...n,context:{...i,...n.context}}),r[o].path=t.path,r[o].method=t.method,r[o].options=t.options,r[o].headers=t.headers;return r};function oo(e){let i=e;return{newRole(r){return Lr(r)}}}function Lr(e){return{statements:e,authorize(i,r){for(let[o,t]of Object.entries(i)){let n=e[o];return n?(r==="OR"?t.some(a=>n.includes(a)):t.every(a=>n.includes(a)))?{success:!0}:{success:!1,error:`Unauthorized to access resource "${o}"`}:{success:!1,error:`You are not allowed to access resource: ${o}`}}return{success:!1,error:"Not authorized"}}}}var jr={organization:["update","delete"],member:["create","update","delete"],invitation:["create","cancel"]},Eo=oo(jr),zr=Eo.newRole({organization:["update"],invitation:["create","cancel"],member:["create","update","delete"]}),xr=Eo.newRole({organization:["update","delete"],member:["create","update","delete"],invitation:["create","cancel"]}),Br=Eo.newRole({organization:[],member:[],invitation:[]}),ji={admin:zr,owner:xr,member:Br};var Fr={proto:/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,constructor:/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,protoShort:/"__proto__"\s*:/,constructorShort:/"constructor"\s*:/},Mr=/^\s*["[{]|^\s*-?\d{1,16}(\.\d{1,17})?([Ee][+-]?\d+)?\s*$/,zi={true:!0,false:!1,null:null,undefined:void 0,nan:Number.NaN,infinity:Number.POSITIVE_INFINITY,"-infinity":Number.NEGATIVE_INFINITY},Vr=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d{1,7}))?(?:Z|([+-])(\d{2}):(\d{2}))$/;function qr(e){return e instanceof Date&&!isNaN(e.getTime())}function Hr(e){let i=Vr.exec(e);if(!i)return null;let[,r,o,t,n,s,a,d,A,c,l]=i,p=new Date(Date.UTC(parseInt(r,10),parseInt(o,10)-1,parseInt(t,10),parseInt(n,10),parseInt(s,10),parseInt(a,10),d?parseInt(d.padEnd(3,"0"),10):0));if(A){let u=(parseInt(c,10)*60+parseInt(l,10))*(A==="+"?-1:1);p.setUTCMinutes(p.getUTCMinutes()+u)}return qr(p)?p:null}function $r(e,i={}){let{strict:r=!1,warnings:o=!1,reviver:t,parseDates:n=!0}=i;if(typeof e!="string")return e;let s=e.trim();if(s[0]==='"'&&s.endsWith('"')&&!s.slice(1,-1).includes('"'))return s.slice(1,-1);let a=s.toLowerCase();if(a.length<=9&&a in zi)return zi[a];if(!Mr.test(s)){if(r)throw new SyntaxError("[better-json] Invalid JSON");return e}if(Object.entries(Fr).some(([A,c])=>{let l=c.test(s);return l&&o&&console.warn(`[better-json] Detected potential prototype pollution attempt using ${A} pattern`),l})&&r)throw new Error("[better-json] Potential prototype pollution attempt detected");try{return JSON.parse(s,(c,l)=>{if(c==="__proto__"||c==="constructor"&&l&&typeof l=="object"&&"prototype"in l){o&&console.warn(`[better-json] Dropping "${c}" key to prevent prototype pollution`);return}if(n&&typeof l=="string"){let p=Hr(l);if(p)return p}return t?t(c,l):l})}catch(A){if(r)throw A;return e}}function Zr(e,i={strict:!0}){return $r(e,i)}var xi=Zr;var V=(e,i)=>{let r=e.adapter;return{findOrganizationBySlug:async o=>await r.findOne({model:"organization",where:[{field:"slug",value:o}]}),createOrganization:async o=>{let t=await r.create({model:"organization",data:{...o.organization,metadata:o.organization.metadata?JSON.stringify(o.organization.metadata):void 0}}),n=await r.create({model:"member",data:{organizationId:t.id,userId:o.user.id,createdAt:new Date,role:i?.creatorRole||"owner"}});return{...t,metadata:t.metadata?JSON.parse(t.metadata):void 0,members:[{...n,user:{id:o.user.id,name:o.user.name,email:o.user.email,image:o.user.image}}]}},findMemberByEmail:async o=>{let t=await r.findOne({model:"user",where:[{field:"email",value:o.email}]});if(!t)return null;let n=await r.findOne({model:"member",where:[{field:"organizationId",value:o.organizationId},{field:"userId",value:t.id}]});return n?{...n,user:{id:t.id,name:t.name,email:t.email,image:t.image}}:null},findMemberByOrgId:async o=>{let[t,n]=await Promise.all([await r.findOne({model:"member",where:[{field:"userId",value:o.userId},{field:"organizationId",value:o.organizationId}]}),await r.findOne({model:"user",where:[{field:"id",value:o.userId}]})]);return!n||!t?null:{...t,user:{id:n.id,name:n.name,email:n.email,image:n.image}}},findMemberById:async o=>{let t=await r.findOne({model:"member",where:[{field:"id",value:o}]});if(!t)return null;let n=await r.findOne({model:"user",where:[{field:"id",value:t.userId}]});return n?{...t,user:{id:n.id,name:n.name,email:n.email,image:n.image}}:null},createMember:async o=>await r.create({model:"member",data:o}),updateMember:async(o,t)=>await r.update({model:"member",where:[{field:"id",value:o}],update:{role:t}}),deleteMember:async o=>await r.delete({model:"member",where:[{field:"id",value:o}]}),updateOrganization:async(o,t)=>{let n=await r.update({model:"organization",where:[{field:"id",value:o}],update:{...t,metadata:typeof t.metadata=="object"?JSON.stringify(t.metadata):t.metadata}});return n?{...n,metadata:n.metadata?xi(n.metadata):void 0}:null},deleteOrganization:async o=>(await r.delete({model:"member",where:[{field:"organizationId",value:o}]}),await r.delete({model:"invitation",where:[{field:"organizationId",value:o}]}),await r.delete({model:"organization",where:[{field:"id",value:o}]}),o),setActiveOrganization:async(o,t)=>await e.internalAdapter.updateSession(o,{activeOrganizationId:t}),findOrganizationById:async o=>await r.findOne({model:"organization",where:[{field:"id",value:o}]}),findFullOrganization:async({organizationId:o,isSlug:t})=>{let n=await r.findOne({model:"organization",where:[{field:t?"slug":"id",value:o}]});if(!n)return null;let[s,a]=await Promise.all([r.findMany({model:"invitation",where:[{field:"organizationId",value:n.id}]}),r.findMany({model:"member",where:[{field:"organizationId",value:n.id}]})]);if(!n)return null;let d=a.map(p=>p.userId),A=await r.findMany({model:"user",where:[{field:"id",value:d,operator:"in"}]}),c=new Map(A.map(p=>[p.id,p])),l=a.map(p=>{let u=c.get(p.userId);if(!u)throw new te("Unexpected error: User not found for member");return{...p,user:{id:u.id,name:u.name,email:u.email,image:u.image}}});return{...n,invitations:s,members:l}},listOrganizations:async o=>{let t=await r.findMany({model:"member",where:[{field:"userId",value:o}]});if(!t||t.length===0)return[];let n=t.map(a=>a.organizationId);return await r.findMany({model:"organization",where:[{field:"id",value:n,operator:"in"}]})},createInvitation:async({invitation:o,user:t})=>{let s=P(i?.invitationExpiresIn||1728e5);return await r.create({model:"invitation",data:{email:o.email,role:o.role,organizationId:o.organizationId,status:"pending",expiresAt:s,inviterId:t.id}})},findInvitationById:async o=>await r.findOne({model:"invitation",where:[{field:"id",value:o}]}),findPendingInvitation:async o=>(await r.findMany({model:"invitation",where:[{field:"email",value:o.email},{field:"organizationId",value:o.organizationId},{field:"status",value:"pending"}]})).filter(n=>new Date(n.expiresAt)>new Date),updateInvitation:async o=>await r.update({model:"invitation",where:[{field:"id",value:o.invitationId}],update:{status:o.status}})}};import"better-call";var $=D(async e=>({})),Q=D({use:[E]},async e=>({session:e.context.session}));import{z as X}from"zod";import{z as N}from"zod";var Bi=N.string(),Qr=N.enum(["pending","accepted","rejected","canceled"]).default("pending"),fK=N.object({id:N.string().default(J),name:N.string(),slug:N.string(),logo:N.string().nullish(),metadata:N.record(N.string()).or(N.string().transform(e=>JSON.parse(e))).nullish(),createdAt:N.date()}),hK=N.object({id:N.string().default(J),organizationId:N.string(),userId:N.string(),role:Bi,createdAt:N.date()}),yK=N.object({id:N.string().default(J),organizationId:N.string(),email:N.string(),role:Bi,status:Qr,inviterId:N.string(),expiresAt:N.date()});import{APIError as q}from"better-call";var C={YOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_ORGANIZATION:"You are not allowed to create a new organization",YOU_HAVE_REACHED_THE_MAXIMUM_NUMBER_OF_ORGANIZATIONS:"You have reached the maximum number of organizations",ORGANIZATION_ALREADY_EXISTS:"Organization already exists",ORGANIZATION_NOT_FOUND:"Organization not found",USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION:"User is not a member of the organization",YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_ORGANIZATION:"You are not allowed to update this organization",YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_ORGANIZATION:"You are not allowed to delete this organization",NO_ACTIVE_ORGANIZATION:"No active organization",USER_IS_ALREADY_A_MEMBER_OF_THIS_ORGANIZATION:"User is already a member of this organization",MEMBER_NOT_FOUND:"Member not found",ROLE_NOT_FOUND:"Role not found",YOU_CANNOT_LEAVE_THE_ORGANIZATION_AS_THE_ONLY_OWNER:"You cannot leave the organization as the only owner",YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_MEMBER:"You are not allowed to delete this member",YOU_ARE_NOT_ALLOWED_TO_INVITE_USERS_TO_THIS_ORGANIZATION:"You are not allowed to invite users to this organization",USER_IS_ALREADY_INVITED_TO_THIS_ORGANIZATION:"User is already invited to this organization",INVITATION_NOT_FOUND:"Invitation not found",YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION:"You are not the recipient of the invitation",YOU_ARE_NOT_ALLOWED_TO_CANCEL_THIS_INVITATION:"You are not allowed to cancel this invitation",INVITER_IS_NO_LONGER_A_MEMBER_OF_THE_ORGANIZATION:"Inviter is no longer a member of the organization"};var Fi=e=>K("/organization/invite-member",{method:"POST",use:[$,Q],body:X.object({email:X.string({description:"The email address of the user to invite"}),role:X.string({description:"The role to assign to the user"}),organizationId:X.string({description:"The organization ID to invite the user to"}).optional(),resend:X.boolean({description:"Resend the invitation email, if the user is already invited"}).optional()}),metadata:{openapi:{description:"Invite a user to an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string"},email:{type:"string"},role:{type:"string"},organizationId:{type:"string"},inviterId:{type:"string"},status:{type:"string"},expiresAt:{type:"string"}},required:["id","email","role","organizationId","inviterId","status","expiresAt"]}}}}}}}},async i=>{if(!i.context.orgOptions.sendInvitationEmail)throw i.context.logger.warn("Invitation email is not enabled. Pass `sendInvitationEmail` to the plugin options to enable it."),new q("BAD_REQUEST",{message:"Invitation email is not enabled"});let r=i.context.session,o=i.body.organizationId||r.session.activeOrganizationId;if(!o)throw new q("BAD_REQUEST",{message:C.ORGANIZATION_NOT_FOUND});let t=V(i.context,i.context.orgOptions),n=await t.findMemberByOrgId({userId:r.user.id,organizationId:o});if(!n)throw new q("BAD_REQUEST",{message:C.MEMBER_NOT_FOUND});let s=i.context.roles[n.role];if(!s)throw new q("BAD_REQUEST",{message:C.ROLE_NOT_FOUND});if(s.authorize({invitation:["create"]}).error)throw new q("FORBIDDEN",{message:C.YOU_ARE_NOT_ALLOWED_TO_INVITE_USERS_TO_THIS_ORGANIZATION});if(await t.findMemberByEmail({email:i.body.email,organizationId:o}))throw new q("BAD_REQUEST",{message:C.USER_IS_ALREADY_A_MEMBER_OF_THIS_ORGANIZATION});if((await t.findPendingInvitation({email:i.body.email,organizationId:o})).length&&!i.body.resend)throw new q("BAD_REQUEST",{message:C.USER_IS_ALREADY_INVITED_TO_THIS_ORGANIZATION});let c=await t.createInvitation({invitation:{role:i.body.role,email:i.body.email,organizationId:o},user:r.user}),l=await t.findOrganizationById(o);if(!l)throw new q("BAD_REQUEST",{message:C.ORGANIZATION_NOT_FOUND});return await i.context.orgOptions.sendInvitationEmail?.({id:c.id,role:c.role,email:c.email,organization:l,inviter:{...n,user:r.user}},i.request),i.json(c)}),Mi=K("/organization/accept-invitation",{method:"POST",body:X.object({invitationId:X.string({description:"The ID of the invitation to accept"})}),use:[$,Q],metadata:{openapi:{description:"Accept an invitation to an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{invitation:{type:"object"},member:{type:"object"}}}}}}}}}},async e=>{let i=e.context.session,r=V(e.context,e.context.orgOptions),o=await r.findInvitationById(e.body.invitationId);if(!o||o.expiresAt<new Date||o.status!=="pending")throw new q("BAD_REQUEST",{message:C.INVITATION_NOT_FOUND});if(o.email!==i.user.email)throw new q("FORBIDDEN",{message:C.YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION});let t=await r.updateInvitation({invitationId:e.body.invitationId,status:"accepted"}),n=await r.createMember({organizationId:o.organizationId,userId:i.user.id,role:o.role,createdAt:new Date});return await r.setActiveOrganization(i.session.token,o.organizationId),t?e.json({invitation:t,member:n}):e.json(null,{status:400,body:{message:C.INVITATION_NOT_FOUND}})}),Vi=K("/organization/reject-invitation",{method:"POST",body:X.object({invitationId:X.string({description:"The ID of the invitation to reject"})}),use:[$,Q],metadata:{openapi:{description:"Reject an invitation to an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{invitation:{type:"object"},member:{type:"null"}}}}}}}}}},async e=>{let i=e.context.session,r=V(e.context,e.context.orgOptions),o=await r.findInvitationById(e.body.invitationId);if(!o||o.expiresAt<new Date||o.status!=="pending")throw new q("BAD_REQUEST",{message:"Invitation not found!"});if(o.email!==i.user.email)throw new q("FORBIDDEN",{message:C.YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION});let t=await r.updateInvitation({invitationId:e.body.invitationId,status:"rejected"});return e.json({invitation:t,member:null})}),qi=K("/organization/cancel-invitation",{method:"POST",body:X.object({invitationId:X.string({description:"The ID of the invitation to cancel"})}),use:[$,Q],openapi:{description:"Cancel an invitation to an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{invitation:{type:"object"}}}}}}}}},async e=>{let i=e.context.session,r=V(e.context,e.context.orgOptions),o=await r.findInvitationById(e.body.invitationId);if(!o)throw new q("BAD_REQUEST",{message:C.INVITATION_NOT_FOUND});let t=await r.findMemberByOrgId({userId:i.user.id,organizationId:o.organizationId});if(!t)throw new q("BAD_REQUEST",{message:C.MEMBER_NOT_FOUND});if(e.context.roles[t.role].authorize({invitation:["cancel"]}).error)throw new q("FORBIDDEN",{message:C.YOU_ARE_NOT_ALLOWED_TO_CANCEL_THIS_INVITATION});let s=await r.updateInvitation({invitationId:e.body.invitationId,status:"canceled"});return e.json(s)}),Hi=K("/organization/get-invitation",{method:"GET",use:[$],requireHeaders:!0,query:X.object({id:X.string({description:"The ID of the invitation to get"})}),metadata:{openapi:{description:"Get an invitation by ID",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string"},email:{type:"string"},role:{type:"string"},organizationId:{type:"string"},inviterId:{type:"string"},status:{type:"string"},expiresAt:{type:"string"},organizationName:{type:"string"},organizationSlug:{type:"string"},inviterEmail:{type:"string"}},required:["id","email","role","organizationId","inviterId","status","expiresAt","organizationName","organizationSlug","inviterEmail"]}}}}}}}},async e=>{let i=await R(e);if(!i)throw new q("UNAUTHORIZED",{message:"Not authenticated"});let r=V(e.context,e.context.orgOptions),o=await r.findInvitationById(e.query.id);if(!o||o.status!=="pending"||o.expiresAt<new Date)throw new q("BAD_REQUEST",{message:"Invitation not found!"});if(o.email!==i.user.email)throw new q("FORBIDDEN",{message:C.YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION});let t=await r.findOrganizationById(o.organizationId);if(!t)throw new q("BAD_REQUEST",{message:C.ORGANIZATION_NOT_FOUND});let n=await r.findMemberByOrgId({userId:o.inviterId,organizationId:o.organizationId});if(!n)throw new q("BAD_REQUEST",{message:C.INVITER_IS_NO_LONGER_A_MEMBER_OF_THE_ORGANIZATION});return e.json({...o,organizationName:t.name,organizationSlug:t.slug,inviterEmail:n.user.email})});import{z as ne}from"zod";import{APIError as Ce}from"better-call";var $i=()=>K("/organization/add-member",{method:"POST",body:ne.object({userId:ne.string(),role:ne.string(),organizationId:ne.string().optional()}),use:[$],metadata:{SERVER_ONLY:!0}},async e=>{let i=e.body.userId?await R(e).catch(a=>null):null,r=e.body.organizationId||i?.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:C.NO_ACTIVE_ORGANIZATION}});let o=V(e.context,e.context.orgOptions),t=await e.context.internalAdapter.findUserById(e.body.userId);if(!t)throw new Ce("BAD_REQUEST",{message:f.USER_NOT_FOUND});if(await o.findMemberByEmail({email:t.email,organizationId:r}))throw new Ce("BAD_REQUEST",{message:C.USER_IS_ALREADY_A_MEMBER_OF_THIS_ORGANIZATION});let s=await o.createMember({id:J(),organizationId:r,userId:t.id,role:e.body.role,createdAt:new Date});return e.json(s)}),Zi=K("/organization/remove-member",{method:"POST",body:ne.object({memberIdOrEmail:ne.string({description:"The ID or email of the member to remove"}),organizationId:ne.string({description:"The ID of the organization to remove the member from. If not provided, the active organization will be used"}).optional()}),use:[$,Q],metadata:{openapi:{description:"Remove a member from an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{member:{type:"object",properties:{id:{type:"string"},userId:{type:"string"},organizationId:{type:"string"},role:{type:"string"}},required:["id","userId","organizationId","role"]}},required:["member"]}}}}}}}},async e=>{let i=e.context.session,r=e.body.organizationId||i.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:C.NO_ACTIVE_ORGANIZATION}});let o=V(e.context,e.context.orgOptions),t=await o.findMemberByOrgId({userId:i.user.id,organizationId:r});if(!t)throw new Ce("BAD_REQUEST",{message:C.MEMBER_NOT_FOUND});let n=e.context.roles[t.role];if(!n)throw new Ce("BAD_REQUEST",{message:C.ROLE_NOT_FOUND});let s=i.user.email===e.body.memberIdOrEmail||t.id===e.body.memberIdOrEmail;if(s&&t.role===(e.context.orgOptions?.creatorRole||"owner"))throw new Ce("BAD_REQUEST",{message:C.YOU_CANNOT_LEAVE_THE_ORGANIZATION_AS_THE_ONLY_OWNER});if(!(s||n.authorize({member:["delete"]}).success))throw new Ce("UNAUTHORIZED",{message:C.YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_MEMBER});let A=null;if(e.body.memberIdOrEmail.includes("@")?A=await o.findMemberByEmail({email:e.body.memberIdOrEmail,organizationId:r}):A=await o.findMemberById(e.body.memberIdOrEmail),A?.organizationId!==r)throw new Ce("BAD_REQUEST",{message:C.MEMBER_NOT_FOUND});return await o.deleteMember(A.id),i.user.id===A.userId&&i.session.activeOrganizationId===A.organizationId&&await o.setActiveOrganization(i.session.token,null),e.json({member:A})}),Qi=e=>K("/organization/update-member-role",{method:"POST",body:ne.object({role:ne.string(),memberId:ne.string(),organizationId:ne.string().optional()}),use:[$,Q],metadata:{openapi:{description:"Update the role of a member in an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{member:{type:"object",properties:{id:{type:"string"},userId:{type:"string"},organizationId:{type:"string"},role:{type:"string"}},required:["id","userId","organizationId","role"]}},required:["member"]}}}}}}}},async i=>{let r=i.context.session,o=i.body.organizationId||r.session.activeOrganizationId;if(!o)return i.json(null,{status:400,body:{message:C.NO_ACTIVE_ORGANIZATION}});let t=V(i.context,i.context.orgOptions),n=await t.findMemberByOrgId({userId:r.user.id,organizationId:o});if(!n)return i.json(null,{status:400,body:{message:C.MEMBER_NOT_FOUND}});let s=i.context.roles[n.role];if(!s)return i.json(null,{status:400,body:{message:C.ROLE_NOT_FOUND}});if(s.authorize({member:["update"]}).error||i.body.role==="owner"&&n.role!=="owner")return i.json(null,{body:{message:"You are not allowed to update this member"},status:403});let d=await t.updateMember(i.body.memberId,i.body.role);return d?i.json(d):i.json(null,{status:400,body:{message:C.MEMBER_NOT_FOUND}})}),Gi=K("/organization/get-active-member",{method:"GET",use:[$,Q],metadata:{openapi:{description:"Get the active member in the organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{id:{type:"string"},userId:{type:"string"},organizationId:{type:"string"},role:{type:"string"}},required:["id","userId","organizationId","role"]}}}}}}}},async e=>{let i=e.context.session,r=i.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:C.NO_ACTIVE_ORGANIZATION}});let t=await V(e.context,e.context.orgOptions).findMemberByOrgId({userId:i.user.id,organizationId:r});return t?e.json(t):e.json(null,{status:400,body:{message:C.MEMBER_NOT_FOUND}})});import{z as S}from"zod";import{APIError as pe}from"better-call";var Wi=K("/organization/create",{method:"POST",body:S.object({name:S.string({description:"The name of the organization"}),slug:S.string({description:"The slug of the organization"}),userId:S.string({description:"The user id of the organization creator. If not provided, the current user will be used. Should only be used by admins or when called by the server."}).optional(),logo:S.string({description:"The logo of the organization"}).optional(),metadata:S.record(S.string(),S.any(),{description:"The metadata of the organization"}).optional()}),use:[$],metadata:{openapi:{description:"Create an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",description:"The organization that was created",$ref:"#/components/schemas/Organization"}}}}}}}},async e=>{let i=await R(e);if(!i&&(e.request||e.headers))throw new pe("UNAUTHORIZED");let r=i?.user||null;if(!r){if(!e.body.userId)throw new pe("UNAUTHORIZED");r=await e.context.internalAdapter.findUserById(e.body.userId)}if(!r)return e.json(null,{status:401});let o=e.context.orgOptions;if(!(typeof o?.allowUserToCreateOrganization=="function"?await o.allowUserToCreateOrganization(r):o?.allowUserToCreateOrganization===void 0?!0:o.allowUserToCreateOrganization))throw new pe("FORBIDDEN",{message:C.YOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_ORGANIZATION});let n=V(e.context,o),s=await n.listOrganizations(r.id);if(typeof o.organizationLimit=="number"?s.length>=o.organizationLimit:typeof o.organizationLimit=="function"?await o.organizationLimit(r):!1)throw new pe("FORBIDDEN",{message:C.YOU_HAVE_REACHED_THE_MAXIMUM_NUMBER_OF_ORGANIZATIONS});if(await n.findOrganizationBySlug(e.body.slug))throw new pe("BAD_REQUEST",{message:C.ORGANIZATION_ALREADY_EXISTS});let A=await n.createOrganization({organization:{id:J(),slug:e.body.slug,name:e.body.name,logo:e.body.logo,createdAt:new Date,metadata:e.body.metadata},user:r});return e.context.session&&await n.setActiveOrganization(e.context.session.session.token,A.id),e.json(A)}),Ji=K("/organization/update",{method:"POST",body:S.object({data:S.object({name:S.string({description:"The name of the organization"}).optional(),slug:S.string({description:"The slug of the organization"}).optional(),logo:S.string({description:"The logo of the organization"}).optional(),metadata:S.record(S.string(),S.any(),{description:"The metadata of the organization"}).optional()}).partial(),organizationId:S.string().optional()}),requireHeaders:!0,use:[$],metadata:{openapi:{description:"Update an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",description:"The updated organization",$ref:"#/components/schemas/Organization"}}}}}}}},async e=>{let i=await e.context.getSession(e);if(!i)throw new pe("UNAUTHORIZED",{message:"User not found"});let r=e.body.organizationId||i.session.activeOrganizationId;if(!r)return e.json(null,{status:400,body:{message:C.ORGANIZATION_NOT_FOUND}});let o=V(e.context,e.context.orgOptions),t=await o.findMemberByOrgId({userId:i.user.id,organizationId:r});if(!t)return e.json(null,{status:400,body:{message:C.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION}});let n=e.context.roles[t.role];if(!n)return e.json(null,{status:400,body:{message:"Role not found!"}});if(n.authorize({organization:["update"]}).error)return e.json(null,{body:{message:C.YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_ORGANIZATION},status:403});let a=await o.updateOrganization(r,e.body.data);return e.json(a)}),Xi=K("/organization/delete",{method:"POST",body:S.object({organizationId:S.string({description:"The organization id to delete"})}),requireHeaders:!0,use:[$],metadata:{openapi:{description:"Delete an organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"string",description:"The organization id that was deleted"}}}}}}}},async e=>{let i=await e.context.getSession(e);if(!i)return e.json(null,{status:401});let r=e.body.organizationId;if(!r)return e.json(null,{status:400,body:{message:C.ORGANIZATION_NOT_FOUND}});let o=V(e.context,e.context.orgOptions),t=await o.findMemberByOrgId({userId:i.user.id,organizationId:r});if(!t)return e.json(null,{status:400,body:{message:C.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION}});let n=e.context.roles[t.role];if(!n)return e.json(null,{status:400,body:{message:"Role not found!"}});if(n.authorize({organization:["delete"]}).error)throw new pe("FORBIDDEN",{message:C.YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_ORGANIZATION});return r===i.session.activeOrganizationId&&await o.setActiveOrganization(i.session.token,null),await o.deleteOrganization(r),e.json(r)}),Yi=K("/organization/get-full-organization",{method:"GET",query:S.optional(S.object({organizationId:S.string({description:"The organization id to get"}).optional(),organizationSlug:S.string({description:"The organization slug to get"}).optional()})),requireHeaders:!0,use:[$,Q],metadata:{openapi:{description:"Get the full organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",description:"The organization",$ref:"#/components/schemas/Organization"}}}}}}}},async e=>{let i=e.context.session,r=e.query?.organizationSlug||e.query?.organizationId||i.session.activeOrganizationId;if(!r)return e.json(null,{status:200});let t=await V(e.context,e.context.orgOptions).findFullOrganization({organizationId:r,isSlug:!!e.query?.organizationSlug});if(!t)throw new pe("BAD_REQUEST",{message:C.ORGANIZATION_NOT_FOUND});return e.json(t)}),et=K("/organization/set-active",{method:"POST",body:S.object({organizationId:S.string({description:"The organization id to set as active. It can be null to unset the active organization"}).nullable().optional(),organizationSlug:S.string({description:"The organization slug to set as active. It can be null to unset the active organization if organizationId is not provided"}).optional()}),use:[Q,$],metadata:{openapi:{description:"Set the active organization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",description:"The organization",$ref:"#/components/schemas/Organization"}}}}}}}},async e=>{let i=V(e.context,e.context.orgOptions),r=e.context.session,o=e.body.organizationSlug||e.body.organizationId;if(o===null){if(!r.session.activeOrganizationId)return e.json(null);let d=await i.setActiveOrganization(r.session.token,null);return await w(e,{session:d,user:r.user}),e.json(null)}if(!o){let a=r.session.activeOrganizationId;if(!a)return e.json(null);o=a}let t=await i.findFullOrganization({organizationId:o,isSlug:!!e.body.organizationSlug});if(!t?.members.find(a=>a.userId===r.user.id))throw await i.setActiveOrganization(r.session.token,null),new pe("FORBIDDEN",{message:C.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION});if(!t)throw new pe("BAD_REQUEST",{message:C.ORGANIZATION_NOT_FOUND});let s=await i.setActiveOrganization(r.session.token,t.id);return await w(e,{session:s,user:r.user}),e.json(t)}),ot=K("/organization/list",{method:"GET",use:[$,Q],metadata:{openapi:{description:"List all organizations",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{$ref:"#/components/schemas/Organization"}}}}}}}}},async e=>{let r=await V(e.context,e.context.orgOptions).listOrganizations(e.context.session.user.id);return e.json(r)});var Gr=oo({name:["action"]}),cp=Gr.newRole({name:["action"]}),Kp=e=>{let i={createOrganization:Wi,updateOrganization:Ji,deleteOrganization:Xi,setActiveOrganization:et,getFullOrganization:Yi,listOrganizations:ot,createInvitation:Fi(e),cancelInvitation:qi,acceptInvitation:Mi,getInvitation:Hi,rejectInvitation:Vi,addMember:$i(),removeMember:Zi,updateMemberRole:Qi(e),getActiveMember:Gi},r={...ji,...e?.roles};return{id:"organization",endpoints:{...Li(i,{orgOptions:e||{},roles:r,getSession:async t=>await R(t)}),hasPermission:K("/organization/has-permission",{method:"POST",requireHeaders:!0,body:Ue.object({organizationId:Ue.string().optional(),permission:Ue.record(Ue.string(),Ue.array(Ue.string()))}),use:[Q],metadata:{openapi:{description:"Check if the user has permission",requestBody:{content:{"application/json":{schema:{type:"object",properties:{permission:{type:"object",description:"The permission to check"}},required:["permission"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{error:{type:"string"},success:{type:"boolean"}},required:["success"]}}}}}}}},async t=>{let n=t.body.organizationId||t.context.session.session.activeOrganizationId;if(!n)throw new it("BAD_REQUEST",{message:C.NO_ACTIVE_ORGANIZATION});let a=await V(t.context).findMemberByOrgId({userId:t.context.session.user.id,organizationId:n});if(!a)throw new it("UNAUTHORIZED",{message:C.USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION});let A=r[a.role].authorize(t.body.permission);return A.error?t.json({error:A.error,success:!1},{status:403}):t.json({error:null,success:!0})})},schema:{session:{fields:{activeOrganizationId:{type:"string",required:!1,fieldName:e?.schema?.session?.fields?.activeOrganizationId}}},organization:{modelName:e?.schema?.organization?.modelName,fields:{name:{type:"string",required:!0,fieldName:e?.schema?.organization?.fields?.name},slug:{type:"string",unique:!0,fieldName:e?.schema?.organization?.fields?.slug},logo:{type:"string",required:!1,fieldName:e?.schema?.organization?.fields?.logo},createdAt:{type:"date",required:!0,fieldName:e?.schema?.organization?.fields?.createdAt},metadata:{type:"string",required:!1,fieldName:e?.schema?.organization?.fields?.metadata}}},member:{modelName:e?.schema?.member?.modelName,fields:{organizationId:{type:"string",required:!0,references:{model:"organization",field:"id"},fieldName:e?.schema?.member?.fields?.organizationId},userId:{type:"string",required:!0,fieldName:e?.schema?.member?.fields?.userId,references:{model:"user",field:"id"}},role:{type:"string",required:!0,defaultValue:"member",fieldName:e?.schema?.member?.fields?.role},createdAt:{type:"date",required:!0,fieldName:e?.schema?.member?.fields?.createdAt}}},invitation:{modelName:e?.schema?.invitation?.modelName,fields:{organizationId:{type:"string",required:!0,references:{model:"organization",field:"id"},fieldName:e?.schema?.invitation?.fields?.organizationId},email:{type:"string",required:!0,fieldName:e?.schema?.invitation?.fields?.email},role:{type:"string",required:!1,fieldName:e?.schema?.invitation?.fields?.role},status:{type:"string",required:!0,defaultValue:"pending",fieldName:e?.schema?.invitation?.fields?.status},expiresAt:{type:"date",required:!0,fieldName:e?.schema?.invitation?.fields?.expiresAt},inviterId:{type:"string",references:{model:"user",field:"id"},fieldName:e?.schema?.invitation?.fields?.inviterId,required:!0}}}},$Infer:{Organization:{},Invitation:{},Member:{},ActiveOrganization:{}},$ERROR_CODES:C}};import{z as no}from"zod";import{z as fe}from"zod";import{APIError as Fe}from"better-call";var io="two_factor";var to="trust_device";import{z as tt}from"zod";import{createHMAC as Wr}from"@better-auth/utils/hmac";import"@better-auth/utils/base64";var be=D({body:tt.object({trustDevice:tt.boolean().optional()})},async e=>{let i=await R(e);if(!i){let r=e.context.createAuthCookie(io),o=await e.getSignedCookie(r.name,e.context.secret);if(!o)throw new Fe("UNAUTHORIZED",{message:"invalid two factor cookie"});let t=await e.context.internalAdapter.findUserById(o);if(!t)throw new Fe("UNAUTHORIZED",{message:"invalid two factor cookie"});let n=await e.context.internalAdapter.createSession(o,e.request);if(!n)throw new Fe("INTERNAL_SERVER_ERROR",{message:"failed to create session"});return{valid:async()=>{if(await w(e,{session:n,user:t}),e.body.trustDevice){let s=e.context.createAuthCookie(to,{maxAge:2592e3}),a=await Wr("SHA-256","base64urlnopad").sign(e.context.secret,`${t.id}!${n.token}`);await e.setSignedCookie(s.name,`${a}!${n.token}`,e.context.secret,s.attributes)}return e.json({token:n.token})},invalid:async()=>{throw new Fe("UNAUTHORIZED",{message:"invalid two factor authentication"})},session:{session:n,user:t}}}return{valid:async()=>e.json({token:i.session.token}),invalid:async()=>{throw new Fe("UNAUTHORIZED",{message:"invalid two factor authentication"})},session:i}});import{APIError as Me}from"better-call";var G={OTP_NOT_ENABLED:"OTP not enabled",OTP_HAS_EXPIRED:"OTP has expired",TOTP_NOT_ENABLED:"TOTP not enabled",TWO_FACTOR_NOT_ENABLED:"Two factor isn't enabled",BACKUP_CODES_NOT_ENABLED:"Backup codes aren't enabled",INVALID_BACKUP_CODE:"Invalid backup code"};function Jr(e){return Array.from({length:e?.amount??10}).fill(null).map(()=>I(e?.length??10,"a-z","0-9","A-Z")).map(i=>`${i.slice(0,5)}-${i.slice(5)}`)}async function Io(e,i){let r=e,o=i?.customBackupCodesGenerate?i.customBackupCodesGenerate():Jr(),t=await de({data:JSON.stringify(o),key:r});return{backupCodes:o,encryptedBackupCodes:t}}async function Xr(e,i){let r=await rt(e.backupCodes,i);return r?{status:r.includes(e.code),updated:r.filter(o=>o!==e.code)}:{status:!1,updated:null}}async function rt(e,i){let r=Buffer.from(await ye({key:i,data:e})).toString("utf-8"),o=JSON.parse(r),t=fe.array(fe.string()).safeParse(o);return t.success?t.data:null}var nt=e=>{let i="twoFactor";return{id:"backup_code",endpoints:{verifyBackupCode:K("/two-factor/verify-backup-code",{method:"POST",body:fe.object({code:fe.string(),disableSession:fe.boolean().optional()}),use:[be]},async r=>{let o=r.context.session.user,t=await r.context.adapter.findOne({model:i,where:[{field:"userId",value:o.id}]});if(!t)throw new Me("BAD_REQUEST",{message:G.BACKUP_CODES_NOT_ENABLED});let n=await Xr({backupCodes:t.backupCodes,code:r.body.code},r.context.secret);if(!n.status)throw new Me("UNAUTHORIZED",{message:G.INVALID_BACKUP_CODE});let s=await de({key:r.context.secret,data:JSON.stringify(n.updated)});return await r.context.adapter.updateMany({model:i,update:{backupCodes:s},where:[{field:"userId",value:o.id}]}),r.body.disableSession||await w(r,{session:r.context.session.session,user:o}),r.json({user:o,session:r.context.session})}),generateBackupCodes:K("/two-factor/generate-backup-codes",{method:"POST",body:fe.object({password:fe.string()}),use:[E]},async r=>{let o=r.context.session.user;if(!o.twoFactorEnabled)throw new Me("BAD_REQUEST",{message:G.TWO_FACTOR_NOT_ENABLED});await r.context.password.checkPassword(o.id,r);let t=await Io(r.context.secret,e);return await r.context.adapter.update({model:i,update:{backupCodes:t.encryptedBackupCodes},where:[{field:"userId",value:r.context.session.user.id}]}),r.json({status:!0,backupCodes:t.backupCodes})}),viewBackupCodes:K("/two-factor/view-backup-codes",{method:"GET",body:fe.object({userId:fe.string()}),metadata:{SERVER_ONLY:!0}},async r=>{let o=await r.context.adapter.findOne({model:i,where:[{field:"userId",value:r.body.userId}]});if(!o)throw new Me("BAD_REQUEST",{message:"Backup codes aren't enabled"});let t=await rt(o.backupCodes,r.context.secret);if(!t)throw new Me("BAD_REQUEST",{message:G.BACKUP_CODES_NOT_ENABLED});return r.json({status:!0,backupCodes:t})})}}};import{APIError as Ve}from"better-call";import{z as st}from"zod";var at=e=>{let i={...e,digits:e?.digits||6,period:(e?.period||3)*60*1e3},r="twoFactor",o=K("/two-factor/send-otp",{method:"POST",use:[be],metadata:{openapi:{summary:"Send two factor OTP",description:"Send two factor OTP to the user",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async n=>{if(!e||!e.sendOTP)throw n.context.logger.error("send otp isn't configured. Please configure the send otp function on otp options."),new Ve("BAD_REQUEST",{message:"otp isn't configured"});let s=n.context.session.user;if(!await n.context.adapter.findOne({model:r,where:[{field:"userId",value:s.id}]}))throw new Ve("BAD_REQUEST",{message:G.OTP_NOT_ENABLED});let d=I(i.digits,"0-9");return await n.context.internalAdapter.createVerificationValue({value:d,identifier:`2fa-otp-${s.id}`,expiresAt:new Date(Date.now()+i.period)}),await e.sendOTP({user:s,otp:d},n.request),n.json({status:!0})}),t=K("/two-factor/verify-otp",{method:"POST",body:st.object({code:st.string({description:"The otp code to verify"})}),use:[be],metadata:{openapi:{summary:"Verify two factor OTP",description:"Verify two factor OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async n=>{let s=n.context.session.user;if(!s.twoFactorEnabled)throw new Ve("BAD_REQUEST",{message:"two factor isn't enabled"});if(!await n.context.adapter.findOne({model:r,where:[{field:"userId",value:s.id}]}))throw new Ve("BAD_REQUEST",{message:G.OTP_NOT_ENABLED});let d=await n.context.internalAdapter.findVerificationValue(`2fa-otp-${s.id}`);if(!d||d.expiresAt<new Date)throw new Ve("BAD_REQUEST",{message:G.OTP_HAS_EXPIRED});return d.value===n.body.code?n.context.valid():n.context.invalid()});return{id:"otp",endpoints:{sendTwoFactorOTP:o,verifyTwoFactorOTP:t}}};import{APIError as Se}from"better-call";import{z as ro}from"zod";import{createOTP as Ro}from"@better-auth/utils/otp";var dt=e=>{let i={...e,digits:e?.digits||6,period:e?.period||30},r="twoFactor",o=K("/totp/generate",{method:"POST",use:[E],metadata:{openapi:{summary:"Generate TOTP code",description:"Use this endpoint to generate a TOTP code",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{code:{type:"string"}}}}}}}}}},async s=>{if(e?.disable)throw s.context.logger.error("totp isn't configured. please pass totp option on two factor plugin to enable totp"),new Se("BAD_REQUEST",{message:"totp isn't configured"});let a=s.context.session.user,d=await s.context.adapter.findOne({model:r,where:[{field:"userId",value:a.id}]});if(!d)throw new Se("BAD_REQUEST",{message:G.TOTP_NOT_ENABLED});return{code:await Ro(d.secret,{period:i.period,digits:i.digits}).totp()}}),t=K("/two-factor/get-totp-uri",{method:"POST",use:[E],body:ro.object({password:ro.string({description:"User password"})}),metadata:{openapi:{summary:"Get TOTP URI",description:"Use this endpoint to get the TOTP URI",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{totpURI:{type:"string"}}}}}}}}}},async s=>{if(e?.disable)throw s.context.logger.error("totp isn't configured. please pass totp option on two factor plugin to enable totp"),new Se("BAD_REQUEST",{message:"totp isn't configured"});let a=s.context.session.user,d=await s.context.adapter.findOne({model:r,where:[{field:"userId",value:a.id}]});if(!d||!a.twoFactorEnabled)throw new Se("BAD_REQUEST",{message:G.TOTP_NOT_ENABLED});return await s.context.password.checkPassword(a.id,s),{totpURI:Ro(d.secret,{digits:i.digits,period:i.period}).url(e?.issuer||s.context.appName,a.email)}}),n=K("/two-factor/verify-totp",{method:"POST",body:ro.object({code:ro.string({description:"The otp code to verify"})}),use:[be],metadata:{openapi:{summary:"Verify two factor TOTP",description:"Verify two factor TOTP",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async s=>{if(e?.disable)throw s.context.logger.error("totp isn't configured. please pass totp option on two factor plugin to enable totp"),new Se("BAD_REQUEST",{message:"totp isn't configured"});let a=s.context.session.user,d=await s.context.adapter.findOne({model:r,where:[{field:"userId",value:a.id}]});if(!d)throw new Se("BAD_REQUEST",{message:G.TOTP_NOT_ENABLED});let A=await ye({key:s.context.secret,data:d.secret});if(!await Ro(A,{period:i.period,digits:i.digits}).verify(s.body.code))return s.context.invalid();if(!a.twoFactorEnabled){let l=await s.context.internalAdapter.updateUser(a.id,{twoFactorEnabled:!0}),p=await s.context.internalAdapter.createSession(a.id,s.request,!1,s.context.session.session).catch(u=>{throw console.log(u),u});await s.context.internalAdapter.deleteSession(s.context.session.session.token),await w(s,{session:p,user:l})}return s.context.valid()});return{id:"totp",endpoints:{generateTOTP:o,getTOTPURI:t,verifyTOTP:n}}};import{APIError as ou}from"better-call";async function _o(e,i){let o=(await e.context.internalAdapter.findAccounts(i.userId))?.find(s=>s.providerId==="credential"),t=o?.password;return!o||!t?!1:await e.context.password.verify({hash:t,password:i.password})}import{APIError as ct}from"better-call";var At={user:{fields:{twoFactorEnabled:{type:"boolean",required:!1,defaultValue:!1,input:!1}}},twoFactor:{fields:{secret:{type:"string",required:!0,returned:!1},backupCodes:{type:"string",required:!0,returned:!1},userId:{type:"string",required:!0,returned:!1,references:{model:"user",field:"id"}}}}};import{createOTP as Yr}from"@better-auth/utils/otp";import"@better-auth/utils/base64";import{createHMAC as Kt}from"@better-auth/utils/hmac";var ru=e=>({id:"two-factor",$InferServerPlugin:{},atomListeners:[{matcher:i=>i.startsWith("/two-factor/"),signal:"$sessionSignal"}],pathMethods:{"/two-factor/disable":"POST","/two-factor/enable":"POST","/two-factor/send-otp":"POST","/two-factor/generate-backup-codes":"POST"},fetchPlugins:[{id:"two-factor",name:"two-factor",hooks:{async onSuccess(i){i.data?.twoFactorRedirect&&e?.onTwoFactorRedirect&&await e.onTwoFactorRedirect()}}}]});var Eu=e=>{let i={twoFactorTable:"twoFactor"},r=dt(e?.totpOptions),o=nt(e?.backupCodeOptions),t=at(e?.otpOptions);return{id:"two-factor",endpoints:{...r.endpoints,...t.endpoints,...o.endpoints,enableTwoFactor:K("/two-factor/enable",{method:"POST",body:no.object({password:no.string({description:"User password"}).min(8)}),use:[E],metadata:{openapi:{summary:"Enable two factor authentication",description:"Use this endpoint to enable two factor authentication. This will generate a TOTP URI and backup codes. Once the user verifies the TOTP URI, the two factor authentication will be enabled.",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{totpURI:{type:"string",description:"TOTP URI"},backupCodes:{type:"array",items:{type:"string"},description:"Backup codes"}}}}}}}}}},async n=>{let s=n.context.session.user,{password:a}=n.body;if(!await _o(n,{password:a,userId:s.id}))throw new ct("BAD_REQUEST",{message:f.INVALID_PASSWORD});let A=I(32),c=await de({key:n.context.secret,data:A}),l=await Io(n.context.secret,e?.backupCodeOptions);if(e?.skipVerificationOnEnable){let u=await n.context.internalAdapter.updateUser(s.id,{twoFactorEnabled:!0}),y=await n.context.internalAdapter.createSession(u.id,n.request,!1,n.context.session.session);await w(n,{session:y,user:s}),await n.context.internalAdapter.deleteSession(n.context.session.session.token)}await n.context.adapter.deleteMany({model:i.twoFactorTable,where:[{field:"userId",value:s.id}]}),await n.context.adapter.create({model:i.twoFactorTable,data:{secret:c,backupCodes:l.encryptedBackupCodes,userId:s.id}});let p=Yr(A,{digits:e?.totpOptions?.digits||6,period:e?.totpOptions?.period}).url(e?.issuer||"Better Auth",s.email);return n.json({totpURI:p,backupCodes:l.backupCodes})}),disableTwoFactor:K("/two-factor/disable",{method:"POST",body:no.object({password:no.string({description:"User password"}).min(8)}),use:[E],metadata:{openapi:{summary:"Disable two factor authentication",description:"Use this endpoint to disable two factor authentication.",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async n=>{let s=n.context.session.user,{password:a}=n.body;if(!await _o(n,{password:a,userId:s.id}))throw new ct("BAD_REQUEST",{message:"Invalid password"});await n.context.internalAdapter.updateUser(s.id,{twoFactorEnabled:!1}),await n.context.adapter.delete({model:i.twoFactorTable,where:[{field:"userId",value:s.id}]});let A=await n.context.internalAdapter.createSession(s.id,n.request,!1,n.context.session.session);return await w(n,{session:A,user:s}),await n.context.internalAdapter.deleteSession(n.context.session.session.token),n.json({status:!0})})},options:e,hooks:{after:[{matcher(n){return n.path==="/sign-in/email"||n.path==="/sign-in/username"||n.path==="/sign-in/phone-number"},handler:D(async n=>{let s=n.context.newSession;if(!s||!s?.user.twoFactorEnabled)return;let a=n.context.createAuthCookie(to),d=await n.getSignedCookie(a.name,n.context.secret);if(d){let[c,l]=d.split("!"),p=await Kt("SHA-256","base64urlnopad").sign(n.context.secret,`${s.user.id}!${l}`);if(c===p){let u=await Kt("SHA-256","base64urlnopad").sign(n.context.secret,`${s.user.id}!${l}`);await n.setSignedCookie(a.name,`${u}!${s.session.token}`,n.context.secret,a.attributes);return}}H(n),await n.context.internalAdapter.deleteSession(s.session.token);let A=n.context.createAuthCookie(io,{maxAge:60*10});return await n.setSignedCookie(A.name,s.user.id,n.context.secret,A.attributes),n.json({twoFactorRedirect:!0})})}]},schema:Ke(At,e?.schema),rateLimit:[{pathMatcher(n){return n.startsWith("/two-factor/")},window:10,max:3}]}};import{z as so}from"zod";import{APIError as ve}from"better-call";var pt=()=>{let e={INVALID_USERNAME_OR_PASSWORD:"invalid username or password",EMAIL_NOT_VERIFIED:"email not verified",UNEXPECTED_ERROR:"unexpected error",USERNAME_IS_ALREADY_TAKEN:"username is already taken. please try another."};return{id:"username",endpoints:{signInUsername:K("/sign-in/username",{method:"POST",body:so.object({username:so.string({description:"The username of the user"}),password:so.string({description:"The password of the user"}),rememberMe:so.boolean({description:"Remember the user session"}).optional()}),metadata:{openapi:{summary:"Sign in with username",description:"Sign in with username",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"},session:{$ref:"#/components/schemas/Session"}}}}}}}}}},async i=>{let r=await i.context.adapter.findOne({model:"user",where:[{field:"username",value:i.body.username.toLowerCase()}]});if(!r)throw await i.context.password.hash(i.body.password),i.context.logger.error("User not found",{username:pt}),new ve("UNAUTHORIZED",{message:e.INVALID_USERNAME_OR_PASSWORD});if(!r.emailVerified&&i.context.options.emailAndPassword?.requireEmailVerification)throw await wo(i,r),new ve("UNAUTHORIZED",{message:e.INVALID_USERNAME_OR_PASSWORD});let o=await i.context.adapter.findOne({model:"account",where:[{field:"userId",value:r.id},{field:"providerId",value:"credential"}]});if(!o)throw new ve("UNAUTHORIZED",{message:e.INVALID_USERNAME_OR_PASSWORD});let t=o?.password;if(!t)throw i.context.logger.error("Password not found",{username:pt}),new ve("UNAUTHORIZED",{message:e.INVALID_USERNAME_OR_PASSWORD});if(!await i.context.password.verify({hash:t,password:i.body.password}))throw i.context.logger.error("Invalid password"),new ve("UNAUTHORIZED",{message:e.INVALID_USERNAME_OR_PASSWORD});let s=await i.context.internalAdapter.createSession(r.id,i.request,i.body.rememberMe===!1);return s?(await w(i,{session:s,user:r},i.body.rememberMe===!1),i.json({token:s.token})):i.json(null,{status:500,body:{message:f.FAILED_TO_CREATE_SESSION,status:500}})})},schema:{user:{fields:{username:{type:"string",required:!1,unique:!0,returned:!0,transform:{input(i){return i?.toString().toLowerCase()}}}}}},hooks:{before:[{matcher(i){return i.path==="/sign-up/email"},async handler(i){let r=i.body.username;if(r&&await i.context.adapter.findOne({model:"user",where:[{field:"username",value:r.toLowerCase()}]}))throw new ve("UNPROCESSABLE_ENTITY",{message:e.USERNAME_IS_ALREADY_TAKEN})}}]},$ERROR_CODES:G}};import{serializeSigned as en}from"better-call";import{createHMAC as on}from"@better-auth/utils/hmac";var Fu=e=>({id:"bearer",hooks:{before:[{matcher(i){return!!(i.request?.headers.get("authorization")||i.headers?.get("authorization"))},handler:async i=>{let r=i.request?.headers.get("authorization")?.replace("Bearer ","")||i.headers?.get("authorization")?.replace("Bearer ","");if(!r)return;let o="";if(r.includes("."))o=r.replace("=","");else{if(e?.requireSignature)return;o=(await en("",r,i.context.secret)).replace("=","")}try{let t=decodeURIComponent(o);if(!await on("SHA-256","base64urlnopad").verify(i.context.secret,t.split(".")[0],t.split(".")[1]))return}catch{return}return i.request&&i.request.headers.append("cookie",`${i.context.authCookies.sessionToken.name}=${o}`),i.headers&&i.headers.append("cookie",`${i.context.authCookies.sessionToken.name}=${o}`),{context:i}}}],after:[{matcher(i){return!!i.responseHeader.get("set-cookie")},handler:D(async i=>{let r=i.responseHeader.get("set-cookie");if(!r)return;let o=he(r),t=i.context.authCookies.sessionToken.name,n=o.get(t);if(!n||!n.value||n["max-age"]===0)return;let s=n.value;return i.responseHeader.set("set-auth-token",s),{responseHeader:i.responseHeader}})}]}});import{z as ke}from"zod";import{APIError as tn}from"better-call";var Gu=e=>({id:"magic-link",endpoints:{signInMagicLink:K("/sign-in/magic-link",{method:"POST",requireHeaders:!0,body:ke.object({email:ke.string({description:"Email address to send the magic link"}).email(),callbackURL:ke.string({description:"URL to redirect after magic link verification"}).optional()}),metadata:{openapi:{description:"Sign in with magic link",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async i=>{let{email:r}=i.body;if(e.disableSignUp&&!await i.context.internalAdapter.findUserByEmail(r))throw new tn("BAD_REQUEST",{message:f.USER_NOT_FOUND});let o=I(32,"a-z","A-Z");await i.context.internalAdapter.createVerificationValue({identifier:o,value:r,expiresAt:new Date(Date.now()+(e.expiresIn||60*5)*1e3)});let t=`${i.context.baseURL}/magic-link/verify?token=${o}&callbackURL=${i.body.callbackURL||"/"}`;return await e.sendMagicLink({email:r,url:t,token:o},i.request),i.json({status:!0})}),magicLinkVerify:K("/magic-link/verify",{method:"GET",query:ke.object({token:ke.string({description:"Verification token"}),callbackURL:ke.string({description:"URL to redirect after magic link verification, if not provided will return session"}).optional()}),requireHeaders:!0,metadata:{openapi:{description:"Verify magic link",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"},user:{$ref:"#/components/schemas/User"}}}}}}}}}},async i=>{let{token:r,callbackURL:o}=i.query,t=o?.startsWith("http")?o:o?`${i.context.options.baseURL}${o}`:i.context.options.baseURL,n=await i.context.internalAdapter.findVerificationValue(r);if(!n)throw i.redirect(`${t}?error=INVALID_TOKEN`);if(n.expiresAt<new Date)throw await i.context.internalAdapter.deleteVerificationValue(n.id),i.redirect(`${t}?error=EXPIRED_TOKEN`);await i.context.internalAdapter.deleteVerificationValue(n.id);let s=n.value,a=await i.context.internalAdapter.findUserByEmail(s),d=a?.user.id||"";if(!a){if(e.disableSignUp)throw i.redirect(`${t}?error=failed_to_create_user`);if(d=(await i.context.internalAdapter.createUser({email:s,emailVerified:!0,name:s})).id,!d)throw i.redirect(`${t}?error=failed_to_create_user`)}let A=await i.context.internalAdapter.createSession(d,i.headers);if(!A)throw i.redirect(`${t}?error=failed_to_create_session`);if(await w(i,{session:A,user:a?.user}),!o)return i.json({token:A.token});throw i.redirect(o)})},rateLimit:[{pathMatcher(i){return i.startsWith("/sign-in/magic-link")||i.startsWith("/magic-link/verify")},window:e.rateLimit?.window||60,max:e.rateLimit?.max||5}]});import{z as se}from"zod";import{APIError as W}from"better-call";function rn(e){return I(e,"0-9")}var sl=e=>{let i={expiresIn:e?.expiresIn||300,otpLength:e?.otpLength||6,...e,phoneNumber:"phoneNumber",phoneNumberVerified:"phoneNumberVerified",code:"code",createdAt:"createdAt"},r={INVALID_PHONE_NUMBER:"Invalid phone number",INVALID_PHONE_NUMBER_OR_PASSWORD:"Invalid phone number or password",UNEXPECTED_ERROR:"Unexpected error",OTP_NOT_FOUND:"OTP not found"};return{id:"phone-number",endpoints:{signInPhoneNumber:K("/sign-in/phone-number",{method:"POST",body:se.object({phoneNumber:se.string({description:"Phone number to sign in"}),password:se.string({description:"Password to use for sign in"}),rememberMe:se.boolean({description:"Remember the session"}).optional()}),metadata:{openapi:{summary:"Sign in with phone number",description:"Use this endpoint to sign in with phone number",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"},session:{$ref:"#/components/schemas/Session"}}}}}},400:{description:"Invalid phone number or password"}}}}},async o=>{let{password:t,phoneNumber:n}=o.body;if(i.phoneNumberValidator&&!await i.phoneNumberValidator(o.body.phoneNumber))throw new W("BAD_REQUEST",{message:r.INVALID_PHONE_NUMBER});let s=await o.context.adapter.findOne({model:"user",where:[{field:"phoneNumber",value:n}]});if(!s)throw new W("UNAUTHORIZED",{message:r.INVALID_PHONE_NUMBER_OR_PASSWORD});let d=(await o.context.internalAdapter.findAccountByUserId(s.id)).find(p=>p.providerId==="credential");if(!d)throw o.context.logger.error("Credential account not found",{phoneNumber:n}),new W("UNAUTHORIZED",{message:r.INVALID_PHONE_NUMBER_OR_PASSWORD});let A=d?.password;if(!A)throw o.context.logger.error("Password not found",{phoneNumber:n}),new W("UNAUTHORIZED",{message:r.UNEXPECTED_ERROR});if(!await o.context.password.verify({hash:A,password:t}))throw o.context.logger.error("Invalid password"),new W("UNAUTHORIZED",{message:r.INVALID_PHONE_NUMBER_OR_PASSWORD});let l=await o.context.internalAdapter.createSession(s.id,o.headers,o.body.rememberMe===!1);if(!l)throw o.context.logger.error("Failed to create session"),new W("UNAUTHORIZED",{message:f.FAILED_TO_CREATE_SESSION});return await w(o,{session:l,user:s},o.body.rememberMe===!1),o.json({token:l.token})}),sendPhoneNumberOTP:K("/phone-number/send-otp",{method:"POST",body:se.object({phoneNumber:se.string({description:"Phone number to send OTP"})}),metadata:{openapi:{summary:"Send OTP to phone number",description:"Use this endpoint to send OTP to phone number",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}}}}}}},async o=>{if(!e?.sendOTP)throw o.context.logger.warn("sendOTP not implemented"),new W("NOT_IMPLEMENTED",{message:"sendOTP not implemented"});if(i.phoneNumberValidator&&!await i.phoneNumberValidator(o.body.phoneNumber))throw new W("BAD_REQUEST",{message:r.INVALID_PHONE_NUMBER});let t=rn(i.otpLength);return await o.context.internalAdapter.createVerificationValue({value:t,identifier:o.body.phoneNumber,expiresAt:P(i.expiresIn,"sec")}),await e.sendOTP({phoneNumber:o.body.phoneNumber,code:t},o.request),o.json({code:t},{body:{message:"Code sent"}})}),verifyPhoneNumber:K("/phone-number/verify",{method:"POST",body:se.object({phoneNumber:se.string({description:"Phone number to verify"}),code:se.string({description:"OTP code"}),disableSession:se.boolean({description:"Disable session creation after verification"}).optional(),updatePhoneNumber:se.boolean({description:"Check if there is a session and update the phone number"}).optional()}),metadata:{openapi:{summary:"Verify phone number",description:"Use this endpoint to verify phone number",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"},session:{$ref:"#/components/schemas/Session"}}}}}},400:{description:"Invalid OTP"}}}}},async o=>{let t=await o.context.internalAdapter.findVerificationValue(o.body.phoneNumber);if(!t||t.expiresAt<new Date)throw t&&t.expiresAt<new Date?(await o.context.internalAdapter.deleteVerificationValue(t.id),new W("BAD_REQUEST",{message:"OTP expired"})):new W("BAD_REQUEST",{message:r.OTP_NOT_FOUND});if(t.value!==o.body.code)throw new W("BAD_REQUEST",{message:"Invalid OTP"});if(await o.context.internalAdapter.deleteVerificationValue(t.id),o.body.updatePhoneNumber){let s=await R(o);if(!s)throw new W("UNAUTHORIZED",{message:f.USER_NOT_FOUND});return await o.context.internalAdapter.updateUser(s.user.id,{[i.phoneNumber]:o.body.phoneNumber,[i.phoneNumberVerified]:!0}),o.json({token:s.session.token,status:!0})}let n=await o.context.adapter.findOne({model:"user",where:[{value:o.body.phoneNumber,field:i.phoneNumber}]});if(await e?.callbackOnVerification?.({phoneNumber:o.body.phoneNumber,user:n},o.request),n)n=await o.context.internalAdapter.updateUser(n.id,{[i.phoneNumberVerified]:!0});else if(e?.signUpOnVerification){if(n=await o.context.internalAdapter.createUser({email:e.signUpOnVerification.getTempEmail(o.body.phoneNumber),name:e.signUpOnVerification.getTempName?e.signUpOnVerification.getTempName(o.body.phoneNumber):o.body.phoneNumber,[i.phoneNumber]:o.body.phoneNumber,[i.phoneNumberVerified]:!0}),!n)throw new W("INTERNAL_SERVER_ERROR",{message:f.FAILED_TO_CREATE_USER})}else return o.json(null);if(!n)throw new W("INTERNAL_SERVER_ERROR",{message:f.FAILED_TO_UPDATE_USER});if(!o.body.disableSession){let s=await o.context.internalAdapter.createSession(n.id,o.request);if(!s)throw new W("INTERNAL_SERVER_ERROR",{message:f.FAILED_TO_CREATE_SESSION});return await w(o,{session:s,user:n}),o.json({token:s.token,status:!0})}return o.json({token:null,status:!0})})},schema:Ke(nn,e?.schema),$ERROR_CODES:r}},nn={user:{fields:{phoneNumber:{type:"string",required:!1,unique:!0,returned:!0},phoneNumberVerified:{type:"boolean",required:!1,returned:!0,input:!1}}}};var sn={user:{fields:{isAnonymous:{type:"boolean",required:!1}}}},pl=e=>{let i={FAILED_TO_CREATE_USER:"Failed to create user",COULD_NOT_CREATE_SESSION:"Could not create session",ANONYMOUS_USERS_CANNOT_SIGN_IN_AGAIN_ANONYMOUSLY:"Anonymous users cannot sign in again anonymously"};return{id:"anonymous",endpoints:{signInAnonymous:K("/sign-in/anonymous",{method:"POST",metadata:{openapi:{description:"Sign in anonymously",responses:{200:{description:"Sign in anonymously",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"},session:{$ref:"#/components/schemas/Session"}}}}}}}}}},async r=>{let{emailDomainName:o=Oe(r.context.baseURL)}=e||{},t=r.context.generateId({model:"user"}),n=`temp-${t}@${o}`,s=await r.context.internalAdapter.createUser({id:t,email:n,emailVerified:!1,isAnonymous:!0,name:"Anonymous",createdAt:new Date,updatedAt:new Date});if(!s)return r.json(null,{status:500,body:{message:i.FAILED_TO_CREATE_USER,status:500}});let a=await r.context.internalAdapter.createSession(s.id,r.request);return a?(await w(r,{session:a,user:s}),r.json({token:a.token})):r.json(null,{status:400,body:{message:i.COULD_NOT_CREATE_SESSION}})})},hooks:{after:[{matcher(r){return!!r.responseHeader.get("set-cookie")?.includes(r.context.authCookies.sessionToken.name)},handler:D(async r=>{let t=r.responseHeader.get("set-cookie"),n=r.context.authCookies.sessionToken.name;if(!he(t||"").get(n)?.value.split(".")[0])return;let a=await R(r,{disableRefresh:!0});if(!a||!a.user.isAnonymous)return;if(r.path==="/sign-in/anonymous")throw new m("BAD_REQUEST",{message:i.ANONYMOUS_USERS_CANNOT_SIGN_IN_AGAIN_ANONYMOUSLY});let d=r.context.newSession;d&&(e?.onLinkAccount&&await e?.onLinkAccount?.({anonymousUser:a,newUser:d}),e?.disableDeleteAnonymousUser||await r.context.internalAdapter.deleteUser(a.user.id))})}]},schema:Ke(sn,e?.schema),$ERROR_CODES:i}};import{z as b}from"zod";import{APIError as an}from"better-call";var ut=async e=>{let i=e.context.returned;return i?i instanceof Response?i.status!==200?null:await i.clone().json():i instanceof an?null:i:null};var Il=e=>{let i={defaultRole:"user",adminRole:"admin",...e},r={FAILED_TO_CREATE_USER:"Failed to create user",USER_ALREADY_EXISTS:"User already exists",USER_NOT_FOUND:"User not found",YOU_CANNOT_BAN_YOURSELF:"You cannot ban yourself",ONLY_ADMINS_CAN_ACCESS_THIS_ENDPOINT:"Only admins can access this endpoint"},o=D(async t=>{let n=await R(t);if(!n?.session)throw new m("UNAUTHORIZED");let s=n.user;if(!s.role||(Array.isArray(i.adminRole)?!i.adminRole.includes(s.role):s.role!==i.adminRole))throw new m("FORBIDDEN",{message:"Only admins can access this endpoint"});return{session:{user:s,session:n.session}}});return{id:"admin",init(t){return{options:{databaseHooks:{user:{create:{async before(n){if(e?.defaultRole!==!1)return{data:{role:e?.defaultRole??"user",...n}}}}},session:{create:{async before(n){let s=await t.internalAdapter.findUserById(n.userId);if(s.banned){if(s.banExpires&&s.banExpires.getTime()<Date.now()){await t.internalAdapter.updateUser(n.userId,{banned:!1,banReason:null,banExpires:null});return}return!1}}}}}}}},hooks:{after:[{matcher(t){return t.path==="/list-sessions"},handler:D(async t=>{let n=await ut(t);if(!n)return;let s=n.filter(a=>!a.impersonatedBy);return t.json(s)})}]},endpoints:{setRole:K("/admin/set-role",{method:"POST",body:b.object({userId:b.string({description:"The user id"}),role:b.string({description:"The role to set. `admin` or `user` by default"})}),use:[o],metadata:{openapi:{operationId:"setRole",summary:"Set the role of a user",description:"Set the role of a user",responses:{200:{description:"User role updated",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async t=>{let n=await t.context.internalAdapter.updateUser(t.body.userId,{role:t.body.role});return t.json({user:n})}),createUser:K("/admin/create-user",{method:"POST",body:b.object({email:b.string({description:"The email of the user"}),password:b.string({description:"The password of the user"}),name:b.string({description:"The name of the user"}),role:b.string({description:"The role of the user"}),data:b.optional(b.record(b.any(),{description:"Extra fields for the user. Including custom additional fields."}))}),use:[o],metadata:{openapi:{operationId:"createUser",summary:"Create a new user",description:"Create a new user",responses:{200:{description:"User created",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async t=>{if(await t.context.internalAdapter.findUserByEmail(t.body.email))throw new m("BAD_REQUEST",{message:r.USER_ALREADY_EXISTS});let s=await t.context.internalAdapter.createUser({email:t.body.email,name:t.body.name,role:t.body.role,...t.body.data});if(!s)throw new m("INTERNAL_SERVER_ERROR",{message:r.FAILED_TO_CREATE_USER});let a=await t.context.password.hash(t.body.password);return await t.context.internalAdapter.linkAccount({accountId:s.id,providerId:"credential",password:a,userId:s.id}),t.json({user:s})}),listUsers:K("/admin/list-users",{method:"GET",use:[o],query:b.object({searchValue:b.string({description:"The value to search for"}).optional(),searchField:b.enum(["email","name"],{description:"The field to search in, defaults to email. Can be `email` or `name`"}).optional(),searchOperator:b.enum(["contains","starts_with","ends_with"],{description:"The operator to use for the search. Can be `contains`, `starts_with` or `ends_with`"}).optional(),limit:b.string({description:"The number of users to return"}).or(b.number()).optional(),offset:b.string({description:"The offset to start from"}).or(b.number()).optional(),sortBy:b.string({description:"The field to sort by"}).optional(),sortDirection:b.enum(["asc","desc"],{description:"The direction to sort by"}).optional(),filterField:b.string({description:"The field to filter by"}).optional(),filterValue:b.string({description:"The value to filter by"}).or(b.number()).or(b.boolean()).optional(),filterOperator:b.enum(["eq","ne","lt","lte","gt","gte"],{description:"The operator to use for the filter"}).optional()}),metadata:{openapi:{operationId:"listUsers",summary:"List users",description:"List users",responses:{200:{description:"List of users",content:{"application/json":{schema:{type:"object",properties:{users:{type:"array",items:{$ref:"#/components/schemas/User"}}}}}}}}}}},async t=>{let n=[];t.query?.searchValue&&n.push({field:t.query.searchField||"email",operator:t.query.searchOperator||"contains",value:t.query.searchValue}),t.query?.filterValue&&n.push({field:t.query.filterField||"email",operator:t.query.filterOperator||"eq",value:t.query.filterValue});try{let s=await t.context.internalAdapter.listUsers(Number(t.query?.limit)||void 0,Number(t.query?.offset)||void 0,t.query?.sortBy?{field:t.query.sortBy,direction:t.query.sortDirection||"asc"}:void 0,n.length?n:void 0);return t.json({users:s})}catch(s){return console.log(s),t.json({users:[]})}}),listUserSessions:K("/admin/list-user-sessions",{method:"POST",use:[o],body:b.object({userId:b.string({description:"The user id"})}),metadata:{openapi:{operationId:"listUserSessions",summary:"List user sessions",description:"List user sessions",responses:{200:{description:"List of user sessions",content:{"application/json":{schema:{type:"object",properties:{sessions:{type:"array",items:{$ref:"#/components/schemas/Session"}}}}}}}}}}},async t=>({sessions:await t.context.internalAdapter.listSessions(t.body.userId)})),unbanUser:K("/admin/unban-user",{method:"POST",body:b.object({userId:b.string({description:"The user id"})}),use:[o],metadata:{openapi:{operationId:"unbanUser",summary:"Unban a user",description:"Unban a user",responses:{200:{description:"User unbanned",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async t=>{let n=await t.context.internalAdapter.updateUser(t.body.userId,{banned:!1});return t.json({user:n})}),banUser:K("/admin/ban-user",{method:"POST",body:b.object({userId:b.string({description:"The user id"}),banReason:b.string({description:"The reason for the ban"}).optional(),banExpiresIn:b.number({description:"The number of seconds until the ban expires"}).optional()}),use:[o],metadata:{openapi:{operationId:"banUser",summary:"Ban a user",description:"Ban a user",responses:{200:{description:"User banned",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async t=>{if(t.body.userId===t.context.session.user.id)throw new m("BAD_REQUEST",{message:r.YOU_CANNOT_BAN_YOURSELF});let n=await t.context.internalAdapter.updateUser(t.body.userId,{banned:!0,banReason:t.body.banReason||e?.defaultBanReason||"No reason",banExpires:t.body.banExpiresIn?P(t.body.banExpiresIn,"sec"):e?.defaultBanExpiresIn?P(e.defaultBanExpiresIn,"sec"):void 0});return await t.context.internalAdapter.deleteSessions(t.body.userId),t.json({user:n})}),impersonateUser:K("/admin/impersonate-user",{method:"POST",body:b.object({userId:b.string({description:"The user id"})}),use:[o],metadata:{openapi:{operationId:"impersonateUser",summary:"Impersonate a user",description:"Impersonate a user",responses:{200:{description:"Impersonation session created",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"},user:{$ref:"#/components/schemas/User"}}}}}}}}}},async t=>{let n=await t.context.internalAdapter.findUserById(t.body.userId);if(!n)throw new m("NOT_FOUND",{message:"User not found"});let s=await t.context.internalAdapter.createSession(n.id,void 0,!0,{impersonatedBy:t.context.session.user.id,expiresAt:e?.impersonationSessionDuration?P(e.impersonationSessionDuration,"sec"):P(60*60,"sec")});if(!s)throw new m("INTERNAL_SERVER_ERROR",{message:r.FAILED_TO_CREATE_USER});let a=t.context.authCookies;return H(t),await t.setSignedCookie("admin_session",t.context.session.session.token,t.context.secret,a.sessionToken.options),await w(t,{session:s,user:n},!0),t.json({session:s,user:n})}),stopImpersonating:K("/admin/stop-impersonating",{method:"POST"},async t=>{let n=await R(t);if(!n)throw new m("UNAUTHORIZED");if(!n.session.impersonatedBy)throw new m("BAD_REQUEST",{message:"You are not impersonating anyone"});let s=await t.context.internalAdapter.findUserById(n.session.impersonatedBy);if(!s)throw new m("INTERNAL_SERVER_ERROR",{message:"Failed to find user"});let a=await t.getSignedCookie("admin_session",t.context.secret);if(!a)throw new m("INTERNAL_SERVER_ERROR",{message:"Failed to find admin session"});let d=await t.context.internalAdapter.findSession(a);if(!d||d.session.userId!==s.id)throw new m("INTERNAL_SERVER_ERROR",{message:"Failed to find admin session"});return await w(t,d),t.json(d)}),revokeUserSession:K("/admin/revoke-user-session",{method:"POST",body:b.object({sessionToken:b.string({description:"The session token"})}),use:[o],metadata:{openapi:{operationId:"revokeUserSession",summary:"Revoke a user session",description:"Revoke a user session",responses:{200:{description:"Session revoked",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async t=>(await t.context.internalAdapter.deleteSession(t.body.sessionToken),t.json({success:!0}))),revokeUserSessions:K("/admin/revoke-user-sessions",{method:"POST",body:b.object({userId:b.string({description:"The user id"})}),use:[o],metadata:{openapi:{operationId:"revokeUserSessions",summary:"Revoke all user sessions",description:"Revoke all user sessions",responses:{200:{description:"Sessions revoked",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async t=>(await t.context.internalAdapter.deleteSessions(t.body.userId),t.json({success:!0}))),removeUser:K("/admin/remove-user",{method:"POST",body:b.object({userId:b.string({description:"The user id"})}),use:[o],metadata:{openapi:{operationId:"removeUser",summary:"Remove a user",description:"Delete a user and all their sessions and accounts. Cannot be undone.",responses:{200:{description:"User removed",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async t=>(await t.context.internalAdapter.deleteUser(t.body.userId),t.json({success:!0})))},$ERROR_CODES:r,schema:Ke(dn,i.schema)}},dn={user:{fields:{role:{type:"string",required:!1,input:!1},banned:{type:"boolean",defaultValue:!1,required:!1,input:!1},banReason:{type:"string",required:!1,input:!1},banExpires:{type:"date",required:!1,input:!1}}},session:{fields:{impersonatedBy:{type:"string",required:!1}}}};import{betterFetch as ao}from"@better-fetch/fetch";import{APIError as De}from"better-call";import{z as ae}from"zod";import{decodeJwt as An}from"jose";async function lt(e,i){if(e.idToken){let o=An(e.idToken);if(o&&o.sub&&o.email)return{id:o.sub,emailVerified:o.email_verified,image:o.picture,...o}}if(!i)return null;let r=await ao(i,{method:"GET",headers:{Authorization:`Bearer ${e.accessToken}`}});return{id:r.data?.sub,emailVerified:r.data?.email_verified,email:r.data?.email,image:r.data?.picture,name:r.data?.name,...r.data}}var jl=e=>{let i={INVALID_OAUTH_CONFIGURATION:"Invalid OAuth configuration"};return{id:"generic-oauth",init:r=>({context:{socialProviders:e.config.map(t=>{let n=t.userInfoUrl;return{id:t.providerId,name:t.providerId,createAuthorizationURL(s){return k({id:t.providerId,options:{clientId:t.clientId,clientSecret:t.clientSecret,redirectURI:t.redirectURI},authorizationEndpoint:t.authorizationUrl,state:s.state,codeVerifier:t.pkce?s.codeVerifier:void 0,scopes:t.scopes||[],redirectURI:`${r.baseURL}/oauth2/callback/${t.providerId}`})},async validateAuthorizationCode(s){let a=t.tokenUrl;if(t.discoveryUrl){let d=await ao(t.discoveryUrl,{method:"GET"});d.data&&(a=d.data.token_endpoint,n=d.data.userinfo_endpoint)}if(!a)throw new De("BAD_REQUEST",{message:"Invalid OAuth configuration. Token URL not found."});return U({code:s.code,codeVerifier:s.codeVerifier,redirectURI:s.redirectURI,options:{clientId:t.clientId,clientSecret:t.clientSecret},tokenEndpoint:a})},async getUserInfo(s){if(!n)return null;let a=t.getUserInfo?await t.getUserInfo(s):await lt(s,n);return a?{user:{id:a?.id,email:a?.email,emailVerified:a?.emailVerified,image:a?.image,name:a?.name,...t.mapProfileToUser?.(a)},data:a}:null}}}).concat(r.socialProviders)}}),endpoints:{signInWithOAuth2:K("/sign-in/oauth2",{method:"POST",query:ae.object({currentURL:ae.string({description:"Redirect to the current URL after sign in"}).optional()}).optional(),body:ae.object({providerId:ae.string({description:"The provider ID for the OAuth provider"}),callbackURL:ae.string({description:"The URL to redirect to after sign in"}).optional(),errorCallbackURL:ae.string({description:"The URL to redirect to if an error occurs"}).optional(),disableRedirect:ae.boolean({description:"Disable redirect"}).optional()}),metadata:{openapi:{description:"Sign in with OAuth2",responses:{200:{description:"Sign in with OAuth2",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string"},redirect:{type:"boolean"}}}}}}}}}},async r=>{let{providerId:o}=r.body,t=e.config.find(v=>v.providerId===o);if(!t)throw new De("BAD_REQUEST",{message:`No config found for provider ${o}`});let{discoveryUrl:n,authorizationUrl:s,tokenUrl:a,clientId:d,clientSecret:A,scopes:c,redirectURI:l,responseType:p,pkce:u,prompt:y,accessType:h}=t,L=s,B=a;if(n){let v=await ao(n,{onError(_){r.context.logger.error(_.error.message,_.error,{discoveryUrl:n})}});v.data&&(L=v.data.authorization_endpoint,B=v.data.token_endpoint)}if(!L||!B)throw new De("BAD_REQUEST",{message:i.INVALID_OAUTH_CONFIGURATION});let{state:F,codeVerifier:g}=await Te(r),O=await k({id:o,options:{clientId:d,clientSecret:A,redirectURI:l},authorizationEndpoint:L,state:F,codeVerifier:u?g:void 0,scopes:c||[],redirectURI:`${r.context.baseURL}/oauth2/callback/${o}`});return p&&p!=="code"&&O.searchParams.set("response_type",p),y&&O.searchParams.set("prompt",y),h&&O.searchParams.set("access_type",h),r.json({url:O.toString(),redirect:!r.body.disableRedirect})}),oAuth2Callback:K("/oauth2/callback/:providerId",{method:"GET",query:ae.object({code:ae.string({description:"The OAuth2 code"}).optional(),error:ae.string({description:"The error message, if any"}).optional(),state:ae.string({description:"The state parameter from the OAuth2 request"}).optional()}),metadata:{openapi:{description:"OAuth2 callback",responses:{200:{description:"OAuth2 callback",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string"}}}}}}}}}},async r=>{if(r.query.error||!r.query.code)throw r.redirect(`${r.context.options.baseURL}?error=${r.query.error||"oAuth_code_missing"}`);let o=e.config.find(g=>g.providerId===r.params.providerId);if(!o)throw new De("BAD_REQUEST",{message:`No config found for provider ${r.params.providerId}`});let t,n=await Xe(r),{callbackURL:s,codeVerifier:a,errorURL:d}=n,A=r.query.code,c=o.tokenUrl,l=o.userInfoUrl;if(o.discoveryUrl){let g=await ao(o.discoveryUrl,{method:"GET"});g.data&&(c=g.data.token_endpoint,l=g.data.userinfo_endpoint)}try{if(!c)throw new De("BAD_REQUEST",{message:"Invalid OAuth configuration."});t=await U({code:A,codeVerifier:a,redirectURI:`${r.context.baseURL}/oauth2/callback/${o.providerId}`,options:{clientId:o.clientId,clientSecret:o.clientSecret},tokenEndpoint:c})}catch(g){throw r.context.logger.error(g&&typeof g=="object"&&"name"in g?g.name:"",g),r.redirect(`${d}?error=oauth_code_verification_failed`)}if(!t)throw new De("BAD_REQUEST",{message:"Invalid OAuth configuration."});let p=o.getUserInfo?await o.getUserInfo(t):await lt(t,l);if(!p?.email)throw r.context.logger.error("Unable to get user info",p),r.redirect(`${r.context.baseURL}/error?error=email_is_missing`);let u=o.mapProfileToUser?await o.mapProfileToUser(p):null,y=await _e(r,{userInfo:{...p,...u},account:{providerId:o.providerId,accountId:p.id,...t,scope:t.scopes?.join(",")}});function h(g){throw r.redirect(`${d||s||`${r.context.baseURL}/error`}?error=${g}`)}if(y.error)return h(y.error.split(" ").join("_"));let{session:L,user:B}=y.data;await w(r,{session:L,user:B});let F;try{F=new URL(s).toString()}catch{F=s}throw r.redirect(F)})},$ERROR_CODES:i}};import{z as qe}from"zod";var mt={jwks:{fields:{publicKey:{type:"string",required:!0},privateKey:{type:"string",required:!0},createdAt:{type:"date",required:!0}}}},Bl=qe.object({id:qe.string(),publicKey:qe.string(),privateKey:qe.string(),createdAt:qe.date()});var Uo=e=>({getAllKeys:async()=>await e.findMany({model:"jwks"}),getLatestKey:async()=>(await e.findMany({model:"jwks",sortBy:{field:"createdAt",direction:"desc"},limit:1}))[0],createJwk:async i=>await e.create({model:"jwks",data:{...i,createdAt:new Date}})});import{exportJWK as Ao,generateKeyPair as gt,importJWK as cn,SignJWT as Kn}from"jose";var Gl=e=>({id:"jwt",endpoints:{getJwks:K("/jwks",{method:"GET",metadata:{openapi:{description:"Get the JSON Web Key Set",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{keys:{type:"array",items:{type:"object",properties:{kid:{type:"string"},kty:{type:"string"},use:{type:"string"},alg:{type:"string"},n:{type:"string"},e:{type:"string"}}}}}}}}}}}}},async i=>{let r=Uo(i.context.adapter),o=await r.getAllKeys();if(o.length===0){let{publicKey:t,privateKey:n}=await gt(e?.jwks?.keyPairConfig?.alg??"EdDSA",e?.jwks?.keyPairConfig??{crv:"Ed25519",extractable:!0}),s=await Ao(t),a=await Ao(n),d=JSON.stringify(a),A=!e?.jwks?.disablePrivateKeyEncryption,c={id:i.context.generateId({model:"jwks"}),publicKey:JSON.stringify(s),privateKey:A?JSON.stringify(await de({key:i.context.options.secret,data:d})):d,createdAt:new Date};return await r.createJwk(c),i.json({keys:[{...s,kid:c.id}]})}return i.json({keys:o.map(t=>({...JSON.parse(t.publicKey),kid:t.id}))})}),getToken:K("/token",{method:"GET",requireHeaders:!0,use:[E],metadata:{openapi:{description:"Get a JWT token",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string"}}}}}}}}}},async i=>{let r=Uo(i.context.adapter),o=await r.getLatestKey(),t=!e?.jwks?.disablePrivateKeyEncryption;if(o===void 0){let{publicKey:A,privateKey:c}=await gt(e?.jwks?.keyPairConfig?.alg??"EdDSA",e?.jwks?.keyPairConfig??{crv:"Ed25519",extractable:!0}),l=await Ao(A),p=await Ao(c),u=JSON.stringify(p),y={id:i.context.generateId({model:"jwks"}),publicKey:JSON.stringify(l),privateKey:t?JSON.stringify(await de({key:i.context.options.secret,data:u})):u,createdAt:new Date};o=await r.createJwk(y)}let n=t?await ye({key:i.context.options.secret,data:JSON.parse(o.privateKey)}):o.privateKey,s=await cn(JSON.parse(n)),a=e?.jwt?.definePayload?await e?.jwt.definePayload(i.context.session):i.context.session.user,d=await new Kn({...a,...i.context.session.session.impersonatedBy?{impersonatedBy:i.context.session.session.impersonatedBy}:{}}).setProtectedHeader({alg:e?.jwks?.keyPairConfig?.alg??"EdDSA",kid:o.id}).setIssuedAt().setIssuer(e?.jwt?.issuer??i.context.options.baseURL).setAudience(e?.jwt?.audience??i.context.options.baseURL).setExpirationTime(e?.jwt?.expirationTime??"15m").setSubject(i.context.session.user.id).sign(s);return i.json({token:d})})},schema:Ke(mt,e?.schema)});import{z as co}from"zod";var em=e=>{let i={maximumSessions:5,...e},r=t=>t.includes("_multi-"),o={INVALID_SESSION_TOKEN:"Invalid session token"};return{id:"multi-session",endpoints:{listDeviceSessions:K("/multi-session/list-device-sessions",{method:"GET",requireHeaders:!0},async t=>{let n=t.headers?.get("cookie");if(!n)return t.json([]);let s=Object.fromEntries(Le(n)),a=(await Promise.all(Object.entries(s).filter(([c])=>r(c)).map(async([c])=>await t.getSignedCookie(c,t.context.secret)))).filter(c=>c!==void 0);if(!a.length)return t.json([]);let A=(await t.context.internalAdapter.findSessions(a)).filter(c=>c&&c.session.expiresAt>new Date);return t.json(A)}),setActiveSession:K("/multi-session/set-active",{method:"POST",body:co.object({sessionToken:co.string({description:"The session token to set as active"})}),requireHeaders:!0,use:[E],metadata:{openapi:{description:"Set the active session",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"}}}}}}}}}},async t=>{let n=t.body.sessionToken,s=`${t.context.authCookies.sessionToken.name}_multi-${n}`;if(!await t.getSignedCookie(s,t.context.secret))throw new m("UNAUTHORIZED",{message:o.INVALID_SESSION_TOKEN});let d=await t.context.internalAdapter.findSession(n);if(!d||d.session.expiresAt<new Date)throw t.setCookie(s,"",{...t.context.authCookies.sessionToken.options,maxAge:0}),new m("UNAUTHORIZED",{message:o.INVALID_SESSION_TOKEN});return await w(t,d),t.json(d)}),revokeDeviceSession:K("/multi-session/revoke",{method:"POST",body:co.object({sessionToken:co.string({description:"The session token to revoke"})}),requireHeaders:!0,use:[E],metadata:{openapi:{description:"Revoke a device session",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async t=>{let n=t.body.sessionToken,s=`${t.context.authCookies.sessionToken.name}_multi-${n}`;if(!await t.getSignedCookie(s,t.context.secret))throw new m("UNAUTHORIZED",{message:o.INVALID_SESSION_TOKEN});if(await t.context.internalAdapter.deleteSession(n),t.setCookie(s,"",{...t.context.authCookies.sessionToken.options,maxAge:0}),!(t.context.session?.session.token===n))return t.json({status:!0});let A=t.headers?.get("cookie");if(A){let c=Object.fromEntries(Le(A)),l=(await Promise.all(Object.entries(c).filter(([u])=>r(u)).map(async([u])=>await t.getSignedCookie(u,t.context.secret)))).filter(u=>u!==void 0),p=t.context.internalAdapter;if(l.length>0){let y=(await p.findSessions(l)).filter(h=>h&&h.session.expiresAt>new Date);if(y.length>0){let h=y[0];await w(t,h)}else H(t)}else H(t)}else H(t);return t.json({status:!0})})},hooks:{after:[{matcher:()=>!0,handler:D(async t=>{let n=t.responseHeader.get("set-cookie");if(!n)return;let s=he(n),a=t.context.authCookies.sessionToken,d=s.get(a.name)?.value;if(!d)return;let A=Le(t.headers?.get("cookie")||""),c=d.split(".")[0];if(!c)return;let l=`${a.name}_multi-${c}`;s.get(l)||A.get(l)||Object.keys(Object.fromEntries(A)).filter(r).length+(n.includes("session_token")?1:0)>i.maximumSessions||await t.setSignedCookie(l,c,t.context.secret,a.options)})},{matcher:t=>t.path==="/sign-out",handler:D(async t=>{let n=t.headers?.get("cookie");if(!n)return;let s=Object.fromEntries(Le(n)),a=Object.keys(s).map(d=>r(d)?(t.setCookie(d,"",{maxAge:0}),d.split("_multi-")[1]):null).filter(d=>d!==null);await t.context.internalAdapter.deleteSessions(a)})}]},$ERROR_CODES:o}};import{z as x}from"zod";var So=["email-verification","sign-in","forget-password"],am=e=>{let i={expireIn:300,otpLength:6,...e},r={OTP_EXPIRED:"otp expired",INVALID_OTP:"invalid otp",INVALID_EMAIL:"invalid email",USER_NOT_FOUND:"user not found"};return{id:"email-otp",endpoints:{sendVerificationOTP:K("/email-otp/send-verification-otp",{method:"POST",body:x.object({email:x.string({description:"Email address to send the OTP"}),type:x.enum(So,{description:"Type of the OTP"})}),metadata:{openapi:{description:"Send verification OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async o=>{if(!e?.sendVerificationOTP)throw o.context.logger.error("send email verification is not implemented"),new m("BAD_REQUEST",{message:"send email verification is not implemented"});let t=o.body.email;if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(t))throw new m("BAD_REQUEST",{message:r.INVALID_EMAIL});let s=I(i.otpLength,"0-9");return await o.context.internalAdapter.createVerificationValue({value:s,identifier:`${o.body.type}-otp-${t}`,expiresAt:P(i.expireIn,"sec")}).catch(async a=>{await o.context.internalAdapter.deleteVerificationByIdentifier(`${o.body.type}-otp-${t}`),await o.context.internalAdapter.createVerificationValue({value:s,identifier:`${o.body.type}-otp-${t}`,expiresAt:P(i.expireIn,"sec")})}),await e.sendVerificationOTP({email:t,otp:s,type:o.body.type},o.request),o.json({success:!0})}),createVerificationOTP:K("/email-otp/create-verification-otp",{method:"POST",body:x.object({email:x.string({description:"Email address to send the OTP"}),type:x.enum(So,{description:"Type of the OTP"})}),metadata:{SERVER_ONLY:!0,openapi:{description:"Create verification OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"string"}}}}}}}},async o=>{let t=o.body.email,n=I(i.otpLength,"0-9");return await o.context.internalAdapter.createVerificationValue({value:n,identifier:`${o.body.type}-otp-${t}`,expiresAt:P(i.expireIn,"sec")}),n}),getVerificationOTP:K("/email-otp/get-verification-otp",{method:"GET",query:x.object({email:x.string({description:"Email address to get the OTP"}),type:x.enum(So)}),metadata:{SERVER_ONLY:!0,openapi:{description:"Get verification OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{otp:{type:"string"}}}}}}}}}},async o=>{let t=o.query.email,n=await o.context.internalAdapter.findVerificationValue(`${o.query.type}-otp-${t}`);return!n||n.expiresAt<new Date?o.json({otp:null}):o.json({otp:n.value})}),verifyEmailOTP:K("/email-otp/verify-email",{method:"POST",body:x.object({email:x.string({description:"Email address to verify"}),otp:x.string({description:"OTP to verify"})}),metadata:{openapi:{description:"Verify email OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"}}}}}}}}}},async o=>{let t=o.body.email;if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(t))throw new m("BAD_REQUEST",{message:r.INVALID_EMAIL});let s=await o.context.internalAdapter.findVerificationValue(`email-verification-otp-${t}`);if(!s)throw new m("BAD_REQUEST",{message:r.INVALID_OTP});if(s.expiresAt<new Date)throw await o.context.internalAdapter.deleteVerificationValue(s.id),new m("BAD_REQUEST",{message:r.OTP_EXPIRED});let a=o.body.otp;if(s.value!==a)throw new m("BAD_REQUEST",{message:r.INVALID_OTP});await o.context.internalAdapter.deleteVerificationValue(s.id);let d=await o.context.internalAdapter.findUserByEmail(t);if(!d)throw new m("BAD_REQUEST",{message:r.USER_NOT_FOUND});let A=await o.context.internalAdapter.updateUser(d.user.id,{email:t,emailVerified:!0});if(o.context.options.emailVerification?.autoSignInAfterVerification){let c=await o.context.internalAdapter.createSession(A.id,o.request);return await w(o,{session:c,user:A}),o.json({token:c.token,status:!0})}return o.json({status:!0,token:null})}),signInEmailOTP:K("/sign-in/email-otp",{method:"POST",body:x.object({email:x.string({description:"Email address to sign in"}),otp:x.string({description:"OTP sent to the email"})}),metadata:{openapi:{description:"Sign in with email OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{$ref:"#/components/schemas/User"},session:{$ref:"#/components/schemas/Session"}}}}}}}}}},async o=>{let t=o.body.email,n=await o.context.internalAdapter.findVerificationValue(`sign-in-otp-${t}`);if(!n)throw new m("BAD_REQUEST",{message:r.INVALID_OTP});if(n.expiresAt<new Date)throw await o.context.internalAdapter.deleteVerificationValue(n.id),new m("BAD_REQUEST",{message:r.OTP_EXPIRED});let s=o.body.otp;if(n.value!==s)throw new m("BAD_REQUEST",{message:r.INVALID_OTP});await o.context.internalAdapter.deleteVerificationValue(n.id);let a=await o.context.internalAdapter.findUserByEmail(t);if(!a){if(i.disableSignUp)throw new m("BAD_REQUEST",{message:r.USER_NOT_FOUND});let A=await o.context.internalAdapter.createUser({email:t,emailVerified:!0,name:t}),c=await o.context.internalAdapter.createSession(A.id,o.request);return await w(o,{session:c,user:A}),o.json({token:c.token})}a.user.emailVerified||await o.context.internalAdapter.updateUser(a.user.id,{emailVerified:!0});let d=await o.context.internalAdapter.createSession(a.user.id,o.request);return await w(o,{session:d,user:a.user}),o.json({token:d.token})}),forgetPasswordEmailOTP:K("/forget-password/email-otp",{method:"POST",body:x.object({email:x.string({description:"Email address to send the OTP"})}),metadata:{openapi:{description:"Forget password with email OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async o=>{let t=o.body.email;if(!await o.context.internalAdapter.findUserByEmail(t))throw new m("BAD_REQUEST",{message:r.USER_NOT_FOUND});let s=I(i.otpLength,"0-9");return await o.context.internalAdapter.createVerificationValue({value:s,identifier:`forget-password-otp-${t}`,expiresAt:P(i.expireIn,"sec")}),await e.sendVerificationOTP({email:t,otp:s,type:"forget-password"},o.request),o.json({success:!0})}),resetPasswordEmailOTP:K("/email-otp/reset-password",{method:"POST",body:x.object({email:x.string({description:"Email address to reset the password"}),otp:x.string({description:"OTP sent to the email"}),password:x.string({description:"New password"})}),metadata:{openapi:{description:"Reset password with email OTP",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async o=>{let t=o.body.email,n=await o.context.internalAdapter.findUserByEmail(t);if(!n)throw new m("BAD_REQUEST",{message:r.USER_NOT_FOUND});let s=await o.context.internalAdapter.findVerificationValue(`forget-password-otp-${t}`);if(!s)throw new m("BAD_REQUEST",{message:r.INVALID_OTP});if(s.expiresAt<new Date)throw await o.context.internalAdapter.deleteVerificationValue(s.id),new m("BAD_REQUEST",{message:r.OTP_EXPIRED});let a=o.body.otp;if(s.value!==a)throw new m("BAD_REQUEST",{message:r.INVALID_OTP});await o.context.internalAdapter.deleteVerificationValue(s.id);let d=await o.context.password.hash(o.body.password);return await o.context.internalAdapter.updatePassword(n.user.id,d),o.json({success:!0})})},hooks:{after:[{matcher(o){return!!(o.path?.startsWith("/sign-up")&&i.sendVerificationOnSignUp)},async handler(o){let t=o.context.returned;if(t instanceof m)return;let n=t&&"email"in t?t.email:t instanceof Response&&t.status===200?o.body.email:null;if(n){let s=I(i.otpLength,"0-9");await o.context.internalAdapter.createVerificationValue({value:s,identifier:`email-verification-otp-${n}`,expiresAt:P(i.expireIn,"sec")}),await e.sendVerificationOTP({email:n,otp:s,type:"email-verification"},o.request)}}}]},$ERROR_CODES:r}};import{z as ht}from"zod";import{betterFetch as pn}from"@better-fetch/fetch";function ft(e){return e==="true"||e===!0}var mm=e=>({id:"one-tap",endpoints:{oneTapCallback:K("/one-tap/callback",{method:"POST",body:ht.object({idToken:ht.string({description:"Google ID token, which the client obtains from the One Tap API"})}),metadata:{openapi:{summary:"One tap callback",description:"Use this endpoint to authenticate with Google One Tap",responses:{200:{description:"Successful response",content:{"application/json":{schema:{type:"object",properties:{session:{$ref:"#/components/schemas/Session"},user:{$ref:"#/components/schemas/User"}}}}}},400:{description:"Invalid token"}}}}},async i=>{let{idToken:r}=i.body,{data:o,error:t}=await pn("https://oauth2.googleapis.com/tokeninfo?id_token="+r);if(t)return i.json({error:"Invalid token"});let n=await i.context.internalAdapter.findUserByEmail(o.email);if(!n){if(e?.disableSignup)throw new m("BAD_GATEWAY",{message:"User not found"});let a=await i.context.internalAdapter.createOAuthUser({email:o.email,emailVerified:ft(o.email_verified),name:o.name,image:o.picture},{providerId:"google",accountId:o.sub});if(!a)throw new m("INTERNAL_SERVER_ERROR",{message:"Could not create user"});let d=await i.context.internalAdapter.createSession(a?.user.id,i.request);return await w(i,{user:a.user,session:d}),i.json({session:d,user:a})}let s=await i.context.internalAdapter.createSession(n.user.id,i.request);return await w(i,{user:n.user,session:s}),i.json({token:s.token})})}});import{z as vo}from"zod";function un(){let e=ue.VERCEL_URL,i=ue.NETLIFY_URL,r=ue.RENDER_URL,o=ue.AWS_LAMBDA_FUNCTION_NAME,t=ue.GOOGLE_CLOUD_FUNCTION_NAME,n=ue.AZURE_FUNCTION_NAME;return e||i||r||o||t||n}var bm=e=>({id:"oauth-proxy",endpoints:{oAuthProxy:K("/oauth-proxy-callback",{method:"GET",query:vo.object({callbackURL:vo.string({description:"The URL to redirect to after the proxy"}),cookies:vo.string({description:"The cookies to set after the proxy"})}),metadata:{openapi:{description:"OAuth Proxy Callback",parameters:[{in:"query",name:"callbackURL",required:!0,description:"The URL to redirect to after the proxy"},{in:"query",name:"cookies",required:!0,description:"The cookies to set after the proxy"}],responses:{302:{description:"Redirect",headers:{Location:{description:"The URL to redirect to",schema:{type:"string"}}}}}}}},async i=>{let r=i.query.cookies,o=await ye({key:i.context.secret,data:r});throw i.setHeader("set-cookie",o),i.redirect(i.query.callbackURL)})},hooks:{after:[{matcher(i){return i.path?.startsWith("/callback")},handler:D(async i=>{let r=i.context.returned,o=r instanceof m?r.headers:null,t=o?.get("location");if(t?.includes("/oauth-proxy-callback?callbackURL")){if(!t.startsWith("http"))return;let n=new URL(t);if(n.origin===Oe(i.context.baseURL)){let c=n.searchParams.get("callbackURL");if(!c)return;i.setHeader("location",c);return}let a=o?.get("set-cookie");if(!a)return;let d=await de({key:i.context.secret,data:a}),A=`${t}&cookies=${encodeURIComponent(d)}`;i.setHeader("location",A)}})}],before:[{matcher(i){return i.path?.startsWith("/sign-in/social")},async handler(i){let r=new URL(e?.currentURL||i.request?.url||un()||i.context.baseURL);return i.body.callbackURL=`${r.origin}${i.context.options.basePath||"/api/auth"}/oauth-proxy-callback?callbackURL=${encodeURIComponent(i.body.callbackURL||i.context.baseURL)}`,{context:i}}}]}});import{z as He}from"zod";var Im=(e,i)=>({id:"custom-session",endpoints:{getSession:K("/get-session",{method:"GET",metadata:{CUSTOM_SESSION:!0},query:He.optional(He.object({disableCookieCache:He.boolean({description:"Disable cookie cache and fetch session from database"}).or(He.string().transform(r=>r==="true")).optional(),disableRefresh:He.boolean({description:"Disable session refresh. Useful for checking session status, without updating the session"}).optional()}))},async r=>{let o=await R(r);if(!o)return r.json(null);let t=await e(o);return r.json(t)})}});import{ZodObject as wt,ZodOptional as ko,ZodSchema as Ct}from"zod";var Pe=e=>{let i=e.plugins?.reduce((d,A)=>{let c=A.schema;if(!c)return d;for(let[l,p]of Object.entries(c))d[l]={fields:{...d[l]?.fields,...p.fields},modelName:p.modelName||l};return d},{}),r=e.rateLimit?.storage==="database",o={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:t,session:n,account:s,...a}=i||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:()=>!1,required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...t?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},token:{type:"string",required:!0,fieldName:e.session?.fields?.token||"token",unique:!0},createdAt:{type:"date",required:!0,fieldName:e.session?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.session?.fields?.updatedAt||"updatedAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...n?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},accessTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"accessTokenExpiresAt"},refreshTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"refreshTokenExpiresAt"},scope:{type:"string",required:!1,fieldName:e.account?.fields?.scope||"scope"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},createdAt:{type:"date",required:!0,fieldName:e.account?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.account?.fields?.updatedAt||"updatedAt"},...s?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.updatedAt||"updatedAt"}},order:4},...a,...r?o:{}}};import{z as Vm}from"zod";import{Kysely as $m,MssqlDialect as Zm}from"kysely";import{MysqlDialect as Gm,PostgresDialect as Wm,SqliteDialect as Jm}from"kysely";var $e={};function bt(e){switch(e.constructor.name){case"ZodString":return"string";case"ZodNumber":return"number";case"ZodBoolean":return"boolean";case"ZodObject":return"object";case"ZodArray":return"array";default:return"string"}}function Ko(e){let i=[];return e.metadata?.openapi?.parameters?(i.push(...e.metadata.openapi.parameters),i):(e.query instanceof wt&&Object.entries(e.query.shape).forEach(([r,o])=>{o instanceof Ct&&i.push({name:r,in:"query",schema:{type:bt(o),..."minLength"in o&&o.minLength?{minLength:o.minLength}:{},description:o.description}})}),i)}function yt(e){if(e.metadata?.openapi?.requestBody)return e.metadata.openapi.requestBody;if(e.body&&(e.body instanceof wt||e.body instanceof ko)){let i=e.body.shape;if(!i)return;let r={},o=[];return Object.entries(i).forEach(([t,n])=>{n instanceof Ct&&(r[t]={type:bt(n),description:n.description},n instanceof ko||o.push(t))}),{required:e.body instanceof ko?!1:!!e.body,content:{"application/json":{schema:{type:"object",properties:r,required:o}}}}}}function po(e){return{400:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}},required:["message"]}}},description:"Bad Request. Usually due to missing parameters, or invalid parameters."},401:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}},required:["message"]}}},description:"Unauthorized. Due to missing or invalid authentication."},403:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Forbidden. You do not have permission to access this resource or to perform this action."},404:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Not Found. The requested resource was not found."},429:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Too Many Requests. You have exceeded the rate limit. Try again later."},500:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Internal Server Error. This is a problem with the server that you cannot fix."},...e}}async function Do(e,i){let r=Oo(e,{...i,plugins:[]}),o=Pe(i),n={schemas:{...Object.entries(o).reduce((a,[d,A])=>{let c=d.charAt(0).toUpperCase()+d.slice(1);return a[c]={type:"object",properties:Object.entries(A.fields).reduce((l,[p,u])=>(l[p]={type:u.type},l),{})},a},{})}};Object.entries(r.api).forEach(([a,d])=>{let A=d.options;if(!A.metadata?.SERVER_ONLY&&(A.method==="GET"&&($e[d.path]={get:{tags:["Default",...A.metadata?.openapi?.tags||[]],description:A.metadata?.openapi?.description,operationId:A.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:Ko(A),responses:po(A.metadata?.openapi?.responses)}}),A.method==="POST")){let c=yt(A);$e[d.path]={post:{tags:["Default",...A.metadata?.openapi?.tags||[]],description:A.metadata?.openapi?.description,operationId:A.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:Ko(A),...c?{requestBody:c}:{requestBody:{content:{"application/json":{schema:{type:"object",properties:{}}}}}},responses:po(A.metadata?.openapi?.responses)}}}});for(let a of i.plugins||[]){if(a.id==="open-api")continue;let d=Oo(e,{...i,plugins:[a]}),A=Object.keys(d.api).map(c=>r.api[c]===void 0?d.api[c]:null).filter(c=>c!==null);Object.entries(A).forEach(([c,l])=>{let p=l.options;p.metadata?.SERVER_ONLY||(p.method==="GET"&&($e[l.path]={get:{tags:p.metadata?.openapi?.tags||[a.id.charAt(0).toUpperCase()+a.id.slice(1)],description:p.metadata?.openapi?.description,operationId:p.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:Ko(p),responses:po(p.metadata?.openapi?.responses)}}),p.method==="POST"&&($e[l.path]={post:{tags:p.metadata?.openapi?.tags||[a.id.charAt(0).toUpperCase()+a.id.slice(1)],description:p.metadata?.openapi?.description,operationId:p.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:Ko(p),requestBody:yt(p),responses:po(p.metadata?.openapi?.responses)}}))})}return{openapi:"3.1.1",info:{title:"Better Auth",description:"API Reference for your Better Auth Instance"},components:n,security:[{apiKeyCookie:[]}],servers:[{url:e.baseURL}],tags:[{name:"Default",description:"Default endpoints that are included with Better Auth by default. These endpoints are not part of any plugin."}],paths:$e}}var Ot=`<svg width="75" height="75" viewBox="0 0 75 75" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<rect width="75" height="75" fill="url(#pattern0_21_12)"/>
<defs>
<pattern id="pattern0_21_12" patternContentUnits="objectBoundingBox" width="1" height="1">
<use xlink:href="#image0_21_12" transform="scale(0.00094697)"/>
</pattern>
<image id="image0_21_12" width="1056" height="1056" xlink:href="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAASABIAAD/4QBARXhpZgAATU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAEIKADAAQAAAABAAAEIAAAAAD/7QA4UGhvdG9zaG9wIDMuMAA4QklNBAQAAAAAAAA4QklNBCUAAAAAABDUHYzZjwCyBOmACZjs+EJ+/+ICKElDQ19QUk9GSUxFAAEBAAACGGFwcGwEAAAAbW50clJHQiBYWVogB+YAAQABAAAAAAAAYWNzcEFQUEwAAAAAQVBQTAAAAAAAAAAAAAAAAAAAAAAAAPbWAAEAAAAA0y1hcHBs7P2jjjiFR8NttL1PetoYLwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKZGVzYwAAAPwAAAAwY3BydAAAASwAAABQd3RwdAAAAXwAAAAUclhZWgAAAZAAAAAUZ1hZWgAAAaQAAAAUYlhZWgAAAbgAAAAUclRSQwAAAcwAAAAgY2hhZAAAAewAAAAsYlRSQwAAAcwAAAAgZ1RSQwAAAcwAAAAgbWx1YwAAAAAAAAABAAAADGVuVVMAAAAUAAAAHABEAGkAcwBwAGwAYQB5ACAAUAAzbWx1YwAAAAAAAAABAAAADGVuVVMAAAA0AAAAHABDAG8AcAB5AHIAaQBnAGgAdAAgAEEAcABwAGwAZQAgAEkAbgBjAC4ALAAgADIAMAAyADJYWVogAAAAAAAA9tUAAQAAAADTLFhZWiAAAAAAAACD3wAAPb////+7WFlaIAAAAAAAAEq/AACxNwAACrlYWVogAAAAAAAAKDgAABELAADIuXBhcmEAAAAAAAMAAAACZmYAAPKnAAANWQAAE9AAAApbc2YzMgAAAAAAAQxCAAAF3v//8yYAAAeTAAD9kP//+6L///2jAAAD3AAAwG7/wAARCAQgBCADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9sAQwACAgICAgIDAgIDBAMDAwQFBAQEBAUHBQUFBQUHCAcHBwcHBwgICAgICAgICgoKCgoKCwsLCwsNDQ0NDQ0NDQ0N/9sAQwECAgIDAwMGAwMGDQkHCQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0N/90ABABC/9oADAMBAAIRAxEAPwD9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//Q/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9L9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//T/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9X9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//W/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//R/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9P9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//U/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9b9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//X/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9H9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//S/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9T9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//V/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Ln/gq38a/in8Dvgp4T8R/CfxFdeG9SvvFMdlcXFoELyW5srqQxnzEcY3op4Gciv1Gr8Z/+C2X/JvXgj/sc4v/AE33lAH4z/8ADwv9tD/oq2tf9823/wAZo/4eF/tof9FW1r/vm2/+M18Z0UAfZn/Dwv8AbQ/6KtrX/fNt/wDGaP8Ah4X+2h/0VbWv++bb/wCM18Z0UAfZn/Dwv9tD/oq2tf8AfNt/8Zo/4eF/tof9FW1r/vm2/wDjNfGdFAH2Z/w8L/bQ/wCira1/3zbf/GaP+Hhf7aH/AEVbWv8Avm2/+M18Z0UAfZn/AA8L/bQ/6KtrX/fNt/8AGaP+Hhf7aH/RVta/75tv/jNfGdFAH2Z/w8L/AG0P+ira1/3zbf8Axmj/AIeF/tof9FW1r/vm2/8AjNfGdFAH63/sVftq/tTfEb9qb4deCfG3xF1TVtD1bVGgvbKdYBHPGIJW2ttiVsblB4I6V/UbX8Z//BPT/k9D4U/9hpv/AEmmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+M/wD4eF/tof8ARVta/wC+bb/4zR/w8L/bQ/6KtrX/AHzbf/Ga+M6KAPsz/h4X+2h/0VbWv++bb/4zR/w8L/bQ/wCira1/3zbf/Ga+M6KAPsz/AIeF/tof9FW1r/vm2/8AjNH/AA8L/bQ/6KtrX/fNt/8AGa+M6KAPsz/h4X+2h/0VbWv++bb/AOM0f8PC/wBtD/oq2tf9823/AMZr4zooA+zP+Hhf7aH/AEVbWv8Avm2/+M0f8PC/20P+ira1/wB823/xmvjOigD7M/4eF/tof9FW1r/vm2/+M0f8PC/20P8Aoq2tf9823/xmvjOigD7M/wCHhf7aH/RVta/75tv/AIzR/wAPC/20P+ira1/3zbf/ABmvjOigD7M/4eF/tof9FW1r/vm2/wDjNH/Dwv8AbQ/6KtrX/fNt/wDGa+M6KAPsz/h4X+2h/wBFW1r/AL5tv/jNH/Dwv9tD/oq2tf8AfNt/8Zr4zooA+zP+Hhf7aH/RVta/75tv/jNH/Dwv9tD/AKKtrX/fNt/8Zr4zooA+zP8Ah4X+2h/0VbWv++bb/wCM0f8ADwv9tD/oq2tf9823/wAZr4zooA+zP+Hhf7aH/RVta/75tv8A4zR/w8L/AG0P+ira1/3zbf8AxmvjOigD7M/4eF/tof8ARVta/wC+bb/4zR/w8L/bQ/6KtrX/AHzbf/Ga+M6KAP6tv+CUnxr+Kfxx+CnizxH8WPEV14k1Kx8UyWVvcXYQPHbiytZBGPLRBje7HkZya/Uavxn/AOCJv/JvXjf/ALHOX/032dfsxQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAf//X/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooA+zP+Cen/J6Hwp/7DTf+k01f2YV/Gf8A8E9P+T0PhT/2Gm/9Jpq/swoAKKKKACiiigAooooAKKKKACiiigAooooA/gDooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD7M/4J6f8nofCn/sNN/6TTV/ZhX8Z/wDwT0/5PQ+FP/Yab/0mmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+AOiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/0f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKAPsz/gnp/yeh8Kf+w03/pNNX9mFfxn/APBPT/k9D4U/9hpv/Saav7MKACiiigAooooAKKKKACiiigAooooAKKKKAP4A6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/JvXjf/ALHOX/032dfsxX4z/wDBE3/k3rxv/wBjnL/6b7Ov2YoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/S/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooA+zP+Cen/J6Hwp/7DTf+k01f2YV/Gf8A8E9P+T0PhT/2Gm/9Jpq/swoAKKKKACiiigAooooAKKKKACiiigAooooA/gDooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9P9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD7M/4J6f8nofCn/sNN/6TTV/ZhX8Z/wDwT0/5PQ+FP/Yab/0mmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+AOiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/1P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKAPsz/gnp/yeh8Kf+w03/pNNX9mFfwq/BT4r638Dvin4d+LHhy0tb7UvDd0bu3t70ObeRzG0eJBGyPjDnowOa/Ub/h9l+0L/ANCR4M/79ah/8m0Af0yUV/M3/wAPsv2hf+hI8Gf9+tQ/+TaP+H2X7Qv/AEJHgz/v1qH/AMm0Af0yUV/M3/w+y/aF/wChI8Gf9+tQ/wDk2j/h9l+0L/0JHgz/AL9ah/8AJtAH9MlFfzN/8Psv2hf+hI8Gf9+tQ/8Ak2j/AIfZftC/9CR4M/79ah/8m0Af0yUV/M3/AMPsv2hf+hI8Gf8AfrUP/k2j/h9l+0L/ANCR4M/79ah/8m0Af0yUV/M3/wAPsv2hf+hI8Gf9+tQ/+TaP+H2X7Qv/AEJHgz/v1qH/AMm0Af0yUV/M3/w+y/aF/wChI8Gf9+tQ/wDk2j/h9l+0L/0JHgz/AL9ah/8AJtAH4z0V/TJ/w5N/Z6/6Hfxn/wB/dP8A/kKj/hyb+z1/0O/jP/v7p/8A8hUAfzN0V/TJ/wAOTf2ev+h38Z/9/dP/APkKj/hyb+z1/wBDv4z/AO/un/8AyFQB/M3RX9Mn/Dk39nr/AKHfxn/390//AOQqP+HJv7PX/Q7+M/8Av7p//wAhUAfzN0V/TJ/w5N/Z6/6Hfxn/AN/dP/8AkKj/AIcm/s9f9Dv4z/7+6f8A/IVAH8zdFf0yf8OTf2ev+h38Z/8Af3T/AP5Co/4cm/s9f9Dv4z/7+6f/APIVAH8zdFf0yf8ADk39nr/od/Gf/f3T/wD5Co/4cm/s9f8AQ7+M/wDv7p//AMhUAfzN0V/TJ/w5N/Z6/wCh38Z/9/dP/wDkKvwV/ag+FGifA74++M/hP4cu7q+03w3fi0t7i9KG4kQxRyZkMaomcueigYoA8FooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/AOxzl/8ATfZ1+zFfjP8A8ETf+TevG/8A2Ocv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//9X9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v8ooooAKKKKACiiigAooooAKKKKACiiigAr+M//goX/wAnofFb/sNL/wCk0Nf2YV/Gf/wUL/5PQ+K3/YaX/wBJoaAPjOiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/JvXjf/ALHOX/032dfsxX4z/wDBE3/k3rxv/wBjnL/6b7Ov2YoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/W/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP7/KKKKACiiigAooooAKKKKACiiigAooooAK/jP/4KF/8AJ6HxW/7DS/8ApNDX9mFfxn/8FC/+T0Pit/2Gl/8ASaGgD4zooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/1/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+/yiiigAooooAKKKKACiiigAooooAKKKKACv4z/+Chf/ACeh8Vv+w0v/AKTQ1/ZhX8Z//BQv/k9D4rf9hpf/AEmhoA+M6KKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v8ooooAKKKKACiiigAooooAKKKKACiiigAr+M//goX/wAnofFb/sNL/wCk0Nf2YV/Gf/wUL/5PQ+K3/YaX/wBJoaAPjOiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/JvXjf/ALHOX/032dfsxX4z/wDBE3/k3rxv/wBjnL/6b7Ov2YoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/R/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP7/KKKKACiiigAooooAKKKKACiiigAooooAK/jP/4KF/8AJ6HxW/7DS/8ApNDX9mFfxn/8FC/+T0Pit/2Gl/8ASaGgD4zooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/0v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+/yiiigAooooAKKKKACiiigAooooAKKKKACv4z/+Chf/ACeh8Vv+w0v/AKTQ1/ZhX8Z//BQv/k9D4rf9hpf/AEmhoA+M6KKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9P9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD1L4KfCjW/jj8U/Dvwn8OXdrY6l4kujaW9xelxbxuI2kzIY1d8YQ9FJzX6jf8OTf2hf8Aod/Bn/f3UP8A5Cr4z/4J6f8AJ6Hwp/7DTf8ApNNX9mFAH8zf/Dk39oX/AKHfwZ/391D/AOQqP+HJv7Qv/Q7+DP8Av7qH/wAhV/TJRQB/M3/w5N/aF/6HfwZ/391D/wCQqP8Ahyb+0L/0O/gz/v7qH/yFX9MlFAH8zf8Aw5N/aF/6HfwZ/wB/dQ/+QqP+HJv7Qv8A0O/gz/v7qH/yFX9MlFAH8zf/AA5N/aF/6HfwZ/391D/5Co/4cm/tC/8AQ7+DP+/uof8AyFX9MlFAH8zf/Dk39oX/AKHfwZ/391D/AOQqP+HJv7Qv/Q7+DP8Av7qH/wAhV/TJRQB/M3/w5N/aF/6HfwZ/391D/wCQqP8Ahyb+0L/0O/gz/v7qH/yFX9MlFAH4z/8AD7L9nr/oSPGf/frT/wD5No/4fZfs9f8AQkeM/wDv1p//AMm1/M3RQB/TJ/w+y/Z6/wChI8Z/9+tP/wDk2j/h9l+z1/0JHjP/AL9af/8AJtfzN0UAf0yf8Psv2ev+hI8Z/wDfrT//AJNo/wCH2X7PX/QkeM/+/Wn/APybX8zdFAH9Mn/D7L9nr/oSPGf/AH60/wD+TaP+H2X7PX/QkeM/+/Wn/wDybX8zdFAH9Mn/AA+y/Z6/6Ejxn/360/8A+TaP+H2X7PX/AEJHjP8A79af/wDJtfzN0UAf0yf8Psv2ev8AoSPGf/frT/8A5No/4fZfs9f9CR4z/wC/Wn//ACbX8zdFAH9Mn/D7L9nr/oSPGf8A360//wCTa/BX9qD4r6J8cfj74z+LHhy0urHTfEl+Lu3t70ILiNBFHHiQRs6Zyh6MRivBaKACiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/ACb143/7HOX/ANN9nX7MV+M//BE3/k3rxv8A9jnL/wCm+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//U/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooA+zP+Cen/J6Hwp/7DTf+k01f2YV/Gf8A8E9P+T0PhT/2Gm/9Jpq/swoAKKKKACiiigAooooAKKKKACiiigAooooA/gDooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9X9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD7M/4J6f8nofCn/sNN/6TTV/ZhX8Z/wDwT0/5PQ+FP/Yab/0mmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+AOiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/1v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+M/wDwWy/5N68Ef9jnF/6b7ygD+ZuiiigAooooAKKKKACiiigAooooAKKKKAPsz/gnp/yeh8Kf+w03/pNNX9mFfxn/APBPT/k9D4U/9hpv/Saav7MKACiiigAooooAKKKKACiiigAooooAKKKKAP4A6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP6ZP+CJv/JvXjf/ALHOX/032dfsxX4z/wDBE3/k3rxv/wBjnL/6b7Ov2YoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/X/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr8Z/+C2X/JvXgj/sc4v/AE33lfsxX4z/APBbL/k3rwR/2OcX/pvvKAP5m6KKKACiiigAooooAKKKKACiiigAooooA+zP+Cen/J6Hwp/7DTf+k01f2YV/Gf8A8E9P+T0PhT/2Gm/9Jpq/swoAKKKKACiiigAooooAKKKKACiiigAooooA/gDooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/pk/4Im/8m9eN/8Asc5f/TfZ1+zFfjP/AMETf+TevG//AGOcv/pvs6/ZigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvxn/4LZf8m9eCP+xzi/8ATfeV+zFfjP8A8Fsv+TevBH/Y5xf+m+8oA/mbooooAKKKKACiiigAooooAKKKKACiiigD7M/4J6f8nofCn/sNN/6TTV/ZhX8Z/wDwT0/5PQ+FP/Yab/0mmr+zCgAooooAKKKKACiiigAooooAKKKKACiiigD+AOiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+mT/gib/yb143/wCxzl/9N9nX7MV+M/8AwRN/5N68b/8AY5y/+m+zr9mKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/0f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK/Gf/gtl/yb14I/7HOL/wBN95X7MV+XP/BVv4KfFP44/BTwn4c+E/h268SalY+KY724t7QoHjtxZXUZkPmOgxvdRwc5NAH8pNFfZn/DvT9tD/olOtf99W3/AMeo/wCHen7aH/RKda/76tv/AI9QB8Z0V9mf8O9P20P+iU61/wB9W3/x6j/h3p+2h/0SnWv++rb/AOPUAfGdFfZn/DvT9tD/AKJTrX/fVt/8eo/4d6ftof8ARKda/wC+rb/49QB8Z0V9mf8ADvT9tD/olOtf99W3/wAeo/4d6ftof9Ep1r/vq2/+PUAfGdFfZn/DvT9tD/olOtf99W3/AMeo/wCHen7aH/RKda/76tv/AI9QB8Z0V9mf8O9P20P+iU61/wB9W3/x6j/h3p+2h/0SnWv++rb/AOPUAH/BPT/k9D4U/wDYab/0mmr+zCv5cv2Kv2Kv2pvhz+1N8OvG3jb4dappOh6TqjT3t7O0BjgjMEq7m2ys2NzAcA9a/qNoAKKKKACiiigAooooAKKKKACiiigAooooA/gDor7M/wCHen7aH/RKda/76tv/AI9R/wAO9P20P+iU61/31bf/AB6gD4zor7M/4d6ftof9Ep1r/vq2/wDj1H/DvT9tD/olOtf99W3/AMeoA+M6K+zP+Hen7aH/AESnWv8Avq2/+PUf8O9P20P+iU61/wB9W3/x6gD4zor7M/4d6ftof9Ep1r/vq2/+PUf8O9P20P8AolOtf99W3/x6gD4zor7M/wCHen7aH/RKda/76tv/AI9R/wAO9P20P+iU61/31bf/AB6gD4zor7M/4d6ftof9Ep1r/vq2/wDj1H/DvT9tD/olOtf99W3/AMeoA+M6K+zP+Hen7aH/AESnWv8Avq2/+PUf8O9P20P+iU61/wB9W3/x6gD4zor7M/4d6ftof9Ep1r/vq2/+PUf8O9P20P8AolOtf99W3/x6gD4zor7M/wCHen7aH/RKda/76tv/AI9R/wAO9P20P+iU61/31bf/AB6gD4zor7M/4d6ftof9Ep1r/vq2/wDj1H/DvT9tD/olOtf99W3/AMeoA+M6K+zP+Hen7aH/AESnWv8Avq2/+PUf8O9P20P+iU61/wB9W3/x6gD4zor7M/4d6ftof9Ep1r/vq2/+PUf8O9P20P8AolOtf99W3/x6gD4zor7M/wCHen7aH/RKda/76tv/AI9R/wAO9P20P+iU61/31bf/AB6gD9mP+CJv/JvXjf8A7HOX/wBN9nX7MV+XP/BKT4KfFP4HfBTxZ4c+LHh268N6lfeKZL23t7soXktzZWsYkHlu4xvRhyc5FfqNQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAf/9L9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//T/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9X9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//W/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9D9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//R/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9P9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//U/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1f38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9b9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//X/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0P38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9H9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//S/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/0/38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9T9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//V/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/1v38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9f9/KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//Q/fyiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/2Q=="/>
</defs>
</svg>
`;var gn=e=>`<!doctype html>
<html>
  <head>
    <title>Scalar API Reference</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <script
      id="api-reference"
      type="application/json">
    ${JSON.stringify(e)}
    </script>
	 <script>
      var configuration = {
	  	favicon: "data:image/svg+xml;utf8,${encodeURIComponent(Ot)}",
	   	theme: "saturn",
        metaData: {
			title: "Better Auth API",
			description: "API Reference for your Better Auth Instance",
		}
      }

      document.getElementById('api-reference').dataset.configuration =
        JSON.stringify(configuration)
    </script>
	  <script src="https://cdn.jsdelivr.net/npm/@scalar/api-reference"></script>
  </body>
</html>`,Zg=e=>{let i=e?.path??"/reference";return{id:"open-api",endpoints:{generateOpenAPISchema:K("/open-api/generate-schema",{method:"GET"},async r=>{let o=await Do(r.context,r.context.options);return r.json(o)}),openAPIReference:K(i,{method:"GET",metadata:{isAction:!1}},async r=>{if(e?.disableDefaultReference)throw new m("NOT_FOUND");let o=await Do(r.context,r.context.options);return new Response(gn(o),{headers:{"Content-Type":"text/html"}})})}}};import{SignJWT as fn}from"jose";import{z as Y}from"zod";var Tt={oauthApplication:{modelName:"oauthApplication",fields:{name:{type:"string"},icon:{type:"string",required:!1},metadata:{type:"string",required:!1},clientId:{type:"string",unique:!0},clientSecret:{type:"string"},redirectURLs:{type:"string"},type:{type:"string"},disabled:{type:"boolean",required:!1,defaultValue:!1},userId:{type:"string",required:!1},createdAt:{type:"date"},updatedAt:{type:"date"}}},oauthAccessToken:{modelName:"oauthAccessToken",fields:{accessToken:{type:"string",unique:!0},refreshToken:{type:"string",unique:!0},accessTokenExpiresAt:{type:"date"},refreshTokenExpiresAt:{type:"date"},clientId:{type:"string"},userId:{type:"string",required:!1},scopes:{type:"string"},createdAt:{type:"date"},updatedAt:{type:"date"}}},oauthConsent:{modelName:"oauthConsent",fields:{clientId:{type:"string"},userId:{type:"string"},scopes:{type:"string"},createdAt:{type:"date"},updatedAt:{type:"date"},consentGiven:{type:"boolean"}}}};import{APIError as Po}from"better-call";function Ze(e,i,r){return`${e.includes("?")?"&":"?"}error=${i}&error_description=${r}`}async function No(e,i){let r={codeExpiresIn:600,defaultScope:"openid",...i,scopes:["openid","profile","email","offline_access",...i?.scopes||[]]};if(!e.request)throw new Po("UNAUTHORIZED",{error_description:"request not found",error:"invalid_request"});let o=await R(e);if(!o){await e.setSignedCookie("oidc_login_prompt",JSON.stringify(e.query),e.context.secret,{maxAge:600});let h=e.request.url?.split("?")[1];throw e.redirect(`${i.loginPage}?${h}`)}let t=e.query;if(!t.client_id)throw e.redirect(`${e.context.baseURL}/error?error=invalid_client`);if(!t.response_type)throw e.redirect(Ze(`${e.context.baseURL}/error`,"invalid_request","response_type is required"));let n=await e.context.adapter.findOne({model:"oauthApplication",where:[{field:"clientId",value:e.query.client_id}]}).then(h=>h?{...h,redirectURLs:h.redirectURLs.split(","),metadata:h.metadata?JSON.parse(h.metadata):{}}:null);if(!n)throw e.redirect(`${e.context.baseURL}/error?error=invalid_client`);let s=n.redirectURLs.find(h=>h===e.query.redirect_uri);if(!s||!t.redirect_uri)throw new Po("BAD_REQUEST",{message:"Invalid redirect URI"});if(n.disabled)throw e.redirect(`${e.context.baseURL}/error?error=client_disabled`);if(t.response_type!=="code")throw e.redirect(`${e.context.baseURL}/error?error=unsupported_response_type`);let a=t.scope?.split(" ").filter(h=>h)||r.defaultScope.split(" "),d=a.filter(h=>!r.scopes.includes(h)||h==="offline_access"&&t.prompt!=="consent");if(d.length)throw e.redirect(Ze(t.redirect_uri,"invalid_scope",`The following scopes are invalid: ${d.join(", ")}`));if((!t.code_challenge||!t.code_challenge_method)&&i.requirePKCE)throw e.redirect(Ze(t.redirect_uri,"invalid_request","pkce is required"));if(!["s256",i.allowPlainCodeChallengeMethod?"plain":"s256"].includes(t.code_challenge_method?.toLowerCase()||""))throw e.redirect(Ze(t.redirect_uri,"invalid_request","invalid code_challenge method"));let A=I(32,"a-z","A-Z","0-9"),c=r.codeExpiresIn*1e3,l=new Date(Date.now()+c);try{await e.context.internalAdapter.createVerificationValue({value:JSON.stringify({clientId:n.clientId,redirectURI:t.redirect_uri,scope:a,userId:o.user.id,authTime:o.session.createdAt.getTime(),requireConsent:t.prompt==="consent",state:t.prompt==="consent"?t.state:null,codeChallenge:t.code_challenge,codeChallengeMethod:t.code_challenge_method}),identifier:A,expiresAt:l})}catch{throw e.redirect(Ze(t.redirect_uri,"server_error","An error occurred while processing the request"))}let p=new URL(s);if(p.searchParams.set("code",A),p.searchParams.set("state",e.query.state),t.prompt!=="consent"||await e.context.adapter.findOne({model:"oauthConsent",where:[{field:"clientId",value:n.clientId},{field:"userId",value:o.user.id}]}).then(h=>!!h?.consentGiven))throw e.redirect(p.toString());if(i?.consentPage){await e.setSignedCookie("oidc_consent_prompt",A,e.context.secret,{maxAge:600});let h=`${i.consentPage}?client_id=${n.clientId}&scope=${a.join(" ")}`;throw e.redirect(h)}let y=i?.getConsentHTML;if(!y)throw new Po("INTERNAL_SERVER_ERROR",{message:"No consent page provided"});return new Response(y({scopes:a,clientMetadata:n.metadata,clientIcon:n?.icon,clientId:n.clientId,clientName:n.name,code:A}),{headers:{"content-type":"text/html"}})}import{createHash as hn}from"@better-auth/utils/hash";var yn=(e,i)=>{let r=e.context.options.baseURL,o=e.context.baseURL;return{issuer:r,authorization_endpoint:`${o}/oauth2/authorize`,token_endpoint:`${o}/oauth2/token`,userInfo_endpoint:`${o}/oauth2/userinfo`,jwks_uri:`${o}/jwks`,registration_endpoint:`${o}/oauth2/register`,scopes_supported:["openid","profile","email","offline_access"],response_types_supported:["code"],response_modes_supported:["query"],grant_types_supported:["authorization_code"],acr_values_supported:["urn:mace:incommon:iap:silver","urn:mace:incommon:iap:bronze"],subject_types_supported:["public"],id_token_signing_alg_values_supported:["RS256","none"],token_endpoint_auth_methods_supported:["client_secret_basic","client_secret_post"],claims_supported:["sub","iss","aud","exp","nbf","iat","jti","email","email_verified","name"],...i?.metadata}},pf=e=>{let i={oauthClient:"oauthApplication",oauthAccessToken:"oauthAccessToken",oauthConsent:"oauthConsent"},r={codeExpiresIn:600,defaultScope:"openid",accessTokenExpiresIn:3600,refreshTokenExpiresIn:604800,...e,scopes:["openid","profile","email","offline_access",...e?.scopes||[]]};return{id:"oidc",hooks:{after:[{matcher(){return!0},handler:async o=>{let t=await o.getSignedCookie("oidc_login_prompt",o.context.secret),n=o.context.authCookies.sessionToken.name,s=he(o.responseHeader.get("set-cookie")||""),a=s.has(n);if(!t||!a)return;o.setCookie("oidc_login_prompt","",{maxAge:0});let A=s.get(n)?.value?.split(".")[0];if(!A)return;let c=await o.context.internalAdapter.findSession(A);return c?(o.query=JSON.parse(t),o.query.prompt="consent",o.context.session=c,await No(o,r)):void 0}}]},endpoints:{getOpenIdConfig:K("/.well-known/openid-configuration",{method:"GET"},async o=>yn(o,e)),oAuth2authorize:K("/oauth2/authorize",{method:"GET",query:Y.record(Y.string(),Y.any())},async o=>No(o,r)),oAuthConsent:K("/oauth2/consent",{method:"POST",body:Y.object({accept:Y.boolean()}),use:[E]},async o=>{let t=await o.getSignedCookie("oidc_consent_prompt",o.context.secret);if(!t)throw new m("UNAUTHORIZED",{error_description:"No consent prompt found",error:"invalid_grant"});let n=await o.context.internalAdapter.findVerificationValue(t);if(!n)throw new m("UNAUTHORIZED",{error_description:"Invalid code",error:"invalid_grant"});if(n.expiresAt<new Date)throw await o.context.internalAdapter.deleteVerificationValue(n.id),new m("UNAUTHORIZED",{error_description:"Code expired",error:"invalid_grant"});let s=JSON.parse(n.value);if(!s.requireConsent||!s.state)throw new m("UNAUTHORIZED",{error_description:"Consent not required",error:"invalid_grant"});if(!o.body.accept)return await o.context.internalAdapter.deleteVerificationValue(n.id),o.json({redirectURI:`${s.redirectURI}?error=access_denied&error_description=User denied access`});let a=I(32,"a-z","A-Z","0-9"),d=r.codeExpiresIn*1e3,A=new Date(Date.now()+d);await o.context.internalAdapter.updateVerificationValue(n.id,{value:JSON.stringify({...s,requireConsent:!1}),identifier:a,expiresAt:A}),await o.context.adapter.create({model:i.oauthConsent,data:{clientId:s.clientId,userId:s.userId,scopes:s.scope.join(" "),consentGiven:!0,createdAt:new Date,updatedAt:new Date}});let c=new URL(s.redirectURI);return c.searchParams.set("code",a),c.searchParams.set("state",s.state),o.json({redirectURI:c.toString()})}),oAuth2token:K("/oauth2/token",{method:"POST",body:Y.any(),metadata:{isAction:!1}},async o=>{let{body:t}=o;if(!t)throw new m("BAD_REQUEST",{error_description:"request body not found",error:"invalid_request"});if(t instanceof FormData&&(t=Object.fromEntries(t.entries())),!(t instanceof Object))throw new m("BAD_REQUEST",{error_description:"request body is not an object",error:"invalid_request"});let{client_id:n,client_secret:s,grant_type:a,code:d,redirect_uri:A,refresh_token:c,code_verifier:l}=t;if(a==="refresh_token"){if(!c)throw new m("BAD_REQUEST",{error_description:"refresh_token is required",error:"invalid_request"});let ee=await o.context.adapter.findOne({model:i.oauthAccessToken,where:[{field:"refreshToken",value:c.toString()}]});if(!ee)throw new m("UNAUTHORIZED",{error_description:"invalid refresh token",error:"invalid_grant"});if(ee.clientId!==n?.toString())throw new m("UNAUTHORIZED",{error_description:"invalid client_id",error:"invalid_client"});if(ee.refreshTokenExpiresAt<new Date)throw new m("UNAUTHORIZED",{error_description:"refresh token expired",error:"invalid_grant"});let Lo=I(32,"a-z","A-Z"),jo=I(32,"a-z","A-Z"),Ut=new Date(Date.now()+r.accessTokenExpiresIn*1e3),St=new Date(Date.now()+r.refreshTokenExpiresIn*1e3);return await o.context.adapter.create({model:i.oauthAccessToken,data:{accessToken:Lo,refreshToken:jo,accessTokenExpiresAt:Ut,refreshTokenExpiresAt:St,clientId:n.toString(),userId:ee.userId,scopes:ee.scopes,createdAt:new Date,updatedAt:new Date}}),o.json({access_token:Lo,token_type:"bearer",expires_in:r.accessTokenExpiresIn,refresh_token:jo,scope:ee.scopes})}if(!d)throw new m("BAD_REQUEST",{error_description:"code is required",error:"invalid_request"});if(e.requirePKCE&&!l)throw new m("BAD_REQUEST",{error_description:"code verifier is missing",error:"invalid_request"});let p=await o.context.internalAdapter.findVerificationValue(d.toString());if(!p)throw new m("UNAUTHORIZED",{error_description:"invalid code",error:"invalid_grant"});if(p.expiresAt<new Date)throw await o.context.internalAdapter.deleteVerificationValue(p.id),new m("UNAUTHORIZED",{error_description:"code expired",error:"invalid_grant"});if(await o.context.internalAdapter.deleteVerificationValue(p.id),!n||!s)throw new m("UNAUTHORIZED",{error_description:"client_id and client_secret are required",error:"invalid_client"});if(!a)throw new m("BAD_REQUEST",{error_description:"grant_type is required",error:"invalid_request"});if(a!=="authorization_code")throw new m("BAD_REQUEST",{error_description:"grant_type must be 'authorization_code'",error:"unsupported_grant_type"});if(!A)throw new m("BAD_REQUEST",{error_description:"redirect_uri is required",error:"invalid_request"});let u=await o.context.adapter.findOne({model:i.oauthClient,where:[{field:"clientId",value:n.toString()}]}).then(ee=>ee?{...ee,redirectURLs:ee.redirectURLs.split(","),metadata:ee.metadata?JSON.parse(ee.metadata):{}}:null);if(!u)throw new m("UNAUTHORIZED",{error_description:"invalid client_id",error:"invalid_client"});if(u.disabled)throw new m("UNAUTHORIZED",{error_description:"client is disabled",error:"invalid_client"});if(!(u.clientSecret===s.toString()))throw new m("UNAUTHORIZED",{error_description:"invalid client_secret",error:"invalid_client"});let h=JSON.parse(p.value);if(h.clientId!==n.toString())throw new m("UNAUTHORIZED",{error_description:"invalid client_id",error:"invalid_client"});if(h.redirectURI!==A.toString())throw new m("UNAUTHORIZED",{error_description:"invalid redirect_uri",error:"invalid_client"});if(h.codeChallenge&&!l)throw new m("BAD_REQUEST",{error_description:"code verifier is missing",error:"invalid_request"});if((h.codeChallengeMethod==="plain"?l:await hn("SHA-256","base64urlnopad").digest(l))!==h.codeChallenge)throw new m("UNAUTHORIZED",{error_description:"code verification failed",error:"invalid_request"});let B=h.scope;await o.context.internalAdapter.deleteVerificationValue(d.toString());let F=I(32,"a-z","A-Z"),g=I(32,"A-Z","a-z"),O=new Date(Date.now()+r.accessTokenExpiresIn*1e3),v=new Date(Date.now()+r.refreshTokenExpiresIn*1e3);await o.context.adapter.create({model:i.oauthAccessToken,data:{accessToken:F,refreshToken:g,accessTokenExpiresAt:O,refreshTokenExpiresAt:v,clientId:n.toString(),userId:h.userId,scopes:B.join(" "),createdAt:new Date,updatedAt:new Date}});let _=await o.context.internalAdapter.findUserById(h.userId);if(!_)throw new m("UNAUTHORIZED",{error_description:"user not found",error:"invalid_grant"});let Qe={alg:"HS256",key:await crypto.subtle.generateKey({name:"HMAC",hash:"SHA-256"},!0,["sign","verify"])},Et={given_name:_.name.split(" ")[0],family_name:_.name.split(" ")[1],name:_.name,profile:_.image,updated_at:_.updatedAt.toISOString()},It={email:_.email,email_verified:_.emailVerified},Rt={...B.includes("profile")?Et:{},...B.includes("email")?It:{}},_t=await new fn({sub:_.id,aud:n.toString(),iat:Date.now(),auth_time:o.context.session?.session.createdAt.getTime(),nonce:t.nonce,acr:"urn:mace:incommon:iap:silver",...Rt}).setProtectedHeader({alg:Qe.alg}).setIssuedAt().setExpirationTime(Math.floor(Date.now()/1e3)+r.accessTokenExpiresIn).sign(Qe.key);return o.json({access_token:F,token_type:"Bearer",expires_in:r.accessTokenExpiresIn,refresh_token:B.includes("offline_access")?g:void 0,scope:B.join(" "),id_token:B.includes("openid")?_t:void 0},{headers:{"Cache-Control":"no-store",Pragma:"no-cache"}})}),oAuth2userInfo:K("/oauth2/userinfo",{method:"GET",metadata:{isAction:!1}},async o=>{if(!o.request)throw new m("UNAUTHORIZED",{error_description:"request not found",error:"invalid_request"});let t=o.request.headers.get("authorization");if(!t)throw new m("UNAUTHORIZED",{error_description:"authorization header not found",error:"invalid_request"});let n=t.replace("Bearer ",""),s=await o.context.adapter.findOne({model:i.oauthAccessToken,where:[{field:"accessToken",value:n}]});if(!s)throw new m("UNAUTHORIZED",{error_description:"invalid access token",error:"invalid_token"});if(s.accessTokenExpiresAt<new Date)throw new m("UNAUTHORIZED",{error_description:"The Access Token expired",error:"invalid_token"});let a=await o.context.internalAdapter.findUserById(s.userId);if(!a)throw new m("UNAUTHORIZED",{error_description:"user not found",error:"invalid_token"});let d=s.scopes.split(" "),A={email:d.includes("email")?a.email:void 0,name:d.includes("profile")?a.name:void 0,picture:d.includes("profile")?a.image:void 0,given_name:d.includes("profile")?a.name.split(" ")[0]:void 0,family_name:d.includes("profile")?a.name.split(" ")[1]:void 0,email_verified:d.includes("email")?a.emailVerified:void 0};return o.json(A)}),registerOAuthApplication:K("/oauth2/register",{method:"POST",body:Y.object({name:Y.string(),icon:Y.string().optional(),metadata:Y.record(Y.any()).optional(),redirectURLs:Y.array(Y.string())})},async o=>{let t=o.body,n=await R(o);if(!n&&!e.allowDynamicClientRegistration)throw new m("UNAUTHORIZED",{message:"Unauthorized"});let s=e.generateClientId?.()||I(32,"a-z","A-Z"),a=e.generateClientSecret?.()||I(32,"a-z","A-Z"),d=await o.context.adapter.create({model:i.oauthClient,data:{name:t.name,icon:t.icon,metadata:t.metadata?JSON.stringify(t.metadata):null,clientId:s,clientSecret:a,redirectURLs:t.redirectURLs.join(","),type:"web",authenticationScheme:"client_secret",disabled:!1,userId:n?.session.userId,createdAt:new Date,updatedAt:new Date}});return o.json({...d,redirectURLs:d.redirectURLs.split(","),metadata:d.metadata?JSON.parse(d.metadata):null})}),getOAuthClient:K("/oauth2/client/:id",{method:"GET",use:[E]},async o=>{let t=await o.context.adapter.findOne({model:i.oauthClient,where:[{field:"clientId",value:o.params.id}]});if(!t)throw new m("NOT_FOUND",{error_description:"client not found",error:"not_found"});return o.json({clientId:t.clientId,name:t.name,icon:t.icon})})},schema:Tt}};export{Ee as HIDE_METADATA,Il as admin,pl as anonymous,Fu as bearer,K as createAuthEndpoint,D as createAuthMiddleware,Im as customSession,am as emailOTP,jl as genericOAuth,Gl as jwt,Gu as magicLink,em as multiSession,bm as oAuthProxy,pf as oidcProvider,mm as oneTap,Zg as openAPI,xo as optionsMiddleware,Kp as organization,sl as phoneNumber,Eu as twoFactor,ru as twoFactorClient,pt as username};
